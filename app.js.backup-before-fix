const { useState, useRef, useEffect } = React;
const e = React.createElement;

// Ikonit
const Icons = {
  Book: () => e('svg', { className: 'w-6 h-6', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253' })
  ),
  Menu: () => e('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M4 6h16M4 12h16M4 18h16' })
  ),
  Plus: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 4v16m8-8H4' })
  ),
  Trash: () => e('svg', { className: 'w-3 h-3', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16' })
  ),
  ChevronDown: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M19 9l-7 7-7-7' })
  ),
  ChevronRight: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M9 5l7 7-7 7' })
  ),
  Sun: () => e('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z' })
  ),
  Moon: () => e('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z' })
  ),
  Sparkles: () => e('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z' })
  ),
  Save: () => e('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4' })
  ),
  Upload: () => e('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12' })
  ),
  Download: () => e('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4' })
  ),
  Eye: () => e('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M15 12a3 3 0 11-6 0 3 3 0 016 0z' }),
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z' })
  ),
  EyeOff: () => e('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21' })
  ),
  Loader: () => e('svg', { className: 'w-4 h-4 animate-spin', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('circle', { cx: 12, cy: 12, r: 10, stroke: 'currentColor', strokeWidth: 4, fill: 'none', opacity: 0.25 }),
    e('path', { fill: 'currentColor', d: 'M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z' })
  ),
  X: () => e('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M6 18L18 6M6 6l12 12' })
  ),
  FileText: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z' })
  ),
  Folder: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z' })
  ),
  AlignLeft: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M4 6h16M4 12h16M4 18h7' })
  ),
  Filter: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z' })
  ),
  Camera: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z' }),
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M15 13a3 3 0 11-6 0 3 3 0 016 0z' })
  ),
  Clock: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z' })
  ),
  Collection: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10' })
  ),
  Tag: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z' })
  ),
  Maximize: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4' })
  ),
  Columns: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v2m0 0V7a2 2 0 00-2-2h-2m-4 0h-2' })
  ),
  Typewriter: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253' }),
    e('circle', { cx: 12, cy: 12, r: 2, stroke: 'currentColor', strokeWidth: 2, fill: 'none' })
  )
};

// üúç FAUST MODE SYSTEM - DEIS (Light) & NOX (Dark)
const FAUST_STYLES = `
  :root {
    /* üåë NOX - Dark Mode (default) - "the Night Mind" */
    --faust-bg-primary: #141210;
    --faust-bg-secondary: #1A1815;
    --faust-bg-tertiary: #26231E;
    --faust-bg-quaternary: #2D2A25;
    
    --faust-text-primary: #E9E4DA;
    --faust-text-secondary: #AFA699;
    --faust-text-tertiary: #7E7669;
    
    --faust-accent-primary: #9A7B4F;
    --faust-accent-secondary: #D2C6B2;
    --faust-accent-tertiary: #715C38;
    
    /* üúç Sigil Colors - NOX */
    --sigil-invocation: #9F885C;
    --sigil-conjunction: #8C744C;
    --sigil-separation: #A28554;
    --sigil-transformation: #9A7B4F;
    --sigil-illumination: #BFA772;
    --sigil-calcination: #7E6946;
    
    --faust-border: #1A1815;
    --faust-shadow: rgba(0, 0, 0, 0.5);
    
    /* Typography - FAUST Fonts */
    --font-body: "IBM Plex Mono", "Iosevka Aile", monospace;
    --font-heading: "EB Garamond", "Canela", serif;
    --font-ui: "Space Mono", monospace;
    --font-sigil: "Space Mono", monospace;
    
    /* Spacing (8px base) */
    --space-xs: 8px;
    --space-sm: 12px;
    --space-md: 16px;
    --space-lg: 20px;
    --space-xl: 24px;
    --space-xxl: 32px;
    
    /* Shadows */
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.3), 0 1px 2px rgba(0,0,0,0.2);
    --shadow-md: 0 4px 8px rgba(0,0,0,0.3), 0 2px 4px rgba(0,0,0,0.2);
    --shadow-lg: 0 10px 20px rgba(0,0,0,0.4), 0 3px 6px rgba(0,0,0,0.3);
    --shadow-window: 0 25px 50px rgba(0,0,0,0.6);
    
    /* Radius */
    --radius-sm: 4px;
    --radius-md: 6px;
    --radius-lg: 10px;
    --radius-xl: 12px;
    
    /* Transitions */
    --ease-in-out: cubic-bezier(0.4, 0.0, 0.2, 1);
    --ease-organic: cubic-bezier(0.33, 1, 0.68, 1);
  }
  
  /* üúï DEIS - Light Mode - "the Day Mind" */
  [data-theme="light"] {
    --faust-bg-primary: #F9F6F0;
    --faust-bg-secondary: #E3DCD0;
    --faust-bg-tertiary: #D8D1C5;
    --faust-bg-quaternary: #CCC5B9;
    
    --faust-text-primary: #26231E;
    --faust-text-secondary: #5E584D;
    --faust-text-tertiary: #878176;
    
    --faust-accent-primary: #C89D5E;
    --faust-accent-secondary: #715C38;
    --faust-accent-tertiary: #A9875A;
    
    /* üúç Sigil Colors - DEIS */
    --sigil-invocation: #B48E5D;
    --sigil-conjunction: #A9875A;
    --sigil-separation: #C8A768;
    --sigil-transformation: #C89D5E;
    --sigil-illumination: #D8C28F;
    --sigil-calcination: #8F7A53;
    
    --faust-border: #E3DCD0;
    --faust-shadow: rgba(38, 35, 30, 0.1);
    
    /* Light mode shadows */
    --shadow-sm: 0 1px 3px rgba(38,35,30,0.08), 0 1px 2px rgba(38,35,30,0.06);
    --shadow-md: 0 4px 8px rgba(38,35,30,0.08), 0 2px 4px rgba(38,35,30,0.06);
    --shadow-lg: 0 10px 20px rgba(38,35,30,0.1), 0 3px 6px rgba(38,35,30,0.08);
    --shadow-window: 0 25px 50px rgba(38,35,30,0.15);
  }
  
  /* Base Styles */
  * {
    box-sizing: border-box;
  }
  
  body {
    font-family: var(--font-body);
    background: var(--faust-bg-primary);
    color: var(--faust-text-primary);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    transition: background 0.3s var(--ease-organic), color 0.3s var(--ease-organic);
  }
  
  /* Smooth transitions */
  button, input, textarea, select {
    transition: background-color 0.3s var(--ease-organic),
                color 0.3s var(--ease-organic),
                border-color 0.3s var(--ease-organic),
                box-shadow 0.3s var(--ease-organic),
                transform 0.3s var(--ease-organic);
  }
  
  /* Focus visible - FAUST accent */
  *:focus-visible {
    outline: 2px solid var(--faust-accent-primary);
    outline-offset: 2px;
    box-shadow: 0 0 0 4px var(--faust-shadow);
  }
  
  /* Scrollbars */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  
  ::-webkit-scrollbar-track {
    background: transparent;
  }
  
  ::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.2);
    border-radius: 4px;
  }
  
  ::-webkit-scrollbar-thumb:hover {
    background: rgba(255,255,255,0.3);
  }
  
  /* Animations */
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
  
  @keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
  }
  
  /* NATSUME: Organic Animations */
  @keyframes breatheIn {
    0% { opacity: 0; transform: scale(1.02); }
    100% { opacity: 1; transform: scale(1); }
  }
  
  @keyframes breatheOut {
    0% { opacity: 1; transform: scale(1); }
    100% { opacity: 0; transform: scale(0.98); }
  }
  
  @keyframes wave {
    0% { opacity: 0; transform: translateY(3px); }
    50% { opacity: 1; transform: translateY(-1px); }
    100% { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  
  .animate-breatheIn {
    animation: breatheIn 0.6s ease-in forwards;
  }
  
  .animate-breatheOut {
    animation: breatheOut 0.6s ease-out forwards;
  }
  
  .animate-wave {
    animation: wave 0.8s cubic-bezier(0.4, 0.0, 0.2, 1) forwards;
  }
  
  .animate-slideIn {
    animation: slideIn 0.4s ease-out forwards;
  }
  
  .animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  
  /* NATSUME: Flow Mode Transitions */
  .flow-transition {
    transition: background 1s ease-in-out, filter 2s ease-in-out;
  }
  
  .mode-focus {
    background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);
  }
  
  .mode-rhythm {
    background: linear-gradient(180deg, #1a1a2a 0%, #0f0f1f 100%);
  }
  
  .mode-review {
    background: linear-gradient(180deg, #1a1f1a 0%, #0f140f 100%);
  }
  
  .tone-calm {
    filter: saturate(0.8);
  }
  
  .tone-tense {
    filter: saturate(1.2) contrast(1.1);
  }
  
  /* NORMAN: Inline Suggestion Affordance - FAUST */
  .inline-suggestion {
    border-bottom: 2px dashed var(--faust-accent-primary);
    opacity: 0.6;
    cursor: pointer;
    transition: all 0.3s var(--ease-organic);
  }
  
  .inline-suggestion:hover {
    border-color: var(--faust-accent-primary);
    background: var(--faust-accent-primary);
    background-opacity: 0.1;
    opacity: 1;
  }
  
  /* SAGMEISTER: Organic Glow Effects - FAUST */
  @keyframes glow-slide {
    0%, 100% { 
      background-position: 0% 50%; 
      opacity: 0.3;
    }
    50% { 
      background-position: 100% 50%; 
      opacity: 0.6;
    }
  }
  
  @keyframes pulse-glow {
    0%, 100% { 
      filter: blur(20px);
    }
    50% { 
      filter: blur(30px);
    }
  }
  
  .glow-suggestion {
    position: relative;
    display: inline-block;
  }
  
  .glow-suggestion::before {
    content: '';
    position: absolute;
    inset: -4px;
    z-index: -1;
    background: linear-gradient(90deg, 
      var(--sigil-transformation), 
      var(--sigil-illumination), 
      var(--sigil-transformation));
    background-size: 200% 100%;
    border-radius: 4px;
    opacity: 0.3;
    animation: glow-slide 3s ease-in-out infinite, pulse-glow 2s ease-in-out infinite;
  }
  
  /* SAGMEISTER: Living Typography - adapts to writing speed */
  .living-typography {
    transition: font-size 1.5s cubic-bezier(0.4, 0.0, 0.2, 1),
                letter-spacing 1.5s cubic-bezier(0.4, 0.0, 0.2, 1);
  }
  
  /* PENTAGRAM: Optimal reading width */
  .typographic-container {
    max-width: 800px;
    margin: 0 auto;
  }
  
  /* üúç FAUST: Rituaalinen vaihtoanimaatio DEIS ‚áÑ NOX */
  @keyframes faustModeTransition {
    0% {
      opacity: 1;
    }
    15% {
      opacity: 0.8;
    }
    50% {
      opacity: 0.8;
      transform: scale(1.005);
    }
    85% {
      opacity: 0.8;
    }
    100% {
      opacity: 1;
      transform: scale(1);
    }
  }
  
  @keyframes gradientSwipe {
    0% {
      opacity: 0;
      transform: translateX(-100%);
    }
    50% {
      opacity: 1;
    }
    100% {
      opacity: 0;
      transform: translateX(100%);
    }
  }
  
  .faust-mode-switching {
    animation: faustModeTransition 1200ms var(--ease-organic);
  }
  
  .faust-gradient-overlay {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 9999;
    background: linear-gradient(90deg, 
      transparent 0%, 
      var(--faust-accent-primary) 50%, 
      transparent 100%);
    opacity: 0;
    animation: gradientSwipe 800ms var(--ease-organic);
  }
  
  /* üúç FAUST: Sigilien animaatiot */
  @keyframes sigilBreath {
    0%, 100% {
      opacity: 0.9;
      transform: scale(1);
    }
    50% {
      opacity: 1;
      transform: scale(1.05);
    }
  }
  
  @keyframes sigilGlowPulse {
    0%, 100% {
      box-shadow: 0 0 0 0 var(--faust-accent-primary);
    }
    50% {
      box-shadow: 0 0 8px 2px var(--faust-accent-primary);
    }
  }
  
  .sigil {
    transition: color 0.2s ease-in, transform 0.2s ease-in, filter 0.2s ease-in;
    color: var(--sigil-transformation);
  }
  
  .sigil:hover {
    color: var(--sigil-illumination);
    filter: drop-shadow(0 0 4px var(--faust-accent-primary));
    transform: scale(1.1);
  }
  
  .sigil:active {
    animation: sigilBreath 400ms var(--ease-organic);
  }
  
  /* üúç FAUST: Kursori hehku */
  @keyframes cursorGlow {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.6;
    }
  }
  
  textarea:focus, input:focus {
    caret-color: var(--faust-accent-primary);
  }
  
  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }
`;

// Label v√§rit
const LABEL_COLORS = [
  { id: 'none', name: 'Ei merkint√§√§', color: 'transparent' },
  { id: 'red', name: 'Punainen', color: '#ef4444' },
  { id: 'orange', name: 'Oranssi', color: '#f97316' },
  { id: 'yellow', name: 'Keltainen', color: '#eab308' },
  { id: 'green', name: 'Vihre√§', color: '#22c55e' },
  { id: 'blue', name: 'Sininen', color: '#3b82f6' },
  { id: 'purple', name: 'Violetti', color: '#a855f7' },
  { id: 'pink', name: 'Pinkki', color: '#ec4899' }
];

// LocationKeeper - Paikkamalli
const LOCATION_TEMPLATE = {
  id: null,
  name: '',
  type: '', // city, building, landmark, public_square, street, nature, interior, transport
  city: '',
  country: '',
  coordinates: { lat: null, lng: null },
  
  facts: {
    history: '',
    architecture: [],
    features: [],
    atmosphere: []
  },
  
  visual: {
    colors_day: [],
    colors_night: [],
    lighting: [],
    textures: []
  },
  
  genre_descriptions: {}, // { genre: description }
  
  used_in_scenes: [],
  notes: '',
  image_refs: [],
  
  // Web search tulokset
  research: {
    last_searched: null,
    facts_source: '',
    images_source: ''
  }
};

// Genre-vaihtoehdot
const GENRE_OPTIONS = [
  { id: 'psychological_thriller', name: 'Psykologinen trilleri', icon: 'üß†' },
  { id: 'romantic_drama', name: 'Romanttinen draama', icon: '‚ù§Ô∏è' },
  { id: 'action_thriller', name: 'Toimintatrilleri', icon: 'üí•' },
  { id: 'horror', name: 'Kauhu', icon: 'üëª' },
  { id: 'noir', name: 'Noir / Rikosromaani', icon: 'üïµÔ∏è' },
  { id: 'historical_fiction', name: 'Historiallinen fiktio', icon: 'üìú' },
  { id: 'literary_fiction', name: 'Kirjallinen fiktio', icon: 'üìö' },
  { id: 'fantasy', name: 'Fantasia', icon: 'üêâ' },
  { id: 'scifi', name: 'Sci-fi', icon: 'üöÄ' },
  { id: 'mystery', name: 'Mysteeri', icon: 'üîç' }
];

// Paikkatyypit
const LOCATION_TYPES = [
  { id: 'city', name: 'Kaupunki', icon: 'üèôÔ∏è' },
  { id: 'building', name: 'Rakennus', icon: 'üè¢' },
  { id: 'landmark', name: 'Maamerkki', icon: 'üóº' },
  { id: 'public_square', name: 'Aukio', icon: 'üèõÔ∏è' },
  { id: 'street', name: 'Katu', icon: 'üõ£Ô∏è' },
  { id: 'nature', name: 'Luonto', icon: 'üå≤' },
  { id: 'interior', name: 'Sis√§tila', icon: 'üö™' },
  { id: 'transport', name: 'Kulkuneuvo', icon: 'üöÇ' }
];

// StoryKeeper - Tarinan rakenne mallit
const CHAPTER_TEMPLATE = {
  chapter: 1,
  title: '',
  summary: '',
  key_events: [],
  story_time: '',  // "Maanantai 9:00"
  real_time: '',   // "2024-03-15 09:00:00"
  duration: '',    // "2h"
  pov: '',         // Kenen n√§k√∂kulma
  location: '',    // Miss√§ tapahtuu
  status: 'not_started',  // not_started / in_progress / completed
  word_count: 0
};

const EVENT_TEMPLATE = {
  id: null,
  description: '',
  chapter: 1,
  timestamp: '',  // "Luku 3, s.45"
  significance: 'minor',  // major / minor
  requires: [],     // [event_ids] mit√§ t√§ytyy olla ennen
  consequences: [], // [event_ids] mihin t√§m√§ vaikuttaa
  opens_threads: [],  // [thread_ids]
  closes_threads: [], // [thread_ids]
  immutable: false,   // voiko t√§m√§ muuttua?
  character_involved: [],  // [character_ids]
  location: ''
};

const THREAD_TEMPLATE = {
  id: null,
  name: '',
  description: '',
  opened_chapter: null,
  closed_chapter: null,
  status: 'open',  // open / closed / abandoned
  importance: 'minor',  // major / minor / subplot
  mentions: []  // [{chapter, note}] miss√§ luvuissa mainitaan
};

// Vaihe 5: Hahmomalli - CharacterKeeper
const CHARACTER_TEMPLATE = {
  id: null,
  name: '',
  bio: {
    age: null,
    gender: '',
    occupation: '',
    appearance: ''
  },
  psychology: {
    want: '',          // Mit√§ hahmo haluaa
    fear: '',          // Mit√§ hahmo pelk√§√§
    weakness: '',      // Hahmon heikkous
    values: []         // Arvot (esim. "rehellisyys", "perhe")
  },
  voice: {
    description: '',   // Miten hahmo puhuu
    avgSentenceLength: 12,
    lexicon: [],       // Tyypilliset sanat/fraasit
    disallowed: []     // Kielletyt ilmaukset
  },
  state: {
    injuries: [],      // Loukkaantumiset
    resources: [],     // Esineet/taidot
    mood: '',          // Nykyinen mieliala
    beliefs: {}        // Uskomukset (key-value)
  },
  arc: [],             // Hahmokaaren kehitys [{scene, belief, trigger}]
  relationships: [],   // Suhteet [{with, trust, tension, lastEvent}]
  lastSeen: {
    scene: '',
    location: '',
    time: ''
  },
  notes: ''            // Vapaat muistiinpanot
};

// Suhdetyypit
const RELATIONSHIP_TYPES = [
  { id: 'family', name: 'Perhe', color: '#ef4444' },
  { id: 'friend', name: 'Yst√§v√§', color: '#22c55e' },
  { id: 'romantic', name: 'Romanttinen', color: '#ec4899' },
  { id: 'enemy', name: 'Vihollinen', color: '#dc2626' },
  { id: 'colleague', name: 'Kollega', color: '#3b82f6' },
  { id: 'mentor', name: 'Mentori', color: '#a855f7' },
  { id: 'stranger', name: 'Tuntematon', color: '#6b7280' }
];

// üúç GRIMOIRE - Projektin muistij√§rjestelm√§ (Project Memory)
const GRIMOIRE_TEMPLATE = {
  // AI-keskusteluhistoria projektikohtaisesti
  conversations: [],  // [{id, timestamp, prompt, response, model, applied}]
  
  // Tyylivalidit ja s√§√§nn√∂t
  styleRules: [],     // [{id, rule, example, priority}]
  
  // Hyl√§tyt ehdotukset - AI oppii mit√§ ET halua
  rejections: [],     // [{id, original, suggestion, reason, timestamp}]
  
  // Hyv√§ksytyt muutokset - AI oppii mit√§ pid√§t
  acceptances: [],    // [{id, original, modified, timestamp, context}]
  
  // Projektin "√§√§ni" - oppii automaattisesti
  projectVoice: {
    avgSentenceLength: null,
    lexicon: [],              // Tyypilliset sanat/fraasit
    avoidedWords: [],         // V√§ltetyt sanat
    preferredStructures: [],  // Tyypilliset lauserakenteet
    tone: 'neutral',          // 'formal', 'casual', 'poetic', 'dark', etc.
    pov: null,                // '1st person', '3rd limited', '3rd omniscient'
    tense: null               // 'present', 'past'
  },
  
  // Teemojen ja symbolien tracker
  themes: [],         // [{name, occurrences: [{chapter, context}]}]
  symbols: [],        // [{symbol, meaning, first_appearance, recurrences}]
  
  // Metadataa
  created: null,
  lastUpdated: null,
  totalInteractions: 0
};

// Vaihe 5: Kirjoitustekniikat-objekti
const WRITING_TECHNIQUES = {
  literary: {
    title: 'üìö KIRJALLISUUSTIEDE',
    color: 'purple',
    techniques: [
      {
        id: 'defamiliarization',
        name: 'Defamiliarisaatio',
        description: 'Tee tutusta vieraaksi - riko kielen j√§rjestys',
        prompt: `Olet kirjoituskonsultti. Sovella DEFAMILIARISAATIOTA (–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ) t√§h√§n tekstiin.

TEKSTI:
\${getActiveItem()?.content || '[Ei sis√§lt√∂√§]'}

DEFAMILIARISAATIO: Tee tutusta oudoksuttavaa rikkaamalla normaalit kieli- ja havaintomallit.

TEKNIIKAT:
1. **Riko lausej√§rjestys**: "Syd√§n ly√∂" ‚Üí "Syd√§n. Ly√∂nti. Pys√§hdys."
2. **Vieraannuta sanat**: "K√§vell√§" ‚Üí "Liike jalkojen kautta, yksi, toinen, yksi"
3. **V√§√§rist√§ n√§k√∂kulma**: Kerro tuttu asia kuin ensimm√§ist√§ kertaa
4. **Irrota merkitys**: Hajota toiminto osiin

ESIMERKKI:
ENNEN: "H√§n avasi oven ja astui sis√§√§n."
J√ÑLKEEN: "Metallikahva. Kylm√§. Kiertyminen. Rako levenee. Valo vuotaa. Askel. Toinen. H√§n on sis√§ll√§."

ANNA:
- 3-5 defamiliarisaatio-ehdotusta
- S√§ilyt√§ ydinsis√§lt√∂ mutta tee se oudoksuttavaksi
- Selit√§ miksi muutos toimii

VASTAA SUOMEKSI.`
      },
      {
        id: 'sensory_richness',
        name: 'Aistillisuus',
        description: 'Aktivoi kaikki viisi aistia',
        prompt: `Lis√§√§ AISTILLISET YKSITYISKOHDAT t√§h√§n tekstiin:

TEKSTI:
\${getActiveItem()?.content || '[Ei sis√§lt√∂√§]'}

LIS√Ñ√Ñ:
1. **N√§k√∂** (v√§rit, muodot, liike, valo/varjo)
2. **Kuulo** (√§√§net, hiljaisuus, rytmit, kaikuja)
3. **Haju** (tuoksut, lemut, ilman laatu)
4. **Maku** (jos relevantti - ilman maku, muistot)
5. **Tunto** (tekstuurit, l√§mp√∂tila, kosketus, paineet)

TAVOITE: Aktivoi lukijan keho, ei vain mieli.

√ÑL√Ñ:
- Listaa aistihavaintoja ("H√§n n√§ki X, kuuli Y, haisti Z")
- Lis√§√§ yksityiskohtia v√§kisin
- Unohda kontekstia

ANNA:
- 3-5 konkreettista lis√§yst√§
- Integroi ne luonnollisesti tekstiin
- Selit√§ miksi kukin vahvistaa kokemusta

VASTAA SUOMEKSI.`
      },
      {
        id: 'symbolic_redundancy',
        name: 'Symbolinen redundanssi',
        description: 'Toista motiivia hienovaraisesti l√§pi tekstin',
        prompt: `Analysoi ja vahvista SYMBOLISTA REDUNDANSSIA:

TEKSTI:
\${getActiveItem()?.content || '[Ei sis√§lt√∂√§]'}

SYMBOLINEN REDUNDANSSI: Toista keskeinen motiivi/symboli/kuva hienovaraisesti eri muodoissa l√§pi tekstin.

ESIMERKKI:
Motiivi: "Murtuminen"
- Rivi 1: "Lasi s√§r√∂ili ikkunassa"
- Rivi 45: "H√§nen √§√§nens√§ katkesi"
- Rivi 89: "Luottamus repeytyi"

TEHT√ÑV√Ñ:
1. Tunnista mahdollinen ydinmotiivi tekstist√§
2. Ehdota 3-5 paikkaa miss√§ sit√§ voi toistaa hienovaraisesti
3. Vaihtele muotoa (konkreetti ‚Üí abstrakti, verbaali ‚Üí visuaalinen)

ANNA:
- Tunnistettu motiivi
- Nykyiset esiintym√§t
- Uudet esiintymis-ehdotukset
- Selitys miksi redundanssi toimii

VASTAA SUOMEKSI.`
      },
      {
        id: 'rhythm_breath',
        name: 'Rytmi & Hengitys',
        description: 'Vaihtele lausepituuksia orgaanisesti',
        prompt: `Optimoi tekstin RYTMI JA HENGITYS:

TEKSTI:
\${getActiveItem()?.content || '[Ei sis√§lt√∂√§]'}

RYTMI: Vaihtele lausepituuksia luoden orgaaninen hengitysrytmi.

TEKNIIKAT:
1. **Lyhyt-lyhyt-pitk√§**: J√§nnite ‚Üí j√§nnite ‚Üí purkaus
2. **Pitk√§-lyhyt**: Rakennus ‚Üí r√§j√§hdys
3. **Staccato**: Lyhyt. Lyhyt. Lyhyt. = ahdistus, kiire
4. **Legato**: Pitk√§t, virtaavat lauseet = rauha, kontempl–∞atio

ESIMERKKI:
ENNEN: "H√§n k√§veli kadulla. H√§n n√§ki jonkun. H√§n tunsi pelon."
J√ÑLKEEN: "H√§n k√§veli. Katu. Joku - siell√§, varjoissa, liikkumatta. Paniikki valutti kylke√§ pitkin kuin j√§√§kylm√§ vesi."

ANNA:
- Nykyinen rytmi-analyysi (montako sanaa per lause)
- 3-5 rytmikorjausta
- Selit√§ miten rytmi tukee tunnelmaa

VASTAA SUOMEKSI.`
      },
      {
        id: 'negative_space',
        name: 'Tyhj√§ tila',
        description: 'J√§t√§ aukkoja lukijan t√§ytett√§v√§ksi',
        prompt: `Luo TYHJ√Ñ√Ñ TILAA (negative space) tekstiin:

TEKSTI:
\${getActiveItem()?.content || '[Ei sis√§lt√∂√§]'}

TYHJ√Ñ TILA: √Ñl√§ kerro kaikkea. J√§t√§ aukkoja, ep√§varmuutta, tulkinnanvaraa.

TEKNIIKAT:
1. **Poisj√§tt√∂**: Kerro A ja C, mutta √§l√§ B:t√§
2. **Vihjeet**: Anna fragmentteja, √§l√§ kokonaisuutta
3. **Ep√§varmuus**: "Ehk√§", "Luultavasti", "H√§n ajatteli ett√§"
4. **Keskenj√§tt√∂**: Keskeyt√§ lause, j√§t√§ ajatus roikkumaan

ESIMERKKI:
ENNEN: "H√§n n√§ki miehen ja tunsi olevansa vaarassa, koska mies katsoi uhkaavasti."
J√ÑLKEEN: "H√§n n√§ki miehen. Jotain katseessa. H√§n k√§√§ntyi nopeasti pois."

ANNA:
- 3-5 kohtaa miss√§ voit j√§tt√§√§ tyhj√§√§ tilaa
- S√§ilyt√§ ydinviesti mutta tee se ep√§suoraksi
- Selit√§ miten t√§m√§ sitouttaa lukijaa

VASTAA SUOMEKSI.`
      }
    ]
  },

  psychological: {
    title: 'üß† PSYKOLOGIA',
    color: 'blue',
    techniques: [
      {
        id: 'peak_end',
        name: 'Peak-End Rule',
        description: 'Huippu keskell√§, ankkuri lopussa',
        prompt: `Sovella PEAK-END RULE t√§h√§n tekstiin:

TEKSTI:
\${getActiveItem()?.content || '[Ei sis√§lt√∂√§]'}

PEAK-END RULE: Lukijat muistavat kaksi asiaa: 1) Intensiivisimm√§n hetken (peak), 2) Lopun (end).

RAKENNE:
1. **Alku**: Johdanto, aseta odotukset
2. **Peak**: Emotionaalinen/j√§nnittynein hetki (2/3 kohdalla)
3. **Lasku**: Laskeva toiminta
4. **End**: Ankkuri - voimakas loppu joka j√§√§ mieleen

ESIMERKKI:
- Peak: "Veitsi viilsi h√§nen selk√§ns√§ yli"
- End: "H√§n sulki oven. Hiljaisuus. H√§n oli yksin."

TEHT√ÑV√Ñ:
1. Tunnista nykyinen peak (jos on)
2. Ehdota vahvempaa peak-hetke√§
3. Suunnittele voimakas end-hetki
4. Anna konkreettinen rakenne

VASTAA SUOMEKSI.`
      },
      {
        id: 'emotional_contagion',
        name: 'Tunnetartunta',
        description: '√Ñ√§nteet vaikuttavat alitajuntaan',
        prompt: `Optimoi TUNNETARTUNTA (emotional contagion):

TEKSTI:
\${getActiveItem()?.content || '[Ei sis√§lt√∂√§]'}

TUNNETARTUNTA: √Ñ√§nteiden (foneemien) valinnalla voit tartuttaa tunteita.

√Ñ√ÑNNE-EMOTIO MAP:
- **Pehme√§t** (l, m, n, v, h): Rauha, l√§mp√∂, hellyys
- **Kovat** (k, t, p, r): J√§nnite, voima, aggressio
- **Sibilantit** (s, sh): Hiljaisuus, salaisuus, pelko
- **Nasaalit** (m, n): Sulkeutuminen, sis√§√§np√§ink√§√§ntyminen

ESIMERKKI:
NEUTRAALI: "H√§n k√§veli ulos ja l√§hti"
PEHME√Ñ: "H√§n livahti ulos ja haihtui hiljaa"
KOVA: "H√§n karkasi ja katosi kiviseen katuh√§m√§r√§√§n"

ANNA:
- Analysoi nykyiset √§√§nteet
- Ehdota 3-5 muutosta emotionaalisen vaikutuksen vahvistamiseksi
- Selit√§ miksi √§√§nnemaailma tukee tunnelmaa

VASTAA SUOMEKSI.`
      },
      {
        id: 'zeigarnik_effect',
        name: 'Zeigarnik-efekti',
        description: 'Avoimet silmukat valvottavat',
        prompt: `Luo ZEIGARNIK-EFEKTI tekstiin:

TEKSTI:
\${getActiveItem()?.content || '[Ei sis√§lt√∂√§]'}

ZEIGARNIK-EFEKTI: Keskener√§iset teht√§v√§t/kysymykset j√§√§v√§t mieleen ja valvottavat.

TEKNIIKAT:
1. **Avoin kysymys**: "Mik√§ se √§√§ni oli?"
2. **Keskenj√§√§nyt teko**: "H√§n kurkotti ovenkahvaan mutta ‚Äî"
3. **Ratkaisematon j√§nnite**: "Joku teki sen. Mutta kuka?"
4. **Luvattu paljastus**: "Kolme sanaa. H√§n kertoisi my√∂hemmin."

ESIMERKKI:
"H√§n avasi kirjeen. Luki. Kasvot kalpenivat. H√§n laski paperin hitaasti p√∂yd√§lle ja katsoi ulos ikkunasta. Mit√§ siin√§ luki? Sit√§ h√§n ei voinut kertoa. Ei viel√§."

TEHT√ÑV√Ñ:
1. Tunnista nykyiset avoimet silmukat (jos on)
2. Ehdota 3-5 uutta silmukkaa
3. Varmista ett√§ lupaat ratkaisun (my√∂hemmin)
4. √Ñl√§ j√§t√§ KAIKKEA auki - vain keskeiset kysymykset

VASTAA SUOMEKSI.`
      },
      {
        id: 'affective_dissonance',
        name: 'Affektiivinen dissonanssi',
        description: 'Sekoita ristiriitaisia tunteita',
        prompt: `Luo AFFEKTIIVINEN DISSONANSSI:

TEKSTI:
\${getActiveItem()?.content || '[Ei sis√§lt√∂√§]'}

AFFEKTIIVINEN DISSONANSSI: Sekoita ristiriitaisia tunteita ‚Üí luo kompleksisuutta.

ESIMERKKEJ√Ñ:
- Suru + huumori: "H√§n itki hautajaisissa. Sitten h√§n muisti sen vitsin jonka √§iti oli kertonut. H√§n nauroi. Itki. Nauroi."
- Rakkaus + viha: "H√§n halusi halata h√§nt√§ ja ly√∂d√§ samaan aikaan."
- Pelko + uteliaisuus: "√Ñl√§ avaa ovea. Mutta mit√§ sen takana on?"

TEHT√ÑV√Ñ:
1. Tunnista yksipuoliset tunnekuvaukset
2. Lis√§√§ vastakkainen tunne samaan hetkeen
3. √Ñl√§ selit√§ ristiriitaa - anna sen olla
4. Anna 3-5 dissonanssi-ehdotusta

ESIMERKKI:
ENNEN: "H√§n oli surullinen"
J√ÑLKEEN: "Kyyneleet valuivat, mutta h√§n hymyili. Jokin t√§ss√§ oli vapauttavaa."

VASTAA SUOMEKSI.`
      },
      {
        id: 'cognitive_priming',
        name: 'Kognitiivinen priming',
        description: 'Ohjaa tulkintaa hienovaraisesti',
        prompt: `K√§yt√§ KOGNITIIVISTA PRIMING:IA:

TEKSTI:
\${getActiveItem()?.content || '[Ei sis√§lt√∂√§]'}

KOGNITIIVINEN PRIMING: Ohjaa lukijan tulkintaa hienovaraisilla vihjeill√§ ennen p√§√§asiaa.

TEKNIIKAT:
1. **Sana-assosiaatiot**: Mainitse "ter√§v√§" ‚Üí lukija odottaa vaaraa
2. **V√§ri-emotio**: "Harmaa" ‚Üí melankoliaa, "Punainen" ‚Üí intohimoa
3. **Kontekstuaaliset vihjeet**: "Hiljaisuus" ‚Üí j√§nnite kasvaa
4. **Metaforat**: "Ilma oli raskas" ‚Üí ahdistus tulossa

ESIMERKKI:
ILMAN PRIMING: "H√§n astui huoneeseen. Mies istui tuolissa."
PRIMING: "Ilma oli raskas, tunkkainen. Jotain oli pieless√§. H√§n astui huoneeseen. Mies istui tuolissa. Liikkumatta."

TEHT√ÑV√Ñ:
1. Tunnista kohdat miss√§ haluat ohjata lukijan odotuksia
2. Lis√§√§ priming-sanoja/kuvia 1-2 lausetta ennen
3. Anna 3-5 priming-ehdotusta
4. Selit√§ miten priming muuttaa tulkintaa

VASTAA SUOMEKSI.`
      }
    ]
  },

  persuasion: {
    title: 'üéØ VAIKUTTAMINEN',
    color: 'orange',
    techniques: [
      {
        id: 'ethos',
        name: 'Ethos (Luottamus)',
        description: 'Rakenna auktoriteetti ilman ylimielisyytt√§',
        prompt: `Rakenna ETHOS (luottavuus):

TEKSTI:
\${getActiveItem()?.content || '[Ei sis√§lt√∂√§]'}

ETHOS: Rakenna lukijan luottamus kertojaasi/hahmoosi ilman ett√§ sanot "luota minuun".

TEKNIIKAT:
1. **Yksityiskohdat**: Osoita ett√§ tied√§t mist√§ puhut (faktat, ammattisanasto)
2. **N√∂yryys**: Tunnusta ep√§varmuus ‚Üí paradoksaalisesti kasvattaa luottamusta
3. **Kokemuksen osoittaminen**: N√§yt√§ ett√§ olet kokenut t√§m√§n
4. **Johdonmukaisuus**: Pysy tyyliss√§ ja √§√§ness√§

ESIMERKKI:
HEIKKO ETHOS: "Olen asiantuntija t√§ss√§ asiassa."
VAHVA ETHOS: "H√§n tutki haavaa. Reunat olivat sile√§t - leikkaus, ei repi√§. Ter√§v√§ veitsi, oikeastaan skalpelli. Leikkaajan k√§si oli varma."

TEHT√ÑV√Ñ:
1. Tunnista kohdat miss√§ tarvitaan luottavuutta
2. Lis√§√§ yksityiskohtia jotka osoittavat asiantuntemusta
3. Poista ylti√∂p√§inen v√§itt√§minen
4. Anna 3-5 ethos-vahvistusta

VASTAA SUOMEKSI.`
      },
      {
        id: 'pathos',
        name: 'Pathos (Tunne)',
        description: 'Kosketa fyysisesti',
        prompt: `Vahvista PATHOS (emotionaalinen vaikutus):

TEKSTI:
\${getActiveItem()?.content || '[Ei sis√§lt√∂√§]'}

PATHOS: Kosketa lukijan tunteisiin niin ett√§ h√§nen KEHONSA reagoi.

TEKNIIKAT:
1. **Bodily sensations**: "Kurkkua kuristaa", "Vatsa kiristyy"
2. **Universaalit tunteet**: Menetys, pelko, rakkaus, pettymys
3. **Henkil√∂kohtainen + universaali**: "H√§nen √§itins√§" ‚Üí jokainen muistaa omansa
4. **Konkreetti, ei abstrakti**: "Tyhj√§ tuoli" > "Yksin√§isyys"

ESIMERKKI:
HEIKKO PATHOS: "H√§n oli surullinen kun muisti √§iti√§√§n."
VAHVA PATHOS: "√Ñidin tuoli oli tyhj√§. Vain se peite, taitettu, niin kuin h√§n oli opettanut. H√§nen k√§tens√§ v√§risiv√§t kun h√§n kosketti sit√§."

TEHT√ÑV√Ñ:
1. Tunnista abstraktit tunnekuvaukset
2. Muuta ne konkreettisiksi, kehollisiksi
3. K√§yt√§ yksityiskohtia jotka aktivoivat lukijan muistot
4. Anna 3-5 pathos-vahvistusta

VASTAA SUOMEKSI.`
      },
      {
        id: 'logos',
        name: 'Logos (Logiikka)',
        description: 'Piilota j√§rki tunteeseen',
        prompt: `Integroi LOGOS (logiikka) narratiiviin:

TEKSTI:
\${getActiveItem()?.content || '[Ei sis√§lt√∂√§]'}

LOGOS: Rakenna looginen argumentti N√ÑYTT√ÑM√ÑLL√Ñ, ei selitt√§m√§ll√§.

TEKNIIKAT:
1. **Syy-seuraus**: N√§yt√§ A ‚Üí B ‚Üí C luonnollisesti
2. **Todisteet havainnossa**: Anna faktat havaintoina, ei v√§itt√§min√§
3. **Deduktiivinen logiikka hahmon kautta**: Hahmo p√§√§ttelee, lukija seuraa
4. **Piilota opetus**: √Ñl√§ saaraa - anna lukijan oppia havainnoistaan

ESIMERKKI:
HEIKKO LOGOS: "H√§n ymm√§rsi ett√§ mies valehteli."
VAHVA LOGOS: "Mies sanoi tulleensa junalla. Mutta ei ollut m√§rk√§, vaikka satoi. Ja h√§nen kengiss√§√§n oli punaista savea - sit√§ l√∂ytyi vain aseman takana olevalta rakennusty√∂maalta. H√§n ei ollut tullut junalla."

TEHT√ÑV√Ñ:
1. Tunnista suorat selitykset/v√§itt√§m√§t
2. Muuta ne havaintosarjoiksi
3. Anna lukijan p√§√§tell√§ itse
4. Anna 3-5 logos-vahvistusta

VASTAA SUOMEKSI.`
      },
      {
        id: 'suspense_dopamine',
        name: 'Suspense & Dopamiini',
        description: 'Lupaa, viivyt√§, paljasta',
        prompt: `Luo SUSPENSE (dopamiinivirtaus):

TEKSTI:
\${getActiveItem()?.content || '[Ei sis√§lt√∂√§]'}

SUSPENSE: Lupaa palkinto ‚Üí Viivyt√§ sit√§ ‚Üí Paljasta (tai √§l√§).

3-VAIHE RAKENNE:
1. **LUPAUS**: "H√§n avasi kirjeen. Sis√§ll√§ oli jotain, joka muuttaisi kaiken."
2. **VIIVYTYS**: "Mutta ensin h√§n piti kaivaa muististaan..." [2-3 kappaletta muuta]
3. **PALJASTUS/SUBVERSION**: "H√§n luki. Kaksi sanaa. H√§n ei ollut varma naurettaisiinko vai itkisik√∂."

DOPAMIINI: Ennakointi ‚Üí Odotus ‚Üí Tyydytys. Venyt√§ "Odotus"-vaihetta.

TEHT√ÑV√Ñ:
1. Tunnista mahdolliset suspense-hetket
2. Lis√§√§ LUPAUS ennen paljastusta
3. Venyt√§ VIIVYTYS (mutta √§l√§ liikaa)
4. Anna 3-5 suspense-rakennetta

VASTAA SUOMEKSI.`
      },
      {
        id: 'contrast_power',
        name: 'Kontrastin voima',
        description: 'Vastakohtaisuus vahvistaa',
        prompt: `K√§yt√§ KONTRASTIN VOIMAA:

TEKSTI:
\${getActiveItem()?.content || '[Ei sis√§lt√∂√§]'}

KONTRASTIN VOIMA: Aseta vastakohdat vierekk√§in ‚Üí kumpikin vahvistuu.

KONTRASTI-TYYPIT:
1. **Valo/Varjo**: "Aurinko paistoi, mutta h√§nen sis√§ll√§√§n oli pimeys"
2. **Nopea/Hidas**: "Maailma kiiti ohi. H√§n seisoi paikallaan."
3. **Hiljainen/√Ñ√§nek√§s**: "Kaupunki karjui. H√§n kuiskasi."
4. **Suuri/Pieni**: "Vuoret kohoavat. H√§n oli pieni kuin hiekanjyv√§."
5. **El√§m√§/Kuolema**: "Vauva nauroi. Ruumis makasi hiljaa."

TEHT√ÑV√Ñ:
1. Tunnista koht at miss√§ kontrasti vahvistaisi
2. Aseta vastakohdat vierekk√§in (ei erilleen)
3. √Ñl√§ selit√§ kontrastia - anna sen toimia
4. Anna 3-5 kontrasti-ehdotusta

ESIMERKKI:
ENNEN: "H√§n oli onnellinen vaikka ymp√§rill√§ oli surkeutta"
J√ÑLKEEN: "Ruumiita kadulla. Tuhkaa ilmassa. H√§n hymyili ensimm√§ist√§ kertaa viikkoon."

VASTAA SUOMEKSI.`
      },
      {
        id: 'anchoring',
        name: 'Ankkurointi',
        description: 'Ensimm√§inen mielikuva hallitsee kaikkea',
        prompt: `K√§yt√§ ANKKUROINTIA:

TEKSTI:
\${getActiveItem()?.content || '[Ei sis√§lt√∂√§]'}

ANKKUROINTI: Ensimm√§inen kuvaus henkil√∂st√§/paikasta/asiasta m√§√§ritt√§√§ miten lukija tulkitsee kaiken my√∂hemm√§n.

TEKNIIKAT:
1. **Vahva ensivaikutelma**: Ensimm√§inen lause hahmon esittelyss√§ on KRIITTINEN
2. **Kontrastoitu my√∂hemmin**: Ankkuri vs. realiteetti = j√§nnite
3. **Moniaistillinen ankkuri**: K√§yt√§ useita aisteja ensikuvauksessa
4. **Emotionaalinen lataus**: Ankkuroi tunteeseen, ei vain ulkon√§k√∂√∂n

ESIMERKKI:
HEIKKO ANKKURI: "Mies astui sis√§√§n. H√§n oli pitk√§."
VAHVA ANKKURI: "Mies t√§ytti oviaukon. Ei vain kokonsa takia - jotain h√§nen katseessaan nielaisi valon, tilan, ilman. Huone pieneni."

TEHT√ÑV√Ñ:
1. Tunnista ensimm√§iset kuvaukset (hahmo, paikka, asia)
2. Vahvista ne - lis√§√§ aisteja, emotioita, vaikutusta
3. Jos ankkuri on olemassa, voitko kontrastoida sit√§ my√∂hemmin?
4. Anna 3-5 ankkurointiehdotusta

VASTAA SUOMEKSI.`
      }
    ]
  },

  advanced: {
    title: '‚ö° EDISTYNEET',
    color: 'red',
    techniques: [
      {
        id: 'meta_awareness',
        name: 'Meta-tason itsetietoisuus',
        description: 'Teksti tiet√§√§ olevansa teksti√§',
        prompt: `Lis√§√§ META-TASON ITSETIETOISUUS:

TEKSTI:
\${getActiveItem()?.content || '[Ei sis√§lt√∂√§]'}

META: Teksti tiet√§√§ olevansa teksti√§. Kertoja/hahmo kommentoi kirjoittamista/kerrontaa.

TEKNIIKAT:
1. **Kertojan itsereflektio**: "Miten t√§m√§n kertoisin? Sanat eiv√§t riit√§."
2. **Suora puhuttelu**: "Sin√§, lukija, tied√§t t√§m√§n tunteen."
3. **Kerronnan riko minen**: "T√§m√§ ei ole se hetki jolloin h√§n kuoli. Se tulee my√∂hemmin."
4. **Kirjoittajan h√§iv√§hdys**: "Jos olisin parempi kirjailija, osaisin kuvata..."

VAROITUS: K√§yt√§ s√§√§steli√§√§sti. Liika meta rikkoo immersion.

ESIMERKKI:
"H√§n avasi oven. (Eik√∂ t√§m√§ aina tapahdu n√§in? Ovi avautuu, ja kaikki muuttuu. Mutta me jatkamme lukemista, koska haluamme tiet√§√§ mit√§ oven takana on.) Sis√§ll√§ oli..."

ANNA:
- 2-3 meta-hetke√§ (MAX)
- Varmista ett√§ ne palvelevat tarinaa
- √Ñl√§ ylik√§yt√§

VASTAA SUOMEKSI.`
      },
      {
        id: 'layering',
        name: 'Kerroksellisuus',
        description: 'Tarina tarinan sis√§ll√§',
        prompt: `Luo KERROKSELLISUUS:

TEKSTI:
\${getActiveItem()?.content || '[Ei sis√§lt√∂√§]'}

KERROKSELLISUUS: Useita kerrontatasoja jotka peilaavat toisiaan.

TASOT:
1. **P√§√§kertomus**: Nykyhetki
2. **Sisempi kertomus**: Muisto/flashback/tarina-tarinan-sis√§ll√§
3. **Symbolinen kerros**: Metaforat/kuvat jotka peilaavat p√§√§kertomusta

TEKNIIKAT:
- **Frame narrative**: "H√§n kertoi tarinan..." ‚Üí sisempi tarina
- **Rinnakkaisuus**: Kaksi tarinaa samanaikaisesti, toinen peilaa toista
- **Metafora-kerros**: Luontokuvaus peilaa hahmon sis√§ist√§ tilaa

ESIMERKKI:
Kerros 1: "H√§n istui kahvilassa, yksin."
Kerros 2: [Muisto √§idist√§, my√∂s kahvilassa, my√∂s yksin]
Kerros 3: "Ikkunassa sadeet iski lasin, yksin√§iset pisarat."

TEHT√ÑV√Ñ:
1. Tunnista mahdolliset kerrokset
2. Ehdota sisempi tarina/muisto joka peilaa p√§√§kertomusta
3. Lis√§√§ symbolinen kerros (luonto/s√§ƒÉ/objekti)
4. Varmista ett√§ kerrokset keskustelevat kesken√§√§n

VASTAA SUOMEKSI.`
      },
      {
        id: 'unreliable_narrator',
        name: 'Ep√§luotettava kertoja',
        description: 'Lukija ep√§ilee jokaista sanaa',
        prompt: `Luo EP√ÑLUOTETTAVA KERTOJA:

TEKSTI:
\${getActiveItem()?.content || '[Ei sis√§lt√∂√§]'}

EP√ÑLUOTETTAVA KERTOJA: Anna vihjeit√§ ett√§ kertoja/hahmo ei kerro totuutta (itselle tai lukijalle).

TEKNIIKAT:
1. **Ristiriidat**: Sanoo X, mutta toimii Y
2. **Liioittelu**: "Kaikki vihasivat h√§nt√§" (todella?)
3. **Valikoiva muisti**: "En muista mit√§ tapahtui seuraavaksi"
4. **Defensiivisyys**: "Se ei ollut minun vikani" (toistuvasti)
5. **Faktojen muutos**: Ensiksi sanoo A, my√∂hemmin B

ESIMERKKI:
"H√§n ei ikin√§ huutanut minulle. Totta, h√§n korotti √§√§nt√§√§n joskus, mutta se oli stressi√§, ty√∂t√§, ei minua. H√§n rakasti minua. Sen tied√§n. Vaikka h√§n sanoi... Ei, h√§n ei sanonut sit√§. En muista oikein. Satoi kovasti sin√§ p√§iv√§n√§."

TEHT√ÑV√Ñ:
1. Lis√§√§ 2-3 ristiriitaa (sanat vs. teot)
2. Anna kertoja puolustautumaan liikaa
3. K√§yt√§ "ehk√§", "luultavasti", "en muista"
4. √ÑL√Ñ PALJASTA suoraan - anna lukijan ep√§ill√§

VASTAA SUOMEKSI.`
      },
      {
        id: 'silence_power',
        name: 'Hiljaisuuden voima',
        description: 'Sanomattomat sanat painavat eniten',
        prompt: `K√§yt√§ HILJAISUUDEN VOIMAA:

TEKSTI:
\${getActiveItem()?.content || '[Ei sis√§lt√∂√§]'}

HILJAISUUDEN VOIMA: Sanomatta j√§tt√§minen on voimakkaampi kuin sanominen.

TEKNIIKAT:
1. **Keskeytetty lause**: "H√§n halusi sanoa ett√§ ‚Äî"
2. **Hiljaisuus vastauksena**: "Rakastatko minua?' Hiljaisuus."
3. **Sanomaton ymm√§rrys**: "He katsoivat toisiaan. He tiesiv√§t."
4. **Tyhj√§ tila dialogissa**: [ei teksti√§, vain v√§lily√∂nti]

ESIMERKKI:
ENNEN: "H√§n sanoi ett√§ rakasti h√§nt√§ mutta ei ollut varma."
J√ÑLKEEN: "'Rakastan sinua', h√§n sanoi. Hiljaisuus ven√§hti. H√§n toisti: 'Rakastan.' H√§n ei sanonut en√§√§ mit√§√§n."

TEHT√ÑV√Ñ:
1. Tunnista kohdat miss√§ liikaa sanotaan
2. Poista sanoja, lis√§√§ hiljaisuutta
3. K√§yt√§ keskeytetty√§ puhetta
4. Anna 3-5 hiljaisuusehdotusta

MUISTA: Hiljaisuus on aktiivinen, ei passiivinen. Se PAISTAA.

VASTAA SUOMEKSI.`
      }
    ]
  },

  // Vaihe 6: LocationKeeper-tekniikat
  locationAnalysis: {
    title: 'üìç PAIKKOJEN ANALYYSI',
    color: 'green',
    techniques: [
      {
        id: 'detect_locations',
        name: 'Tunnista paikat',
        description: 'Etsi kaikki paikat tekstist√§ automaattisesti',
        prompt: `Tunnista KAIKKI paikat t√§st√§ tekstist√§. Sis√§llyt√§ kaupungit, rakennukset, kadut, luontokohteet, maamerkit.

TEKSTI:
${getActiveItem()?.content || '[Ei sis√§lt√∂√§]'}

Palauta VAIN JSON (ei mit√§√§n muuta teksti√§):
{
  "locations": [
    {
      "name": "paikan nimi",
      "type": "city/building/landmark/public_square/street/nature/interior",
      "city": "kaupunki jos mainittu",
      "country": "maa jos mainittu",
      "context": "lause jossa paikka mainitaan"
    }
  ]
}

Jos ei paikkoja, palauta: {"locations": []}

VASTAA PELKK√Ñ JSON.`
      },
      {
        id: 'analyze_place',
        name: 'Analysoi paikka',
        description: 'Syv√§luotaava analyysi tietyn paikan tunnelmasta',
        prompt: `Analysoi t√§m√§ paikka kirjailijaa varten:

PAIKKA: {selectedLocation}

FAKTAT:
${JSON.stringify(getSelectedLocation()?.facts || {}, null, 2)}

VISUAALISET ELEMENTIT:
${JSON.stringify(getSelectedLocation()?.visual || {}, null, 2)}

KIRJAN GENRE:
${GENRE_OPTIONS.find(g => g.id === project.genre)?.name || 'Psykologinen trilleri'}

Palauta JSON:
{
  "analysis": {
    "atmosphere": "paikan tunnelma",
    "sensory_details": ["aistilliset yksityiskohdat"],
    "genre_fit": "miten sopii genreen",
    "writing_opportunities": ["kirjoitusmahdollisuudet"]
  }
}

VASTAA SUOMEKSI, JSON-MUODOSSA.`
      },
      {
        id: 'generate_description',
        name: 'Generoi kuvaus',
        description: 'Luo genrespesifi kuvaus paikasta',
        prompt: `Olet LocationKeeper - paikkojen kuvausasiantuntija.

PAIKKA:
{selectedLocation}

FAKTAT:
${JSON.stringify(getSelectedLocation()?.facts || {}, null, 2)}

VISUAALISET ELEMENTIT:
${JSON.stringify(getSelectedLocation()?.visual || {}, null, 2)}

KIRJAN GENRE:
${GENRE_OPTIONS.find(g => g.id === project.genre)?.name || 'Psykologinen trilleri'}

TEHT√ÑV√Ñ:
Kirjoita 2-4 kappaletta paikka-kuvausta joka:

1. **Faktatarkka**: K√§yt√§ todellisia yksityiskohtia paikasta
2. **Aistillinen**: Aktivoi n√§k√∂, kuulo, haju, tunto (ja maku jos relevantti)
3. **Genrespesifi**: Sovita tunnelma genreen (${project.genre})
4. **Tyylillinen**: K√§yt√§ defamiliarisaatiota, rytmi√§, konkretiaa
5. **Emotionaalinen**: Luo tunnelma joka tukee kohtausta

GENRE-OHJEET:
${getGenreGuidance(project.genre)}

√ÑL√Ñ:
- Listaa faktoja ("Paikalla on X ja Y")
- Kerro tunnelmaa suoraan ("Paikka oli ahdistava")
- K√§yt√§ kliseit√§
- Ylihypettele

KIRJOITA NIIN ETT√Ñ SE SOPII SUORAAN ROMAANIIN.
VASTAA SUOMEKSI.`
      }
    ]
  },

  // Vaihe 5: CharacterKeeper-tekniikat
  characterContinuity: {
    title: 'üë• HAHMOJEN JATKUVUUS',
    color: 'pink',
    techniques: [
      {
        id: 'check_all',
        name: 'Tarkista kaikki hahmot',
        description: 'Analysoi kaikkien hahmojen jatkuvuus t√§ss√§ kohtauksessa',
        prompt: `Olet CharacterKeeper - hahmojen jatkuvuuden valvoja.

TEHT√ÑV√Ñ: Tarkista KAIKKI hahmot t√§ss√§ kohtauksessa seuraavien kriteerien mukaan:

HAHMOT:
{characterList}

TARKISTETTAVAT ASIAT:
1. **Toimintalogiikka**: Ovatko hahmojen teot uskottavia heid√§n tavoitteidensa/pelkojensa/heikkouksiensa valossa?
2. **√Ñ√§ni**: Puhuuko hahmo tyylilleen uskollisesti? (lausepituus, sanavalinnat)
3. **Psykologinen jatkuvuus**: Muuttuuko hahmon k√§yt√∂s liian √§killisesti ilman triggeri√§?
4. **Faktat**: Ovatko fyysiset yksityiskohdat (ulkon√§k√∂, ik√§, loukkaantumiset) johdonmukaisia?
5. **Resurssit**: K√§ytt√§√§k√∂ hahmo esineit√§/taitoja, joita h√§nell√§ ei ole?
6. **Suhteet**: Ovatko hahmojen v√§liset vuorovaikutukset uskottavia?

TEKSTI:
${getActiveItem()?.content || '[Ei sis√§lt√∂√§]'}

VASTAA T√ÑSS√Ñ MUODOSSA:

## üü¢ TOIMIVAT HAHMOT
[Listaa hahmot joiden jatkuvuus on kunnossa]

## üü° HUOMIOITAVAA
[Pienet ep√§johdonmukaisuudet - ehdota korjaus]

## üî¥ KRIITTISET ONGELMAT
[Isot ristiriidat - vaativat korjauksia]

## üí° EHDOTUKSET
[Konkreettiset parannukset - lis√§√§ trigger, muuta dialogi, korjaa fakta]

VASTAA SUOMEKSI.`
      },
      {
        id: 'check_voice',
        name: 'Tarkista √§√§ni',
        description: 'Varmista ett√§ hahmo puhuu/ajattelee tyylilleen uskollisesti',
        prompt: `Tarkista √Ñ√ÑNIJATKUVUUS t√§lle hahmolle:

HAHMO:
{selectedCharacter}

HAHMON √Ñ√ÑNEN TUNNUSPIIRTEET:
- Puhetyyli: {voiceDescription}
- Tyypilliset fraasit: {lexicon}
- Lausepituus: noin {avgSentenceLength} sanaa

TEKSTI:
${getActiveItem()?.content || '[Ei sis√§lt√∂√§]'}

TARKISTA:
1. Onko dialogin tyyli johdonmukainen?
2. K√§ytt√§√§k√∂ hahmo tyypillisi√§ fraasejaan?
3. Onko lausepituus keskim√§√§rin oikea?
4. Onko sanavalinnat hahmolle uskollisia?

ANNA:
- Arvosana 1-10
- Kohdat jotka eiv√§t kuulosta hahmolta
- Korjausehdotukset (konkreettiset diff-muutokset)

VASTAA SUOMEKSI.`
      },
      {
        id: 'check_psychology',
        name: 'Tarkista psykologia',
        description: 'Analysoi hahmon p√§√§t√∂sten ja tunteiden johdonmukaisuus',
        prompt: `Analysoi PSYKOLOGINEN JATKUVUUS:

HAHMO:
{selectedCharacter}

PSYKOLOGINEN PROFIILI:
- Tavoite: {want}
- Pelko: {fear}
- Heikkous: {weakness}
- Arvot: {values}

TEKSTI:
${getActiveItem()?.content || '[Ei sis√§lt√∂√§]'}

TARKISTA:
1. **P√§√§t√∂kset**: Ovatko hahmon valinnat johdonmukaisia tavoitteidensa kanssa?
2. **Reaktiot**: Ovatko tunnereaktion uskottavia?
3. **Tunne-hypyt**: Tapahtuuko liian suuria tunnemuutoksia ilman triggeri√§?
4. **Arvo-ristiriidat**: Toimiiko hahmo arvojensa vastaisesti ilman hyv√§√§ syyt√§?

JOS L√ñYD√ÑT ONGELMIA:
- Ehdota "mikrotriggeri" (pieni tapahtuma/muisto/bodysensaatio) joka perustelee muutoksen
- Tai suosittele teon/p√§√§t√∂ksen muuttamista

VASTAA SUOMEKSI.`
      },
      {
        id: 'check_resources',
        name: 'Tarkista resurssit',
        description: 'Varmista ett√§ esineet/taidot/loukkaantumiset ovat johdonmukaisia',
        prompt: `Tarkista RESURSSIT JA FYYSISET FAKTAT:

HAHMO:
{selectedCharacter}

RESURSSIT/TAIDOT: {resources}
LOUKKAANTUMISET: {injuries}
ULKON√ÑK√ñ: {appearance}

TEKSTI:
${getActiveItem()?.content || '[Ei sis√§lt√∂√§]'}

TARKISTA:
1. K√§ytt√§√§k√∂ hahmo esineit√§ joita h√§nell√§ ei ole?
2. Sovelletaanko taitoja jotka h√§nelt√§ puuttuvat?
3. Onko loukkaantumisia mainittu/huomioitu?
4. Muuttuuko ulkon√§k√∂ ilman selityst√§?
5. Ilmestyyk√∂/h√§vi√§√§k√∂ esineit√§?

JOS L√ñYD√ÑT VIRHEIT√Ñ:
- Lis√§√§ esine aiempaan kohtaukseen TAI
- Poista viittaus esineeseen TAI
- Lis√§√§ lause joka selitt√§√§ muutoksen

VASTAA SUOMEKSI konkretilla korjausehdotuksilla.`
      },
      {
        id: 'suggest_arc',
        name: 'Ehdota kehityst√§',
        description: 'Anna ideoita hahmon psykologiseen kasvuun',
        prompt: `Ehdota HAHMOKAAREN KEHITYST√Ñ:

HAHMO:
{selectedCharacter}

NYKYINEN TILA:
- Tavoite: {want}
- Pelko: {fear}
- Uskomukset: {beliefs}

KOHTAUKSEN SIS√ÑLT√ñ:
${getActiveItem()?.content || '[Ei sis√§lt√∂√§]'}

TEHT√ÑV√Ñ:
1. Tunnista 1-3 mahdollisuutta hahmon KASVUUN/MUUTOKSEEN t√§ss√§ kohtauksessa
2. Ehdota triggeri joka voisi k√§ynnist√§√§ muutoksen (paljastus, pettymys, voitto)
3. Kuvaa miten uskomus/arvo voisi muuttua
4. Pid√§ muutos realistisena (pieni√§ askeleita, ei √§kkin√§isi√§ t√§ysk√§√§nn√∂ksi√§)

ESIMERKKI:
"Jos hahmo kohtaa t√§ss√§ kohtauksessa yst√§v√§n pett√§myksen, se voisi alkaa rapauttaa h√§nen uskoaan luottamukseen. Lis√§√§ pieni hetki jossa h√§n HUOMAA ep√§r√∂iv√§ns√§ (bodysensaatio: k√§det kiristyv√§t nyrkkiin) ennen kuin vastaa yst√§v√§n kysymykseen."

ANNA 2-3 KONKREETTISTA KAARI-IDEAA. VASTAA SUOMEKSI.`
      },
      {
        id: 'create_trigger',
        name: 'Luo trigger-hetki',
        description: 'Luo uskottava syy isommalle muutokselle',
        prompt: `Luo TRIGGER-HETKI hahmon muutokselle:

HAHMO:
{selectedCharacter}

HALUTTU MUUTOS:
[K√§ytt√§j√§: Kerro mit√§ muutosta haluat - esim. "hahmo menett√§√§ luottamuksen mentoriinsa"]

KOHTAUS:
${getActiveItem()?.content || '[Ei sis√§lt√∂√§]'}

TEHT√ÑV√Ñ:
Luo USKOTTAVA TRIGGER joka perustelee muutoksen. Triggerin tulee:
1. Olla emotionaalisesti voimakas (shokki, paljastus, pettymys, voitto)
2. Yhdisty√§ hahmon pelkoihin/arvoihin
3. Olla konkreettinen ja koettavissa (n√§hd√§√§n/kuullaan/tunnetaan)
4. Johtaa luonnollisesti muutokseen

ANNA:
- 2-4 kappaleen triggeri-kohtaus (suoraan tekstiin lis√§tt√§v√§)
- Hahmon sis√§inen reaktio (ajatukset/tunteet)
- Lyhyt selitys miten t√§m√§ johtaa muutokseen

KIRJOITA KAUNIISTI, KUIN OSA ROMAANIA. VASTAA SUOMEKSI.`
      }
    ]
  }
};

// ========== NORMAN-KRUG-NATSUME: UI/UX Components ==========

// NORMAN: AI Feedback Component - Shows what AI did with progressive disclosure
const AIFeedback = ({ action, details, type = 'info', onDismiss }) => {
  if (!action) return null;
  
  const icons = {
    info: '‚ú®',
    success: '‚úÖ',
    learning: 'üß†',
    rhythm: 'üéµ'
  };
  
  return e('div', { 
    className: 'fixed top-4 right-4 z-50 animate-slideIn'
  },
    e('div', { 
      className: 'bg-[var(--mac-bg-tertiary)] backdrop-blur-xl rounded-lg px-4 py-3 shadow-xl border border-[rgba(255,255,255,0.1)] max-w-sm'
    },
      e('div', { className: 'flex items-start gap-3' },
        // Icon
        e('div', { 
          className: 'w-6 h-6 rounded-full bg-[var(--mac-accent-blue)] flex items-center justify-center text-xs flex-shrink-0'
        }, icons[type]),
        
        // Content
        e('div', { className: 'flex-1 min-w-0' },
          e('div', { 
            className: 'text-sm font-medium',
            style: { color: 'var(--mac-text-primary)' }
          }, action),
          details && e('div', { 
            className: 'text-xs mt-1',
            style: { color: 'var(--mac-text-secondary)' }
          }, details)
        ),
        
        // Dismiss button
        onDismiss && e('button', {
          onClick: onDismiss,
          className: 'text-xs opacity-50 hover:opacity-100 transition-opacity'
        }, '√ó')
      )
    )
  );
};

// NORMAN: Contextual AI Bubble - Appears on cursor pause
const AIContextualBubble = ({ isVisible, suggestion, onApply, onDismiss, position }) => {
  if (!isVisible || !suggestion) return null;
  
  return e('div', { 
    className: 'absolute z-50 animate-breatheIn',
    style: {
      top: position?.top || '50%',
      left: position?.left || '50%',
      transform: 'translate(-50%, -100%)',
      marginTop: '-8px'
    }
  },
    e('div', { className: 'relative' },
      // Arrow
      e('div', { 
        className: 'absolute -bottom-1 left-4 w-2 h-2 bg-[var(--mac-bg-tertiary)] rotate-45 border-r border-b border-[rgba(255,255,255,0.1)]'
      }),
      
      // Bubble content
      e('div', { 
        className: 'bg-[var(--mac-bg-tertiary)] rounded-lg p-3 shadow-lg border border-[rgba(255,255,255,0.1)] min-w-[280px]'
      },
        // Suggestion text
        e('div', { 
          className: 'text-xs mb-2',
          style: { color: 'var(--mac-text-secondary)' }
        }, suggestion.reason || 'AI-ehdotus'),
        
        // Actions - KRUG: Simple choice, not forced
        e('div', { className: 'flex gap-2' },
          e('button', {
            onClick: onApply,
            className: 'px-3 py-1 rounded bg-[var(--mac-accent-blue)] text-white text-xs font-medium hover:opacity-90 transition-all'
          }, '‚ú® Sovella'),
          e('button', {
            onClick: onDismiss,
            className: 'px-3 py-1 rounded text-xs hover:bg-[rgba(255,255,255,0.08)] transition-all',
            style: { color: 'var(--mac-text-secondary)' }
          }, 'Ei kiitos')
        )
      )
    )
  );
};

// NATSUME: Inspiration Panel - Appears when stuck
const InspirationPanel = ({ isVisible, inspiration, onDismiss }) => {
  if (!isVisible || !inspiration) return null;
  
  return e('div', { 
    className: 'fixed bottom-4 left-4 z-50 animate-slideIn'
  },
    e('div', { 
      className: 'bg-[var(--mac-bg-tertiary)] backdrop-blur-xl rounded-lg p-4 shadow-xl border border-[rgba(255,255,255,0.1)] max-w-xs'
    },
      // Header
      e('div', { className: 'flex items-center gap-2 mb-3' },
        e('span', { className: 'text-xl' }, 'üí°'),
        e('div', { 
          className: 'text-sm font-medium',
          style: { color: 'var(--mac-text-primary)' }
        }, 'Inspiraatio')
      ),
      
      // Content
      inspiration.type === 'quote' && e('blockquote', { 
        className: 'text-sm italic border-l-2 border-[var(--mac-accent-purple)] pl-3',
        style: { color: 'var(--mac-text-secondary)' }
      },
        `"${inspiration.text}"`,
        inspiration.author && e('cite', { 
          className: 'block text-xs mt-2 not-italic opacity-50'
        }, `‚Äî ${inspiration.author}`)
      ),
      
      inspiration.type === 'rhythm' && e('div', null,
        e('div', { 
          className: 'text-xs mb-2',
          style: { color: 'var(--mac-text-secondary)' }
        }, 'Kokeile t√§t√§ rytmi√§:'),
        e('div', { 
          className: 'font-mono text-xs bg-black/20 rounded p-2',
          style: { color: 'var(--mac-text-primary)' }
        }, inspiration.pattern)
      ),
      
      // Dismiss
      e('button', {
        onClick: onDismiss,
        className: 'mt-3 text-xs opacity-50 hover:opacity-100 transition-opacity'
      }, 'Kiitos üëç')
    )
  );
};

// NATSUME: Flow Mode Indicator - Shows current mode subtly
const FlowModeIndicator = ({ mode }) => {
  if (mode === 'normal') return null;
  
  const labels = {
    focus: 'üéØ Fokus',
    rhythm: 'üéµ Rytmi',
    review: 'üîç Tarkistus'
  };
  
  return e('div', { 
    className: 'fixed bottom-4 right-4 text-xs opacity-20 pointer-events-none z-10',
    style: { color: 'var(--mac-text-primary)' }
  }, labels[mode] || '');
};

// NORMAN: Learning Feedback - Shows AI learned from rejection
const LearningFeedback = ({ message, isVisible, onDismiss }) => {
  if (!isVisible) return null;
  
  return e('div', { 
    className: 'fixed top-20 right-4 z-50 animate-slideIn'
  },
    e('div', { 
      className: 'bg-[var(--mac-bg-tertiary)] backdrop-blur-xl rounded-lg px-4 py-3 shadow-xl border border-[rgba(255,255,255,0.1)] max-w-sm'
    },
      e('div', { className: 'flex items-start gap-3' },
        e('div', { 
          className: 'w-6 h-6 rounded-full bg-[var(--mac-accent-purple)] flex items-center justify-center text-xs'
        }, 'üß†'),
        e('div', { 
          className: 'text-xs',
          style: { color: 'var(--mac-text-secondary)' }
        }, message),
        e('button', {
          onClick: onDismiss,
          className: 'text-xs opacity-50 hover:opacity-100 transition-opacity ml-2'
        }, '√ó')
      )
    )
  );
};

// KRUG: Simple Status Bar - Always visible, minimal
const SimpleStatusBar = ({ wordCount, saveStatus }) => {
  const statusIcons = {
    saved: '‚úì',
    saving: '‚è≥',
    error: '‚ö†Ô∏è'
  };
  
  const statusText = {
    saved: 'Tallennettu',
    saving: 'Tallennetaan...',
    error: 'Virhe tallennuksessa'
  };
  
  return e('div', { 
    className: 'h-8 bg-[var(--mac-bg-secondary)] border-t border-[rgba(255,255,255,0.05)] flex items-center justify-between px-4 text-xs',
    style: { color: 'var(--mac-text-secondary)' }
  },
    e('div', null, `${wordCount || 0} sanaa`),
    e('div', { className: 'flex items-center gap-1' },
      e('span', null, statusIcons[saveStatus]),
      e('span', null, statusText[saveStatus])
    )
  );
};

// NORMAN: Writer-Centric Sidebar Section
const WriterSidebarSection = ({ title, icon, children, defaultExpanded = true }) => {
  const [isExpanded, setIsExpanded] = useState(defaultExpanded);
  
  return e('div', { className: 'mb-4' },
    // Section header - clickable to expand/collapse
    e('button', {
      className: 'w-full px-3 py-2 flex items-center justify-between hover:bg-[rgba(255,255,255,0.05)] transition-colors rounded',
      onClick: () => setIsExpanded(!isExpanded)
    },
      e('div', { 
        className: 'text-[11px] font-semibold uppercase tracking-wide flex items-center gap-2',
        style: { color: 'var(--mac-text-tertiary)' }
      },
        e('span', null, icon),
        e('span', null, title)
      ),
      e('span', { 
        className: 'text-xs',
        style: { color: 'var(--mac-text-tertiary)' }
      }, isExpanded ? '‚ñº' : '‚ñ∂')
    ),
    
    // Content - collapsible
    isExpanded && e('div', { className: 'px-2 mt-1' }, children)
  );
};

// KRUG: Visual Hierarchy - Primary/Secondary/Tertiary Buttons
const PrimaryButton = ({ children, onClick, className = '', title }) => {
  return e('button', {
    className: `px-4 py-2 rounded-lg font-semibold transition-all ${className}`,
    style: {
      background: 'var(--mac-accent-blue)',
      color: '#ffffff'
    },
    onClick,
    title
  }, children);
};

const SecondaryButton = ({ children, onClick, className = '', title }) => {
  return e('button', {
    className: `px-3 py-1.5 rounded transition-all hover:bg-[rgba(255,255,255,0.08)] ${className}`,
    style: {
      background: 'rgba(255,255,255,0.05)',
      color: 'var(--mac-text-primary)'
    },
    onClick,
    title
  }, children);
};

const TertiaryButton = ({ children, onClick, className = '', title }) => {
  return e('button', {
    className: `px-2 py-1 text-sm rounded transition-opacity hover:opacity-100 opacity-70 ${className}`,
    style: {
      color: 'var(--mac-text-secondary)'
    },
    onClick,
    title
  }, children);
};

// ========== VISUAL MASTERS: UI Components ==========

// IDEO: Cognitive Load Indicator
const CognitiveLoadIndicator = ({ load }) => {
  if (load < 30) return null; // Only show when load is noticeable
  
  const getLoadColor = () => {
    if (load < 50) return '#30d158'; // Green - OK
    if (load < 75) return '#ff9f0a'; // Orange - Moderate
    return '#ff453a'; // Red - High
  };
  
  const getLoadLabel = () => {
    if (load < 50) return 'Kevyt kuorma';
    if (load < 75) return 'Keskitaso';
    return 'Korkea kuorma';
  };
  
  return e('div', {
    className: 'fixed bottom-20 right-4 z-20',
    style: { opacity: 0.6 }
  },
    e('div', {
      className: 'bg-black/50 backdrop-blur-xl rounded-lg px-3 py-2 flex items-center gap-2 text-xs'
    },
      // Load bar
      e('div', {
        className: 'w-16 h-1.5 bg-gray-700 rounded-full overflow-hidden'
      },
        e('div', {
          className: 'h-full transition-all duration-1000',
          style: {
            width: `${load}%`,
            background: getLoadColor()
          }
        })
      ),
      // Label
      e('span', {
        style: { color: getLoadColor() }
      }, getLoadLabel())
    )
  );
};

// SUPERSIDE: Work Phase Indicator
const WorkPhaseIndicator = ({ phase }) => {
  const phaseConfig = {
    drafting: { icon: 'üöÄ', label: 'Luonnostelu', color: '#ff9f0a' },
    writing: { icon: '‚úçÔ∏è', label: 'Kirjoitus', color: '#0a84ff' },
    editing: { icon: '‚úÇÔ∏è', label: 'Muokkaus', color: '#bf5af2' },
    reviewing: { icon: 'üîç', label: 'Tarkistus', color: '#30d158' }
  };
  
  const config = phaseConfig[phase] || phaseConfig.writing;
  
  return e('div', {
    className: 'fixed top-20 right-4 z-20',
    style: { opacity: 0.4 }
  },
    e('div', {
      className: 'bg-black/50 backdrop-blur-xl rounded-lg px-3 py-2 flex items-center gap-2 text-xs transition-all duration-1000'
    },
      e('span', { className: 'text-lg' }, config.icon),
      e('span', { style: { color: config.color } }, config.label)
    )
  );
};

// IDEO: Transparent AI Indicator
const TransparentAIIndicator = ({ active, thinking, suggestionCount }) => {
  return e('div', {
    className: 'fixed bottom-4 right-4 z-20'
  },
    e('div', {
      className: 'bg-black/50 backdrop-blur-xl rounded-full px-4 py-2 flex items-center gap-3'
    },
      // Status dot
      e('div', {
        className: `w-2 h-2 rounded-full transition-all ${thinking ? 'animate-pulse' : ''}`,
        style: {
          background: thinking ? '#0a84ff' : active ? '#30d158' : '#6b6b6b'
        }
      }),
      
      // Status text
      e('span', {
        className: 'text-xs',
        style: { color: 'var(--mac-text-secondary)' }
      }, thinking ? 'Analysoin...' : active ? 'Valmis' : 'Lepotila'),
      
      // Suggestion count badge
      suggestionCount > 0 && e('span', {
        className: 'bg-blue-500 text-white text-xs px-2 py-0.5 rounded-full'
      }, suggestionCount)
    )
  );
};

// ========== NORMAN-KRUG-NATSUME: Utility Functions ==========

// NATSUME: Analyze emotional tone of text
const analyzeEmotionalTone = (text) => {
  if (!text || text.length < 50) return 'neutral';
  
  const calmWords = ['rauhallinen', 'hiljainen', 'pehme√§', 'hiljaa', 'tyyni', 'rauha', 'lempe√§', 'hidas', 'kevyt'];
  const tenseWords = ['kiireinen', 'j√§nnitt√§v√§', 'nopea', '√§killinen', 'kiihke√§', 'r√§j√§ht√§v√§', 'intensiivinen', 'voimakas'];
  
  const lowerText = text.toLowerCase();
  const calmCount = calmWords.filter(word => lowerText.includes(word)).length;
  const tenseCount = tenseWords.filter(word => lowerText.includes(word)).length;
  
  // Check sentence structure too
  const sentences = text.split(/[.!?]+/).filter(s => s.trim());
  const avgSentenceLength = sentences.reduce((sum, s) => sum + s.split(' ').length, 0) / sentences.length;
  
  if (calmCount > tenseCount && avgSentenceLength > 15) return 'calm';
  if (tenseCount > calmCount || avgSentenceLength < 10) return 'tense';
  return 'neutral';
};

// NATSUME: Generate inspiration based on context
const generateInspiration = (context, genre) => {
  const inspirations = {
    psychological_thriller: [
      { type: 'quote', text: 'Hiljaisuus on √§√§ni, joka kuuluu vain sis√§lt√§.', author: 'Tietoinen kirjoittaja' },
      { type: 'quote', text: 'Pelko ei ole heikkoutta, vaan keino s√§ilytt√§√§ valppaana.', author: 'Psykologinen' },
      { type: 'rhythm', pattern: 'Lyhyt. Lyhyt. Pitk√§ ja virtaava lause joka antaa heng√§hdystauon.' }
    ],
    romantic_drama: [
      { type: 'quote', text: 'Rakkaus ei ole se mit√§ sanomme, vaan se mit√§ j√§t√§mme sanomatta.', author: 'Romanttinen' },
      { type: 'rhythm', pattern: 'Pehme√§ aalto. Lempe√§ liike. Ja lopulta hiljaisuus joka puhuu.' }
    ],
    mystery: [
      { type: 'quote', text: 'Jokainen kysymys paljastaa enemm√§n kuin vastaus.', author: 'Mysteerio' },
      { type: 'rhythm', pattern: 'Mik√§? Miksi? Miten se tapahtui?' }
    ]
  };
  
  const genreInspirations = inspirations[genre] || inspirations.psychological_thriller;
  return genreInspirations[Math.floor(Math.random() * genreInspirations.length)];
};

// KRUG: Terminology mapping - Technical to Writer's language
const WRITER_TERMINOLOGY = {
  'save': 'Tallenna',
  'export': 'Vie',
  'import': 'Tuo',
  'settings': 'Asetukset',
  'preferences': 'Omat valinnat',
  'sync': 'Synkronoi',
  'backup': 'Varmuuskopio',
  'restore': 'Palauta',
  'delete': 'Poista',
  'duplicate': 'Monista',
  'rename': 'Nime√§ uudelleen',
  'move': 'Siirr√§',
  'edit': 'Muokkaa',
  'view': 'N√§yt√§',
  'hide': 'Piilota',
  'show': 'N√§yt√§',
  'close': 'Sulje',
  'open': 'Avaa'
};

// ========== VISUAL MASTERS: Design System ==========

// PENTAGRAM/BIERUT: Typographic Scale (Golden Ratio 1.618)
const TYPOGRAPHIC_SCALE = {
  xxxl: '44px',   // 44 / 1.618 ‚âà 27
  xxl: '27px',    // 27 / 1.618 ‚âà 17
  xl: '22px',     // Headline
  lg: '17px',     // Body (base)
  md: '15px',     // Subheadline
  sm: '13px',     // Caption
  xs: '11px'      // Footnote
};

// PENTAGRAM/BIERUT: Spacing Scale (8px base)
const SPACING_SCALE = {
  xxxxl: '96px',  // 12 * 8
  xxxl: '72px',   // 9 * 8
  xxl: '48px',    // 6 * 8
  xl: '32px',     // 4 * 8
  lg: '24px',     // 3 * 8
  md: '16px',     // 2 * 8
  sm: '12px',     // 1.5 * 8
  xs: '8px',      // 1 * 8
  xxs: '4px'      // 0.5 * 8
};

// SUPERSIDE: Comprehensive Design Tokens
const DESIGN_TOKENS = {
  // Typography
  fontFamily: {
    primary: '-apple-system, BlinkMacSystemFont, "SF Pro Display", system-ui, sans-serif',
    mono: '"SF Mono", Monaco, Menlo, monospace'
  },
  
  fontSize: TYPOGRAPHIC_SCALE,
  
  fontWeight: {
    light: 300,
    regular: 400,
    medium: 500,
    semibold: 600,
    bold: 700
  },
  
  lineHeight: {
    tight: 1.2,
    snug: 1.3,
    normal: 1.4,
    relaxed: 1.6,
    loose: 1.8
  },
  
  letterSpacing: {
    tight: '-0.02em',
    snug: '-0.01em',
    normal: '0',
    wide: '0.01em',
    wider: '0.02em'
  },
  
  // Spacing
  spacing: SPACING_SCALE,
  
  // Transitions (MOK: Timeless durations)
  transition: {
    instant: '100ms',
    fast: '150ms',
    normal: '300ms',
    slow: '500ms',
    verySlow: '1000ms',
    superSlow: '1500ms'
  },
  
  // Easing (Natural, organic)
  easing: {
    linear: 'linear',
    easeIn: 'cubic-bezier(0.4, 0, 1, 1)',
    easeOut: 'cubic-bezier(0, 0, 0.2, 1)',
    easeInOut: 'cubic-bezier(0.4, 0, 0.2, 1)',
    natural: 'cubic-bezier(0.4, 0.0, 0.2, 1)' // Sagmeister: organic
  }
};

// SAGMEISTER: Emotional color palettes
const EMOTIONAL_COLOR_ARCS = {
  positive: {
    primary: '#ff9f9f',  // Warm pink
    background: 'linear-gradient(180deg, #2a1a1f 0%, #1f0f14 100%)',
    accent: '#ffb3b3'
  },
  negative: {
    primary: '#7c9ef2',  // Cool blue
    background: 'linear-gradient(180deg, #1a1a2a 0%, #0f0f1f 100%)',
    accent: '#92aef7'
  },
  neutral: {
    primary: '#0a84ff',  // Standard blue
    background: 'linear-gradient(180deg, #1e1e1e 0%, #0f0f0f 100%)',
    accent: '#0a84ff'
  },
  intense: {
    primary: '#bf5af2',  // Purple
    background: 'linear-gradient(180deg, #1f1a2a 0%, #14101f 100%)',
    accent: '#d470ff'
  },
  calm: {
    primary: '#30d158',  // Green
    background: 'linear-gradient(180deg, #1a1f1a 0%, #0f140f 100%)',
    accent: '#40e168'
  }
};

// ========== VISUAL MASTERS: Utility Functions ==========

// SAGMEISTER: Analyze emotional arc (enhanced version)
const analyzeEmotionalArc = (text) => {
  if (!text || text.length < 100) return 'neutral';
  
  const sentences = text.split(/[.!?]+/).filter(s => s.trim());
  const lowerText = text.toLowerCase();
  
  // Word lists for emotional detection
  const positiveWords = ['iloinen', 'onnellinen', 'rauhallinen', 'l√§mmin', 'valo', 'kaunis', 'rakkaus', 'hymy'];
  const negativeWords = ['surullinen', 'pime√§', 'kylm√§', 'synkk√§', 'pelottava', 'viha', 'suru', 'kipu'];
  const intenseWords = ['√§killinen', 'r√§j√§ht√§v√§', 'voimakas', 'intensiivinen', 'kiihke√§', 'hurja'];
  const calmWords = ['rauhallinen', 'hiljainen', 'tyyni', 'rauha', 'lempe√§', 'pehme√§'];
  
  // Count emotional indicators
  const positiveScore = positiveWords.filter(w => lowerText.includes(w)).length;
  const negativeScore = negativeWords.filter(w => lowerText.includes(w)).length;
  const intenseScore = intenseWords.filter(w => lowerText.includes(w)).length;
  const calmScore = calmWords.filter(w => lowerText.includes(w)).length;
  
  // Check sentence structure
  const avgSentenceLength = sentences.reduce((sum, s) => sum + s.split(' ').length, 0) / sentences.length;
  const hasExclamations = (text.match(/!/g) || []).length;
  
  // Determine emotional arc
  if (intenseScore > 2 || hasExclamations > 3) return 'intense';
  if (calmScore > intenseScore && avgSentenceLength > 15) return 'calm';
  if (positiveScore > negativeScore + 2) return 'positive';
  if (negativeScore > positiveScore + 2) return 'negative';
  
  return 'neutral';
};

// SUPERSIDE: Detect work phase from activity
const detectWorkPhase = (metrics) => {
  const { editCount, wordCount, cursorMovements, timeSinceLastEdit } = metrics;
  
  // Many edits, few new words = editing
  if (editCount > 20 && wordCount < 100) return 'editing';
  
  // Lots of new words with flow = drafting
  if (wordCount > 500 && editCount < 10) return 'drafting';
  
  // Many cursor movements, few edits = reviewing
  if (cursorMovements > 50 && editCount < 5) return 'reviewing';
  
  // Default = writing
  return 'writing';
};

// IDEO: Calculate cognitive load
const calculateCognitiveLoad = (factors) => {
  const {
    typingSpeed = 50,
    errorRate = 0,
    timeOnTask = 0,
    pauseFrequency = 0
  } = factors;
  
  // Fast typing = high load (stress)
  const speedFactor = (typingSpeed / 100) * 30;
  
  // Many errors = high load
  const errorFactor = Math.min(errorRate * 0.5, 30);
  
  // Long time = increasing load (fatigue)
  const timeFactor = Math.min((timeOnTask / 60) * 0.2, 20);
  
  // Many pauses = high load (struggling)
  const pauseFactor = Math.min(pauseFrequency * 0.3, 20);
  
  return Math.min(100, speedFactor + errorFactor + timeFactor + pauseFactor);
};

// PENTAGRAM: Calculate optimal font size based on width
const getOptimalFontSize = (containerWidth) => {
  // Optimal: 60-75 characters per line
  // Formula: width / 60 (assuming ~0.5em per character)
  const optimalSize = containerWidth / 45; // ~67 chars at this size
  return Math.max(15, Math.min(20, optimalSize)); // Clamp 15-20px
};

// üúç FAUST - Main Editor Component
function FaustEditor() {
  const [project, setProject] = useState({
    title: 'Nimet√∂n projekti',
    collections: [],
    targets: {
      project: 80000,
      daily: 1000,
      session: 500
    },

    // Vaihe 5: Hahmotietokanta
    characters: [],

    // Vaihe 6: Paikkatietokanta
    locations: [],
    genre: 'psychological_thriller', // Kirjan genre
    
    // StoryKeeper: Tarinan rakenne ja kausaalisuus
    story: {
      outline: [],      // Lukujen rakenne
      events: [],       // Keskeiset tapahtumat
      threads: [],      // Juonilangat
      timeline: [],     // Aikajana
      immutable_facts: [] // Faktat jotka eiv√§t voi muuttua
    },
    
    // üúç GRIMOIRE: Projektin muistij√§rjestelm√§
    grimoire: {
      conversations: [],
      styleRules: [],
      rejections: [],
      acceptances: [],
      projectVoice: {
        avgSentenceLength: null,
        lexicon: [],
        avoidedWords: [],
        preferredStructures: [],
        tone: 'neutral',
        pov: null,
        tense: null
      },
      themes: [],
      symbols: [],
      created: new Date().toISOString(),
      lastUpdated: new Date().toISOString(),
      totalInteractions: 0
    },
    
    // üúç CONTEXTUS: Hierarkkinen kontekstinhallinta
    contextus: {
      // Taso 1: Globaali metadata
      global: {
        synopsis: '',
        themes: [],
        timeline: { start: null, current: null, end: null },
        pov: null,  // '1st person', '3rd limited', '3rd omniscient'
        tense: null, // 'present', 'past'
        style_dna: ''
      },
      
      // Taso 2: Lukutiivistelm√§t
      chapterSummaries: [],  // [{chapter, summary_short, summary_medium, key_events, tension}]
      
      // Taso 3: Hahmojen tilat per luku
      characterStates: [],   // [{chapter, character, state: {physical, mental, knowledge, relationships}}]
      
      // Juonilankojen seuranta
      plotThreads: [],       // [{name, type, arc, tension_curve, promises}]
      
      // Tapahtumien kausaalisuus
      eventGraph: {
        events: [],          // [{id, chapter, description, requires, should_cause}]
        connections: []      // [{from, to, relationship}]
      },
      
      // Metadataa
      created: new Date().toISOString(),
      lastUpdated: new Date().toISOString()
    },
    
    items: [
      {
        id: 1,
        type: 'folder',
        title: 'K√§sikirjoitus',
        expanded: true,
        children: [
          { id: 11, type: 'chapter', title: 'Luku 1', content: '', wordCount: 0, notes: '', status: 'draft', label: 'none', snapshots: [] }
        ]
      },
      {
        id: 2,
        type: 'folder',
        title: 'Tutkimus',
        expanded: false,
        children: []
      }
    ]
  });

  const [activeItemId, setActiveItemId] = useState(11);
  const [isDarkMode, setIsDarkMode] = useState(false);
  const [showSidebar, setShowSidebar] = useState(true);
  const [showInspector, setShowInspector] = useState(true);
  const [aiAssistantOpen, setAiAssistantOpen] = useState(false);
  const [aiPrompt, setAiPrompt] = useState('');
  const [aiResponse, setAiResponse] = useState('');
  const [isGenerating, setIsGenerating] = useState(false);
  const [viewMode, setViewMode] = useState('editor');
  const [inspectorTab, setInspectorTab] = useState('notes');
  const [showExportMenu, setShowExportMenu] = useState(false);
  const [showCollectionsPanel, setShowCollectionsPanel] = useState(false);
  const [activeCollection, setActiveCollection] = useState(null);
  const [selectedAIApi, setSelectedAIApi] = useState('claude'); // Valittu AI-palvelu

  // Projektin tavoitteet
  const [targets, setTargets] = useState({
    project: 80000,      // Koko projektin sanam√§√§r√§tavoite
    daily: 1000,         // P√§ivitt√§inen tavoite
    session: 500         // Istunnon tavoite
  });

  // Nykyinen kirjoitusistunto
  const [sessionStats, setSessionStats] = useState({
    startTime: Date.now(),
    startWords: 0,
    currentWords: 0,
    wordsWritten: 0,
    duration: 0
  });

  // P√§ivitt√§iset tilastot (tallennetaan localStorage)
  const [dailyStats, setDailyStats] = useState(() => {
    const today = new Date().toISOString().split('T')[0];
    const saved = localStorage.getItem(`dailyStats_${today}`);
    return saved ? JSON.parse(saved) : { date: today, words: 0, sessions: [] };
  });

  // Vaihe 3: Split View & Compose Mode
  const [composeMode, setComposeMode] = useState(false);
  const [splitView, setSplitView] = useState(false);
  const [typewriterMode, setTypewriterMode] = useState(false);
  const [splitViewItem, setSplitViewItem] = useState(null); // Toinen dokumentti split view'ssa

  // Vaihe 4: Fonttien mukauttaminen
  const [editorFont, setEditorFont] = useState(() => {
    const saved = localStorage.getItem('editorPreferences');
    return saved ? JSON.parse(saved).editorFont : 'serif';
  });

  const [fontSize, setFontSize] = useState(() => {
    const saved = localStorage.getItem('editorPreferences');
    return saved ? JSON.parse(saved).fontSize : 18;
  });

  const [lineHeight, setLineHeight] = useState(() => {
    const saved = localStorage.getItem('editorPreferences');
    return saved ? JSON.parse(saved).lineHeight : 1.8;
  });

  const [focusMode, setFocusMode] = useState(false);
  const [showWordCount, setShowWordCount] = useState(true);

  // Vaihe 5: CharacterKeeper - hahmojen jatkuvuuden valvoja
  const [editingCharacter, setEditingCharacter] = useState(null);
  const [showCharacterSheet, setShowCharacterSheet] = useState(false);
  
  // LocationKeeper - paikkojen hallinta
  const [editingLocation, setEditingLocation] = useState(null);
  const [showLocationSheet, setShowLocationSheet] = useState(false);

  // StoryKeeper - tarinan rakenteen hallinta
  const [editingChapter, setEditingChapter] = useState(null);
  const [showChapterSheet, setShowChapterSheet] = useState(false);
  const [editingThread, setEditingThread] = useState(null);
  const [showThreadSheet, setShowThreadSheet] = useState(false);

  // ========== NORMAN-KRUG-NATSUME: UI/UX States ==========
  
  // NATSUME: Flow Modes - Focus, Rhythm, Review
  const [flowMode, setFlowMode] = useState('normal'); // 'normal', 'focus', 'rhythm', 'review'
  const [emotionalTone, setEmotionalTone] = useState('neutral'); // 'calm', 'tense', 'neutral'
  
  // NORMAN: AI Suggestions & Feedback
  const [aiSuggestions, setAiSuggestions] = useState([]); // { id, text, reason, position, type }
  const [showAIFeedback, setShowAIFeedback] = useState(null); // { action, details, type }
  const [activeSuggestion, setActiveSuggestion] = useState(null);
  
  // NATSUME: Inspiration Panel
  const [showInspiration, setShowInspiration] = useState(false);
  const [inspirationData, setInspirationData] = useState(null);
  const [lastEditTime, setLastEditTime] = useState(Date.now());
  
  // NORMAN: Learning System - AI learns from user preferences
  const [userPreferences, setUserPreferences] = useState(() => {
    const saved = localStorage.getItem('aiLearningPreferences');
    return saved ? JSON.parse(saved) : {
      rejectedSuggestions: [],
      preferredStyles: {},
      contextPreferences: {}
    };
  });
  
  // KRUG: Optimistic UI state
  const [saveStatus, setSaveStatus] = useState('saved'); // 'saved', 'saving', 'error'

  // ========== VISUAL MASTERS: State Management ==========
  
  // SAGMEISTER: Living Typography
  const [writingSpeed, setWritingSpeed] = useState(50); // 0-100, affects font size/spacing
  const [lastKeystroke, setLastKeystroke] = useState(Date.now());
  const [keystrokeCount, setKeystrokeCount] = useState(0);
  
  // SAGMEISTER: Emotional Color Arc
  const [emotionalArc, setEmotionalArc] = useState('neutral'); // 'positive', 'negative', 'neutral', 'intense', 'calm'
  
  // SUPERSIDE: Work Phase Detection
  const [workPhase, setWorkPhase] = useState('writing'); // 'drafting', 'writing', 'editing', 'reviewing'
  const [activityMetrics, setActivityMetrics] = useState({
    editCount: 0,
    wordCount: 0,
    cursorMovements: 0,
    timeSinceLastEdit: 0
  });
  
  // IDEO: Cognitive Load
  const [cognitiveLoad, setCognitiveLoad] = useState(50); // 0-100
  
  // IDEO: AI Transparency
  const [aiTransparency, setAiTransparency] = useState({
    active: false,
    thinking: false,
    context: null
  });

  // ========== UUDET OMINAISUUDET: Valitun tekstin k√§sittely ==========
  
  // Valittu teksti ja Quick Actions
  const [selectedText, setSelectedText] = useState('');
  const [selectionRange, setSelectionRange] = useState({ start: 0, end: 0 });
  const [showQuickActions, setShowQuickActions] = useState(false);
  const [showInsertMenu, setShowInsertMenu] = useState(false);
  
  // Automaattinen jatkuvuuden valvonta
  const [autoCheckEnabled, setAutoCheckEnabled] = useState(false);
  const [inlineWarnings, setInlineWarnings] = useState([]);
  
  // ========== CURSOR-TYYLI: Chat-muokkaukset ==========
  
  // Parsitut muutosehdotukset AI:n vastauksesta
  const [suggestedEdits, setSuggestedEdits] = useState([]);
  // { id, type: 'replace'|'insert', oldText, newText, applied }

  // Fonttivaihtoehdot
  const fontOptions = [
    { id: 'serif', name: 'Serif (Times)', family: 'Times New Roman, serif' },
    { id: 'sans', name: 'Sans-serif', family: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif' },
    { id: 'mono', name: 'Monospace', family: 'Menlo, Monaco, Consolas, monospace' },
    { id: 'georgia', name: 'Georgia', family: 'Georgia, serif' },
    { id: 'garamond', name: 'Garamond', family: 'Garamond, serif' },
    { id: 'bookman', name: 'Bookman', family: 'Bookman, serif' },
    { id: 'courier', name: 'Courier', family: '"Courier New", Courier, monospace' },
    { id: 'arial', name: 'Arial', family: 'Arial, Helvetica, sans-serif' },
    { id: 'verdana', name: 'Verdana', family: 'Verdana, Geneva, sans-serif' },
    { id: 'tahoma', name: 'Tahoma', family: 'Tahoma, Geneva, sans-serif' },
    // Google Fonts
    { id: 'merriweather', name: 'Merriweather', family: 'Merriweather, serif' },
    { id: 'playfair', name: 'Playfair Display', family: '"Playfair Display", serif' },
    { id: 'lora', name: 'Lora', family: 'Lora, serif' },
    { id: 'opensans', name: 'Open Sans', family: '"Open Sans", sans-serif' },
    { id: 'source', name: 'Source Code Pro', family: '"Source Code Pro", monospace' }
  ];

  const editorRef = useRef(null);

  const statusOptions = [
    { value: 'draft', label: 'Luonnos' },
    { value: 'revision', label: 'Korjaus' },
    { value: 'complete', label: 'Valmis' }
  ];

  const aiPrompts = [
    { label: 'Jatka kirjoittamista', prompt: 'Jatka t√§t√§ teksti√§ luonnollisesti s√§ilytt√§en tyylin ja √§√§nen.' },
    { label: 'Paranna kappaletta', prompt: 'Paranna t√§t√§ kappaletta s√§ilytt√§en sen ydinsis√§ll√∂n.' },
    { label: 'Luo juonikaari', prompt: 'Ehdota juonikaarta t√§lle luvulle.' },
    { label: 'Kehit√§ hahmoa', prompt: 'Anna ideoita hahmon kehitt√§miseen t√§m√§n perusteella.' },
    { label: 'Paranna dialogia', prompt: 'Tee dialogista luonnollisempaa ja kiinnostavampaa.' },
    { label: 'Luo j√§nnitett√§', prompt: 'Ehdota tapoja lis√§t√§ j√§nnitett√§ t√§h√§n kohtaukseen.' }
  ];

  const findItem = (items, id) => {
    for (const item of items) {
      if (item.id === id) return item;
      if (item.children) {
        const found = findItem(item.children, id);
        if (found) return found;
      }
    }
    return null;
  };

  const getActiveItem = () => findItem(project.items, activeItemId);
  const getSelectedLocation = () => project.locations?.find(loc => loc.id === editingLocation?.id);
  const countWords = (text) => text.trim().split(/\s+/).filter(word => word.length > 0).length;

  const getTotalWordCount = () => {
    const countRecursive = (items) => items.reduce((sum, item) => {
      let count = sum + (item.wordCount || 0);
      if (item.children) count += countRecursive(item.children);
      return count;
    }, 0);
    return countRecursive(project.items);
  };

  const updateItem = (id, updates) => {
    const updateRecursive = (items) => items.map(item => {
      if (item.id === id) {
        const updatedItem = { ...item, ...updates };
        if (updates.content !== undefined) updatedItem.wordCount = countWords(updates.content);
        return updatedItem;
      }
      if (item.children) return { ...item, children: updateRecursive(item.children) };
      return item;
    });
    setProject({ ...project, items: updateRecursive(project.items) });
  };

  // Luo snapshot (tilannekuva)
  const createSnapshot = () => {
    const activeItem = getActiveItem();
    if (!activeItem || !activeItem.content) {
      alert('Ei sis√§lt√∂√§ tallennettavaksi!');
      return;
    }

    const snapshot = {
      id: Date.now(),
      title: `Tilannekuva ${new Date().toLocaleString('fi-FI')}`,
      content: activeItem.content,
      timestamp: new Date().toISOString(),
      wordCount: activeItem.wordCount
    };

    updateItem(activeItemId, { snapshots: [...(activeItem.snapshots || []), snapshot] });
    alert('Tilannekuva tallennettu!');
  };

  // Palauta snapshot
  const restoreSnapshot = (snapshot) => {
    if (confirm(`Palauta tilannekuva "${snapshot.title}"? Nykyinen sis√§lt√∂ korvataan.`)) {
      updateItem(activeItemId, { content: snapshot.content });
      if (editorRef.current) editorRef.current.value = snapshot.content;
      alert('Tilannekuva palautettu!');
    }
  };

  // Poista snapshot
  const deleteSnapshot = (snapshotId) => {
    const activeItem = getActiveItem();
    updateItem(activeItemId, { snapshots: (activeItem.snapshots || []).filter(s => s.id !== snapshotId) });
  };

  // Luo uusi kokoelma
  const createCollection = () => {
    const name = prompt('Anna kokoelman nimi:');
    if (!name) return;

    const newCollection = {
      id: Date.now(),
      name,
      itemIds: []
    };

    setProject({ ...project, collections: [...(project.collections || []), newCollection] });
  };

  // Lis√§√§ dokumentti kokoelmaan
  const addToCollection = (collectionId, itemId) => {
    setProject({
      ...project,
      collections: project.collections.map(col =>
        col.id === collectionId ? { ...col, itemIds: [...col.itemIds, itemId] } : col
      )
    });
  };

  // Poista dokumentti kokoelmasta
  const removeFromCollection = (collectionId, itemId) => {
    setProject({
      ...project,
      collections: project.collections.map(col =>
        col.id === collectionId ? { ...col, itemIds: col.itemIds.filter(id => id !== itemId) } : col
      )
    });
  };

  const addItem = (parentId, type) => {
    const newId = Date.now();
    const titles = {
      chapter: 'Uusi luku',
      document: 'Uusi dokumentti',
      folder: 'Uusi kansio'
    };

    const newItem = {
      id: newId,
      type,
      title: titles[type] || 'Uusi kohde',
      content: '',
      wordCount: 0,
      notes: '',
      status: 'draft',
      label: 'none',
      snapshots: []
    };

    if (type === 'folder') {
      newItem.children = [];
      newItem.expanded = true;
    }

    const addRecursive = (items) => items.map(item => {
      if (item.id === parentId && item.type === 'folder') {
        return { ...item, children: [...(item.children || []), newItem] };
      }
      if (item.children) return { ...item, children: addRecursive(item.children) };
      return item;
    });

    setProject({ ...project, items: addRecursive(project.items) });
    setActiveItemId(newId);
  };

  const deleteItem = (id) => {
    const deleteRecursive = (items) => items.filter(item => {
      if (item.id === id) return false;
      if (item.children) item.children = deleteRecursive(item.children);
      return true;
    });

    setProject({ ...project, items: deleteRecursive(project.items) });
    if (activeItemId === id) {
      setActiveItemId(project.items[0]?.children?.[0]?.id || project.items[0]?.id);
    }
  };

  const toggleFolder = (id) => {
    const toggleRecursive = (items) => items.map(item => {
      if (item.id === id && item.type === 'folder') {
        return { ...item, expanded: !item.expanded };
      }
      if (item.children) return { ...item, children: toggleRecursive(item.children) };
      return item;
    });
    setProject({ ...project, items: toggleRecursive(project.items) });
  };

  // üúç GRIMOIRE: Muistinhallinta-funktiot
  
  const addToGrimoire = (type, data) => {
    const grimoire = { ...project.grimoire };
    
    switch(type) {
      case 'conversation':
        grimoire.conversations.push({
          id: Date.now(),
          timestamp: new Date().toISOString(),
          ...data
        });
        // Pid√§ viimeiset 100 keskustelua
        if (grimoire.conversations.length > 100) {
          grimoire.conversations = grimoire.conversations.slice(-100);
        }
        break;
        
      case 'styleRule':
        grimoire.styleRules.push({
          id: Date.now(),
          ...data
        });
        break;
        
      case 'rejection':
        grimoire.rejections.push({
          id: Date.now(),
          timestamp: new Date().toISOString(),
          ...data
        });
        break;
        
      case 'acceptance':
        grimoire.acceptances.push({
          id: Date.now(),
          timestamp: new Date().toISOString(),
          ...data
        });
        break;
    }
    
    grimoire.lastUpdated = new Date().toISOString();
    grimoire.totalInteractions++;
    
    setProject({ ...project, grimoire });
  };
  
  const getGrimoireContext = () => {
    const grimoire = project.grimoire;
    
    // Rakenna konteksti AI:lle
    let context = '\n\nüúç PROJEKTIN MUISTI (GRIMOIRE):\n\n';
    
    // Tyylivalidit
    if (grimoire.styleRules.length > 0) {
      context += '**Tyylivalidit:**\n';
      grimoire.styleRules.slice(-5).forEach(rule => {
        context += `- ${rule.rule}\n`;
        if (rule.example) context += `  Esimerkki: ${rule.example}\n`;
      });
      context += '\n';
    }
    
    // Hyl√§tyt ehdotukset - AI oppii mit√§ EI haluta
    if (grimoire.rejections.length > 0) {
      context += '**V√§ltet√§√§n (hyl√§tyt ehdotukset):**\n';
      grimoire.rejections.slice(-5).forEach(rej => {
        context += `- √Ñl√§ ehdota: "${rej.suggestion}"\n`;
        if (rej.reason) context += `  Syy: ${rej.reason}\n`;
      });
      context += '\n';
    }
    
    // Hyv√§ksytyt muutokset - AI oppii mit√§ halutaan
    if (grimoire.acceptances.length > 0) {
      context += '**Hyv√§ksytyt muutokset (toista t√§t√§ tyyli√§):**\n';
      grimoire.acceptances.slice(-3).forEach(acc => {
        context += `- "${acc.original}" ‚Üí "${acc.modified}"\n`;
      });
      context += '\n';
    }
    
    // Projektin √§√§ni
    if (grimoire.projectVoice.tone !== 'neutral' || grimoire.projectVoice.pov) {
      context += '**Projektin √§√§ni:**\n';
      if (grimoire.projectVoice.tone) context += `- S√§vy: ${grimoire.projectVoice.tone}\n`;
      if (grimoire.projectVoice.pov) context += `- N√§k√∂kulma: ${grimoire.projectVoice.pov}\n`;
      if (grimoire.projectVoice.tense) context += `- Aikamuoto: ${grimoire.projectVoice.tense}\n`;
      if (grimoire.projectVoice.avoidedWords.length > 0) {
        context += `- V√§lt√§ sanoja: ${grimoire.projectVoice.avoidedWords.join(', ')}\n`;
      }
      context += '\n';
    }
    
    // Teemat
    if (grimoire.themes.length > 0) {
      context += '**Keskeiset teemat:**\n';
      grimoire.themes.forEach(theme => {
        context += `- ${theme.name} (${theme.occurrences.length} kertaa)\n`;
      });
      context += '\n';
    }
    
    context += '**Noudata n√§it√§ ohjeita ja oppimistasi t√§ss√§ projektissa.**\n\n';
    
    return context;
  };
  
  // üúç CONTEXTUS: Hierarkkisen kontekstin rakentaja
  
  // Helper-funktio juonilangan etenemisen laskemiseen
  const calculateThreadProgress = (arc) => {
    if (!arc) return 0;
    let total = 0;
    let completed = 0;
    
    Object.keys(arc).forEach(phase => {
      total += arc[phase].target_percentage || 0;
      completed += arc[phase].actual_percentage || 0;
    });
    
    return total > 0 ? completed / total : 0;
  };
  
  const getContextusContext = (queryType = 'general', currentChapter = null) => {
    const contextus = project.contextus;
    let context = '\n\nüúç KONTEKSTUAALINEN MUISTI:\n\n';
    
    // TASO 1: Globaali metadata (jos m√§√§ritelty)
    if (contextus.global.synopsis || contextus.global.themes.length > 0) {
      context += '**Projektin yleiskuva:**\n';
      if (contextus.global.synopsis) {
        context += `Synopsis: ${contextus.global.synopsis}\n`;
      }
      if (contextus.global.themes.length > 0) {
        context += `Teemat: ${contextus.global.themes.join(', ')}\n`;
      }
      if (contextus.global.pov) {
        context += `N√§k√∂kulma: ${contextus.global.pov}\n`;
      }
      if (contextus.global.tense) {
        context += `Aikamuoto: ${contextus.global.tense}\n`;
      }
      context += '\n';
    }
    
    // TASO 2: Lukutiivistelm√§t (jos on)
    if (contextus.chapterSummaries.length > 0) {
      context += '**Aikaisemmat luvut:**\n';
      contextus.chapterSummaries.forEach(summary => {
        if (summary.summary_short) {
          context += `Luku ${summary.chapter}: ${summary.summary_short}\n`;
        }
      });
      context += '\n';
    }
    
    // TASO 3: Hahmojen tilat (query-tyypist√§ riippuen)
    if (queryType === 'dialogue' || queryType === 'character') {
      if (contextus.characterStates.length > 0) {
        context += '**Hahmojen nykyinen tila:**\n';
        // Hae viimeisimm√§t tilat kullekin hahmolle
        const latestStates = {};
        contextus.characterStates.forEach(state => {
          if (!latestStates[state.character] || state.chapter > latestStates[state.character].chapter) {
            latestStates[state.character] = state;
          }
        });
        
        Object.values(latestStates).forEach(state => {
          context += `- ${state.character}:\n`;
          if (state.state.physical?.location) {
            context += `  Sijainti: ${state.state.physical.location}\n`;
          }
          if (state.state.mental?.primary_emotion) {
            context += `  Tunnetila: ${state.state.mental.primary_emotion}\n`;
          }
          if (state.state.knowledge?.knows) {
            context += `  Tiet√§√§: ${state.state.knowledge.knows.join(', ')}\n`;
          }
        });
        context += '\n';
      }
    }
    
    // Juonilangat (jos plot-kysely)
    if (queryType === 'plot' || queryType === 'general') {
      if (contextus.plotThreads.length > 0) {
        context += '**Aktiiviset juonilangat:**\n';
        contextus.plotThreads.forEach(thread => {
          const progress = calculateThreadProgress(thread.arc);
          context += `- ${thread.name} (${Math.round(progress * 100)}% valmis)\n`;
          if (thread.promises && thread.promises.length > 0) {
            const unresolved = thread.promises.filter(p => !p.resolved);
            if (unresolved.length > 0) {
              context += `  ‚ö†Ô∏è Ratkaistava: ${unresolved.map(p => p.setup).join(', ')}\n`;
            }
          }
        });
        context += '\n';
      }
    }
    
    return context;
  };

  const callAIAPI = async (prompt, includeContext = true) => {
    setIsGenerating(true);
    setAiResponse('');
    setSuggestedEdits([]); // Tyhjenn√§ vanhat ehdotukset

    try {
      const activeItem = getActiveItem();
      const context = includeContext && activeItem?.content
        ? `\n\nNykyinen sis√§lt√∂:\n${activeItem.content}`
        : '';
      
      // Lis√§√§ GRIMOIRE-konteksti (tyyli, oppiminen)
      const grimoireContext = getGrimoireContext();
      
      // Lis√§√§ CONTEXTUS-konteksti (hahmot, juoni, historia)
      const contextusContext = getContextusContext('general', activeItem?.id);

      const fullPrompt = `Olet luova kirjoitusavustaja, joka auttaa kirjailijaa kirjoittamaan kirjaansa suomeksi.\n\n${prompt}${context}${grimoireContext}${contextusContext}\n\nAnna hy√∂dyllist√§, luovaa ja rakentavaa apua. Ole konkreettinen ja k√§yt√§nn√∂llinen. Vastaa AINA suomeksi.

JOS ehdotat tekstimuutoksia, k√§yt√§ t√§t√§ formaattia:
1. Selit√§ muutos sanallisesti
2. N√§yt√§ muutos k√§ytt√§en joko:
   - "Muuta 'vanha teksti' -> 'uusi teksti'"
   - TAI koodiblokkeja:
     \`\`\`
     vanha teksti
     \`\`\`
     ‚Üí
     \`\`\`
     uusi teksti
     \`\`\`

T√§m√§ mahdollistaa automaattisen Apply-napin.`;

      let result;
      switch (selectedAIApi) {
        case 'claude':
          result = await window.electronAPI.claudeAPI(fullPrompt);
          break;
        case 'grok':
          result = await window.electronAPI.grokAPI(fullPrompt);
          break;
        case 'openai':
          result = await window.electronAPI.openaiAPI(fullPrompt);
          break;
        case 'cursor':
          result = await window.electronAPI.cursorAPI(fullPrompt);
          break;
        default:
          result = await window.electronAPI.claudeAPI(fullPrompt);
      }

      if (result.success) {
        const response = result.data;
        setAiResponse(response);
        
        // üúç Tallenna keskustelu Grimoireen
        addToGrimoire('conversation', {
          prompt: prompt,
          response: response,
          model: selectedAIApi,
          applied: false
        });
        
        // Parsitaan muutosehdotukset
        const edits = parseAIEdits(response);
        if (edits.length > 0) {
          setSuggestedEdits(edits);
          showToast(`üîç L√∂ytyi ${edits.length} muutosehdotus${edits.length > 1 ? 'ta' : ''}`, 'info');
        }
      } else {
        setAiResponse(`Vastauksen luominen ep√§onnistui (${selectedAIApi}): ` + result.error);
      }
    } catch (err) {
      setAiResponse('Vastauksen luominen ep√§onnistui. Yrit√§ uudelleen.');
    } finally {
      setIsGenerating(false);
    }
  };

  // ========== PARANNETTU: Valitun tekstin korvaaminen ==========
  
  const replaceSelectedText = (newText) => {
    if (!editorRef.current) return;
    
    const editor = editorRef.current;
    const start = selectionRange.start;
    const end = selectionRange.end;
    const currentContent = editor.value;
    
    if (start === end) {
      // Ei valintaa ‚Üí lis√§√§ kursorin kohtaan
      const newContent = 
        currentContent.substring(0, start) + 
        newText + 
        currentContent.substring(start);
      
      updateItem(activeItemId, { content: newContent });
      editor.value = newContent;
      editor.setSelectionRange(start + newText.length, start + newText.length);
    } else {
      // Korvaa valinta
      const newContent = 
        currentContent.substring(0, start) + 
        newText + 
        currentContent.substring(end);
      
      updateItem(activeItemId, { content: newContent });
      editor.value = newContent;
      editor.setSelectionRange(start, start + newText.length);
    }
    
    editor.focus();
  };

  const insertAiResponse = (mode = 'append') => {
    if (!aiResponse) return;
    
    switch (mode) {
      case 'append':
        // Lis√§√§ loppuun (vanha toiminta)
        const activeItem = getActiveItem();
        const newContent = (activeItem?.content || '') + (activeItem?.content ? '\n\n' : '') + aiResponse;
        updateItem(activeItemId, { content: newContent });
        if (editorRef.current) {
          editorRef.current.value = newContent;
          editorRef.current.scrollTop = editorRef.current.scrollHeight;
        }
        break;
        
      case 'replace-selection':
        // Korvaa valittu teksti
        replaceSelectedText(aiResponse);
        break;
        
      case 'replace-all':
        // Korvaa koko sis√§lt√∂
        updateItem(activeItemId, { content: aiResponse });
        if (editorRef.current) {
          editorRef.current.value = aiResponse;
        }
        break;
        
      case 'at-cursor':
        // Lis√§√§ kursorin kohtaan
        replaceSelectedText(aiResponse);
        break;
    }
    
    setAiResponse('');
    setShowInsertMenu(false);
  };

  // ========== TEKSTIN VALINNAN K√ÑSITTELY ==========
  
  const handleTextSelection = () => {
    if (!editorRef.current) return;
    
    const editor = editorRef.current;
    const start = editor.selectionStart;
    const end = editor.selectionEnd;
    
    setSelectionRange({ start, end });
    
    if (start !== end) {
      const selected = editor.value.substring(start, end);
      setSelectedText(selected);
      setShowQuickActions(true);
    } else {
      setSelectedText('');
      setShowQuickActions(false);
    }
  };

  // ========== QUICK ACTIONS TOIMINNOT ==========
  
  const handleQuickAction = async (action) => {
    if (!selectedText) return;
    
    const prompts = {
      improve: `Paranna t√§t√§ teksti√§ (s√§ilyt√§ merkitys, paranna tyyli√§ ja sujuvuutta):\n\n${selectedText}\n\nPalauta VAIN parannettu teksti, ei selityksi√§.`,
      shorten: `Lyhenn√§ t√§t√§ teksti√§ noin puoleen (s√§ilyt√§ ydinsis√§lt√∂ ja t√§rkeimm√§t yksityiskohdat):\n\n${selectedText}\n\nPalauta VAIN lyhennetty teksti, ei selityksi√§.`,
      expand: `Laajenna t√§t√§ teksti√§ (lis√§√§ yksityiskohtia, aistihavaintoja ja syvyytt√§):\n\n${selectedText}\n\nPalauta VAIN laajennettu teksti, ei selityksi√§.`,
      fix: `Korjaa kielioppi-, oikeinkirjoitus- ja tyylvirheet t√§st√§ tekstist√§:\n\n${selectedText}\n\nPalauta VAIN korjattu teksti, ei selityksi√§.`
    };
    
    setShowQuickActions(false);
    setAiAssistantOpen(true); // Avaa AI-paneeli
    setAiPrompt(`${action === 'improve' ? '‚ú® Paranna' : action === 'shorten' ? 'üìè Lyhenn√§' : action === 'expand' ? 'üìñ Laajenna' : '‚úÖ Korjaa'}: "${selectedText.substring(0, 50)}${selectedText.length > 50 ? '...' : ''}"`);
    await callAIAPI(prompts[action], false);
  };

  // ========== CURSOR-TYYLI: Parsitaan muutosehdotukset AI:n vastauksesta ==========
  
  const parseAIEdits = (aiResponse) => {
    // Etsii muutosehdotuksia AI:n vastauksesta
    const edits = [];
    
    // Pattern 1: "Muuta X -> Y" tai "Korvaa X tekstill√§ Y"
    const replacePattern = /(?:Muuta|Korvaa|Vaihda)\s+["']([^"']+)["']\s*(?:->|tekstill√§|:)\s*["']([^"']+)["']/gi;
    let match;
    
    while ((match = replacePattern.exec(aiResponse)) !== null) {
      edits.push({
        id: Date.now() + Math.random(),
        type: 'replace',
        oldText: match[1],
        newText: match[2],
        applied: false
      });
    }
    
    // Pattern 2: Koodiblokit (```teksti```)
    const codeBlockPattern = /```(?:text|plaintext)?\n([\s\S]+?)\n```/g;
    const codeBlocks = [];
    
    while ((match = codeBlockPattern.exec(aiResponse)) !== null) {
      codeBlocks.push(match[1].trim());
    }
    
    // Jos l√∂ytyy 2+ koodiblokkia, oleta ett√§ ensimm√§inen on "ennen" ja toinen "j√§lkeen"
    if (codeBlocks.length >= 2) {
      edits.push({
        id: Date.now() + Math.random(),
        type: 'replace',
        oldText: codeBlocks[0],
        newText: codeBlocks[1],
        applied: false
      });
    } else if (codeBlocks.length === 1 && selectedText) {
      // Yksi koodiblokki + valittu teksti = korvausehdotus
      edits.push({
        id: Date.now() + Math.random(),
        type: 'replace',
        oldText: selectedText,
        newText: codeBlocks[0],
        applied: false
      });
    }
    
    return edits;
  };

  // ========== CURSOR-TYYLI: Sovella muutosehdotus ==========
  
  const applyEdit = (edit) => {
    const activeItem = getActiveItem();
    if (!activeItem || !editorRef.current) return;
    
    const content = activeItem.content || '';
    
    // Etsi vanhan tekstin sijainti
    const index = content.indexOf(edit.oldText);
    
    if (index === -1) {
      showToast('‚ö†Ô∏è Teksti√§ ei l√∂ytynyt dokumentista', 'warning');
      return;
    }
    
    // Korvaa teksti
    const newContent = 
      content.substring(0, index) + 
      edit.newText + 
      content.substring(index + edit.oldText.length);
    
    updateItem(activeItemId, { content: newContent });
    
    if (editorRef.current) {
      editorRef.current.value = newContent;
      // Aseta kursori korvatun tekstin loppuun
      const cursorPos = index + edit.newText.length;
      editorRef.current.setSelectionRange(cursorPos, cursorPos);
      editorRef.current.focus();
    }
    
    // Merkitse sovellettuksi
    setSuggestedEdits(prev => 
      prev.map(e => e.id === edit.id ? { ...e, applied: true } : e)
    );
    
    // üúç Tallenna hyv√§ksynt√§ Grimoireen
    addToGrimoire('acceptance', {
      original: edit.oldText,
      modified: edit.newText,
      context: `Chapter: ${activeItem.title || 'Unknown'}`
    });
    
    showToast('‚úì Muutos sovellettu!', 'success');
  };

  // ========== CURSOR-TYYLI: Hylk√§√§ muutosehdotus ==========
  
  const rejectEdit = (edit, reason = '') => {
    setSuggestedEdits(prev => prev.filter(e => e.id !== edit.id));
    
    // üúç Tallenna hylk√§ys Grimoireen - AI oppii mit√§ ET halua
    addToGrimoire('rejection', {
      original: edit.oldText,
      suggestion: edit.newText,
      reason: reason
    });
    
    showToast('‚úó Muutos hyl√§tty', 'info');
  };

  // ========== CURSOR-TYYLI: Sovella kaikki muutokset ==========
  
  const applyAllEdits = () => {
    const unapplied = suggestedEdits.filter(e => !e.applied);
    
    if (unapplied.length === 0) {
      showToast('‚ÑπÔ∏è Kaikki muutokset jo sovellettu', 'info');
      return;
    }
    
    if (!confirm(`Sovelletan ${unapplied.length} muutosta. Jatka?`)) {
      return;
    }
    
    let successCount = 0;
    
    unapplied.forEach(edit => {
      const activeItem = getActiveItem();
      if (!activeItem) return;
      
      const content = activeItem.content || '';
      const index = content.indexOf(edit.oldText);
      
      if (index !== -1) {
        const newContent = 
          content.substring(0, index) + 
          edit.newText + 
          content.substring(index + edit.oldText.length);
        
        updateItem(activeItemId, { content: newContent });
        
        if (editorRef.current) {
          editorRef.current.value = newContent;
        }
        
        setSuggestedEdits(prev => 
          prev.map(e => e.id === edit.id ? { ...e, applied: true } : e)
        );
        
        successCount++;
      }
    });
    
    showToast(`‚úì ${successCount}/${unapplied.length} muutosta sovellettu!`, 'success');
  };

  // ========== LAAJAT MUUTOKSET: Pyyd√§ AI:ta muokkaamaan koko tarinaa ==========
  
  const requestStoryWideChange = async (changeDescription) => {
    // Ker√§√§ kaikki luvut kontekstiksi
    const allChapters = [];
    
    const collectChapters = (items) => {
      items.forEach(item => {
        if (item.type === 'chapter' && item.content) {
          allChapters.push({
            id: item.id,
            title: item.title,
            content: item.content,
            wordCount: item.wordCount || 0
          });
        }
        if (item.children) {
          collectChapters(item.children);
        }
      });
    };
    
    collectChapters(project.items);
    
    if (allChapters.length === 0) {
      showToast('‚ö†Ô∏è Ei lukuja muokattavaksi', 'warning');
      return;
    }
    
    // Luo kattava konteksti
    const storyContext = `
KOKO TARINA (${allChapters.length} lukua, yhteens√§ ${allChapters.reduce((sum, ch) => sum + ch.wordCount, 0)} sanaa):

${allChapters.map((ch, idx) => `
=== LUKU ${idx + 1}: ${ch.title} ===
${ch.content}
`).join('\n\n')}

MUUTOSPYYNT√ñ: ${changeDescription}

TEHT√ÑV√Ñ:
Ehdota muutoksia yll√§ olevaan tarinaan. K√§yt√§ formaattia:

**Luku X: Muutokset**
- Muuta "vanha teksti" -> "uusi teksti"
- TAI k√§yt√§ koodiblokkeja suurempiin muutoksiin

Voit ehdottaa muutoksia useisiin lukuihin kerralla.`;
    
    setAiAssistantOpen(true);
    setAiPrompt(`Laaja muutos: ${changeDescription}`);
    await callAIAPI(storyContext, false);
  };

  // ========== AUTOMAATTINEN JATKUVUUDEN VALVONTA ==========
  
  const checkContinuityQuietly = async (content) => {
    if (!content || content.length < 100) return [];
    
    const warnings = [];
    
    // Tarkista hahmot
    if (project.characters && project.characters.length > 0) {
      // Yksinkertainen tarkistus: etsi hahmojen nimi√§
      project.characters.forEach(char => {
        const nameRegex = new RegExp(char.name, 'gi');
        const matches = content.match(nameRegex);
        if (matches && matches.length > 3) {
          // Hahmo esiintyy usein - voisi tarkistaa tarkemmin
          // T√§m√§ on placeholder - oikea tarkistus tulisi tehd√§ AI:lla
          // mutta se olisi liian hidas reaaliaikaiseen k√§ytt√∂√∂n
        }
      });
    }
    
    return warnings;
  };

  // Debounced auto-check
  useEffect(() => {
    if (!autoCheckEnabled) {
      setInlineWarnings([]);
      return;
    }
    
    const timer = setTimeout(async () => {
      const activeItem = getActiveItem();
      if (!activeItem?.content) return;
      
      const warnings = await checkContinuityQuietly(activeItem.content);
      setInlineWarnings(warnings);
      
      // Jos l√∂ytyy vakavia ongelmia, n√§yt√§ notification
      if (warnings.length > 0) {
        showToast(`‚ö†Ô∏è L√∂ytyi ${warnings.length} jatkuvuusvaroitus${warnings.length > 1 ? 'ta' : ''}`, 'warning');
      }
    }, 3000); // 3s kirjoituksen j√§lkeen
    
    return () => clearTimeout(timer);
  }, [getActiveItem()?.content, autoCheckEnabled]);

  const saveProject = async () => {
    const projectWithAll = {
      ...project,
      targets,
      characters: project.characters || [], // Varmista ett√§ hahmot tallennetaan
      locations: project.locations || [], // Varmista ett√§ paikat tallennetaan
      genre: project.genre || 'psychological_thriller', // Varmista ett√§ genre tallennetaan
      story: project.story || { outline: [], events: [], threads: [], timeline: [], immutable_facts: [] } // Varmista ett√§ tarina tallennetaan
    };
    const result = await window.electronAPI.saveProject(projectWithAll);
    if (result.success) {
      alert('Projekti, hahmot, paikat ja tarina tallennettu!');
    }
  };

  const loadProject = async () => {
    const result = await window.electronAPI.loadProject();
    if (result.success) {
      setProject(result.data);
      if (result.data.targets) {
        setTargets(result.data.targets);
      }
      alert('Projekti ladattu!');
    }
  };

  const exportDocument = async (format) => {
    const activeItem = getActiveItem();
    if (!activeItem || !activeItem.content) {
      alert('Ei sis√§lt√∂√§ viet√§v√§ksi!');
      return;
    }

    if (format === 'pdf') {
      const html = `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>${activeItem.title}</title>
<style>body{font-family:'Times New Roman',serif;max-width:800px;margin:40px auto;line-height:1.6;padding:20px;}
h1{font-size:28px;margin-bottom:20px;}p{margin-bottom:15px;text-align:justify;}</style></head>
<body><h1>${activeItem.title}</h1>${activeItem.content.split('\n\n').map(p => `<p>${p}</p>`).join('')}</body></html>`;

      const result = await window.electronAPI.exportPDF({ html, title: activeItem.title });
      if (result.success) alert('PDF viety onnistuneesti!');
    } else {
      const result = await window.electronAPI.exportDocument({
        content: activeItem.content,
        title: activeItem.title,
        format
      });
      if (result.success) alert(`Dokumentti viety ${format.toUpperCase()}-muodossa!`);
    }
    setShowExportMenu(false);
  };

  const exportFullProject = async (format) => {
    const result = await window.electronAPI.exportFullProject({ project, format });
    if (result.success) {
      alert(`Koko projekti viety ${format.toUpperCase()}-muodossa!`);
    }
    setShowExportMenu(false);
  };

  const renderTree = (items, depth = 0) => items.map(item => {
    const labelColor = LABEL_COLORS.find(l => l.id === (item.label || 'none'));
    const isActive = activeItemId === item.id;

    return e('div', { key: item.id },
      e('button', {
        className: 'w-full flex items-center gap-2 px-3 py-1.5 rounded-md text-sm transition-all cursor-pointer',
        style: {
          paddingLeft: `${depth * 16 + 12}px`,
          background: isActive ? 'var(--mac-accent-blue)' : 'transparent',
          color: isActive ? 'white' : 'var(--mac-text-primary)',
          borderLeft: labelColor && labelColor.id !== 'none' ? `2px solid ${labelColor.color}` : 'none'
        },
        onMouseEnter: (e) => {
          if (!isActive) e.currentTarget.style.background = 'rgba(255,255,255,0.05)';
        },
        onMouseLeave: (e) => {
          if (!isActive) e.currentTarget.style.background = 'transparent';
        },
        onClick: () => setActiveItemId(item.id)
      },
        item.type === 'folder' && e('span', {
          onClick: (ev) => { ev.stopPropagation(); toggleFolder(item.id); },
          className: 'flex items-center justify-center w-4'
        }, item.expanded ? e(Icons.ChevronDown, { className: 'w-3 h-3' }) : e(Icons.ChevronRight, { className: 'w-3 h-3' })),
        item.type === 'folder' ? e(Icons.Folder, { className: 'w-4 h-4' }) : e(Icons.FileText, { className: 'w-4 h-4' }),
        e('span', { className: 'flex-1 text-left truncate' }, item.title),
        item.wordCount > 0 && e('span', {
          className: 'text-[11px] font-mono tabular-nums',
          style: { color: isActive ? 'rgba(255,255,255,0.8)' : 'var(--mac-text-tertiary)' }
        }, item.wordCount)
      ),
      item.type === 'folder' && item.expanded && item.children && renderTree(item.children, depth + 1)
    );
  });

  useEffect(() => {
    if (editorRef.current) {
      const chapter = getActiveItem();
      editorRef.current.value = chapter?.content || '';
    }
  }, [activeItemId]);

  // Vaihe 3: N√§pp√§imist√∂oikotiet
  useEffect(() => {
    const handleKeyDown = (event) => {
      // Cmd/Ctrl + F11: Compose Mode
      if ((event.metaKey || event.ctrlKey) && event.key === 'F11') {
        event.preventDefault();
        setComposeMode(!composeMode);
      }

      // Cmd/Ctrl + \: Split View
      if ((event.metaKey || event.ctrlKey) && event.key === '\\') {
        event.preventDefault();
        setSplitView(!splitView);
        if (!splitView) {
          // Valitse toinen dokumentti split view'hun
          const items = [];
          const collectItems = (nodes) => {
            nodes.forEach(node => {
              if (node.type !== 'folder') items.push(node);
              if (node.children) collectItems(node.children);
            });
          };
          collectItems(project.items);
          const otherItems = items.filter(item => item.id !== activeItemId);
          if (otherItems.length > 0) {
            setSplitViewItem(otherItems[0]);
          }
        }
      }

      // Cmd/Ctrl + Shift + T: Typewriter Mode
      if ((event.metaKey || event.ctrlKey) && event.shiftKey && event.key === 'T') {
        event.preventDefault();
        setTypewriterMode(!typewriterMode);
      }
    };

    document.addEventListener('keydown', handleKeyDown);
    return () => document.removeEventListener('keydown', handleKeyDown);
  }, [composeMode, splitView, typewriterMode, activeItemId, project.items]);

  // Istunnon seuranta
  useEffect(() => {
    // Aloita istunto jos ensimm√§inen
    if (sessionStats.startWords === 0) {
      setSessionStats(prev => ({
        ...prev,
        startWords: getTotalWordCount()
      }));
    }

    // P√§ivit√§ istunnon tilastot
    const interval = setInterval(() => {
      const currentTotal = getTotalWordCount();
      const written = currentTotal - sessionStats.startWords;
      const duration = Math.floor((Date.now() - sessionStats.startTime) / 1000);

      setSessionStats(prev => ({
        ...prev,
        currentWords: currentTotal,
        wordsWritten: written,
        duration: duration
      }));

      // P√§ivit√§ p√§iv√§tilastot
      setDailyStats(prev => {
        const updated = { ...prev, words: prev.words + written };
        const today = new Date().toISOString().split('T')[0];
        localStorage.setItem(`dailyStats_${today}`, JSON.stringify(updated));
        return updated;
      });
    }, 5000); // P√§ivit√§ 5 sekunnin v√§lein

    return () => clearInterval(interval);
  }, [getTotalWordCount()]);

  // Vaihe 4: Tallenna fonttipreferenssit localStorageen
  useEffect(() => {
    const preferences = { editorFont, fontSize, lineHeight };
    localStorage.setItem('editorPreferences', JSON.stringify(preferences));
  }, [editorFont, fontSize, lineHeight]);

  // macOS System Theme Sync
  useEffect(() => {
    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
    
    const updateTheme = (e) => {
      setIsDarkMode(e.matches);
    };
    
    // Set initial theme
    updateTheme(mediaQuery);
    
    // Listen for changes
    mediaQuery.addEventListener('change', updateTheme);
    
    return () => mediaQuery.removeEventListener('change', updateTheme);
  }, []);

  // üúç FAUST: Rituaalinen moodinvaihto DEIS ‚áÑ NOX
  useEffect(() => {
    const rootElement = document.documentElement;
    
    // Lis√§√§ switching-luokka
    rootElement.classList.add('faust-mode-switching');
    
    // Luo gradient overlay -elementti
    const overlay = document.createElement('div');
    overlay.className = 'faust-gradient-overlay';
    document.body.appendChild(overlay);
    
    // Vaihda data-theme 150ms:n kuluttua (fade phase)
    const themeTimeout = setTimeout(() => {
      rootElement.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
    }, 150);
    
    // Poista overlay 800ms:n kuluttua (gradient swipe duration)
    const overlayTimeout = setTimeout(() => {
      if (overlay.parentNode) {
        overlay.parentNode.removeChild(overlay);
      }
    }, 950);
    
    // Poista switching-luokka 1200ms:n kuluttua (koko animaatio)
    const switchTimeout = setTimeout(() => {
      rootElement.classList.remove('faust-mode-switching');
    }, 1200);
    
    return () => {
      clearTimeout(themeTimeout);
      clearTimeout(overlayTimeout);
      clearTimeout(switchTimeout);
      if (overlay.parentNode) {
        overlay.parentNode.removeChild(overlay);
      }
      rootElement.classList.remove('faust-mode-switching');
    };
  }, [isDarkMode]);

  // macOS Keyboard Shortcuts
  useEffect(() => {
    const handleKeyboard = (e) => {
      const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
      const mod = isMac ? e.metaKey : e.ctrlKey;
      
      // Cmd+S: Save
      if (mod && e.key === 's') {
        e.preventDefault();
        saveProject();
      }
      
      // Cmd+B: Toggle Sidebar
      if (mod && e.key === 'b') {
        e.preventDefault();
        setShowSidebar(prev => !prev);
      }
      
      // Cmd+Option+I: Toggle Inspector
      if (mod && e.altKey && e.key === 'i') {
        e.preventDefault();
        setShowInspector(prev => !prev);
      }
      
      // Cmd+K: AI Assistant
      if (mod && e.key === 'k') {
        e.preventDefault();
        setAiAssistantOpen(prev => !prev);
      }
      
      // Cmd+Shift+F: Focus Mode
      if (mod && e.shiftKey && e.key === 'f') {
        e.preventDefault();
        setComposeMode(prev => !prev);
      }
    };
    
    window.addEventListener('keydown', handleKeyboard);
    return () => window.removeEventListener('keydown', handleKeyboard);
  }, []);

  // ========== NORMAN-KRUG-NATSUME: Effects ==========
  
  // NATSUME: Emotional tone detection - Analyzes text and adapts UI
  useEffect(() => {
    const activeItem = getActiveItem();
    if (!activeItem || !activeItem.content) return;
    
    // Debounce analysis - don't run on every keystroke
    const timeout = setTimeout(() => {
      const tone = analyzeEmotionalTone(activeItem.content);
      if (tone !== emotionalTone) {
        setEmotionalTone(tone);
      }
    }, 2000); // Analyze 2s after user stops typing
    
    return () => clearTimeout(timeout);
  }, [project.items]); // Re-run when content changes
  
  // NATSUME: Stuck detection - Shows inspiration when no activity
  useEffect(() => {
    const checkStuck = setInterval(() => {
      const timeSinceEdit = Date.now() - lastEditTime;
      
      // If no edits for 3 minutes and document is focused
      if (timeSinceEdit > 180000 && document.hasFocus() && !showInspiration) {
        const inspiration = generateInspiration('stuck', project.genre);
        setInspirationData(inspiration);
        setShowInspiration(true);
      }
    }, 30000); // Check every 30s
    
    return () => clearInterval(checkStuck);
  }, [lastEditTime, showInspiration, project.genre]);
  
  // NORMAN: Auto-dismiss feedback after 3 seconds
  useEffect(() => {
    if (showAIFeedback) {
      const timeout = setTimeout(() => {
        setShowAIFeedback(null);
      }, 3000);
      return () => clearTimeout(timeout);
    }
  }, [showAIFeedback]);
  
  // KRUG: Track edit time for stuck detection
  useEffect(() => {
    const activeItem = getActiveItem();
    if (activeItem && activeItem.content) {
      setLastEditTime(Date.now());
    }
  }, [project.items]);
  
  // KRUG: Optimistic save with localStorage
  useEffect(() => {
    // Debounce saving
    const timeout = setTimeout(() => {
      try {
        setSaveStatus('saving');
        localStorage.setItem('kirjoitusstudio_project', JSON.stringify(project));
        setTimeout(() => setSaveStatus('saved'), 300); // Show saving briefly
      } catch (error) {
        console.error('Save error:', error);
        setSaveStatus('error');
      }
    }, 1000); // Save 1s after last change
    
    return () => clearTimeout(timeout);
  }, [project]);
  
  // NORMAN: Save learning preferences
  useEffect(() => {
    localStorage.setItem('aiLearningPreferences', JSON.stringify(userPreferences));
  }, [userPreferences]);

  // ========== NORMAN-KRUG-NATSUME: Demo & Helper Functions ==========
  
  // Demo: Show AI Feedback (can be triggered by keyboard shortcut)
  const showDemoAIFeedback = () => {
    setShowAIFeedback({
      action: 'Rytmi tasoitettu',
      details: '12% pehme√§mpi siirtym√§',
      type: 'rhythm'
    });
  };
  
  // Demo: Show inspiration panel
  const showDemoInspiration = () => {
    const inspiration = generateInspiration('demo', project.genre);
    setInspirationData(inspiration);
    setShowInspiration(true);
  };
  
  // Add keyboard shortcut for demo (Cmd+Shift+D)
  useEffect(() => {
    const handleDemoShortcut = (e) => {
      const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
      const mod = isMac ? e.metaKey : e.ctrlKey;
      
      // Cmd+Shift+D: Demo AI Feedback
      if (mod && e.shiftKey && e.key === 'd') {
        e.preventDefault();
        showDemoAIFeedback();
      }
      
      // Cmd+Shift+I: Demo Inspiration
      if (mod && e.shiftKey && e.key === 'i') {
        e.preventDefault();
        showDemoInspiration();
      }
    };
    
    window.addEventListener('keydown', handleDemoShortcut);
    return () => window.removeEventListener('keydown', handleDemoShortcut);
  }, [project.genre]);

  // ========== VISUAL MASTERS: Effects ==========
  
  // SAGMEISTER: Track writing speed for living typography
  useEffect(() => {
    const now = Date.now();
    const timeSinceLastKey = now - lastKeystroke;
    
    // Calculate characters per second
    if (timeSinceLastKey < 2000) { // Within 2 seconds
      const cps = 1000 / timeSinceLastKey;
      // Normalize to 0-100 scale
      const normalizedSpeed = Math.min(100, cps * 20);
      setWritingSpeed(normalizedSpeed);
    } else {
      // Slow down if no typing
      setWritingSpeed(prev => Math.max(0, prev - 5));
    }
  }, [lastKeystroke]);
  
  // SAGMEISTER: Analyze emotional arc from content
  useEffect(() => {
    const activeItem = getActiveItem();
    if (!activeItem || !activeItem.content) return;
    
    const timeout = setTimeout(() => {
      const arc = analyzeEmotionalArc(activeItem.content);
      if (arc !== emotionalArc) {
        setEmotionalArc(arc);
      }
    }, 2000); // Analyze 2s after typing stops
    
    return () => clearTimeout(timeout);
  }, [project.items]);
  
  // SUPERSIDE: Detect work phase from activity
  useEffect(() => {
    const timeout = setTimeout(() => {
      const phase = detectWorkPhase(activityMetrics);
      if (phase !== workPhase) {
        setWorkPhase(phase);
      }
    }, 3000); // Check every 3s
    
    return () => clearTimeout(timeout);
  }, [activityMetrics]);
  
  // IDEO: Calculate cognitive load
  useEffect(() => {
    const activeItem = getActiveItem();
    if (!activeItem) return;
    
    const interval = setInterval(() => {
      const load = calculateCognitiveLoad({
        typingSpeed: writingSpeed,
        errorRate: 0, // Could track backspace frequency
        timeOnTask: (Date.now() - sessionStats.startTime) / 1000,
        pauseFrequency: writingSpeed < 20 ? 50 : 10
      });
      
      setCognitiveLoad(load);
    }, 5000); // Update every 5s
    
    return () => clearInterval(interval);
  }, [writingSpeed, sessionStats.startTime]);
  
  // Track keystroke for writing speed calculation
  useEffect(() => {
    const handleKeyPress = () => {
      setLastKeystroke(Date.now());
      setKeystrokeCount(prev => prev + 1);
    };
    
    window.addEventListener('keydown', handleKeyPress);
    return () => window.removeEventListener('keydown', handleKeyPress);
  }, []);

  // Vaihe 6: LocationKeeper-funktiot
  const detectLocationsInText = async () => {
    const activeItem = getActiveItem();
    if (!activeItem || !activeItem.content) {
      alert('Ei sis√§lt√∂√§ analysoitavaksi!');
      return;
    }

    setIsGenerating(true);

    const prompt = `Tunnista KAIKKI paikat t√§st√§ tekstist√§. Sis√§llyt√§ kaupungit, rakennukset, kadut, luontokohteet, maamerkit.

TEKSTI:
${activeItem.content}

Palauta VAIN JSON (ei mit√§√§n muuta teksti√§):
{
  "locations": [
    {
      "name": "paikan nimi",
      "type": "city/building/landmark/public_square/street/nature/interior",
      "city": "kaupunki jos mainittu",
      "country": "maa jos mainittu",
      "context": "lause jossa paikka mainitaan"
    }
  ]
}

Jos ei paikkoja, palauta: {"locations": []}

VASTAA PELKK√Ñ JSON.`;

    try {
      const result = await window.electronAPI.claudeAPI(prompt);
      if (result.success) {
        // Parseri JSON
        let responseText = result.data.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        const locationData = JSON.parse(responseText);

        // Lis√§√§ paikat projektiin (v√§lt√§ duplikaatit)
        const existingNames = (project.locations || []).map(l => l.name.toLowerCase());
        const newLocations = locationData.locations
          .filter(loc => !existingNames.includes(loc.name.toLowerCase()))
          .map(loc => ({
            ...LOCATION_TEMPLATE,
            id: Date.now() + Math.random(),
            name: loc.name,
            type: loc.type || 'landmark',
            city: loc.city || '',
            country: loc.country || '',
            used_in_scenes: [activeItemId]
          }));

        if (newLocations.length > 0) {
          setProject({
            ...project,
            locations: [...(project.locations || []), ...newLocations]
          });
          alert(`L√∂ydetty ${newLocations.length} uutta paikkaa!`);
        } else {
          alert('Ei uusia paikkoja l√∂ytynyt (tai kaikki jo lis√§tty).');
        }
      }
    } catch (err) {
      alert('Paikkojen tunnistus ep√§onnistui: ' + err.message);
    } finally {
      setIsGenerating(false);
    }
  };

  const fetchLocationData = async (location) => {
    setIsGenerating(true);

    try {
      // Web search - faktat
      const factsQuery = `${location.name} ${location.city} history architecture culture atmosphere`;
      const factsResult = await window.electronAPI.webSearch(factsQuery);

      // Web search - kuvat
      const imageQuery = `${location.name} ${location.city} photos`;
      const imageResult = await window.electronAPI.webSearch(imageQuery);

      // Pyyd√§ Claude analysoimaan
      const prompt = `Analysoi t√§m√§ paikka kirjailijaa varten:

PAIKKA: ${location.name} (${location.city}, ${location.country})

FAKTATIEDOT:
${JSON.stringify(factsResult)}

KUVATIEDOT:
${JSON.stringify(imageResult)}

Palauta JSON:
{
  "facts": {
    "history": "lyhyt historia",
    "architecture": ["arkkitehtuuri", "piirteit√§"],
    "features": ["keskeisi√§", "ominaisuuksia"],
    "atmosphere": ["tunnelma", "sanoja"]
  },
  "visual": {
    "colors_day": ["p√§iv√§v√§rit"],
    "colors_night": ["y√∂v√§rit"],
    "lighting": ["valaistus"],
    "textures": ["tekstuurit"]
  },
  "writing_tips": ["vinkkej√§", "kuvaukseen"]
}

VASTAA SUOMEKSI, JSON-MUODOSSA.`;

      const result = await window.electronAPI.claudeAPI(prompt);

      if (result.success) {
        let responseText = result.data.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        const analysis = JSON.parse(responseText);

        // P√§ivit√§ location
        setProject({
          ...project,
          locations: project.locations.map(loc =>
            loc.id === location.id ? {
              ...loc,
              facts: analysis.facts,
              visual: analysis.visual,
              research: {
                last_searched: new Date().toISOString(),
                facts_source: 'web_search',
                images_source: 'web_search'
              }
            } : loc
          )
        });

        // N√§yt√§ AI-avustajassa
        if (!aiAssistantOpen) setAiAssistantOpen(true);
        setAiResponse(`üìç ${location.name} - Tiedot haettu!\n\n` +
          `üìö FAKTAT:\n${JSON.stringify(analysis.facts, null, 2)}\n\n` +
          `üé® VISUAALISUUS:\n${JSON.stringify(analysis.visual, null, 2)}\n\n` +
          `üí° KIRJOITUSVINKIT:\n${analysis.writing_tips.join('\n')}`
        );

        alert('Tiedot haettu! Katso AI-avustaja.');
      }
    } catch (err) {
      alert('Tietojen haku ep√§onnistui: ' + err.message);
    } finally {
      setIsGenerating(false);
    }
  };

  const generateLocationDescription = async (location) => {
    if (!location.facts || !location.facts.history) {
      if (confirm('Paikan tiedot puuttuvat. Haetaanko ensin?')) {
        await fetchLocationData(location);
        return;
      }
    }

    setIsGenerating(true);

    const activeItem = getActiveItem();
    const context = activeItem?.content?.substring(0, 500) || '';

    const prompt = `Olet LocationKeeper - paikkojen kuvausasiantuntija.

PAIKKA:
${location.name} (${location.city}, ${location.country})

FAKTAT:
${JSON.stringify(location.facts, null, 2)}

VISUAALISET ELEMENTIT:
${JSON.stringify(location.visual, null, 2)}

KIRJAN GENRE:
${GENRE_OPTIONS.find(g => g.id === project.genre)?.name || 'Psykologinen trilleri'}

KOHTAUKSEN KONTEKSTI:
${context}

TEHT√ÑV√Ñ:
Kirjoita 2-4 kappaletta paikka-kuvausta joka:

1. **Faktatarkka**: K√§yt√§ todellisia yksityiskohtia paikasta
2. **Aistillinen**: Aktivoi n√§k√∂, kuulo, haju, tunto (ja maku jos relevantti)
3. **Genrespesifi**: Sovita tunnelma genreen (${project.genre})
4. **Tyylillinen**: K√§yt√§ defamiliarisaatiota, rytmi√§, konkretiaa
5. **Emotionaalinen**: Luo tunnelma joka tukee kohtausta

GENRE-OHJEET:
${getGenreGuidance(project.genre)}

√ÑL√Ñ:
- Listaa faktoja ("Paikalla on X ja Y")
- Kerro tunnelmaa suoraan ("Paikka oli ahdistava")
- K√§yt√§ kliseit√§
- Ylihypettele

KIRJOITA NIIN ETT√Ñ SE SOPII SUORAAN ROMAANIIN.
VASTAA SUOMEKSI.`;

    try {
      const result = await window.electronAPI.claudeAPI(prompt);

      if (result.success) {
        // Tallenna genre-spesifi kuvaus
        const updatedLocation = {
          ...location,
          genre_descriptions: {
            ...location.genre_descriptions,
            [project.genre]: result.data
          }
        };

        setProject({
          ...project,
          locations: project.locations.map(loc =>
            loc.id === location.id ? updatedLocation : loc
          )
        });

        // N√§yt√§ AI-avustajassa
        if (!aiAssistantOpen) setAiAssistantOpen(true);
        setAiResponse(result.data);
      }
    } catch (err) {
      alert('Kuvauksen generointi ep√§onnistui: ' + err.message);
    } finally {
      setIsGenerating(false);
    }
  };

  // StoryKeeper - Juonen loogisen eheyden valvonta

  // 1. TARKISTA JUONEN LOGIIKKA
  const checkStoryLogic = async () => {
    if (!project.story || !project.story.outline || project.story.outline.length === 0) {
      alert('Luo ensin tarinan rakenne!');
      return;
    }

    setIsGenerating(true);

    const prompt = `Olet StoryKeeper - juonen loogisen eheyden valvoja.

Tarkista t√§m√§n tarinan logiikka:

LUVUT:
${project.story.outline.map(ch => 
  `Luku ${ch.chapter}: ${ch.title}
  Yhteenveto: ${ch.summary || 'Ei yhteenvetoa'}
  Tapahtumat: ${ch.key_events?.length || 0}`
).join('\n\n')}

JUONILANGAT:
${(project.story.threads || []).map(t =>
  `- ${t.name} (${t.importance})
    Avattu: Luku ${t.opened_chapter || '?'}
    Tila: ${t.status === 'open' ? 'AUKI ‚ö†Ô∏è' : 'SULJETTU ‚úì'}`
).join('\n')}

TARKISTA:
1. Onko luvuissa loogisia ristiriitoja?
2. Ovatko kaikki juonilangat suljettu?
3. Onko kausaalisuus kunnossa? (A vaikuttaa B:hen)
4. Onko tempo j√§rkev√§?

VASTAA:
## ‚úÖ LOOGISESTI EHE√ÑT
[Luvut joissa ei ongelmia]

## ‚ö†Ô∏è HUOMIOITAVAA
[Pienet ep√§johdonmukaisuudet + ehdotukset]

## ‚ùå KRIITTISET RISTIRIIDAT
[Isot ongelmat + korjaukset]

## üßµ AVOIMET JUONILANGAT
[Juonilangat jotka pit√§√§ sulkea]

## üìä YHTEENVETO
[Kokonaisarvio]

VASTAA SUOMEKSI.`;

    try {
      const result = await window.electronAPI.claudeAPI(prompt);
      if (result.success) {
        if (!aiAssistantOpen) setAiAssistantOpen(true);
        setAiResponse(result.data);
      }
    } catch (err) {
      alert('Juonitarkistus ep√§onnistui: ' + err.message);
    } finally {
      setIsGenerating(false);
    }
  };

  // 2. TUNNISTA TAPAHTUMAT LUVUSTA (NYT LIS√ÑTTY!)
  const detectEventsInChapter = async (chapterNumber, text) => {
    const prompt = `Tunnista KESKEISET TAPAHTUMAT t√§st√§ luvusta.

LUKU ${chapterNumber}:
${text}

Palauta JSON:
{
  "events": [
    {
      "description": "Lyhyt kuvaus (1 lause)",
      "significance": "major/minor",
      "immutable": true/false,
      "characters_involved": ["hahmon nimi"],
      "location": "paikka"
    }
  ]
}

VAIN MERKITT√ÑV√ÑT TAPAHTUMAT (ei jokaista pient√§ toimintoa).

VASTAA PELKK√Ñ JSON.`;

    try {
      const result = await window.electronAPI.claudeAPI(prompt);
      if (result.success) {
        let responseText = result.data.replace(/\`\`\`json\n?/g, '').replace(/\`\`\`\n?/g, '').trim();
        const eventData = JSON.parse(responseText);
        
        // Lis√§√§ tapahtumat projektiin
        const newEvents = eventData.events.map(e => ({
          ...EVENT_TEMPLATE,
          id: Date.now() + Math.random(),
          chapter: chapterNumber,
          timestamp: `Luku ${chapterNumber}`,
          ...e
        }));

        setProject({
          ...project,
          story: {
            ...project.story,
            events: [...(project.story.events || []), ...newEvents]
          }
        });

        return newEvents;
      }
    } catch (err) {
      console.error('Tapahtumien tunnistus ep√§onnistui:', err);
      return [];
    }
  };

  // 3. TARKISTA NYKYISEN LUVUN MAHDOLLISUUS
  const checkChapterFeasibility = async (chapterNumber) => {
    const currentChapter = project.story.outline?.find(ch => ch.chapter === chapterNumber);
    if (!currentChapter) return;

    const previousEvents = (project.story.events || [])
      .filter(e => e.chapter < chapterNumber);

    const openThreads = (project.story.threads || [])
      .filter(t => t.status === 'open');

    const prompt = `Tarkista voiko Luku ${chapterNumber} tapahtua loogisesti.

AIKAISEMMAT TAPAHTUMAT:
${previousEvents.map(e => 
  `- Luku ${e.chapter}: ${e.description}`
).join('\n')}

SUUNNITELTU LUKU ${chapterNumber}:
Otsikko: ${currentChapter.title}
Yhteenveto: ${currentChapter.summary}

AVOIMET JUONILANGAT:
${openThreads.map(t => 
  `- ${t.name} (Avattu: Luku ${t.opened_chapter})`
).join('\n')}

TARKISTA:
1. Onko kaikki edelt√§v√§t tapahtumat olemassa?
2. Voiko t√§m√§ loogisesti tapahtua nyt?
3. Rikkooko t√§m√§ aikaisempia faktoja?
4. Pit√§isik√∂ joku juonilanka edet√§/sulkea?

VASTAA:
‚úÖ jos loogisesti mahdollinen
‚ö†Ô∏è jos pieni√§ huomioita
‚ùå jos ristiriita + ehdotukset

VASTAA SUOMEKSI.`;

    try {
      const result = await window.electronAPI.claudeAPI(prompt);
      if (result.success) {
        if (!aiAssistantOpen) setAiAssistantOpen(true);
        setAiResponse(result.data);
      }
    } catch (err) {
      alert('Tarkistus ep√§onnistui: ' + err.message);
    }
  };

  // 4. EHDOTA SEURAAVAA LUKUA
  const suggestNextChapter = async () => {
    const lastChapter = Math.max(...(project.story.outline || []).map(ch => ch.chapter), 0);

    const prompt = `Ehdota mit√§ Luku ${lastChapter + 1}:ssa voisi tapahtua.

AIKAISEMMAT LUVUT:
${(project.story.outline || []).map(ch => 
  `Luku ${ch.chapter}: ${ch.title || 'Nimet√∂n'}
  ${ch.summary || 'Ei yhteenvetoa'}`
).join('\n\n')}

AVOIMET JUONILANGAT:
${(project.story.threads || []).filter(t => t.status === 'open').map(t =>
  `- ${t.name} (${t.importance})`
).join('\n')}

GENRE: ${GENRE_OPTIONS.find(g => g.id === project.genre)?.name || 'Ei m√§√§ritelty'}

EHDOTA:
3-5 mahdollista suuntaa Luku ${lastChapter + 1}:lle jotka:
1. Jatkavat loogisesti tarinaa
2. Viev√§t juonilankaa eteenp√§in
3. Lis√§√§v√§t j√§nnitett√§
4. Sopivat genreen

VASTAA SUOMEKSI, SELKE√ÑSTI NUMEROITUNA.`;

    try {
      const result = await window.electronAPI.claudeAPI(prompt);
      if (result.success) {
        if (!aiAssistantOpen) setAiAssistantOpen(true);
        setAiResponse(result.data);
      }
    } catch (err) {
      alert('Ehdotusten generointi ep√§onnistui: ' + err.message);
    }
  };

  // APUFUNKTIO: Genre-ohjeet
  const getGenreGuidance = (genre) => {
    const guides = {
      psychological_thriller: 'Focus: Ahdistus, kontrollin menetys. Elementit: √Ñ√§net, varjot, katseet. Tone: Kylm√§, uhkaava.',
      romantic_drama: 'Focus: L√§mp√∂, intimiteetti, muistot. Elementit: Valo, v√§rit, kosketukset. Tone: Pehme√§, nostalginen.',
      action_thriller: 'Focus: Nopeus, liike, vaara. Elementit: Pakov√§yl√§t, esteet. Tone: J√§nnittynyt, dynaaminen.',
      horror: 'Focus: Ep√§todellinen, v√§√§ristynyt. Elementit: √Ñ√§net, hajut, varjot. Tone: Ahdistava, sairaalloinen.',
      noir: 'Focus: Varjot, rikkin√§isyys. Elementit: Sade, pimeys, kontrastit. Tone: Karu, kylm√§.',
      historical_fiction: 'Focus: Aika, autenttisuus. Elementit: Historialliset kerrokset. Tone: Reflektoiva, ajallinen.'
    };

    return guides[genre] || guides.psychological_thriller;
  };

  const sessionWords = sessionStats.currentWordCount - sessionStats.startWordCount;
  const progressToTarget = (getTotalWordCount() / project.targets.project) * 100;

  // Vaihe 5: CharacterKeeper - checkCharacterContinuity-funktio
  const checkCharacterContinuity = (character) => {
    const activeItem = getActiveItem();
    if (!activeItem || !activeItem.content) {
      alert('Ei sis√§lt√∂√§ tarkistettavaksi!');
      return;
    }

    // Rakenna hahmon tiedot promptiin
    const characterInfo = `
NIMI: ${character.name}
IK√Ñ: ${character.bio.age || 'ei m√§√§ritelty'}
AMMATTI: ${character.bio.occupation || 'ei m√§√§ritelty'}
TAVOITE: ${character.psychology.want || 'ei m√§√§ritelty'}
PELKO: ${character.psychology.fear || 'ei m√§√§ritelty'}
HEIKKOUS: ${character.psychology.weakness || 'ei m√§√§ritelty'}
PUHETYYLI: ${character.voice.description || 'ei m√§√§ritelty'}
TYYPILLISET FRAASIT: ${(character.voice.lexicon || []).join(', ') || 'ei m√§√§ritelty'}
RESURSSIT: ${(character.state.resources || []).join(', ') || 'ei'}
LOUKKAANTUMISET: ${(character.state.injuries || []).join(', ') || 'ei'}
`.trim();

    const prompt = `Olet CharacterKeeper - hahmojen jatkuvuuden valvoja.

Tarkista t√§m√§n hahmon jatkuvuus kohtauksessa:

${characterInfo}

KOHTAUKSEN TEKSTI:
${activeItem.content}

TARKISTA:
1. **√Ñ√§ni**: Puhuuko hahmo tyylilleen uskollisesti?
2. **Psykologia**: Ovatko teot/p√§√§t√∂kset johdonmukaisia tavoitteiden/pelkojen kanssa?
3. **Faktat**: K√§ytet√§√§nk√∂ esineit√§/taitoja joita h√§nell√§ ei ole?
4. **Loukkaantumiset**: Mainitaanko/huomioidaanko loukkaantumiset?

ANNA:
‚úÖ Mik√§ toimii hyvin
‚ö†Ô∏è Pienet ep√§johdonmukaisuudet + korjausehdotus
‚ùå Kriittiset ongelmat + konkreettinen korjaus

VASTAA SUOMEKSI.`;

    // Avaa AI-avustaja ja l√§het√§ tarkistus
    if (!aiAssistantOpen) setAiAssistantOpen(true);
    setAiPrompt(`Tarkista: ${character.name}`);
    callAIAPI(prompt, false);
  };

  // Progress Bar -komponentti
  const ProgressBar = ({ value, max, label, color = 'blue' }) => {
    const percentage = Math.min((value / max) * 100, 100);
    return e('div', { className: 'mb-3' },
      e('div', { className: 'flex justify-between text-xs mb-1' },
        e('span', null, label),
        e('span', null, `${value} / ${max} (${Math.round(percentage)}%)`)
      ),
      e('div', { className: `w-full bg-gray-700 rounded-full h-2` },
        e('div', {
          className: `bg-${color}-500 h-2 rounded-full transition-all duration-300`,
          style: { width: `${percentage}%` }
        })
      )
    );
  };

  return e(React.Fragment, null,
    // Inject FAUST styles
    e('style', { dangerouslySetInnerHTML: { __html: FAUST_STYLES } }),
    
    // ========== QUICK ACTIONS POPUP ==========
    showQuickActions && selectedText && e('div', {
      className: 'fixed z-[10001]',
      style: {
        top: '50%',
        left: '50%',
        transform: 'translate(-50%, -50%)'
      }
    },
      e('div', {
        className: 'bg-white dark:bg-gray-800 rounded-lg shadow-2xl border border-gray-200 dark:border-gray-700 p-2 flex gap-2 animate-breatheIn'
      },
        e('button', {
          onClick: () => handleQuickAction('improve'),
          className: 'px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-sm font-medium transition-colors flex flex-col items-center gap-1 min-w-[80px]',
          title: 'Paranna teksti√§ (tyyli, sujuvuus)'
        }, 
          e('span', { className: 'text-2xl' }, '‚ú®'),
          e('span', { className: 'text-xs' }, 'Paranna')
        ),
        
        e('button', {
          onClick: () => handleQuickAction('shorten'),
          className: 'px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-sm font-medium transition-colors flex flex-col items-center gap-1 min-w-[80px]',
          title: 'Lyhenn√§ teksti√§'
        },
          e('span', { className: 'text-2xl' }, 'üìè'),
          e('span', { className: 'text-xs' }, 'Lyhenn√§')
        ),
        
        e('button', {
          onClick: () => handleQuickAction('expand'),
          className: 'px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-sm font-medium transition-colors flex flex-col items-center gap-1 min-w-[80px]',
          title: 'Laajenna teksti√§ (lis√§√§ yksityiskohtia)'
        },
          e('span', { className: 'text-2xl' }, 'üìñ'),
          e('span', { className: 'text-xs' }, 'Laajenna')
        ),
        
        e('button', {
          onClick: () => handleQuickAction('fix'),
          className: 'px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-sm font-medium transition-colors flex flex-col items-center gap-1 min-w-[80px]',
          title: 'Korjaa kielioppi ja tyylvirheet'
        },
          e('span', { className: 'text-2xl' }, '‚úÖ'),
          e('span', { className: 'text-xs' }, 'Korjaa')
        ),
        
        e('button', {
          onClick: () => setShowQuickActions(false),
          className: 'px-3 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-sm transition-colors flex items-center justify-center',
          title: 'Sulje'
        },
          e('span', { className: 'text-xl' }, '√ó')
        )
      ),
      
      // N√§yt√§ valitun tekstin alku
      selectedText.length > 100 && e('div', {
        className: 'mt-2 px-3 py-2 bg-gray-100 dark:bg-gray-900 rounded text-xs opacity-70 max-w-md'
      }, `"${selectedText.substring(0, 100)}..."`)
    ),
    
    // Main App
    e('div', {
      className: 'h-screen flex flex-col',
      style: {
        background: 'var(--faust-bg-primary)',
        color: 'var(--faust-text-primary)',
        fontFamily: 'var(--font-body)'
      },
      'data-theme': isDarkMode ? 'dark' : 'light'
    },
    // üúç FAUST Titlebar with Traffic Lights
    e('header', {
      className: 'fixed top-0 left-0 right-0 h-[52px] flex items-center justify-between px-4 z-50',
      style: {
        background: 'var(--faust-bg-secondary)',
        borderBottom: '1px solid var(--faust-border)',
        WebkitAppRegion: 'drag'
      }
    },
      // Traffic Lights (macOS window controls)
      e('div', {
        className: 'flex gap-2',
        style: { WebkitAppRegion: 'no-drag' }
      },
        e('button', {
          className: 'w-3 h-3 rounded-full hover:opacity-80 transition-opacity',
          style: { background: '#ff5f56' },
          onClick: () => window.close?.(),
          'aria-label': 'Close',
          title: 'Close'
        }),
        e('button', {
          className: 'w-3 h-3 rounded-full hover:opacity-80 transition-opacity',
          style: { background: '#ffbd2e' },
          onClick: () => window.minimize?.(),
          'aria-label': 'Minimize',
          title: 'Minimize'
        }),
        e('button', {
          className: 'w-3 h-3 rounded-full hover:opacity-80 transition-opacity',
          style: { background: '#27c93f' },
          onClick: () => window.maximize?.(),
          'aria-label': 'Fullscreen',
          title: 'Fullscreen'
        })
      ),
      
      // Title (center)
      e('div', {
        className: 'absolute left-1/2 -translate-x-1/2 text-sm font-medium flex items-center gap-2',
        style: { color: 'var(--mac-text-primary)', WebkitAppRegion: 'no-drag' }
      },
        e(Icons.Book, { className: 'w-4 h-4' }),
        e('input', {
          value: project.title,
          onChange: (ev) => setProject({ ...project, title: ev.target.value }),
          className: 'bg-transparent border-none outline-none text-center font-medium',
          style: { color: 'var(--mac-text-primary)' },
          placeholder: 'Nimet√∂n projekti'
        })
      ),
      
      // Toolbar Controls (right)
      e('div', {
        className: 'flex items-center gap-3',
        style: { WebkitAppRegion: 'no-drag' }
      },
        // Word count badge
        e('div', {
          className: 'px-3 py-1 rounded text-xs font-mono tabular-nums',
          style: {
            background: 'rgba(255,255,255,0.05)',
            color: 'var(--mac-text-secondary)'
          }
        }, `${getTotalWordCount()} sanaa`),
        
        // NATSUME: Flow Mode Switcher
        e('div', { className: 'flex items-center gap-1 px-2 py-1 rounded', style: { background: 'rgba(255,255,255,0.05)' } },
          e('button', {
            className: `px-2 py-1 rounded text-xs transition-all ${flowMode === 'normal' ? 'bg-[var(--mac-accent-blue)] text-white' : 'hover:bg-[rgba(255,255,255,0.05)]'}`,
            onClick: () => setFlowMode('normal'),
            title: 'Normal Mode'
          }, '‚úçÔ∏è'),
          e('button', {
            className: `px-2 py-1 rounded text-xs transition-all ${flowMode === 'focus' ? 'bg-[var(--mac-accent-blue)] text-white' : 'hover:bg-[rgba(255,255,255,0.05)]'}`,
            onClick: () => setFlowMode('focus'),
            title: 'Focus Mode - Minimaal distraktiota'
          }, 'üéØ'),
          e('button', {
            className: `px-2 py-1 rounded text-xs transition-all ${flowMode === 'rhythm' ? 'bg-[var(--mac-accent-purple)] text-white' : 'hover:bg-[rgba(255,255,255,0.05)]'}`,
            onClick: () => setFlowMode('rhythm'),
            title: 'Rhythm Mode - Tekstin rytmin analyysi'
          }, 'üéµ'),
          e('button', {
            className: `px-2 py-1 rounded text-xs transition-all ${flowMode === 'review' ? 'bg-[var(--mac-accent-green)] text-white' : 'hover:bg-[rgba(255,255,255,0.05)]'}`,
            onClick: () => setFlowMode('review'),
            title: 'Review Mode - Tarkistus ja korjaus'
          }, 'üîç')
        ),
        
        // üúç FAUST Mode toggle: DEIS ‚áÑ NOX
        e('button', {
          className: 'w-8 h-8 rounded flex items-center justify-center transition-colors sigil',
          style: { background: 'rgba(255,255,255,0.05)' },
          onClick: () => setIsDarkMode(!isDarkMode),
          title: isDarkMode ? 'üúï DEIS - p√§iv√§n mieli' : 'üåë NOX - y√∂n mieli'
        }, isDarkMode ? e(Icons.Sun, { className: 'w-4 h-4' }) : e(Icons.Moon, { className: 'w-4 h-4' })),
        
        // Sidebar toggle
        e('button', {
          className: 'w-8 h-8 rounded flex items-center justify-center hover:bg-[rgba(255,255,255,0.08)] transition-colors',
          onClick: () => setShowSidebar(!showSidebar),
          title: 'Toggle Sidebar (Cmd+B)'
        }, e(Icons.Menu, { className: 'w-5 h-5' })),
        
        // Inspector toggle
        e('button', {
          className: 'w-8 h-8 rounded flex items-center justify-center hover:bg-[rgba(255,255,255,0.08)] transition-colors',
          onClick: () => setShowInspector(!showInspector),
          title: 'Toggle Inspector (Cmd+Option+I)'
        }, showInspector ? e(Icons.EyeOff, { className: 'w-5 h-5' }) : e(Icons.Eye, { className: 'w-5 h-5' }))
      )
    ),

    // Main content area (below titlebar)
    // NATSUME + SAGMEISTER: Flow-transition + emotional arc background
    e('div', { 
      className: `flex flex-1 overflow-hidden flow-transition mode-${flowMode} tone-${emotionalTone}`, 
      style: { 
        marginTop: '52px',
        background: EMOTIONAL_COLOR_ARCS[emotionalArc]?.background || EMOTIONAL_COLOR_ARCS.neutral.background,
        transition: 'background 2s ease-in-out'
      } 
    },
      // Sidebar - macOS Source List with NORMAN Writer-Centric Navigation
      showSidebar && e('aside', {
        className: 'w-60 overflow-y-auto',
        style: {
          background: 'var(--mac-bg-secondary)',
          borderRight: '1px solid rgba(255,255,255,0.05)'
        }
      },
        e('div', { className: 'p-2' },
          // NORMAN: Writer-Centric Navigation Menu
          e('div', { className: 'mb-4 pb-4 border-b border-[rgba(255,255,255,0.05)]' },
            e('div', {
              className: 'text-[10px] font-semibold uppercase tracking-wide px-3 py-2',
              style: { color: 'var(--mac-text-tertiary)' }
            }, 'KIRJOITTAJAN TY√ñTILA'),
            
            // TARINA (Story) Section
            e('button', {
              className: 'w-full px-3 py-2 rounded flex items-center gap-2 hover:bg-[rgba(255,255,255,0.05)] transition-colors text-sm',
              style: { color: 'var(--mac-text-primary)' },
              title: 'Tarina: Luvut, juonilangat, tapahtumat'
            },
              e('span', null, 'üìñ'),
              e('span', null, 'Tarina')
            ),
            
            // MAAILMA (World) Section
            e('button', {
              className: 'w-full px-3 py-2 rounded flex items-center gap-2 hover:bg-[rgba(255,255,255,0.05)] transition-colors text-sm',
              onClick: () => setShowCharacterSheet(true),
              style: { color: 'var(--mac-text-primary)' },
              title: 'Maailma: Hahmot, paikat, aikajana'
            },
              e('span', null, 'üåç'),
              e('span', null, 'Maailma'),
              e('span', { className: 'ml-auto text-xs opacity-50' }, `${project.characters?.length || 0}`)
            ),
            
            // TY√ñKALUT (Tools) Section
            e('button', {
              className: 'w-full px-3 py-2 rounded flex items-center gap-2 hover:bg-[rgba(255,255,255,0.05)] transition-colors text-sm',
              onClick: () => setAiAssistantOpen(true),
              style: { color: 'var(--mac-text-primary)' },
              title: 'Ty√∂kalut: Tekniikat, analyysi, AI-apu'
            },
              e('span', null, '‚ú®'),
              e('span', null, 'AI-Ty√∂kalut')
            )
          ),
          
          // Original file tree section
          e('div', {
            className: 'px-3 py-2 flex items-center justify-between',
            style: { color: 'var(--mac-text-tertiary)' }
          },
            e('div', {
              className: 'text-[11px] font-semibold uppercase tracking-wide'
            }, 'TIEDOSTOT'),
            e('button', {
              onClick: () => addItem(1, 'chapter'),
              className: 'w-5 h-5 rounded flex items-center justify-center hover:bg-[rgba(255,255,255,0.08)] transition-colors',
              title: 'Lis√§√§ luku'
            }, e(Icons.Plus, { className: 'w-3 h-3' }))
          ),
          renderTree(project.items)
        )
      ),

      // Collections Panel - macOS Source List
      showCollectionsPanel && e('aside', {
        className: 'w-60 overflow-y-auto',
        style: {
          background: 'var(--mac-bg-secondary)',
          borderRight: '1px solid rgba(255,255,255,0.05)'
        }
      },
        e('div', { className: 'p-2' },
          // Section header
          e('div', {
            className: 'px-3 py-2 flex items-center justify-between',
            style: { color: 'var(--mac-text-tertiary)' }
          },
            e('div', {
              className: 'text-[11px] font-semibold uppercase tracking-wide'
            }, 'KOKOELMAT'),
            e('button', {
              onClick: createCollection,
              className: 'w-5 h-5 rounded flex items-center justify-center hover:bg-[rgba(255,255,255,0.08)] transition-colors',
              title: 'Luo kokoelma'
            }, e(Icons.Plus, { className: 'w-3 h-3' }))
          ),
          (project.collections || []).length === 0
            ? e('div', {
                className: 'text-xs text-center py-4',
                style: { color: 'var(--mac-text-tertiary)' }
              }, 'Ei kokoelmia')
            : (project.collections || []).map(collection =>
                e('button', {
                  key: collection.id,
                  className: 'w-full flex items-center gap-2 px-3 py-2 rounded-md text-sm transition-all cursor-pointer',
                  style: {
                    background: 'transparent',
                    color: 'var(--mac-text-primary)'
                  },
                  onMouseEnter: (e) => {
                    e.currentTarget.style.background = 'rgba(255,255,255,0.05)';
                  },
                  onMouseLeave: (e) => {
                    e.currentTarget.style.background = 'transparent';
                  }
                },
                  e(Icons.Collection, { className: 'w-4 h-4' }),
                  e('div', { className: 'flex-1 text-left' },
                    e('div', { className: 'font-medium' }, collection.name),
                    e('div', {
                      className: 'text-[11px]',
                      style: { color: 'var(--mac-text-tertiary)' }
                    }, `${collection.itemIds.length} dokumenttia`)
                  )
                )
              )
        )
      ),

      // Editor - Vaihe 3: Compose Mode & Split View
      e('main', {
        className: `flex-1 overflow-hidden ${composeMode ? 'bg-gray-900' : ''}`,
        style: composeMode ? {
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          zIndex: 9999
        } : {}
      },
        viewMode === 'editor' && (
          composeMode ? (
            // Compose Mode - H√§iri√∂t√∂n kirjoitustila
            e('div', {
              className: 'h-full flex items-center justify-center p-8',
              style: {
                background: isDarkMode ? '#111827' : '#f9fafb',
                color: isDarkMode ? '#f9fafb' : '#111827'
              }
            },
              e('div', {
                className: 'w-full max-w-4xl',
                style: typewriterMode ? {
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  justifyContent: 'center',
                  height: '100%'
                } : {}
              },
                typewriterMode && e('div', {
                  className: 'text-center mb-8',
                  style: { fontSize: '14px', opacity: 0.7 }
                }, `${getActiveItem()?.title || 'Nimet√∂n dokumentti'} ‚Ä¢ ${getActiveItem()?.wordCount || 0} sanaa`),

                e('textarea', {
                  ref: editorRef,
                  defaultValue: getActiveItem()?.content || '',
                  onChange: (ev) => updateItem(activeItemId, { content: ev.target.value }),
                  onMouseUp: handleTextSelection,
                  onKeyUp: handleTextSelection,
                  placeholder: 'Aloita kirjoittaminen...',
                  className: `w-full resize-none outline-none ${
                    isDarkMode
                      ? 'bg-transparent text-gray-100 placeholder-gray-600'
                      : 'bg-transparent text-gray-900 placeholder-gray-400'
                  }`,
                  style: {
                    fontFamily: fontOptions.find(f => f.id === editorFont)?.family || 'serif',
                    fontSize: `${fontSize}px`,
                    lineHeight: lineHeight,
                    ...(typewriterMode ? {
                      textAlign: 'center',
                      minHeight: '60vh'
                    } : {
                      minHeight: '80vh'
                    })
                  }
                })
              )
            )
          ) : splitView && splitViewItem ? (
            // Split View - Kaksi dokumenttia vierekk√§in
            e('div', { className: 'flex h-full' },
              // Vasen paneeli (aktiivinen dokumentti)
              e('div', { className: 'flex-1 border-r border-gray-700 overflow-y-auto' },
                e('div', { className: 'max-w-4xl mx-auto p-8' },
                  e('div', { className: 'mb-4' },
                    e('input', {
                      value: getActiveItem()?.title || '',
                      onChange: (ev) => updateItem(activeItemId, { title: ev.target.value }),
                      className: `text-2xl font-bold w-full bg-transparent border-b-2 border-transparent hover:border-blue-500 focus:border-blue-500 outline-none mb-2 ${
                        isDarkMode ? 'text-white' : 'text-gray-900'
                      }`
                    }),
                    e('div', { className: 'text-sm opacity-60' }, `${getActiveItem()?.wordCount || 0} sanaa`)
                  ),
                  e('textarea', {
                    ref: editorRef,
                    defaultValue: getActiveItem()?.content || '',
                    onChange: (ev) => updateItem(activeItemId, { content: ev.target.value }),
                    onMouseUp: handleTextSelection,
                    onKeyUp: handleTextSelection,
                    placeholder: 'Aloita kirjoittaminen...',
                    className: `w-full min-h-[600px] p-6 rounded-lg border-2 resize-none outline-none ${
                      isDarkMode
                        ? 'bg-gray-800 border-gray-700 text-gray-100 placeholder-gray-600'
                        : 'bg-white border-gray-200 text-gray-900 placeholder-gray-400'
                    }`,
                    style: {
                      fontFamily: fontOptions.find(f => f.id === editorFont)?.family || 'serif',
                      fontSize: `${fontSize}px`,
                      lineHeight: lineHeight
                    }
                  })
                )
              ),

              // Oikea paneeli (toinen dokumentti)
              e('div', { className: 'flex-1 overflow-y-auto' },
                e('div', { className: 'max-w-4xl mx-auto p-8' },
                  e('div', { className: 'mb-4' },
                    e('input', {
                      value: splitViewItem.title || '',
                      onChange: (ev) => updateItem(splitViewItem.id, { title: ev.target.value }),
                      className: `text-2xl font-bold w-full bg-transparent border-b-2 border-transparent hover:border-blue-500 focus:border-blue-500 outline-none mb-2 ${
                        isDarkMode ? 'text-white' : 'text-gray-900'
                      }`
                    }),
                    e('div', { className: 'text-sm opacity-60' }, `${splitViewItem.wordCount || 0} sanaa`)
                  ),
                  e('textarea', {
                    defaultValue: splitViewItem.content || '',
                    onChange: (ev) => updateItem(splitViewItem.id, { content: ev.target.value }),
                    placeholder: 'Aloita kirjoittaminen...',
                    className: `w-full min-h-[600px] p-6 rounded-lg border-2 resize-none outline-none ${
                      isDarkMode
                        ? 'bg-gray-800 border-gray-700 text-gray-100 placeholder-gray-600'
                        : 'bg-white border-gray-200 text-gray-900 placeholder-gray-400'
                    }`,
                    style: {
                      fontFamily: fontOptions.find(f => f.id === editorFont)?.family || 'serif',
                      fontSize: `${fontSize}px`,
                      lineHeight: lineHeight
                    }
                  })
                )
              )
            )
          ) : (
            // Normaali editori
            e('div', { className: 'max-w-4xl mx-auto p-8' },
              e('div', { className: 'mb-4' },
                e('input', {
                  value: getActiveItem()?.title || '',
                  onChange: (ev) => updateItem(activeItemId, { title: ev.target.value }),
                  className: `text-2xl font-bold w-full bg-transparent border-b-2 border-transparent hover:border-blue-500 focus:border-blue-500 outline-none mb-2 ${
                    isDarkMode ? 'text-white' : 'text-gray-900'
                  }`
                }),
                e('div', { className: 'text-sm opacity-60' }, `${getActiveItem()?.wordCount || 0} sanaa`)
              ),
              e('textarea', {
                ref: editorRef,
                defaultValue: getActiveItem()?.content || '',
                onChange: (ev) => updateItem(activeItemId, { content: ev.target.value }),
                placeholder: 'Aloita kirjoittaminen...',
                className: `w-full min-h-[600px] p-6 rounded-lg border-2 resize-none outline-none ${
                  isDarkMode
                    ? 'bg-gray-800 border-gray-700 text-gray-100 placeholder-gray-600'
                    : 'bg-white border-gray-200 text-gray-900 placeholder-gray-400'
                }`,
                style: {
                  fontFamily: fontOptions.find(f => f.id === editorFont)?.family || 'serif',
                  fontSize: `${fontSize}px`,
                  lineHeight: lineHeight
                }
              })
            )
          )
        )
      ),

      // Inspector - macOS style
      showInspector && e('aside', {
        className: 'w-80 flex flex-col',
        style: {
          background: 'var(--mac-bg-secondary)',
          borderLeft: '1px solid rgba(255,255,255,0.05)'
        }
      },
        // Inspector tabs - macOS style
        e('div', {
          className: 'flex border-b overflow-x-auto',
          style: {
            borderColor: 'rgba(255,255,255,0.05)',
            scrollbarWidth: 'none'
          }
        },
          ['notes', 'metadata', 'characters', 'locations', 'story', 'grimoire', 'contextus', 'tekniikat'].map(tab => {
            const isActive = inspectorTab === tab;
            const tabLabel = tab === 'notes' ? 'Muistiinpanot' : 
                           tab === 'metadata' ? 'Metatiedot' : 
                           tab === 'characters' ? 'Hahmot' :
                           tab === 'locations' ? 'Paikat' :
                           tab === 'story' ? 'Tarina' :
                           tab === 'grimoire' ? 'üúç Grimoire' :
                           tab === 'contextus' ? 'üúç Contextus' :
                           'Tekniikat';
            
            return e('button', {
              key: tab,
              onClick: () => setInspectorTab(tab),
              className: 'flex-1 min-w-fit px-4 py-3 text-sm font-medium relative transition-colors',
              style: {
                background: 'transparent',
                border: 'none',
                color: isActive ? 'var(--mac-text-primary)' : 'var(--mac-text-secondary)',
                cursor: 'pointer'
              },
              onMouseEnter: (e) => {
                if (!isActive) e.currentTarget.style.color = 'var(--mac-text-primary)';
              },
              onMouseLeave: (e) => {
                if (!isActive) e.currentTarget.style.color = 'var(--mac-text-secondary)';
              }
            }, 
              tabLabel,
              isActive && e('div', {
                className: 'absolute bottom-0 left-0 right-0 h-0.5 rounded-t',
                style: { background: 'var(--mac-accent-blue)' }
              })
            );
          })
        ),
        
        // Inspector content
        e('div', { className: 'flex-1 overflow-y-auto p-4 space-y-4' },

          inspectorTab === 'notes' && e('div', null,
            e('h4', { className: 'text-sm font-semibold mb-2' }, 'Dokumentin muistiinpanot'),
            e('textarea', {
              value: getActiveItem()?.notes || '',
              onChange: (ev) => updateItem(activeItemId, { notes: ev.target.value }),
              placeholder: 'Kirjoita muistiinpanoja t√§h√§n...',
              className: `w-full h-40 p-3 rounded border resize-none ${
                isDarkMode ? 'bg-gray-900 border-gray-700 text-white' : 'bg-gray-50 border-gray-200 text-gray-900'
              }`,
              style: {
                fontFamily: fontOptions.find(f => f.id === editorFont)?.family || 'serif',
                fontSize: `${Math.max(fontSize - 2, 12)}px`,
                lineHeight: lineHeight
              }
            })
          ),

          inspectorTab === 'metadata' && e('div', { className: 'space-y-3' },
            e('div', null,
              e('label', { className: 'text-sm font-semibold block mb-1' }, 'Tila'),
              e('select', {
                value: getActiveItem()?.status || 'draft',
                onChange: (ev) => updateItem(activeItemId, { status: ev.target.value }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700 text-white' : 'bg-white border-gray-200 text-gray-900'
                }`
              }, statusOptions.map(opt => e('option', { key: opt.value, value: opt.value }, opt.label)))
            ),
            e('div', null,
              e('label', { className: 'text-sm font-semibold block mb-1' }, 'Merkint√§'),
              e('select', {
                value: getActiveItem()?.label || 'none',
                onChange: (ev) => updateItem(activeItemId, { label: ev.target.value }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700 text-white' : 'bg-white border-gray-200 text-gray-900'
                }`
              }, LABEL_COLORS.map(label => e('option', { key: label.id, value: label.id }, label.name)))
            )
          ),

          inspectorTab === 'snapshots' && e('div', null,
            e('h4', { className: 'text-sm font-semibold mb-2' }, 'Tilannekuvat'),
            (getActiveItem()?.snapshots || []).length === 0
              ? e('div', { className: 'text-xs opacity-50 text-center py-4' }, 'Ei tilannekuvia')
              : (getActiveItem()?.snapshots || []).map(snapshot =>
                  e('div', {
                    key: snapshot.id,
                    className: `p-3 mb-2 rounded border ${
                      isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'
                    }`
                  },
                    e('div', { className: 'flex items-start justify-between mb-2' },
                      e('div', { className: 'flex-1' },
                        e('div', { className: 'text-sm font-medium' }, snapshot.title),
                        e('div', { className: 'text-xs opacity-75' }, `${snapshot.wordCount} sanaa`)
                      ),
                      e('div', { className: 'flex gap-1' },
                        e('button', {
                          onClick: () => restoreSnapshot(snapshot),
                          className: 'text-xs px-2 py-1 rounded bg-blue-500 text-white hover:bg-blue-600',
                          title: 'Palauta'
                        }, '‚Ü∫'),
                        e('button', {
                          onClick: () => deleteSnapshot(snapshot.id),
                          className: 'text-xs px-2 py-1 rounded bg-red-500 text-white hover:bg-red-600',
                          title: 'Poista'
                        }, '√ó')
                      )
                    )
                  )
                )
          ),

          inspectorTab === 'targets' && e('div', { className: 'space-y-4' },
            e('h4', { className: 'text-sm font-semibold mb-3' }, 'Kirjoitustavoitteet'),

            // Istunnon edistyminen
            e('div', { className: 'p-3 rounded border ' + (isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200') },
              e('h5', { className: 'text-xs font-medium mb-2 opacity-75' }, 'Nykyinen istunto'),
              ProgressBar({
                value: sessionStats.wordsWritten,
                max: targets.session,
                label: 'Istuntotavoite',
                color: 'green'
              }),
              e('div', { className: 'text-xs opacity-75 mt-2' },
                `Kesto: ${Math.floor(sessionStats.duration / 60)} min | `,
                `Nopeus: ${Math.round(sessionStats.wordsWritten / (sessionStats.duration / 60) || 0)} sanaa/min`
              )
            ),

            // P√§iv√§tavoite
            e('div', { className: 'p-3 rounded border ' + (isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200') },
              e('h5', { className: 'text-xs font-medium mb-2 opacity-75' }, 'P√§iv√§tavoite'),
              ProgressBar({
                value: dailyStats.words,
                max: targets.daily,
                label: 'P√§iv√§n sanat',
                color: 'blue'
              })
            ),

            // Projektitavoite
            e('div', { className: 'p-3 rounded border ' + (isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200') },
              e('h5', { className: 'text-xs font-medium mb-2 opacity-75' }, 'Projektin edistyminen'),
              ProgressBar({
                value: getTotalWordCount(),
                max: targets.project,
                label: 'Kokonaissanam√§√§r√§',
                color: 'purple'
              }),
              e('div', { className: 'text-xs opacity-75 mt-2' },
                `J√§ljell√§: ${targets.project - getTotalWordCount()} sanaa | `,
                `Arvioitu valmis: ${Math.ceil((targets.project - getTotalWordCount()) / targets.daily)} p√§iv√§ss√§`
              )
            ),

            // Tavoitteiden muokkaus
            e('div', { className: 'p-3 rounded border ' + (isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200') },
              e('h5', { className: 'text-xs font-medium mb-2 opacity-75' }, 'Muokkaa tavoitteita'),
              e('div', { className: 'space-y-2' },
                e('input', {
                  type: 'number',
                  value: targets.session,
                  onChange: (ev) => setTargets({...targets, session: parseInt(ev.target.value)}),
                  className: 'w-full p-2 rounded border text-sm ' + (isDarkMode ? 'bg-gray-800 border-gray-600' : 'bg-white border-gray-300'),
                  placeholder: 'Istuntotavoite'
                }),
                e('input', {
                  type: 'number',
                  value: targets.daily,
                  onChange: (ev) => setTargets({...targets, daily: parseInt(ev.target.value)}),
                  className: 'w-full p-2 rounded border text-sm ' + (isDarkMode ? 'bg-gray-800 border-gray-600' : 'bg-white border-gray-300'),
                  placeholder: 'P√§iv√§tavoite'
                }),
                e('input', {
                  type: 'number',
                  value: targets.project,
                  onChange: (ev) => setTargets({...targets, project: parseInt(ev.target.value)}),
                  className: 'w-full p-2 rounded border text-sm ' + (isDarkMode ? 'bg-gray-800 border-gray-600' : 'bg-white border-gray-300'),
                  placeholder: 'Projektitavoite'
                })
              )
            )
          ),

          inspectorTab === 'appearance' && e('div', { className: 'space-y-4' },
            e('h4', { className: 'text-sm font-semibold mb-3' }, 'Ulkoasu'),

            // Fontti valinta
            e('div', { className: 'space-y-2' },
              e('label', { className: 'text-xs font-medium opacity-75' }, 'Fontti'),
              e('select', {
                value: editorFont,
                onChange: (ev) => setEditorFont(ev.target.value),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-200'
                }`
              }, fontOptions.map(font =>
                e('option', { key: font.id, value: font.id }, font.name)
              ))
            ),

            // Fonttikoko
            e('div', { className: 'space-y-2' },
              e('label', { className: 'text-xs font-medium opacity-75' }, `Fonttikoko: ${fontSize}px`),
              e('input', {
                type: 'range',
                min: 12,
                max: 32,
                value: fontSize,
                onChange: (ev) => setFontSize(parseInt(ev.target.value)),
                className: 'w-full'
              }),
              e('div', { className: 'flex justify-between text-xs opacity-50' },
                e('span', null, '12px'),
                e('span', null, '32px')
              )
            ),

            // Riviv√§li
            e('div', { className: 'space-y-2' },
              e('label', { className: 'text-xs font-medium opacity-75' }, `Riviv√§li: ${lineHeight}`),
              e('input', {
                type: 'range',
                min: 1,
                max: 3,
                step: 0.1,
                value: lineHeight,
                onChange: (ev) => setLineHeight(parseFloat(ev.target.value)),
                className: 'w-full'
              }),
              e('div', { className: 'flex justify-between text-xs opacity-50' },
                e('span', null, 'Tiukka'),
                e('span', null, 'V√§lj√§')
              )
            ),

            // Esikatselu
            e('div', {
              className: `p-4 rounded border ${
                isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'
              }`
            },
              e('h5', { className: 'text-xs font-medium mb-2 opacity-75' }, 'Esikatselu'),
              e('p', {
                style: {
                  fontFamily: fontOptions.find(f => f.id === editorFont)?.family,
                  fontSize: `${fontSize}px`,
                  lineHeight: lineHeight
                }
              }, 'T√§m√§ on esimerkkiteksti. N√§et milt√§ valitsemasi fontti n√§ytt√§√§ kirjoittaessa. Lorem ipsum dolor sit amet, consectetur adipiscing elit.')
            ),

            // Kirjoitustila vaihtoehdot
            e('div', { className: 'space-y-2 pt-4 border-t ' + (isDarkMode ? 'border-gray-700' : 'border-gray-200') },
              e('h5', { className: 'text-xs font-medium mb-2 opacity-75' }, 'Kirjoitustila'),

              e('label', { className: 'flex items-center gap-2 text-sm' },
                e('input', {
                  type: 'checkbox',
                  checked: typewriterMode || false,
                  onChange: (ev) => setTypewriterMode(ev.target.checked)
                }),
                'Typewriter scrolling'
              ),

              e('label', { className: 'flex items-center gap-2 text-sm' },
                e('input', {
                  type: 'checkbox',
                  checked: focusMode || false,
                  onChange: (ev) => setFocusMode(ev.target.checked)
                }),
                'Focus mode (korostaa nykyist√§ kappaletta)'
              ),

              e('label', { className: 'flex items-center gap-2 text-sm' },
                e('input', {
                  type: 'checkbox',
                  checked: showWordCount || true,
                  onChange: (ev) => setShowWordCount(ev.target.checked)
                }),
                'N√§yt√§ sanam√§√§r√§'
              )
            )
          ),

          // HAHMOT-v√§lilehti - CharacterKeeper
          inspectorTab === 'characters' && e('div', { className: 'space-y-3' },
            e('div', { className: 'flex items-center justify-between mb-3' },
              e('h4', { className: 'text-sm font-semibold flex items-center gap-2' },
                e('span', null, 'üë• Hahmot'),
                e('span', { className: 'text-xs opacity-50 font-normal' },
                  `${project.characters?.length || 0} hahmoa`)
              ),
              e('button', {
                onClick: () => {
                  const newChar = {
                    ...CHARACTER_TEMPLATE,
                    id: Date.now(),
                    name: 'Uusi hahmo'
                  };
                  setProject({
                    ...project,
                    characters: [...(project.characters || []), newChar]
                  });
                },
                className: 'px-2 py-1 text-xs rounded bg-blue-500 text-white hover:bg-blue-600'
              }, '+ Lis√§√§ hahmo')
            ),
            
            // Automaattinen valvonta toggle
            e('div', { className: 'px-3 py-2 rounded bg-[var(--mac-bg-tertiary)] border border-[rgba(255,255,255,0.1)]' },
              e('label', { className: 'flex items-center gap-2 cursor-pointer' },
                e('input', {
                  type: 'checkbox',
                  checked: autoCheckEnabled,
                  onChange: (ev) => setAutoCheckEnabled(ev.target.checked),
                  className: 'w-4 h-4'
                }),
                e('div', { className: 'flex-1' },
                  e('div', { className: 'text-xs font-medium' }, '‚öôÔ∏è Automaattinen valvonta'),
                  e('div', { className: 'text-[10px] opacity-60 mt-0.5' }, 
                    'Tarkistaa jatkuvuuden automaattisesti kirjoituksen aikana')
                )
              ),
              inlineWarnings.length > 0 && e('div', { className: 'mt-2 pt-2 border-t border-[rgba(255,255,255,0.1)]' },
                e('div', { className: 'text-xs font-medium text-yellow-500 mb-1' }, 
                  `‚ö†Ô∏è ${inlineWarnings.length} varoitus${inlineWarnings.length > 1 ? 'ta' : ''}`),
                ...inlineWarnings.map((warning, i) =>
                  e('div', { key: i, className: 'text-[10px] opacity-70 mt-1' }, `‚Ä¢ ${warning}`)
                )
              )
            ),

            // Hahmolista
            (project.characters || []).length === 0 ?
              e('div', { className: 'text-xs opacity-50 text-center py-8' },
                'Ei hahmoja. Luo ensimm√§inen hahmo!') :

              (project.characters || []).map(char =>
                e('div', {
                  key: char.id,
                  className: `p-3 rounded border mb-2 ${
                    isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'
                  }`
                },
                  // Hahmon nimi
                  e('div', { className: 'flex items-center justify-between mb-2' },
                    e('input', {
                      value: char.name,
                      onChange: (ev) => {
                        setProject({
                          ...project,
                          characters: project.characters.map(c =>
                            c.id === char.id ? { ...c, name: ev.target.value } : c
                          )
                        });
                      },
                      className: `font-medium text-sm bg-transparent border-b border-transparent hover:border-blue-500 focus:border-blue-500 outline-none ${
                        isDarkMode ? 'text-white' : 'text-gray-900'
                      }`,
                      placeholder: 'Hahmon nimi'
                    }),
                    e('button', {
                      onClick: () => {
                        if (confirm(`Poista hahmo "${char.name}"?`)) {
                          setProject({
                            ...project,
                            characters: project.characters.filter(c => c.id !== char.id)
                          });
                        }
                      },
                      className: 'text-red-500 hover:text-red-600'
                    }, e(Icons.Trash))
                  ),

                  // Pika-info
                  e('div', { className: 'text-xs space-y-1 opacity-75 mb-2' },
                    char.bio.age && e('div', null, `üìÖ ${char.bio.age} vuotta`),
                    char.bio.occupation && e('div', null, `üíº ${char.bio.occupation}`),
                    char.psychology.want && e('div', null, `üéØ Haluaa: ${char.psychology.want}`)
                  ),

                  // Toimintopainikkeet
                  e('div', { className: 'flex gap-1 mt-2' },
                    e('button', {
                      onClick: () => {
                        // Avaa CharacterSheet -modaali
                        setEditingCharacter(char);
                        setShowCharacterSheet(true);
                      },
                      className: 'flex-1 px-2 py-1 text-xs rounded bg-blue-500 text-white hover:bg-blue-600'
                    }, '‚úèÔ∏è Muokkaa'),

                    e('button', {
                      onClick: () => {
                        // Tarkista hahmo nykyisess√§ dokumentissa
                        checkCharacterContinuity(char);
                      },
                      className: 'flex-1 px-2 py-1 text-xs rounded bg-purple-500 text-white hover:bg-purple-600',
                      title: 'Tarkista jatkuvuus'
                    }, 'üîç Tarkista')
                  )
                )
              )
          ),
          
          // PAIKAT-v√§lilehti (LocationKeeper)
          inspectorTab === 'locations' && e('div', { className: 'space-y-3' },
            e('div', { className: 'text-sm opacity-75 mb-2' }, 'üìç Locations tab - Moved to correct order')
          ),
          
          // TARINA-v√§lilehti (StoryKeeper)
          inspectorTab === 'story' && e('div', { className: 'space-y-3' },
            e('div', { className: 'text-sm opacity-75 mb-2' }, 'üìñ Story tab - Moved to correct order')
          ),
          
          // üúç GRIMOIRE-v√§lilehti (Projektin oppimismuisti)
          inspectorTab === 'grimoire' && e('div', { className: 'space-y-3' },
            // Info-laatikko
            e('div', { className: `p-3 rounded border text-xs mb-4 ${isDarkMode ? 'bg-amber-900/20 border-amber-700' : 'bg-amber-50 border-amber-300'}` },
              e('div', { className: 'font-medium mb-1 flex items-center gap-2' },
                e('span', null, 'üúç GRIMOIRE'),
                e('span', { className: 'opacity-75 font-normal' }, '- Projektin oppimismuisti')
              ),
              e('div', { className: 'opacity-75' }, 
                'Grimoire tallentaa kaikki AI:n kanssa k√§ydyt keskustelut, tyylivalidit, hyl√§tyt ja hyv√§ksytyt ehdotukset. AI oppii mit√§ haluat ja mit√§ ET halua.')
            ),
            
            // Tilastot
            e('div', { className: 'grid grid-cols-2 gap-2 mb-4' },
              e('div', { className: `p-3 rounded border ${isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'}` },
                e('div', { className: 'text-2xl font-bold text-blue-500' }, project.grimoire.totalInteractions || 0),
                e('div', { className: 'text-xs opacity-75' }, 'AI-keskustelua')
              ),
              e('div', { className: `p-3 rounded border ${isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'}` },
                e('div', { className: 'text-2xl font-bold text-green-500' }, project.grimoire.acceptances?.length || 0),
                e('div', { className: 'text-xs opacity-75' }, 'Hyv√§ksytty√§')
              ),
              e('div', { className: `p-3 rounded border ${isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'}` },
                e('div', { className: 'text-2xl font-bold text-red-500' }, project.grimoire.rejections?.length || 0),
                e('div', { className: 'text-xs opacity-75' }, 'Hyl√§tty√§')
              ),
              e('div', { className: `p-3 rounded border ${isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'}` },
                e('div', { className: 'text-2xl font-bold text-purple-500' }, project.grimoire.styleRules?.length || 0),
                e('div', { className: 'text-xs opacity-75' }, 'Tyylis√§√§nt√∂√§')
              )
            ),
            
            // Projektin √§√§ni
            e('div', { className: `p-3 rounded border ${isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'}` },
              e('div', { className: 'text-xs font-semibold opacity-75 mb-2' }, 'PROJEKTIN √Ñ√ÑNI'),
              e('div', { className: 'text-xs space-y-1' },
                e('div', null,
                  e('span', { className: 'opacity-60' }, 'S√§vy: '),
                  e('span', { className: 'font-medium' }, project.grimoire.projectVoice?.tone || 'Ei m√§√§ritelty')
                ),
                e('div', null,
                  e('span', { className: 'opacity-60' }, 'N√§k√∂kulma: '),
                  e('span', { className: 'font-medium' }, project.grimoire.projectVoice?.perspective || 'Ei m√§√§ritelty')
                ),
                e('div', null,
                  e('span', { className: 'opacity-60' }, 'Aikamuoto: '),
                  e('span', { className: 'font-medium' }, project.grimoire.projectVoice?.tense || 'Ei m√§√§ritelty')
                )
              )
            ),
            
            // Viimeisimm√§t hyl√§tyt ehdotukset
            (project.grimoire.rejections?.length || 0) > 0 && e('div', { className: `p-3 rounded border ${isDarkMode ? 'bg-red-900/20 border-red-700' : 'bg-red-50 border-red-300'}` },
              e('div', { className: 'text-xs font-semibold opacity-75 mb-2' }, 'VIIMEISIMM√ÑT HYL√ÑTYT EHDOTUKSET'),
              e('div', { className: 'space-y-2' },
                project.grimoire.rejections.slice(-5).reverse().map((rejection, idx) =>
                  e('div', { key: idx, className: 'text-xs border-b border-red-700/20 pb-2' },
                    e('div', { className: 'font-medium mb-1' }, `"${rejection.original?.substring(0, 30)}..."`),
                    e('div', { className: 'opacity-75' }, `‚Üí "${rejection.suggestion?.substring(0, 30)}..."`),
                    rejection.reason && e('div', { className: 'text-[10px] opacity-60 mt-1' }, `Syy: ${rejection.reason}`)
                  )
                )
              )
            ),
            
            // Viimeisimm√§t hyv√§ksytyt muutokset
            (project.grimoire.acceptances?.length || 0) > 0 && e('div', { className: `p-3 rounded border ${isDarkMode ? 'bg-green-900/20 border-green-700' : 'bg-green-50 border-green-300'}` },
              e('div', { className: 'text-xs font-semibold opacity-75 mb-2' }, 'VIIMEISIMM√ÑT HYV√ÑKSYTYT MUUTOKSET'),
              e('div', { className: 'space-y-2' },
                project.grimoire.acceptances.slice(-3).reverse().map((acceptance, idx) =>
                  e('div', { key: idx, className: 'text-xs border-b border-green-700/20 pb-2' },
                    e('div', { className: 'opacity-75' }, `"${acceptance.original?.substring(0, 30)}..."`),
                    e('div', { className: 'font-medium mb-1' }, `‚Üí "${acceptance.modified?.substring(0, 30)}..."`),
                    acceptance.context && e('div', { className: 'text-[10px] opacity-60 mt-1' }, acceptance.context)
                  )
                )
              )
            )
          ),
          
          // üúç CONTEXTUS-v√§lilehti (Hierarkkinen konteksti)
          inspectorTab === 'contextus' && e('div', { className: 'space-y-3' },
            // Info-laatikko
            e('div', { className: `p-3 rounded border text-xs mb-4 ${isDarkMode ? 'bg-blue-900/20 border-blue-700' : 'bg-blue-50 border-blue-300'}` },
              e('div', { className: 'font-medium mb-1 flex items-center gap-2' },
                e('span', null, 'üúç CONTEXTUS'),
                e('span', { className: 'opacity-75 font-normal' }, '- Hierarkkinen kontekstinhallinta')
              ),
              e('div', { className: 'opacity-75' }, 
                'Contextus pit√§√§ kirjaa projektin kokonaiskuvasta, lukujen tiivistelmist√§, hahmojen tiloista ja juonen kausaalisuudesta. AI muistaa koko 300,000 sanan romaanin.')
            ),
            
            // Globaali metadata
            e('div', { className: `p-3 rounded border ${isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'}` },
              e('div', { className: 'text-xs font-semibold opacity-75 mb-2' }, 'PROJEKTIN YLEISKUVA'),
              e('div', { className: 'space-y-2 text-xs' },
                e('div', null,
                  e('label', { className: 'block text-[10px] opacity-60 mb-1' }, 'Synopsis (200 sanaa):'),
                  e('textarea', {
                    value: project.contextus.global.synopsis || '',
                    onChange: (ev) => setProject({
                      ...project,
                      contextus: {
                        ...project.contextus,
                        global: {
                          ...project.contextus.global,
                          synopsis: ev.target.value
                        }
                      }
                    }),
                    className: `w-full p-2 rounded border text-xs ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-300'}`,
                    rows: 4,
                    placeholder: 'Kuvaa projektisi p√§√§juoni 200 sanassa...'
                  })
                ),
                e('div', null,
                  e('label', { className: 'block text-[10px] opacity-60 mb-1' }, 'Teemat (pilkulla eroteltu):'),
                  e('input', {
                    type: 'text',
                    value: project.contextus.global.themes?.join(', ') || '',
                    onChange: (ev) => setProject({
                      ...project,
                      contextus: {
                        ...project.contextus,
                        global: {
                          ...project.contextus.global,
                          themes: ev.target.value.split(',').map(t => t.trim()).filter(Boolean)
                        }
                      }
                    }),
                    className: `w-full p-2 rounded border text-xs ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-300'}`,
                    placeholder: 'esim. petos, anteeksianto, perhe'
                  })
                ),
                e('div', { className: 'grid grid-cols-2 gap-2' },
                  e('div', null,
                    e('label', { className: 'block text-[10px] opacity-60 mb-1' }, 'N√§k√∂kulma:'),
                    e('input', {
                      type: 'text',
                      value: project.contextus.global.pov || '',
                      onChange: (ev) => setProject({
                        ...project,
                        contextus: {
                          ...project.contextus,
                          global: {
                            ...project.contextus.global,
                            pov: ev.target.value
                          }
                        }
                      }),
                      className: `w-full p-2 rounded border text-xs ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-300'}`,
                      placeholder: '3. persoon limited'
                    })
                  ),
                  e('div', null,
                    e('label', { className: 'block text-[10px] opacity-60 mb-1' }, 'Aikamuoto:'),
                    e('input', {
                      type: 'text',
                      value: project.contextus.global.tense || '',
                      onChange: (ev) => setProject({
                        ...project,
                        contextus: {
                          ...project.contextus,
                          global: {
                            ...project.contextus.global,
                            tense: ev.target.value
                          }
                        }
                      }),
                      className: `w-full p-2 rounded border text-xs ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-300'}`,
                      placeholder: 'Preesens'
                    })
                  )
                )
              )
            ),
            
            // Lukujen tiivistelm√§t
            e('div', { className: `p-3 rounded border ${isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'}` },
              e('div', { className: 'text-xs font-semibold opacity-75 mb-2 flex items-center justify-between' },
                e('span', null, 'LUKUJEN TIIVISTELM√ÑT'),
                e('span', { className: 'font-normal opacity-60' }, `${project.contextus.chapterSummaries?.length || 0} lukua`)
              ),
              (project.contextus.chapterSummaries?.length || 0) === 0 ?
                e('div', { className: 'text-xs opacity-50 text-center py-4' }, 'Ei lukujen tiivistelmi√§ viel√§.') :
                e('div', { className: 'space-y-2' },
                  project.contextus.chapterSummaries.slice(0, 5).map((summary, idx) =>
                    e('div', { key: idx, className: 'text-xs border-b border-gray-700/20 pb-2' },
                      e('div', { className: 'font-medium' }, `Luku ${summary.chapter}`),
                      e('div', { className: 'opacity-75 mt-1' }, summary.summary_short || 'Ei tiivistelm√§√§')
                    )
                  )
                )
            ),
            
            // Hahmojen tilat
            e('div', { className: `p-3 rounded border ${isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'}` },
              e('div', { className: 'text-xs font-semibold opacity-75 mb-2 flex items-center justify-between' },
                e('span', null, 'HAHMOJEN TILAT'),
                e('span', { className: 'font-normal opacity-60' }, `${project.contextus.characterStates?.length || 0} tilaa`)
              ),
              (project.contextus.characterStates?.length || 0) === 0 ?
                e('div', { className: 'text-xs opacity-50 text-center py-4' }, 'Ei hahmojen tiloja tallennettuna.') :
                e('div', { className: 'space-y-2' },
                  // Hae viimeisimm√§t tilat kullekin hahmolle
                  Object.entries(
                    (project.contextus.characterStates || []).reduce((acc, state) => {
                      if (!acc[state.character] || state.chapter > acc[state.character].chapter) {
                        acc[state.character] = state;
                      }
                      return acc;
                    }, {})
                  ).slice(0, 5).map(([charName, state], idx) =>
                    e('div', { key: idx, className: 'text-xs border-b border-gray-700/20 pb-2' },
                      e('div', { className: 'font-medium' }, charName),
                      e('div', { className: 'opacity-75 mt-1' },
                        state.state?.physical?.location && `üìç ${state.state.physical.location}`,
                        state.state?.mental?.primary_emotion && ` ‚Ä¢ üí≠ ${state.state.mental.primary_emotion}`
                      )
                    )
                  )
                )
            ),
            
            // Juonilangat
            e('div', { className: `p-3 rounded border ${isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'}` },
              e('div', { className: 'text-xs font-semibold opacity-75 mb-2 flex items-center justify-between' },
                e('span', null, 'JUONILANGAT'),
                e('span', { className: 'font-normal opacity-60' }, `${project.contextus.plotThreads?.length || 0} lankaa`)
              ),
              (project.contextus.plotThreads?.length || 0) === 0 ?
                e('div', { className: 'text-xs opacity-50 text-center py-4' }, 'Ei juonilankoja m√§√§riteltyn√§.') :
                e('div', { className: 'space-y-2' },
                  project.contextus.plotThreads.slice(0, 5).map((thread, idx) => {
                    const progress = calculateThreadProgress(thread.arc);
                    return e('div', { key: idx, className: 'text-xs border-b border-gray-700/20 pb-2' },
                      e('div', { className: 'font-medium flex items-center justify-between' },
                        e('span', null, thread.name),
                        e('span', { className: 'text-[10px] opacity-60' }, `${Math.round(progress * 100)}%`)
                      ),
                      e('div', { className: 'mt-1 h-1 bg-gray-700 rounded-full overflow-hidden' },
                        e('div', {
                          className: 'h-full bg-blue-500',
                          style: { width: `${progress * 100}%` }
                        })
                      )
                    );
                  })
                )
            )
          ),
          
          // TEKNIIKAT-v√§lilehti
          inspectorTab === 'tekniikat' && e('div', { className: 'space-y-3' },
            // Info-laatikko
            e('div', { className: `p-3 rounded border text-xs mb-4 ${isDarkMode ? 'bg-purple-900/20 border-purple-700' : 'bg-purple-50 border-purple-300'}` },
              e('div', { className: 'font-medium mb-1' }, 'üí° Kuinka k√§ytt√§√§:'),
              e('div', { className: 'opacity-75' }, 'Valitse tekniikka ‚Üí Claude analysoi aktiivisen dokumentin ja soveltaa valitsemaasi tekniikkaa. Tulos ilmestyy AI-avustajaan.')
            ),
            
            // Tekniikkakategoriat
            Object.entries(WRITING_TECHNIQUES).map(([categoryKey, category]) =>
              e('div', { key: categoryKey, className: `p-3 rounded border mb-3 ${isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'}` },
                e('h5', { className: 'text-xs font-bold mb-2 text-' + category.color + '-500' }, category.title),
                
                category.techniques.map(technique =>
                  e('button', {
                    key: technique.id,
                    onClick: () => {
                      // K√§yt√§ tekniikkaa nykyiseen sis√§lt√∂√∂n
                      const activeItem = getActiveItem();
                      const prompt = technique.prompt
                        .replace(/\$\{getActiveItem\(\)\?\.content \|\| '\[Ei sis√§lt√∂√§\]'\}/g, activeItem?.content || '[Ei sis√§lt√∂√§]')
                        .replace('{characterList}', project.characters?.map(char => `
- ${char.name} (${char.bio.age || '?'}v, ${char.bio.occupation || 'ammatti?'})
  Tavoite: ${char.psychology.want || '?'}
  Pelko: ${char.psychology.fear || '?'}
  Puhetyyli: ${char.voice.description || '?'}
`).join('\n') || 'Ei hahmoja m√§√§riteltyn√§')
                        .replace('{selectedCharacter}', editingCharacter ? `${editingCharacter.name} (${editingCharacter.bio.age || '?'}v)` : 'Ei valittua hahmoa')
                        .replace('{voiceDescription}', editingCharacter?.voice?.description || 'Ei m√§√§ritelty')
                        .replace('{lexicon}', editingCharacter?.voice?.lexicon?.join(', ') || 'Ei m√§√§ritelty')
                        .replace('{avgSentenceLength}', editingCharacter?.voice?.avgSentenceLength || '12')
                        .replace('{want}', editingCharacter?.psychology?.want || 'Ei m√§√§ritelty')
                        .replace('{fear}', editingCharacter?.psychology?.fear || 'Ei m√§√§ritelty')
                        .replace('{weakness}', editingCharacter?.psychology?.weakness || 'Ei m√§√§ritelty')
                        .replace('{values}', editingCharacter?.psychology?.values?.join(', ') || 'Ei m√§√§ritelty')
                        .replace('{resources}', editingCharacter?.state?.resources?.join(', ') || 'Ei m√§√§ritelty')
                        .replace('{injuries}', editingCharacter?.state?.injuries?.join(', ') || 'Ei m√§√§ritelty')
                        .replace('{appearance}', editingCharacter?.bio?.appearance || 'Ei m√§√§ritelty')
                        .replace('{beliefs}', JSON.stringify(editingCharacter?.state?.beliefs || {}));

                      if (!aiAssistantOpen) setAiAssistantOpen(true);
                      setAiPrompt(`${technique.name}: ${technique.description}`);
                      callAIAPI(prompt, false);
                    },
                    className: `w-full text-left p-2 mb-2 rounded text-xs transition-colors ${
                      isDarkMode ? 'bg-gray-800 hover:bg-gray-700' : 'bg-white hover:bg-gray-100'
                    }`,
                    title: technique.description
                  },
                    e('div', { className: 'font-medium mb-0.5' }, technique.name),
                    e('div', { className: 'opacity-75 text-[10px]' }, technique.description)
                  )
                )
              )
            )
          )
        )
      ),

      // Vaihe 5: Tekniikat-paneeli
      e('aside', {
        className: `w-80 border-l overflow-y-auto ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`
      },
        e('div', { className: 'p-4 space-y-4' },
          e('div', { className: 'flex items-center justify-between' },
            e('div', { className: 'flex items-center gap-2' },
              e('span', { className: 'text-lg' }, 'üé®'), 
                  `${project.locations?.length || 0} paikkaa`)
              ),
              e('button', {
                onClick: () => detectLocationsInText(),
                className: 'px-2 py-1 text-xs rounded bg-purple-500 text-white hover:bg-purple-600',
                title: 'Tunnista paikat automaattisesti',
                disabled: isGenerating
              }, 'üîç Tunnista')
            ),

            // Genre-valinta
            e('div', { className: 'mb-3' },
              e('label', { className: 'text-xs block mb-1 opacity-75' }, 'Kirjan genre'),
              e('select', {
                value: project.genre || 'psychological_thriller',
                onChange: (ev) => setProject({ ...project, genre: ev.target.value }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-200'
                }`
              }, GENRE_OPTIONS.map(g => e('option', { key: g.id, value: g.id }, `${g.icon} ${g.name}`)))
            ),

            // Paikkalista
            (project.locations || []).length === 0 ? 
              e('div', { className: 'text-xs opacity-50 text-center py-8' }, 
                'Ei paikkoja. Klikkaa "Tunnista" tai lis√§√§ manuaalisesti.') :
              
              (project.locations || []).map(loc =>
                e('div', {
                  key: loc.id,
                  className: `p-3 rounded border mb-2 ${
                    isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'
                  }`
                },
                  // Paikan nimi ja tyyppi
                  e('div', { className: 'flex items-start justify-between mb-2' },
                    e('div', { className: 'flex-1' },
                      e('div', { className: 'font-medium text-sm mb-1' },
                        LOCATION_TYPES.find(t => t.id === loc.type)?.icon || 'üìç',
                        ' ',
                        loc.name
                      ),
                      loc.city && e('div', { className: 'text-xs opacity-75' },
                        `${loc.city}${loc.country ? `, ${loc.country}` : ''}`
                      )
                    ),
                    e('button', {
                      onClick: () => {
                        if (confirm(`Poista paikka "${loc.name}"?`)) {
                          setProject({
                            ...project,
                            locations: project.locations.filter(l => l.id !== loc.id)
                          });
                        }
                      },
                      className: 'text-red-500 hover:text-red-600'
                    }, e(Icons.Trash))
                  ),

                  // Stats
                  e('div', { className: 'text-xs opacity-75 mb-2' },
                    `K√§ytetty: ${loc.used_in_scenes?.length || 0} kohtausta`,
                    loc.genre_descriptions && Object.keys(loc.genre_descriptions).length > 0 &&
                      ` ‚Ä¢ ${Object.keys(loc.genre_descriptions).length} kuvausta`
                  ),

                  // Toiminnot
                  e('div', { className: 'flex gap-1 mt-2 flex-wrap' },
                    e('button', {
                      onClick: () => {
                        setEditingLocation(loc);
                        setShowLocationSheet(true);
                      },
                      className: 'px-2 py-1 text-xs rounded bg-blue-500 text-white hover:bg-blue-600'
                    }, '‚úèÔ∏è Muokkaa'),
                    
                    e('button', {
                      onClick: () => fetchLocationData(loc),
                      disabled: isGenerating,
                      className: `px-2 py-1 text-xs rounded ${
                        isGenerating 
                          ? 'bg-gray-600 cursor-not-allowed' 
                          : 'bg-green-500 text-white hover:bg-green-600'
                      }`
                    }, 'üîç Hae tiedot'),
                    
                    e('button', {
                      onClick: () => generateLocationDescription(loc),
                      disabled: isGenerating,
                      className: `px-2 py-1 text-xs rounded ${
                        isGenerating 
                          ? 'bg-gray-600 cursor-not-allowed' 
                          : 'bg-purple-500 text-white hover:bg-purple-600'
                      }`
                    }, '‚úçÔ∏è Generoi kuvaus')
                  )
                )
              ),

            // Lis√§√§ paikka manuaalisesti
            e('button', {
              onClick: () => {
                const newLoc = {
                  ...LOCATION_TEMPLATE,
                  id: Date.now(),
                  name: 'Uusi paikka'
                };
                setProject({
                  ...project,
                  locations: [...(project.locations || []), newLoc]
                });
              },
              className: 'w-full px-3 py-2 text-sm rounded border-2 border-dashed hover:bg-gray-700 transition-colors',
              style: { borderColor: isDarkMode ? '#4b5563' : '#d1d5db' }
            }, '+ Lis√§√§ paikka manuaalisesti')
          ),
          
          // TARINA-v√§lilehti (StoryKeeper)
          inspectorTab === 'story' && e('div', { className: 'space-y-3' },
            // Header
            e('div', { className: 'flex items-center justify-between mb-3' },
              e('h4', { className: 'text-sm font-semibold flex items-center gap-2' },
                e('span', null, 'üìñ Tarina'),
                e('span', { className: 'text-xs opacity-50 font-normal' }, 
                  `${project.story?.outline?.length || 0} lukua`)
              ),
              e('button', {
                onClick: () => checkStoryLogic(),
                disabled: isGenerating,
                className: `px-2 py-1 text-xs rounded ${
                  isGenerating 
                    ? 'bg-gray-600 cursor-not-allowed' 
                    : 'bg-purple-500 text-white hover:bg-purple-600'
                }`,
                title: 'Tarkista juonen logiikka'
              }, 'üîç Tarkista juoni')
            ),

            // Lukujen lista
            e('div', { className: 'space-y-2' },
              e('div', { className: 'text-xs font-semibold opacity-75 mb-1' }, 'LUVUT'),
              
              (project.story?.outline || []).length === 0 ?
                e('div', { className: 'text-xs opacity-50 text-center py-4' },
                  'Ei lukuja. Luo tarinan rakenne.') :
                
                (project.story.outline || []).map((chapter, idx) =>
                  e('div', {
                    key: idx,
                    className: `p-2 rounded border text-xs ${
                      chapter.status === 'completed' 
                        ? (isDarkMode ? 'bg-green-900/20 border-green-700' : 'bg-green-50 border-green-300')
                        : chapter.status === 'in_progress'
                        ? (isDarkMode ? 'bg-blue-900/20 border-blue-700' : 'bg-blue-50 border-blue-300')
                        : (isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200')
                    }`
                  },
                    e('div', { className: 'flex items-start justify-between mb-1' },
                      e('div', { className: 'flex-1' },
                        e('div', { className: 'font-medium' },
                          `${chapter.chapter}. ${chapter.title || 'Nimet√∂n luku'}`
                        ),
                        chapter.summary && e('div', { className: 'opacity-75 mt-1' }, 
                          chapter.summary.substring(0, 60) + (chapter.summary.length > 60 ? '...' : '')
                        )
                      ),
                      e('div', { className: 'flex gap-1' },
                        chapter.status === 'completed' && e('span', { title: 'Valmis' }, '‚úì'),
                        chapter.status === 'in_progress' && e('span', { title: 'Kirjoitetaan' }, '‚úçÔ∏è'),
                        chapter.status === 'not_started' && e('span', { title: 'Ei aloitettu', className: 'opacity-50' }, '‚óã')
                      )
                    ),
                    
                    chapter.key_events && chapter.key_events.length > 0 && 
                      e('div', { className: 'mt-1 opacity-75' },
                        `${chapter.key_events.length} tapahtumaa`
                      ),
                    
                    e('button', {
                      onClick: () => {
                        setEditingChapter(chapter);
                        setShowChapterSheet(true);
                      },
                      className: 'mt-2 px-2 py-1 text-xs rounded bg-blue-500 text-white hover:bg-blue-600'
                    }, '‚úèÔ∏è Muokkaa')
                  )
                )
            ),

            // Lis√§√§ luku
            e('button', {
              onClick: () => {
                const newChapter = {
                  ...CHAPTER_TEMPLATE,
                  chapter: (project.story.outline?.length || 0) + 1
                };
                setProject({
                  ...project,
                  story: {
                    ...project.story,
                    outline: [...(project.story.outline || []), newChapter]
                  }
                });
              },
              className: 'w-full px-3 py-2 text-sm rounded border-2 border-dashed hover:bg-gray-700 transition-colors',
              style: { borderColor: isDarkMode ? '#4b5563' : '#d1d5db' }
            }, '+ Lis√§√§ luku'),

            // JUONILANGAT
            e('div', { className: 'mt-4' },
              e('div', { className: 'text-xs font-semibold opacity-75 mb-2 flex items-center justify-between' },
                e('span', null, 'JUONILANGAT'),
                e('button', {
                  onClick: () => {
                    const newThread = {
                      ...THREAD_TEMPLATE,
                      id: Date.now(),
                      name: 'Uusi juonilanka'
                    };
                    setProject({
                      ...project,
                      story: {
                        ...project.story,
                        threads: [...(project.story.threads || []), newThread]
                      }
                    });
                  },
                  className: 'px-2 py-1 text-xs rounded bg-blue-500 text-white hover:bg-blue-600'
                }, '+')
              ),

              (project.story?.threads || []).length === 0 ?
                e('div', { className: 'text-xs opacity-50 text-center py-2' },
                  'Ei juonilankoja') :
                
                (project.story.threads || []).map(thread =>
                  e('div', {
                    key: thread.id,
                    className: `p-2 rounded border text-xs mb-2 ${
                      thread.status === 'closed'
                        ? (isDarkMode ? 'bg-green-900/20 border-green-700' : 'bg-green-50 border-green-300')
                        : thread.importance === 'major'
                        ? (isDarkMode ? 'bg-red-900/20 border-red-700' : 'bg-red-50 border-red-300')
                        : (isDarkMode ? 'bg-yellow-900/20 border-yellow-700' : 'bg-yellow-50 border-yellow-300')
                    }`
                  },
                    e('div', { className: 'flex items-start justify-between' },
                      e('div', { className: 'flex-1' },
                        e('div', { className: 'font-medium flex items-center gap-1' },
                          thread.importance === 'major' ? 'üî¥' : 
                          thread.importance === 'minor' ? 'üü°' : '‚ö™',
                          thread.name
                        ),
                        e('div', { className: 'opacity-75 mt-1' },
                          thread.status === 'open' 
                            ? `Avattu: Luku ${thread.opened_chapter || '?'}` 
                            : `Suljettu: Luku ${thread.closed_chapter}`
                        )
                      ),
                      e('div', { className: 'flex gap-1' },
                        e('button', {
                          onClick: () => {
                            setEditingThread(thread);
                            setShowThreadSheet(true);
                          },
                          className: 'px-2 py-1 text-xs rounded bg-blue-500 text-white hover:bg-blue-600',
                          title: 'Muokkaa'
                        }, '‚úèÔ∏è'),
                        thread.status === 'open' && e('button', {
                          onClick: () => {
                            setProject({
                              ...project,
                              story: {
                                ...project.story,
                                threads: project.story.threads.map(t =>
                                  t.id === thread.id 
                                    ? { ...t, status: 'closed', closed_chapter: getActiveItem()?.metadata?.chapter || '?' }
                                    : t
                                )
                              }
                            });
                          },
                          className: 'px-2 py-1 text-xs rounded bg-green-600 hover:bg-green-700 text-white',
                          title: 'Merkitse suljetuksi'
                        }, '‚úì')
                      )
                    )
                  )
                )
            )
          )
        )
      ),

      // Vaihe 5: Tekniikat-paneeli
      e('aside', {
        className: `w-80 border-l overflow-y-auto ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`
      },
        e('div', { className: 'p-4 space-y-4' },
          e('div', { className: 'flex items-center justify-between' },
            e('div', { className: 'flex items-center gap-2' },
              e('span', { className: 'text-lg' }, 'üé®'),
              e('h3', { className: 'font-semibold' }, 'Kirjoitustekniikat')
            ),
            e('button', {
              onClick: () => setAiAssistantOpen(false),
              className: 'p-1 rounded hover:bg-gray-700'
            }, e(Icons.X))
          ),

          // Tekniikkakategoriat
          Object.entries(WRITING_TECHNIQUES).map(([categoryKey, category]) =>
            e('div', { key: categoryKey, className: 'space-y-2' },
              e('h4', { className: 'text-sm font-medium opacity-75' }, category.title),
              e('div', { className: 'grid grid-cols-1 gap-1' },
                category.techniques.map(technique =>
                  e('button', {
                    key: technique.id,
                    onClick: () => {
                      // K√§yt√§ tekniikkaa nykyiseen sis√§lt√∂√∂n
                      const prompt = technique.prompt
                        .replace('{characterList}', project.characters?.map(char => `
- ${char.name} (${char.bio.age || '?'}v, ${char.bio.occupation || 'ammatti?'})
  Tavoite: ${char.psychology.want || '?'}
  Pelko: ${char.psychology.fear || '?'}
  Puhetyyli: ${char.voice.description || '?'}
`).join('\n') || 'Ei hahmoja m√§√§riteltyn√§')
                        .replace('{selectedCharacter}', editingCharacter ? `${editingCharacter.name} (${editingCharacter.bio.age || '?'}v)` : 'Ei valittua hahmoa')
                        .replace('{voiceDescription}', editingCharacter?.voice?.description || 'Ei m√§√§ritelty')
                        .replace('{lexicon}', editingCharacter?.voice?.lexicon?.join(', ') || 'Ei m√§√§ritelty')
                        .replace('{avgSentenceLength}', editingCharacter?.voice?.avgSentenceLength || '12')
                        .replace('{want}', editingCharacter?.psychology?.want || 'Ei m√§√§ritelty')
                        .replace('{fear}', editingCharacter?.psychology?.fear || 'Ei m√§√§ritelty')
                        .replace('{weakness}', editingCharacter?.psychology?.weakness || 'Ei m√§√§ritelty')
                        .replace('{values}', editingCharacter?.psychology?.values?.join(', ') || 'Ei m√§√§ritelty')
                        .replace('{resources}', editingCharacter?.state?.resources?.join(', ') || 'Ei m√§√§ritelty')
                        .replace('{injuries}', editingCharacter?.state?.injuries?.join(', ') || 'Ei m√§√§ritelty')
                        .replace('{appearance}', editingCharacter?.bio?.appearance || 'Ei m√§√§ritelty')
                        .replace('{beliefs}', JSON.stringify(editingCharacter?.state?.beliefs || {}));

                      if (!aiAssistantOpen) setAiAssistantOpen(true);
                      setAiPrompt(`${technique.name}: ${technique.description}`);
                      callAIAPI(prompt, false);
                    },
                    className: `w-full text-left p-2 rounded text-xs transition-colors ${
                      isDarkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-50 hover:bg-gray-100'
                    }`,
                    title: technique.description
                  }, technique.name)
                )
              )
            )
          )
        )
      ),

      // AI Assistant
      aiAssistantOpen && e('aside', {
        className: `w-96 border-l overflow-y-auto ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`
      },
        e('div', { className: 'p-4 space-y-4' },
          e('div', { className: 'flex items-center justify-between' },
            e('div', { className: 'flex items-center gap-2' },
              e(Icons.Sparkles, { className: 'w-5 h-5 text-purple-500' }),
              e('h3', { className: 'font-semibold' }, 'AI-avustaja')
            ),
            e('button', { onClick: () => setAiAssistantOpen(false), className: 'p-1 rounded hover:bg-gray-700' }, e(Icons.X))
          ),
          e('div', null,
            e('h4', { className: 'text-sm font-medium mb-2 opacity-75' }, 'AI-palvelu'),
            e('select', {
              value: selectedAIApi,
              onChange: (ev) => setSelectedAIApi(ev.target.value),
              className: `w-full p-2 mb-3 rounded border text-sm ${
                isDarkMode ? 'bg-gray-900 border-gray-700 text-white' : 'bg-white border-gray-200 text-gray-900'
              }`
            }, [
              e('option', { key: 'claude', value: 'claude' }, 'Claude (Anthropic)'),
              e('option', { key: 'grok', value: 'grok' }, 'Grok (xAI)'),
              e('option', { key: 'openai', value: 'openai' }, 'OpenAI (GPT-4)'),
              e('option', { key: 'cursor', value: 'cursor' }, 'Cursor')
            ]),
            e('h4', { className: 'text-sm font-medium mb-2 opacity-75' }, 'Pikatoiminnot'),
            e('div', { className: 'grid grid-cols-2 gap-2' },
              aiPrompts.map((item, idx) =>
                e('button', {
                  key: idx,
                  onClick: () => { setAiPrompt(item.prompt); callAIAPI(item.prompt, true); },
                  disabled: isGenerating,
                  className: `p-2 text-xs rounded border transition-colors ${
                    isDarkMode ? 'border-gray-700 hover:bg-gray-700' : 'border-gray-200 hover:bg-gray-50'
                  } ${isGenerating ? 'opacity-50' : ''}`
                }, item.label)
              )
            )
          ),
          e('div', null,
            e('h4', { className: 'text-sm font-medium mb-2 opacity-75' }, 'Oma pyynt√∂'),
            e('textarea', {
              value: aiPrompt,
              onChange: (ev) => setAiPrompt(ev.target.value),
              placeholder: 'Kysy Claudelta mit√§ tahansa...',
              className: `w-full h-24 p-3 rounded border resize-none text-sm ${
                isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'
              }`
            }),
            e('button', {
              onClick: () => callAIAPI(aiPrompt, true),
              disabled: isGenerating || !aiPrompt.trim(),
              className: `w-full mt-2 px-4 py-2 rounded font-medium flex items-center justify-center gap-2 ${
                isGenerating || !aiPrompt.trim()
                  ? 'bg-gray-600 text-gray-400 cursor-not-allowed'
                  : 'bg-purple-600 text-white hover:bg-purple-700'
              }`
            }, isGenerating ? [e(Icons.Loader), ' Luodaan...'] : 'Luo vastaus')
          ),
          
          // LAAJAT MUUTOKSET: Nappi koko tarinan muokkaamiseen
          e('div', { className: 'mt-4 pt-4 border-t border-gray-700' },
            e('h4', { className: 'text-sm font-medium mb-2 opacity-75' }, 'üìö Laajat muutokset'),
            e('p', { className: 'text-xs opacity-60 mb-2' }, 'Muokkaa koko tarinaa kerralla (kaikki luvut)'),
            e('button', {
              onClick: () => {
                const change = prompt('Kuvaile haluamasi muutos koko tarinaan:\n\nEsim: "Muuta p√§√§henkil√∂ Annasta Matiksi kaikissa luvuissa"\nEsim: "Lis√§√§ enemm√§n j√§nnityst√§ luvuissa 3-5"\nEsim: "Muuta tapahtumapaikka Helsingist√§ Tampereelle"');
                if (change) {
                  requestStoryWideChange(change);
                }
              },
              disabled: isGenerating,
              className: `w-full px-3 py-2 rounded text-sm font-medium transition-colors ${
                isGenerating
                  ? 'bg-gray-600 text-gray-400 cursor-not-allowed'
                  : 'bg-orange-600 text-white hover:bg-orange-700'
              }`
            }, 'üîÑ Muokkaa koko tarinaa')
          ),
          aiResponse && e('div', {
            className: `p-4 rounded border ${isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'}`
          },
            e('div', { className: 'flex items-center justify-between mb-2' },
              e('h4', { className: 'text-sm font-medium' }, 'Vastaus'),
              e('div', { className: 'flex gap-2' },
                // Korvaa valinta -nappi (n√§kyy kun teksti valittu)
                selectedText && e('button', {
                  onClick: () => insertAiResponse('replace-selection'),
                  className: 'text-xs px-3 py-1 rounded bg-blue-600 text-white hover:bg-blue-700',
                  title: 'Korvaa valittu teksti t√§ll√§ vastauksella'
                }, '‚Ü∫ Korvaa valinta'),
                
                // Dropdown menu
                e('div', { className: 'relative' },
                  e('button', {
                    onClick: () => setShowInsertMenu(!showInsertMenu),
                    className: 'text-xs px-3 py-1 rounded bg-purple-600 text-white hover:bg-purple-700 flex items-center gap-1'
                  }, 'Lis√§√§ tekstiin', e('span', { className: 'text-[10px]' }, '‚ñº')),
                  
                  showInsertMenu && e('div', {
                    className: 'absolute right-0 mt-1 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 p-1 min-w-[180px] z-50'
                  },
                    e('button', {
                      onClick: () => insertAiResponse('append'),
                      className: 'w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-sm'
                    }, '‚ûï Lis√§√§ loppuun'),
                    
                    e('button', {
                      onClick: () => insertAiResponse('at-cursor'),
                      className: 'w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-sm'
                    }, 'üìç Lis√§√§ kursorin kohtaan'),
                    
                    e('button', {
                      onClick: () => insertAiResponse('replace-all'),
                      className: 'w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-sm text-red-600'
                    }, '‚ö†Ô∏è Korvaa kaikki')
                  )
                )
              )
            ),
            
            // CURSOR-TYYLI: Muutosehdotukset (jos l√∂ytyy)
            suggestedEdits.length > 0 && e('div', {
              className: 'mb-3 p-3 rounded border border-blue-500/30 bg-blue-500/5'
            },
              e('div', { className: 'flex items-center justify-between mb-2' },
                e('div', { className: 'text-sm font-medium text-blue-600 dark:text-blue-400' }, 
                  `üîç ${suggestedEdits.length} muutosehdotus${suggestedEdits.length > 1 ? 'ta' : ''}`),
                e('button', {
                  onClick: applyAllEdits,
                  className: 'text-xs px-2 py-1 rounded bg-blue-600 text-white hover:bg-blue-700',
                  title: 'Sovella kaikki muutokset kerralla'
                }, '‚úì Apply All')
              ),
              
              // Listaa muutokset
              e('div', { className: 'space-y-2 max-h-96 overflow-y-auto' },
                ...suggestedEdits.map(edit =>
                  e('div', {
                    key: edit.id,
                    className: `p-2 rounded ${edit.applied ? 'bg-green-500/10 border border-green-500/30' : 'bg-gray-800/50 border border-gray-700'}`
                  },
                    // Diff-n√§kym√§
                    e('div', { className: 'space-y-1' },
                      e('div', { className: 'text-[10px] font-medium opacity-60' }, 'Ennen:'),
                      e('div', { className: 'text-xs p-2 rounded bg-red-500/10 text-red-400 font-mono line-through' }, 
                        edit.oldText.substring(0, 100) + (edit.oldText.length > 100 ? '...' : '')),
                      e('div', { className: 'text-[10px] font-medium opacity-60 mt-1' }, 'J√§lkeen:'),
                      e('div', { className: 'text-xs p-2 rounded bg-green-500/10 text-green-400 font-mono' }, 
                        edit.newText.substring(0, 100) + (edit.newText.length > 100 ? '...' : ''))
                    ),
                    
                    // Napit
                    !edit.applied && e('div', { className: 'flex gap-2 mt-2' },
                      e('button', {
                        onClick: () => applyEdit(edit),
                        className: 'flex-1 text-xs px-2 py-1 rounded bg-green-600 text-white hover:bg-green-700'
                      }, '‚úì Apply'),
                      e('button', {
                        onClick: () => rejectEdit(edit),
                        className: 'flex-1 text-xs px-2 py-1 rounded bg-red-600 text-white hover:bg-red-700'
                      }, '‚úó Reject')
                    ),
                    
                    edit.applied && e('div', { className: 'text-xs text-green-500 mt-2' }, '‚úì Sovellettu')
                  )
                )
              )
            ),
            
            e('div', { className: 'text-sm whitespace-pre-wrap' }, aiResponse)
          )
        )
      )
    ),

    // Vaihe 5: CharacterSheet Modal
  showCharacterSheet && editingCharacter && e('div', {
    className: 'fixed inset-0 bg-black/50 flex items-center justify-center z-[10000]',
    onClick: () => setShowCharacterSheet(false)
  },
    e('div', {
      className: `w-full max-w-3xl max-h-[90vh] overflow-y-auto rounded-lg shadow-xl ${
        isDarkMode ? 'bg-gray-800' : 'bg-white'
      }`,
      onClick: (ev) => ev.stopPropagation()
    },
      // Header
      e('div', { className: 'p-4 border-b flex items-center justify-between sticky top-0 bg-inherit z-10' },
        e('h3', { className: 'text-lg font-bold' }, `Hahmo: ${editingCharacter.name}`),
        e('button', {
          onClick: () => setShowCharacterSheet(false),
          className: 'p-2 rounded hover:bg-gray-700'
        }, e(Icons.X))
      ),

      // Content
      e('div', { className: 'p-4 space-y-6' },
        // PERUSTIEDOT
        e('div', null,
          e('h4', { className: 'font-semibold mb-2 text-blue-500' }, 'üìã Perustiedot'),
          e('div', { className: 'grid grid-cols-2 gap-3' },
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Ik√§'),
              e('input', {
                type: 'number',
                value: editingCharacter.bio.age || '',
                onChange: (ev) => setEditingCharacter({
                  ...editingCharacter,
                  bio: { ...editingCharacter.bio, age: parseInt(ev.target.value) }
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`
              })
            ),
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Ammatti'),
              e('input', {
                value: editingCharacter.bio.occupation || '',
                onChange: (ev) => setEditingCharacter({
                  ...editingCharacter,
                  bio: { ...editingCharacter.bio, occupation: ev.target.value }
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`,
                placeholder: 'esim. toimittaja'
              })
            )
          ),
          e('div', { className: 'mt-3' },
            e('label', { className: 'text-xs block mb-1' }, 'Ulkon√§k√∂'),
            e('textarea', {
              value: editingCharacter.bio.appearance || '',
              onChange: (ev) => setEditingCharacter({
                ...editingCharacter,
                bio: { ...editingCharacter.bio, appearance: ev.target.value }
              }),
              className: `w-full p-2 rounded border text-sm h-20 resize-none ${
                isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
              }`,
              placeholder: 'Pitk√§t mustat hiukset, vihre√§t silm√§t...'
            })
          )
        ),

        // PSYKOLOGIA
        e('div', null,
          e('h4', { className: 'font-semibold mb-2 text-purple-500' }, 'üß† Psykologia'),
          e('div', { className: 'space-y-3' },
            ['want', 'fear', 'weakness'].map(field =>
              e('div', { key: field },
                e('label', { className: 'text-xs block mb-1' },
                  field === 'want' ? 'Mit√§ haluaa' :
                  field === 'fear' ? 'Mit√§ pelk√§√§' :
                  'Heikkous'
                ),
                e('input', {
                  value: editingCharacter.psychology[field] || '',
                  onChange: (ev) => setEditingCharacter({
                    ...editingCharacter,
                    psychology: { ...editingCharacter.psychology, [field]: ev.target.value }
                  }),
                  className: `w-full p-2 rounded border text-sm ${
                    isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                  }`,
                  placeholder:
                    field === 'want' ? 'esim. totuus, rakkaus, vapaus' :
                    field === 'fear' ? 'esim. hyl√§tyksi tuleminen, ep√§onnistuminen' :
                    'esim. ylianalysoi, impulsiivinen'
                })
              )
            )
          )
        ),

        // √Ñ√ÑNI JA PUHETYYLI
        e('div', null,
          e('h4', { className: 'font-semibold mb-2 text-green-500' }, 'üó£Ô∏è √Ñ√§ni ja puhetyyli'),
          e('div', null,
            e('label', { className: 'text-xs block mb-1' }, 'Miten hahmo puhuu'),
            e('textarea', {
              value: editingCharacter.voice.description || '',
              onChange: (ev) => setEditingCharacter({
                ...editingCharacter,
                voice: { ...editingCharacter.voice, description: ev.target.value }
              }),
              className: `w-full p-2 rounded border text-sm h-20 resize-none ${
                isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
              }`,
              placeholder: 'Lyhyet lauseet, suorat kysymykset, ei runoile...'
            })
          ),
          e('div', { className: 'mt-3' },
            e('label', { className: 'text-xs block mb-1' },
              'Tyypilliset fraasit (pilkulla eroteltu)'),
            e('input', {
              value: (editingCharacter.voice.lexicon || []).join(', '),
              onChange: (ev) => setEditingCharacter({
                ...editingCharacter,
                voice: {
                  ...editingCharacter.voice,
                  lexicon: ev.target.value.split(',').map(s => s.trim()).filter(Boolean)
                }
              }),
              className: `w-full p-2 rounded border text-sm ${
                isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
              }`,
              placeholder: 'kuule nyt, hitto vie, ajattelen ett√§...'
            })
          )
        ),

        // TILA JA RESURSSIT
        e('div', null,
          e('h4', { className: 'font-semibold mb-2 text-orange-500' }, 'üéí Tila ja resurssit'),
          e('div', { className: 'space-y-3' },
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Loukkaantumiset / Vammat'),
              e('input', {
                value: (editingCharacter.state.injuries || []).join(', '),
                onChange: (ev) => setEditingCharacter({
                  ...editingCharacter,
                  state: {
                    ...editingCharacter.state,
                    injuries: ev.target.value.split(',').map(s => s.trim()).filter(Boolean)
                  }
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`,
                placeholder: 'mustelma oikea kyyn√§rp√§√§, murtanut luuja...'
              })
            ),
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Esineet / Taidot'),
              e('input', {
                value: (editingCharacter.state.resources || []).join(', '),
                onChange: (ev) => setEditingCharacter({
                  ...editingCharacter,
                  state: {
                    ...editingCharacter.state,
                    resources: ev.target.value.split(',').map(s => s.trim()).filter(Boolean)
                  }
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`,
                placeholder: 'salaoviavain, hakkerointi, ase...'
              })
            ),
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Nykyinen mieliala'),
              e('input', {
                value: editingCharacter.state.mood || '',
                onChange: (ev) => setEditingCharacter({
                  ...editingCharacter,
                  state: { ...editingCharacter.state, mood: ev.target.value }
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`,
                placeholder: 'ep√§luuloinen, innokas, v√§synyt...'
              })
            )
          )
        ),

        // SUHTEET
        e('div', null,
          e('h4', { className: 'font-semibold mb-2 text-pink-500' }, 'üíï Suhteet'),
          e('div', { className: 'text-xs opacity-75 mb-2' },
            'Lis√§√§ hahmon suhteet toisiin hahmoihin'),
          // TODO: Suhteet-UI (yksinkertainen versio)
          e('div', { className: 'text-xs opacity-50' },
            '(Tulossa: suhdekartta ja luottamusindeksit)')
        ),

        // MUISTIINPANOT
        e('div', null,
          e('h4', { className: 'font-semibold mb-2' }, 'üìù Muistiinpanot'),
          e('textarea', {
            value: editingCharacter.notes || '',
            onChange: (ev) => setEditingCharacter({
              ...editingCharacter,
              notes: ev.target.value
            }),
            className: `w-full p-2 rounded border text-sm h-32 resize-none ${
              isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
            }`,
            placeholder: 'Vapaita muistiinpanoja hahmosta...'
          })
        )
      ),

      // Footer
      e('div', { className: 'p-4 border-t flex justify-end gap-2 sticky bottom-0 bg-inherit' },
        e('button', {
          onClick: () => setShowCharacterSheet(false),
          className: 'px-4 py-2 rounded text-sm hover:bg-gray-700'
        }, 'Peruuta'),
        e('button', {
          onClick: () => {
            // Tallenna muutokset
            setProject({
              ...project,
              characters: project.characters.map(c =>
                c.id === editingCharacter.id ? editingCharacter : c
              )
            });
            setShowCharacterSheet(false);
          },
          className: 'px-4 py-2 rounded text-sm bg-blue-500 text-white hover:bg-blue-600'
        }, 'Tallenna')
      )
    )
  ),
  
  // LocationSheet Modal
  showLocationSheet && editingLocation && e('div', {
    className: 'fixed inset-0 bg-black/50 flex items-center justify-center z-[10000]',
    onClick: () => setShowLocationSheet(false)
  },
    e('div', {
      className: `w-full max-w-2xl max-h-[90vh] overflow-y-auto rounded-lg shadow-xl ${
        isDarkMode ? 'bg-gray-800' : 'bg-white'
      }`,
      onClick: (ev) => ev.stopPropagation()
    },
      // Header
      e('div', { className: 'p-4 border-b flex items-center justify-between sticky top-0 bg-inherit z-10' },
        e('h3', { className: 'text-lg font-bold' }, `Paikka: ${editingLocation.name}`),
        e('button', {
          onClick: () => setShowLocationSheet(false),
          className: 'p-2 rounded hover:bg-gray-700'
        }, e(Icons.X))
      ),

      // Content
      e('div', { className: 'p-4 space-y-4' },
        // Perustiedot
        e('div', null,
          e('h4', { className: 'font-semibold mb-2 text-blue-500 text-sm' }, 'üìç Perustiedot'),
          e('div', { className: 'grid grid-cols-2 gap-3' },
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Nimi'),
              e('input', {
                value: editingLocation.name || '',
                onChange: (ev) => setEditingLocation({
                  ...editingLocation,
                  name: ev.target.value
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`
              })
            ),
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Tyyppi'),
              e('select', {
                value: editingLocation.type || 'landmark',
                onChange: (ev) => setEditingLocation({
                  ...editingLocation,
                  type: ev.target.value
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`
              }, LOCATION_TYPES.map(t => e('option', { key: t.id, value: t.id }, `${t.icon} ${t.name}`)))
            ),
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Kaupunki'),
              e('input', {
                value: editingLocation.city || '',
                onChange: (ev) => setEditingLocation({
                  ...editingLocation,
                  city: ev.target.value
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`
              })
            ),
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Maa'),
              e('input', {
                value: editingLocation.country || '',
                onChange: (ev) => setEditingLocation({
                  ...editingLocation,
                  country: ev.target.value
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`
              })
            )
          )
        ),

        // Muistiinpanot
        e('div', null,
          e('h4', { className: 'font-semibold mb-2 text-sm' }, 'üìù Muistiinpanot'),
          e('textarea', {
            value: editingLocation.notes || '',
            onChange: (ev) => setEditingLocation({
              ...editingLocation,
              notes: ev.target.value
            }),
            className: `w-full p-2 rounded border text-sm h-24 resize-none ${
              isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
            }`,
            placeholder: 'Vapaat muistiinpanot paikasta...'
          })
        ),

        // Genre-kuvaukset (read-only n√§ytt√∂)
        Object.keys(editingLocation.genre_descriptions || {}).length > 0 && e('div', null,
          e('h4', { className: 'font-semibold mb-2 text-purple-500 text-sm' }, '‚úçÔ∏è Tallennetut kuvaukset'),
          Object.entries(editingLocation.genre_descriptions).map(([genre, description]) =>
            e('div', {
              key: genre,
              className: `p-3 rounded border mb-2 ${
                isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'
              }`
            },
              e('div', { className: 'text-xs font-medium mb-1 opacity-75' },
                GENRE_OPTIONS.find(g => g.id === genre)?.name || genre
              ),
              e('div', { className: 'text-xs whitespace-pre-wrap' }, description)
            )
          )
        )
      ),

      // Footer
      e('div', { className: 'p-4 border-t flex justify-end gap-2 sticky bottom-0 bg-inherit' },
        e('button', {
          onClick: () => setShowLocationSheet(false),
          className: 'px-4 py-2 rounded text-sm hover:bg-gray-700'
        }, 'Peruuta'),
        e('button', {
          onClick: () => {
            setProject({
              ...project,
              locations: project.locations.map(loc =>
                loc.id === editingLocation.id ? editingLocation : loc
              )
            });
            setShowLocationSheet(false);
          },
          className: 'px-4 py-2 rounded text-sm bg-blue-500 text-white hover:bg-blue-600'
        }, 'Tallenna')
      )
    ),

    // ChapterSheet Modal (StoryKeeper)
    showChapterSheet && editingChapter && e('div', {
      className: 'fixed inset-0 bg-black/50 flex items-center justify-center z-[10000]',
      onClick: () => setShowChapterSheet(false)
    },
      e('div', {
        className: `w-full max-w-2xl max-h-[90vh] overflow-y-auto rounded-lg shadow-xl ${
          isDarkMode ? 'bg-gray-800' : 'bg-white'
        }`,
        onClick: (ev) => ev.stopPropagation()
      },
        // Header
        e('div', { className: 'p-4 border-b flex items-center justify-between sticky top-0 bg-inherit z-10' },
          e('h3', { className: 'text-lg font-bold' }, `Luku ${editingChapter.chapter}`),
          e('button', {
            onClick: () => setShowChapterSheet(false),
            className: 'p-2 rounded hover:bg-gray-700'
          }, e(Icons.X))
        ),

        // Content
        e('div', { className: 'p-4 space-y-4' },
          // Otsikko
          e('div', null,
            e('label', { className: 'text-xs block mb-1' }, 'Otsikko'),
            e('input', {
              value: editingChapter.title || '',
              onChange: (ev) => setEditingChapter({
                ...editingChapter,
                title: ev.target.value
              }),
              className: `w-full p-2 rounded border text-sm ${
                isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
              }`,
              placeholder: 'Luvun otsikko'
            })
          ),

          // Yhteenveto
          e('div', null,
            e('label', { className: 'text-xs block mb-1' }, 'Yhteenveto'),
            e('textarea', {
              value: editingChapter.summary || '',
              onChange: (ev) => setEditingChapter({
                ...editingChapter,
                summary: ev.target.value
              }),
              className: `w-full p-2 rounded border text-sm h-24 resize-none ${
                isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
              }`,
              placeholder: 'Lyhyt yhteenveto luvusta...'
            })
          ),

          // Tila
          e('div', null,
            e('label', { className: 'text-xs block mb-1' }, 'Tila'),
            e('select', {
              value: editingChapter.status || 'not_started',
              onChange: (ev) => setEditingChapter({
                ...editingChapter,
                status: ev.target.value
              }),
              className: `w-full p-2 rounded border text-sm ${
                isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
              }`
            },
              e('option', { value: 'not_started' }, 'Ei aloitettu'),
              e('option', { value: 'in_progress' }, 'Kirjoitetaan'),
              e('option', { value: 'completed' }, 'Valmis')
            )
          ),

          // Aika tarinassa
          e('div', { className: 'grid grid-cols-2 gap-3' },
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Aika tarinassa'),
              e('input', {
                value: editingChapter.story_time || '',
                onChange: (ev) => setEditingChapter({
                  ...editingChapter,
                  story_time: ev.target.value
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`,
                placeholder: 'esim. Maanantai 9:00'
              })
            ),
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Kesto'),
              e('input', {
                value: editingChapter.duration || '',
                onChange: (ev) => setEditingChapter({
                  ...editingChapter,
                  duration: ev.target.value
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`,
                placeholder: 'esim. 2h'
              })
            )
          ),

          // POV ja paikka
          e('div', { className: 'grid grid-cols-2 gap-3' },
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'POV (n√§k√∂kulma)'),
              e('input', {
                value: editingChapter.pov || '',
                onChange: (ev) => setEditingChapter({
                  ...editingChapter,
                  pov: ev.target.value
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`,
                placeholder: 'esim. Aava'
              })
            ),
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Paikka'),
              e('input', {
                value: editingChapter.location || '',
                onChange: (ev) => setEditingChapter({
                  ...editingChapter,
                  location: ev.target.value
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`,
                placeholder: 'esim. Kampin aukio'
              })
            )
          )
        ),

        // Footer
        e('div', { className: 'p-4 border-t flex justify-end gap-2 sticky bottom-0 bg-inherit' },
          e('button', {
            onClick: () => setShowChapterSheet(false),
            className: 'px-4 py-2 rounded text-sm hover:bg-gray-700'
          }, 'Peruuta'),
          e('button', {
            onClick: () => {
              setProject({
                ...project,
                story: {
                  ...project.story,
                  outline: project.story.outline.map(ch =>
                    ch.chapter === editingChapter.chapter ? editingChapter : ch
                  )
                }
              });
              setShowChapterSheet(false);
            },
            className: 'px-4 py-2 rounded text-sm bg-blue-500 text-white hover:bg-blue-600'
          }, 'Tallenna')
        )
      )
    ),

    // ThreadSheet Modal (StoryKeeper)
    showThreadSheet && editingThread && e('div', {
      className: 'fixed inset-0 bg-black/50 flex items-center justify-center z-[10000]',
      onClick: () => setShowThreadSheet(false)
    },
      e('div', {
        className: `w-full max-w-2xl max-h-[90vh] overflow-y-auto rounded-lg shadow-xl ${
          isDarkMode ? 'bg-gray-800' : 'bg-white'
        }`,
        onClick: (ev) => ev.stopPropagation()
      },
        // Header
        e('div', { className: 'p-4 border-b flex items-center justify-between sticky top-0 bg-inherit z-10' },
          e('h3', { className: 'text-lg font-bold' }, 'Juonilanka'),
          e('button', {
            onClick: () => setShowThreadSheet(false),
            className: 'p-2 rounded hover:bg-gray-700'
          }, e(Icons.X))
        ),

        // Content
        e('div', { className: 'p-4 space-y-4' },
          // Nimi
          e('div', null,
            e('label', { className: 'text-xs block mb-1' }, 'Nimi'),
            e('input', {
              value: editingThread.name || '',
              onChange: (ev) => setEditingThread({
                ...editingThread,
                name: ev.target.value
              }),
              className: `w-full p-2 rounded border text-sm ${
                isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
              }`,
              placeholder: 'Juonilangan nimi'
            })
          ),

          // Kuvaus
          e('div', null,
            e('label', { className: 'text-xs block mb-1' }, 'Kuvaus'),
            e('textarea', {
              value: editingThread.description || '',
              onChange: (ev) => setEditingThread({
                ...editingThread,
                description: ev.target.value
              }),
              className: `w-full p-2 rounded border text-sm h-24 resize-none ${
                isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
              }`,
              placeholder: 'Juonilangan kuvaus...'
            })
          ),

          // T√§rkeys ja tila
          e('div', { className: 'grid grid-cols-2 gap-3' },
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'T√§rkeys'),
              e('select', {
                value: editingThread.importance || 'minor',
                onChange: (ev) => setEditingThread({
                  ...editingThread,
                  importance: ev.target.value
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`
              },
                e('option', { value: 'major' }, 'üî¥ Major (P√§√§juoni)'),
                e('option', { value: 'minor' }, 'üü° Minor (Sivujuoni)'),
                e('option', { value: 'subplot' }, '‚ö™ Subplot (Alajuoni)')
              )
            ),
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Tila'),
              e('select', {
                value: editingThread.status || 'open',
                onChange: (ev) => setEditingThread({
                  ...editingThread,
                  status: ev.target.value
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`
              },
                e('option', { value: 'open' }, 'Auki'),
                e('option', { value: 'closed' }, 'Suljettu'),
                e('option', { value: 'abandoned' }, 'Hyl√§tty')
              )
            )
          ),

          // Luvut
          e('div', { className: 'grid grid-cols-2 gap-3' },
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Avattu luku'),
              e('input', {
                type: 'number',
                value: editingThread.opened_chapter || '',
                onChange: (ev) => setEditingThread({
                  ...editingThread,
                  opened_chapter: parseInt(ev.target.value) || null
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`,
                placeholder: 'esim. 1'
              })
            ),
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Suljettu luku'),
              e('input', {
                type: 'number',
                value: editingThread.closed_chapter || '',
                onChange: (ev) => setEditingThread({
                  ...editingThread,
                  closed_chapter: parseInt(ev.target.value) || null
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`,
                placeholder: 'esim. 12',
                disabled: editingThread.status !== 'closed'
              })
            )
          )
        ),

        // Footer
        e('div', { className: 'p-4 border-t flex justify-end gap-2 sticky bottom-0 bg-inherit' },
          e('button', {
            onClick: () => setShowThreadSheet(false),
            className: 'px-4 py-2 rounded text-sm hover:bg-gray-700'
          }, 'Peruuta'),
          e('button', {
            onClick: () => {
              setProject({
                ...project,
                story: {
                  ...project.story,
                  threads: project.story.threads.map(t =>
                    t.id === editingThread.id ? editingThread : t
                  )
                }
              });
              setShowThreadSheet(false);
            },
            className: 'px-4 py-2 rounded text-sm bg-blue-500 text-white hover:bg-blue-600'
          }, 'Tallenna')
        )
      )
    ),
    
    // ========== NORMAN-KRUG-NATSUME: UI Components ==========
    
    // NORMAN: AI Feedback - Shows what AI did
    e(AIFeedback, {
      action: showAIFeedback?.action,
      details: showAIFeedback?.details,
      type: showAIFeedback?.type || 'info',
      onDismiss: () => setShowAIFeedback(null)
    }),
    
    // NATSUME: Inspiration Panel - Appears when stuck
    e(InspirationPanel, {
      isVisible: showInspiration,
      inspiration: inspirationData,
      onDismiss: () => setShowInspiration(false)
    }),
    
    // NATSUME: Flow Mode Indicator - Subtle mode display
    e(FlowModeIndicator, { mode: flowMode }),
    
    // NATSUME: Genre Visual Metaphor - Shows genre theme
    project.genre && e('div', {
      className: 'fixed top-20 left-4 text-4xl opacity-10 pointer-events-none z-10'
    }, GENRE_OPTIONS.find(g => g.id === project.genre)?.icon || ''),
    
    // ========== VISUAL MASTERS: Indicators ==========
    
    // IDEO: Cognitive Load Indicator
    e(CognitiveLoadIndicator, { load: cognitiveLoad }),
    
    // SUPERSIDE: Work Phase Indicator
    e(WorkPhaseIndicator, { phase: workPhase }),
    
    // IDEO: Transparent AI Indicator
    e(TransparentAIIndicator, {
      active: aiTransparency.active,
      thinking: aiTransparency.thinking || isGenerating,
      suggestionCount: aiSuggestions.length
    })
    
  )) // Close Fragment
  ); // Close return statement
}
// Error boundary for debugging
class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, error: null };
  }
  
  static getDerivedStateFromError(error) {
    return { hasError: true, error };
  }
  
  componentDidCatch(error, errorInfo) {
    console.error('React Error:', error, errorInfo);
  }
  
  render() {
    if (this.state.hasError) {
      return React.createElement('div', { 
        style: { 
          padding: '20px', 
          color: 'var(--faust-text-primary)', 
          background: 'var(--faust-bg-primary)',
          fontFamily: 'var(--font-body)'
        } 
      },
        React.createElement('h1', { style: { fontFamily: 'var(--font-heading)' } }, 'üúç FAUST Error'),
        React.createElement('pre', null, this.state.error?.toString()),
        React.createElement('pre', null, this.state.error?.stack)
      );
    }
    return this.props.children;
  }
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(ErrorBoundary, null, e(FaustEditor)));
