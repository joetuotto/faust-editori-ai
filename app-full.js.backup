const { useState, useRef, useEffect } = React;
const e = React.createElement;

// Ikonit
const Icons = {
  Book: () => e('svg', { className: 'w-6 h-6', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253' })
  ),
  Menu: () => e('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M4 6h16M4 12h16M4 18h16' })
  ),
  Plus: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 4v16m8-8H4' })
  ),
  Trash: () => e('svg', { className: 'w-3 h-3', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16' })
  ),
  ChevronDown: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M19 9l-7 7-7-7' })
  ),
  ChevronRight: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M9 5l7 7-7 7' })
  ),
  Sun: () => e('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z' })
  ),
  Moon: () => e('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z' })
  ),
  Sparkles: () => e('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z' })
  ),
  Save: () => e('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4' })
  ),
  Upload: () => e('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12' })
  ),
  Download: () => e('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4' })
  ),
  Eye: () => e('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M15 12a3 3 0 11-6 0 3 3 0 016 0z' }),
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z' })
  ),
  EyeOff: () => e('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21' })
  ),
  Loader: () => e('svg', { className: 'w-4 h-4 animate-spin', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('circle', { cx: 12, cy: 12, r: 10, stroke: 'currentColor', strokeWidth: 4, fill: 'none', opacity: 0.25 }),
    e('path', { fill: 'currentColor', d: 'M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z' })
  ),
  X: () => e('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M6 18L18 6M6 6l12 12' })
  ),
  FileText: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z' })
  ),
  Folder: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z' })
  ),
  AlignLeft: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M4 6h16M4 12h16M4 18h7' })
  ),
  Filter: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z' })
  ),
  Camera: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z' }),
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M15 13a3 3 0 11-6 0 3 3 0 016 0z' })
  ),
  Clock: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z' })
  ),
  Collection: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10' })
  ),
  Tag: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z' })
  ),
  Maximize: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4' })
  ),
  Columns: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v2m0 0V7a2 2 0 00-2-2h-2m-4 0h-2' })
  ),
  Typewriter: () => e('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253' }),
    e('circle', { cx: 12, cy: 12, r: 2, stroke: 'currentColor', strokeWidth: 2, fill: 'none' })
  )
};

// macOS Native Styles
const MAC_OS_STYLES = `
  :root {
    /* macOS Native Colors - Dark Mode */
    --mac-bg-primary: #1e1e1e;
    --mac-bg-secondary: #2d2d2d;
    --mac-bg-tertiary: #3a3a3a;
    --mac-bg-quaternary: #464646;
    
    --mac-text-primary: #ffffff;
    --mac-text-secondary: rgba(255,255,255,0.65);
    --mac-text-tertiary: rgba(255,255,255,0.45);
    
    --mac-accent-blue: #0a84ff;
    --mac-accent-purple: #bf5af2;
    --mac-accent-green: #30d158;
    --mac-accent-red: #ff453a;
    --mac-accent-orange: #ff9f0a;
    
    /* Typography - SF Pro */
    --font-primary: -apple-system, BlinkMacSystemFont, "SF Pro Display", system-ui, sans-serif;
    --font-mono: "SF Mono", Monaco, Menlo, monospace;
    
    /* Spacing (8px base) */
    --space-xs: 8px;
    --space-sm: 12px;
    --space-md: 16px;
    --space-lg: 20px;
    --space-xl: 24px;
    --space-xxl: 32px;
    
    /* Shadows */
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.08);
    --shadow-md: 0 4px 8px rgba(0,0,0,0.12), 0 2px 4px rgba(0,0,0,0.08);
    --shadow-lg: 0 10px 20px rgba(0,0,0,0.15), 0 3px 6px rgba(0,0,0,0.10);
    --shadow-window: 0 25px 50px rgba(0,0,0,0.30);
    
    /* Radius */
    --radius-sm: 4px;
    --radius-md: 6px;
    --radius-lg: 10px;
    --radius-xl: 12px;
    
    /* Transitions */
    --ease-in-out: cubic-bezier(0.4, 0.0, 0.2, 1);
  }
  
  /* Light Mode */
  [data-theme="light"] {
    --mac-bg-primary: #ffffff;
    --mac-bg-secondary: #f5f5f7;
    --mac-bg-tertiary: #e8e8ed;
    --mac-bg-quaternary: #d2d2d7;
    
    --mac-text-primary: #000000;
    --mac-text-secondary: rgba(0,0,0,0.65);
    --mac-text-tertiary: rgba(0,0,0,0.45);
    
    --mac-accent-blue: #007aff;
  }
  
  /* Base Styles */
  * {
    box-sizing: border-box;
  }
  
  body {
    font-family: var(--font-primary);
    background: var(--mac-bg-primary);
    color: var(--mac-text-primary);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  
  /* Smooth transitions */
  button, input, textarea, select {
    transition: background-color 0.15s var(--ease-in-out),
                color 0.15s var(--ease-in-out),
                border-color 0.15s var(--ease-in-out),
                box-shadow 0.15s var(--ease-in-out),
                transform 0.15s var(--ease-in-out);
  }
  
  /* Focus visible */
  *:focus-visible {
    outline: 2px solid var(--mac-accent-blue);
    outline-offset: 2px;
  }
  
  /* Scrollbars */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  
  ::-webkit-scrollbar-track {
    background: transparent;
  }
  
  ::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.2);
    border-radius: 4px;
  }
  
  ::-webkit-scrollbar-thumb:hover {
    background: rgba(255,255,255,0.3);
  }
  
  /* Animations */
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
  
  @keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
  }
  
  /* NATSUME: Organic Animations */
  @keyframes breatheIn {
    0% { opacity: 0; transform: scale(1.02); }
    100% { opacity: 1; transform: scale(1); }
  }
  
  @keyframes breatheOut {
    0% { opacity: 1; transform: scale(1); }
    100% { opacity: 0; transform: scale(0.98); }
  }
  
  @keyframes wave {
    0% { opacity: 0; transform: translateY(3px); }
    50% { opacity: 1; transform: translateY(-1px); }
    100% { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  
  .animate-breatheIn {
    animation: breatheIn 0.6s ease-in forwards;
  }
  
  .animate-breatheOut {
    animation: breatheOut 0.6s ease-out forwards;
  }
  
  .animate-wave {
    animation: wave 0.8s cubic-bezier(0.4, 0.0, 0.2, 1) forwards;
  }
  
  .animate-slideIn {
    animation: slideIn 0.4s ease-out forwards;
  }
  
  .animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  
  /* NATSUME: Flow Mode Transitions */
  .flow-transition {
    transition: background 1s ease-in-out, filter 2s ease-in-out;
  }
  
  .mode-focus {
    background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);
  }
  
  .mode-rhythm {
    background: linear-gradient(180deg, #1a1a2a 0%, #0f0f1f 100%);
  }
  
  .mode-review {
    background: linear-gradient(180deg, #1a1f1a 0%, #0f140f 100%);
  }
  
  .tone-calm {
    filter: saturate(0.8);
  }
  
  .tone-tense {
    filter: saturate(1.2) contrast(1.1);
  }
  
  /* NORMAN: Inline Suggestion Affordance */
  .inline-suggestion {
    border-bottom: 2px dashed rgba(10, 132, 255, 0.4);
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .inline-suggestion:hover {
    border-color: var(--mac-accent-blue);
    background: rgba(10, 132, 255, 0.1);
  }
  
  /* SAGMEISTER: Organic Glow Effects */
  @keyframes glow-slide {
    0%, 100% { 
      background-position: 0% 50%; 
      opacity: 0.3;
    }
    50% { 
      background-position: 100% 50%; 
      opacity: 0.6;
    }
  }
  
  @keyframes pulse-glow {
    0%, 100% { 
      filter: blur(20px);
    }
    50% { 
      filter: blur(30px);
    }
  }
  
  .glow-suggestion {
    position: relative;
    display: inline-block;
  }
  
  .glow-suggestion::before {
    content: '';
    position: absolute;
    inset: -4px;
    z-index: -1;
    background: linear-gradient(90deg, rgba(10,132,255,0.3), rgba(191,90,242,0.3), rgba(10,132,255,0.3));
    background-size: 200% 100%;
    border-radius: 4px;
    animation: glow-slide 3s ease-in-out infinite, pulse-glow 2s ease-in-out infinite;
  }
  
  /* SAGMEISTER: Living Typography - adapts to writing speed */
  .living-typography {
    transition: font-size 1.5s cubic-bezier(0.4, 0.0, 0.2, 1),
                letter-spacing 1.5s cubic-bezier(0.4, 0.0, 0.2, 1);
  }
  
  /* PENTAGRAM: Optimal reading width */
  .typographic-container {
    max-width: 800px;
    margin: 0 auto;
  }
  
  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }
`;

// Label vÃ¤rit
const LABEL_COLORS = [
  { id: 'none', name: 'Ei merkintÃ¤Ã¤', color: 'transparent' },
  { id: 'red', name: 'Punainen', color: '#ef4444' },
  { id: 'orange', name: 'Oranssi', color: '#f97316' },
  { id: 'yellow', name: 'Keltainen', color: '#eab308' },
  { id: 'green', name: 'VihreÃ¤', color: '#22c55e' },
  { id: 'blue', name: 'Sininen', color: '#3b82f6' },
  { id: 'purple', name: 'Violetti', color: '#a855f7' },
  { id: 'pink', name: 'Pinkki', color: '#ec4899' }
];

// LocationKeeper - Paikkamalli
const LOCATION_TEMPLATE = {
  id: null,
  name: '',
  type: '', // city, building, landmark, public_square, street, nature, interior, transport
  city: '',
  country: '',
  coordinates: { lat: null, lng: null },
  
  facts: {
    history: '',
    architecture: [],
    features: [],
    atmosphere: []
  },
  
  visual: {
    colors_day: [],
    colors_night: [],
    lighting: [],
    textures: []
  },
  
  genre_descriptions: {}, // { genre: description }
  
  used_in_scenes: [],
  notes: '',
  image_refs: [],
  
  // Web search tulokset
  research: {
    last_searched: null,
    facts_source: '',
    images_source: ''
  }
};

// Genre-vaihtoehdot
const GENRE_OPTIONS = [
  { id: 'psychological_thriller', name: 'Psykologinen trilleri', icon: 'ðŸ§ ' },
  { id: 'romantic_drama', name: 'Romanttinen draama', icon: 'â¤ï¸' },
  { id: 'action_thriller', name: 'Toimintatrilleri', icon: 'ðŸ’¥' },
  { id: 'horror', name: 'Kauhu', icon: 'ðŸ‘»' },
  { id: 'noir', name: 'Noir / Rikosromaani', icon: 'ðŸ•µï¸' },
  { id: 'historical_fiction', name: 'Historiallinen fiktio', icon: 'ðŸ“œ' },
  { id: 'literary_fiction', name: 'Kirjallinen fiktio', icon: 'ðŸ“š' },
  { id: 'fantasy', name: 'Fantasia', icon: 'ðŸ‰' },
  { id: 'scifi', name: 'Sci-fi', icon: 'ðŸš€' },
  { id: 'mystery', name: 'Mysteeri', icon: 'ðŸ”' }
];

// Paikkatyypit
const LOCATION_TYPES = [
  { id: 'city', name: 'Kaupunki', icon: 'ðŸ™ï¸' },
  { id: 'building', name: 'Rakennus', icon: 'ðŸ¢' },
  { id: 'landmark', name: 'Maamerkki', icon: 'ðŸ—¼' },
  { id: 'public_square', name: 'Aukio', icon: 'ðŸ›ï¸' },
  { id: 'street', name: 'Katu', icon: 'ðŸ›£ï¸' },
  { id: 'nature', name: 'Luonto', icon: 'ðŸŒ²' },
  { id: 'interior', name: 'SisÃ¤tila', icon: 'ðŸšª' },
  { id: 'transport', name: 'Kulkuneuvo', icon: 'ðŸš‚' }
];

// StoryKeeper - Tarinan rakenne mallit
const CHAPTER_TEMPLATE = {
  chapter: 1,
  title: '',
  summary: '',
  key_events: [],
  story_time: '',  // "Maanantai 9:00"
  real_time: '',   // "2024-03-15 09:00:00"
  duration: '',    // "2h"
  pov: '',         // Kenen nÃ¤kÃ¶kulma
  location: '',    // MissÃ¤ tapahtuu
  status: 'not_started',  // not_started / in_progress / completed
  word_count: 0
};

const EVENT_TEMPLATE = {
  id: null,
  description: '',
  chapter: 1,
  timestamp: '',  // "Luku 3, s.45"
  significance: 'minor',  // major / minor
  requires: [],     // [event_ids] mitÃ¤ tÃ¤ytyy olla ennen
  consequences: [], // [event_ids] mihin tÃ¤mÃ¤ vaikuttaa
  opens_threads: [],  // [thread_ids]
  closes_threads: [], // [thread_ids]
  immutable: false,   // voiko tÃ¤mÃ¤ muuttua?
  character_involved: [],  // [character_ids]
  location: ''
};

const THREAD_TEMPLATE = {
  id: null,
  name: '',
  description: '',
  opened_chapter: null,
  closed_chapter: null,
  status: 'open',  // open / closed / abandoned
  importance: 'minor',  // major / minor / subplot
  mentions: []  // [{chapter, note}] missÃ¤ luvuissa mainitaan
};

// Vaihe 5: Hahmomalli - CharacterKeeper
const CHARACTER_TEMPLATE = {
  id: null,
  name: '',
  bio: {
    age: null,
    gender: '',
    occupation: '',
    appearance: ''
  },
  psychology: {
    want: '',          // MitÃ¤ hahmo haluaa
    fear: '',          // MitÃ¤ hahmo pelkÃ¤Ã¤
    weakness: '',      // Hahmon heikkous
    values: []         // Arvot (esim. "rehellisyys", "perhe")
  },
  voice: {
    description: '',   // Miten hahmo puhuu
    avgSentenceLength: 12,
    lexicon: [],       // Tyypilliset sanat/fraasit
    disallowed: []     // Kielletyt ilmaukset
  },
  state: {
    injuries: [],      // Loukkaantumiset
    resources: [],     // Esineet/taidot
    mood: '',          // Nykyinen mieliala
    beliefs: {}        // Uskomukset (key-value)
  },
  arc: [],             // Hahmokaaren kehitys [{scene, belief, trigger}]
  relationships: [],   // Suhteet [{with, trust, tension, lastEvent}]
  lastSeen: {
    scene: '',
    location: '',
    time: ''
  },
  notes: ''            // Vapaat muistiinpanot
};

// Suhdetyypit
const RELATIONSHIP_TYPES = [
  { id: 'family', name: 'Perhe', color: '#ef4444' },
  { id: 'friend', name: 'YstÃ¤vÃ¤', color: '#22c55e' },
  { id: 'romantic', name: 'Romanttinen', color: '#ec4899' },
  { id: 'enemy', name: 'Vihollinen', color: '#dc2626' },
  { id: 'colleague', name: 'Kollega', color: '#3b82f6' },
  { id: 'mentor', name: 'Mentori', color: '#a855f7' },
  { id: 'stranger', name: 'Tuntematon', color: '#6b7280' }
];

// Vaihe 5: Kirjoitustekniikat-objekti
const WRITING_TECHNIQUES = {
  literary: {
    title: 'ðŸ“š KIRJALLISUUSTIEDE',
    color: 'purple',
    techniques: [
      {
        id: 'defamiliarization',
        name: 'Defamiliarisaatio',
        description: 'Tee tutusta vieraaksi - riko kielen jÃ¤rjestys',
        prompt: `Olet kirjoituskonsultti. Sovella DEFAMILIARISAATIOTA (Ð¾ÑÑ‚Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ) tÃ¤hÃ¤n tekstiin.

TEKSTI:
\${getActiveItem()?.content || '[Ei sisÃ¤ltÃ¶Ã¤]'}

DEFAMILIARISAATIO: Tee tutusta oudoksuttavaa rikkaamalla normaalit kieli- ja havaintomallit.

TEKNIIKAT:
1. **Riko lausejÃ¤rjestys**: "SydÃ¤n lyÃ¶" â†’ "SydÃ¤n. LyÃ¶nti. PysÃ¤hdys."
2. **Vieraannuta sanat**: "KÃ¤vellÃ¤" â†’ "Liike jalkojen kautta, yksi, toinen, yksi"
3. **VÃ¤Ã¤ristÃ¤ nÃ¤kÃ¶kulma**: Kerro tuttu asia kuin ensimmÃ¤istÃ¤ kertaa
4. **Irrota merkitys**: Hajota toiminto osiin

ESIMERKKI:
ENNEN: "HÃ¤n avasi oven ja astui sisÃ¤Ã¤n."
JÃ„LKEEN: "Metallikahva. KylmÃ¤. Kiertyminen. Rako levenee. Valo vuotaa. Askel. Toinen. HÃ¤n on sisÃ¤llÃ¤."

ANNA:
- 3-5 defamiliarisaatio-ehdotusta
- SÃ¤ilytÃ¤ ydinsisÃ¤ltÃ¶ mutta tee se oudoksuttavaksi
- SelitÃ¤ miksi muutos toimii

VASTAA SUOMEKSI.`
      },
      {
        id: 'sensory_richness',
        name: 'Aistillisuus',
        description: 'Aktivoi kaikki viisi aistia',
        prompt: `LisÃ¤Ã¤ AISTILLISET YKSITYISKOHDAT tÃ¤hÃ¤n tekstiin:

TEKSTI:
\${getActiveItem()?.content || '[Ei sisÃ¤ltÃ¶Ã¤]'}

LISÃ„Ã„:
1. **NÃ¤kÃ¶** (vÃ¤rit, muodot, liike, valo/varjo)
2. **Kuulo** (Ã¤Ã¤net, hiljaisuus, rytmit, kaikuja)
3. **Haju** (tuoksut, lemut, ilman laatu)
4. **Maku** (jos relevantti - ilman maku, muistot)
5. **Tunto** (tekstuurit, lÃ¤mpÃ¶tila, kosketus, paineet)

TAVOITE: Aktivoi lukijan keho, ei vain mieli.

Ã„LÃ„:
- Listaa aistihavaintoja ("HÃ¤n nÃ¤ki X, kuuli Y, haisti Z")
- LisÃ¤Ã¤ yksityiskohtia vÃ¤kisin
- Unohda kontekstia

ANNA:
- 3-5 konkreettista lisÃ¤ystÃ¤
- Integroi ne luonnollisesti tekstiin
- SelitÃ¤ miksi kukin vahvistaa kokemusta

VASTAA SUOMEKSI.`
      },
      {
        id: 'symbolic_redundancy',
        name: 'Symbolinen redundanssi',
        description: 'Toista motiivia hienovaraisesti lÃ¤pi tekstin',
        prompt: `Analysoi ja vahvista SYMBOLISTA REDUNDANSSIA:

TEKSTI:
\${getActiveItem()?.content || '[Ei sisÃ¤ltÃ¶Ã¤]'}

SYMBOLINEN REDUNDANSSI: Toista keskeinen motiivi/symboli/kuva hienovaraisesti eri muodoissa lÃ¤pi tekstin.

ESIMERKKI:
Motiivi: "Murtuminen"
- Rivi 1: "Lasi sÃ¤rÃ¶ili ikkunassa"
- Rivi 45: "HÃ¤nen Ã¤Ã¤nensÃ¤ katkesi"
- Rivi 89: "Luottamus repeytyi"

TEHTÃ„VÃ„:
1. Tunnista mahdollinen ydinmotiivi tekstistÃ¤
2. Ehdota 3-5 paikkaa missÃ¤ sitÃ¤ voi toistaa hienovaraisesti
3. Vaihtele muotoa (konkreetti â†’ abstrakti, verbaali â†’ visuaalinen)

ANNA:
- Tunnistettu motiivi
- Nykyiset esiintymÃ¤t
- Uudet esiintymis-ehdotukset
- Selitys miksi redundanssi toimii

VASTAA SUOMEKSI.`
      },
      {
        id: 'rhythm_breath',
        name: 'Rytmi & Hengitys',
        description: 'Vaihtele lausepituuksia orgaanisesti',
        prompt: `Optimoi tekstin RYTMI JA HENGITYS:

TEKSTI:
\${getActiveItem()?.content || '[Ei sisÃ¤ltÃ¶Ã¤]'}

RYTMI: Vaihtele lausepituuksia luoden orgaaninen hengitysrytmi.

TEKNIIKAT:
1. **Lyhyt-lyhyt-pitkÃ¤**: JÃ¤nnite â†’ jÃ¤nnite â†’ purkaus
2. **PitkÃ¤-lyhyt**: Rakennus â†’ rÃ¤jÃ¤hdys
3. **Staccato**: Lyhyt. Lyhyt. Lyhyt. = ahdistus, kiire
4. **Legato**: PitkÃ¤t, virtaavat lauseet = rauha, kontemplÐ°atio

ESIMERKKI:
ENNEN: "HÃ¤n kÃ¤veli kadulla. HÃ¤n nÃ¤ki jonkun. HÃ¤n tunsi pelon."
JÃ„LKEEN: "HÃ¤n kÃ¤veli. Katu. Joku - siellÃ¤, varjoissa, liikkumatta. Paniikki valutti kylkeÃ¤ pitkin kuin jÃ¤Ã¤kylmÃ¤ vesi."

ANNA:
- Nykyinen rytmi-analyysi (montako sanaa per lause)
- 3-5 rytmikorjausta
- SelitÃ¤ miten rytmi tukee tunnelmaa

VASTAA SUOMEKSI.`
      },
      {
        id: 'negative_space',
        name: 'TyhjÃ¤ tila',
        description: 'JÃ¤tÃ¤ aukkoja lukijan tÃ¤ytettÃ¤vÃ¤ksi',
        prompt: `Luo TYHJÃ„Ã„ TILAA (negative space) tekstiin:

TEKSTI:
\${getActiveItem()?.content || '[Ei sisÃ¤ltÃ¶Ã¤]'}

TYHJÃ„ TILA: Ã„lÃ¤ kerro kaikkea. JÃ¤tÃ¤ aukkoja, epÃ¤varmuutta, tulkinnanvaraa.

TEKNIIKAT:
1. **PoisjÃ¤ttÃ¶**: Kerro A ja C, mutta Ã¤lÃ¤ B:tÃ¤
2. **Vihjeet**: Anna fragmentteja, Ã¤lÃ¤ kokonaisuutta
3. **EpÃ¤varmuus**: "EhkÃ¤", "Luultavasti", "HÃ¤n ajatteli ettÃ¤"
4. **KeskenjÃ¤ttÃ¶**: KeskeytÃ¤ lause, jÃ¤tÃ¤ ajatus roikkumaan

ESIMERKKI:
ENNEN: "HÃ¤n nÃ¤ki miehen ja tunsi olevansa vaarassa, koska mies katsoi uhkaavasti."
JÃ„LKEEN: "HÃ¤n nÃ¤ki miehen. Jotain katseessa. HÃ¤n kÃ¤Ã¤ntyi nopeasti pois."

ANNA:
- 3-5 kohtaa missÃ¤ voit jÃ¤ttÃ¤Ã¤ tyhjÃ¤Ã¤ tilaa
- SÃ¤ilytÃ¤ ydinviesti mutta tee se epÃ¤suoraksi
- SelitÃ¤ miten tÃ¤mÃ¤ sitouttaa lukijaa

VASTAA SUOMEKSI.`
      }
    ]
  },

  psychological: {
    title: 'ðŸ§  PSYKOLOGIA',
    color: 'blue',
    techniques: [
      {
        id: 'peak_end',
        name: 'Peak-End Rule',
        description: 'Huippu keskellÃ¤, ankkuri lopussa',
        prompt: `Sovella PEAK-END RULE tÃ¤hÃ¤n tekstiin:

TEKSTI:
\${getActiveItem()?.content || '[Ei sisÃ¤ltÃ¶Ã¤]'}

PEAK-END RULE: Lukijat muistavat kaksi asiaa: 1) IntensiivisimmÃ¤n hetken (peak), 2) Lopun (end).

RAKENNE:
1. **Alku**: Johdanto, aseta odotukset
2. **Peak**: Emotionaalinen/jÃ¤nnittynein hetki (2/3 kohdalla)
3. **Lasku**: Laskeva toiminta
4. **End**: Ankkuri - voimakas loppu joka jÃ¤Ã¤ mieleen

ESIMERKKI:
- Peak: "Veitsi viilsi hÃ¤nen selkÃ¤nsÃ¤ yli"
- End: "HÃ¤n sulki oven. Hiljaisuus. HÃ¤n oli yksin."

TEHTÃ„VÃ„:
1. Tunnista nykyinen peak (jos on)
2. Ehdota vahvempaa peak-hetkeÃ¤
3. Suunnittele voimakas end-hetki
4. Anna konkreettinen rakenne

VASTAA SUOMEKSI.`
      },
      {
        id: 'emotional_contagion',
        name: 'Tunnetartunta',
        description: 'Ã„Ã¤nteet vaikuttavat alitajuntaan',
        prompt: `Optimoi TUNNETARTUNTA (emotional contagion):

TEKSTI:
\${getActiveItem()?.content || '[Ei sisÃ¤ltÃ¶Ã¤]'}

TUNNETARTUNTA: Ã„Ã¤nteiden (foneemien) valinnalla voit tartuttaa tunteita.

Ã„Ã„NNE-EMOTIO MAP:
- **PehmeÃ¤t** (l, m, n, v, h): Rauha, lÃ¤mpÃ¶, hellyys
- **Kovat** (k, t, p, r): JÃ¤nnite, voima, aggressio
- **Sibilantit** (s, sh): Hiljaisuus, salaisuus, pelko
- **Nasaalit** (m, n): Sulkeutuminen, sisÃ¤Ã¤npÃ¤inkÃ¤Ã¤ntyminen

ESIMERKKI:
NEUTRAALI: "HÃ¤n kÃ¤veli ulos ja lÃ¤hti"
PEHMEÃ„: "HÃ¤n livahti ulos ja haihtui hiljaa"
KOVA: "HÃ¤n karkasi ja katosi kiviseen katuhÃ¤mÃ¤rÃ¤Ã¤n"

ANNA:
- Analysoi nykyiset Ã¤Ã¤nteet
- Ehdota 3-5 muutosta emotionaalisen vaikutuksen vahvistamiseksi
- SelitÃ¤ miksi Ã¤Ã¤nnemaailma tukee tunnelmaa

VASTAA SUOMEKSI.`
      },
      {
        id: 'zeigarnik_effect',
        name: 'Zeigarnik-efekti',
        description: 'Avoimet silmukat valvottavat',
        prompt: `Luo ZEIGARNIK-EFEKTI tekstiin:

TEKSTI:
\${getActiveItem()?.content || '[Ei sisÃ¤ltÃ¶Ã¤]'}

ZEIGARNIK-EFEKTI: KeskenerÃ¤iset tehtÃ¤vÃ¤t/kysymykset jÃ¤Ã¤vÃ¤t mieleen ja valvottavat.

TEKNIIKAT:
1. **Avoin kysymys**: "MikÃ¤ se Ã¤Ã¤ni oli?"
2. **KeskenjÃ¤Ã¤nyt teko**: "HÃ¤n kurkotti ovenkahvaan mutta â€”"
3. **Ratkaisematon jÃ¤nnite**: "Joku teki sen. Mutta kuka?"
4. **Luvattu paljastus**: "Kolme sanaa. HÃ¤n kertoisi myÃ¶hemmin."

ESIMERKKI:
"HÃ¤n avasi kirjeen. Luki. Kasvot kalpenivat. HÃ¤n laski paperin hitaasti pÃ¶ydÃ¤lle ja katsoi ulos ikkunasta. MitÃ¤ siinÃ¤ luki? SitÃ¤ hÃ¤n ei voinut kertoa. Ei vielÃ¤."

TEHTÃ„VÃ„:
1. Tunnista nykyiset avoimet silmukat (jos on)
2. Ehdota 3-5 uutta silmukkaa
3. Varmista ettÃ¤ lupaat ratkaisun (myÃ¶hemmin)
4. Ã„lÃ¤ jÃ¤tÃ¤ KAIKKEA auki - vain keskeiset kysymykset

VASTAA SUOMEKSI.`
      },
      {
        id: 'affective_dissonance',
        name: 'Affektiivinen dissonanssi',
        description: 'Sekoita ristiriitaisia tunteita',
        prompt: `Luo AFFEKTIIVINEN DISSONANSSI:

TEKSTI:
\${getActiveItem()?.content || '[Ei sisÃ¤ltÃ¶Ã¤]'}

AFFEKTIIVINEN DISSONANSSI: Sekoita ristiriitaisia tunteita â†’ luo kompleksisuutta.

ESIMERKKEJÃ„:
- Suru + huumori: "HÃ¤n itki hautajaisissa. Sitten hÃ¤n muisti sen vitsin jonka Ã¤iti oli kertonut. HÃ¤n nauroi. Itki. Nauroi."
- Rakkaus + viha: "HÃ¤n halusi halata hÃ¤ntÃ¤ ja lyÃ¶dÃ¤ samaan aikaan."
- Pelko + uteliaisuus: "Ã„lÃ¤ avaa ovea. Mutta mitÃ¤ sen takana on?"

TEHTÃ„VÃ„:
1. Tunnista yksipuoliset tunnekuvaukset
2. LisÃ¤Ã¤ vastakkainen tunne samaan hetkeen
3. Ã„lÃ¤ selitÃ¤ ristiriitaa - anna sen olla
4. Anna 3-5 dissonanssi-ehdotusta

ESIMERKKI:
ENNEN: "HÃ¤n oli surullinen"
JÃ„LKEEN: "Kyyneleet valuivat, mutta hÃ¤n hymyili. Jokin tÃ¤ssÃ¤ oli vapauttavaa."

VASTAA SUOMEKSI.`
      },
      {
        id: 'cognitive_priming',
        name: 'Kognitiivinen priming',
        description: 'Ohjaa tulkintaa hienovaraisesti',
        prompt: `KÃ¤ytÃ¤ KOGNITIIVISTA PRIMING:IA:

TEKSTI:
\${getActiveItem()?.content || '[Ei sisÃ¤ltÃ¶Ã¤]'}

KOGNITIIVINEN PRIMING: Ohjaa lukijan tulkintaa hienovaraisilla vihjeillÃ¤ ennen pÃ¤Ã¤asiaa.

TEKNIIKAT:
1. **Sana-assosiaatiot**: Mainitse "terÃ¤vÃ¤" â†’ lukija odottaa vaaraa
2. **VÃ¤ri-emotio**: "Harmaa" â†’ melankoliaa, "Punainen" â†’ intohimoa
3. **Kontekstuaaliset vihjeet**: "Hiljaisuus" â†’ jÃ¤nnite kasvaa
4. **Metaforat**: "Ilma oli raskas" â†’ ahdistus tulossa

ESIMERKKI:
ILMAN PRIMING: "HÃ¤n astui huoneeseen. Mies istui tuolissa."
PRIMING: "Ilma oli raskas, tunkkainen. Jotain oli pielessÃ¤. HÃ¤n astui huoneeseen. Mies istui tuolissa. Liikkumatta."

TEHTÃ„VÃ„:
1. Tunnista kohdat missÃ¤ haluat ohjata lukijan odotuksia
2. LisÃ¤Ã¤ priming-sanoja/kuvia 1-2 lausetta ennen
3. Anna 3-5 priming-ehdotusta
4. SelitÃ¤ miten priming muuttaa tulkintaa

VASTAA SUOMEKSI.`
      }
    ]
  },

  persuasion: {
    title: 'ðŸŽ¯ VAIKUTTAMINEN',
    color: 'orange',
    techniques: [
      {
        id: 'ethos',
        name: 'Ethos (Luottamus)',
        description: 'Rakenna auktoriteetti ilman ylimielisyyttÃ¤',
        prompt: `Rakenna ETHOS (luottavuus):

TEKSTI:
\${getActiveItem()?.content || '[Ei sisÃ¤ltÃ¶Ã¤]'}

ETHOS: Rakenna lukijan luottamus kertojaasi/hahmoosi ilman ettÃ¤ sanot "luota minuun".

TEKNIIKAT:
1. **Yksityiskohdat**: Osoita ettÃ¤ tiedÃ¤t mistÃ¤ puhut (faktat, ammattisanasto)
2. **NÃ¶yryys**: Tunnusta epÃ¤varmuus â†’ paradoksaalisesti kasvattaa luottamusta
3. **Kokemuksen osoittaminen**: NÃ¤ytÃ¤ ettÃ¤ olet kokenut tÃ¤mÃ¤n
4. **Johdonmukaisuus**: Pysy tyylissÃ¤ ja Ã¤Ã¤nessÃ¤

ESIMERKKI:
HEIKKO ETHOS: "Olen asiantuntija tÃ¤ssÃ¤ asiassa."
VAHVA ETHOS: "HÃ¤n tutki haavaa. Reunat olivat sileÃ¤t - leikkaus, ei repiÃ¤. TerÃ¤vÃ¤ veitsi, oikeastaan skalpelli. Leikkaajan kÃ¤si oli varma."

TEHTÃ„VÃ„:
1. Tunnista kohdat missÃ¤ tarvitaan luottavuutta
2. LisÃ¤Ã¤ yksityiskohtia jotka osoittavat asiantuntemusta
3. Poista yltiÃ¶pÃ¤inen vÃ¤ittÃ¤minen
4. Anna 3-5 ethos-vahvistusta

VASTAA SUOMEKSI.`
      },
      {
        id: 'pathos',
        name: 'Pathos (Tunne)',
        description: 'Kosketa fyysisesti',
        prompt: `Vahvista PATHOS (emotionaalinen vaikutus):

TEKSTI:
\${getActiveItem()?.content || '[Ei sisÃ¤ltÃ¶Ã¤]'}

PATHOS: Kosketa lukijan tunteisiin niin ettÃ¤ hÃ¤nen KEHONSA reagoi.

TEKNIIKAT:
1. **Bodily sensations**: "Kurkkua kuristaa", "Vatsa kiristyy"
2. **Universaalit tunteet**: Menetys, pelko, rakkaus, pettymys
3. **HenkilÃ¶kohtainen + universaali**: "HÃ¤nen Ã¤itinsÃ¤" â†’ jokainen muistaa omansa
4. **Konkreetti, ei abstrakti**: "TyhjÃ¤ tuoli" > "YksinÃ¤isyys"

ESIMERKKI:
HEIKKO PATHOS: "HÃ¤n oli surullinen kun muisti Ã¤itiÃ¤Ã¤n."
VAHVA PATHOS: "Ã„idin tuoli oli tyhjÃ¤. Vain se peite, taitettu, niin kuin hÃ¤n oli opettanut. HÃ¤nen kÃ¤tensÃ¤ vÃ¤risivÃ¤t kun hÃ¤n kosketti sitÃ¤."

TEHTÃ„VÃ„:
1. Tunnista abstraktit tunnekuvaukset
2. Muuta ne konkreettisiksi, kehollisiksi
3. KÃ¤ytÃ¤ yksityiskohtia jotka aktivoivat lukijan muistot
4. Anna 3-5 pathos-vahvistusta

VASTAA SUOMEKSI.`
      },
      {
        id: 'logos',
        name: 'Logos (Logiikka)',
        description: 'Piilota jÃ¤rki tunteeseen',
        prompt: `Integroi LOGOS (logiikka) narratiiviin:

TEKSTI:
\${getActiveItem()?.content || '[Ei sisÃ¤ltÃ¶Ã¤]'}

LOGOS: Rakenna looginen argumentti NÃ„YTTÃ„MÃ„LLÃ„, ei selittÃ¤mÃ¤llÃ¤.

TEKNIIKAT:
1. **Syy-seuraus**: NÃ¤ytÃ¤ A â†’ B â†’ C luonnollisesti
2. **Todisteet havainnossa**: Anna faktat havaintoina, ei vÃ¤ittÃ¤minÃ¤
3. **Deduktiivinen logiikka hahmon kautta**: Hahmo pÃ¤Ã¤ttelee, lukija seuraa
4. **Piilota opetus**: Ã„lÃ¤ saaraa - anna lukijan oppia havainnoistaan

ESIMERKKI:
HEIKKO LOGOS: "HÃ¤n ymmÃ¤rsi ettÃ¤ mies valehteli."
VAHVA LOGOS: "Mies sanoi tulleensa junalla. Mutta ei ollut mÃ¤rkÃ¤, vaikka satoi. Ja hÃ¤nen kengissÃ¤Ã¤n oli punaista savea - sitÃ¤ lÃ¶ytyi vain aseman takana olevalta rakennustyÃ¶maalta. HÃ¤n ei ollut tullut junalla."

TEHTÃ„VÃ„:
1. Tunnista suorat selitykset/vÃ¤ittÃ¤mÃ¤t
2. Muuta ne havaintosarjoiksi
3. Anna lukijan pÃ¤Ã¤tellÃ¤ itse
4. Anna 3-5 logos-vahvistusta

VASTAA SUOMEKSI.`
      },
      {
        id: 'suspense_dopamine',
        name: 'Suspense & Dopamiini',
        description: 'Lupaa, viivytÃ¤, paljasta',
        prompt: `Luo SUSPENSE (dopamiinivirtaus):

TEKSTI:
\${getActiveItem()?.content || '[Ei sisÃ¤ltÃ¶Ã¤]'}

SUSPENSE: Lupaa palkinto â†’ ViivytÃ¤ sitÃ¤ â†’ Paljasta (tai Ã¤lÃ¤).

3-VAIHE RAKENNE:
1. **LUPAUS**: "HÃ¤n avasi kirjeen. SisÃ¤llÃ¤ oli jotain, joka muuttaisi kaiken."
2. **VIIVYTYS**: "Mutta ensin hÃ¤n piti kaivaa muististaan..." [2-3 kappaletta muuta]
3. **PALJASTUS/SUBVERSION**: "HÃ¤n luki. Kaksi sanaa. HÃ¤n ei ollut varma naurettaisiinko vai itkisikÃ¶."

DOPAMIINI: Ennakointi â†’ Odotus â†’ Tyydytys. VenytÃ¤ "Odotus"-vaihetta.

TEHTÃ„VÃ„:
1. Tunnista mahdolliset suspense-hetket
2. LisÃ¤Ã¤ LUPAUS ennen paljastusta
3. VenytÃ¤ VIIVYTYS (mutta Ã¤lÃ¤ liikaa)
4. Anna 3-5 suspense-rakennetta

VASTAA SUOMEKSI.`
      },
      {
        id: 'contrast_power',
        name: 'Kontrastin voima',
        description: 'Vastakohtaisuus vahvistaa',
        prompt: `KÃ¤ytÃ¤ KONTRASTIN VOIMAA:

TEKSTI:
\${getActiveItem()?.content || '[Ei sisÃ¤ltÃ¶Ã¤]'}

KONTRASTIN VOIMA: Aseta vastakohdat vierekkÃ¤in â†’ kumpikin vahvistuu.

KONTRASTI-TYYPIT:
1. **Valo/Varjo**: "Aurinko paistoi, mutta hÃ¤nen sisÃ¤llÃ¤Ã¤n oli pimeys"
2. **Nopea/Hidas**: "Maailma kiiti ohi. HÃ¤n seisoi paikallaan."
3. **Hiljainen/Ã„Ã¤nekÃ¤s**: "Kaupunki karjui. HÃ¤n kuiskasi."
4. **Suuri/Pieni**: "Vuoret kohoavat. HÃ¤n oli pieni kuin hiekanjyvÃ¤."
5. **ElÃ¤mÃ¤/Kuolema**: "Vauva nauroi. Ruumis makasi hiljaa."

TEHTÃ„VÃ„:
1. Tunnista koht at missÃ¤ kontrasti vahvistaisi
2. Aseta vastakohdat vierekkÃ¤in (ei erilleen)
3. Ã„lÃ¤ selitÃ¤ kontrastia - anna sen toimia
4. Anna 3-5 kontrasti-ehdotusta

ESIMERKKI:
ENNEN: "HÃ¤n oli onnellinen vaikka ympÃ¤rillÃ¤ oli surkeutta"
JÃ„LKEEN: "Ruumiita kadulla. Tuhkaa ilmassa. HÃ¤n hymyili ensimmÃ¤istÃ¤ kertaa viikkoon."

VASTAA SUOMEKSI.`
      },
      {
        id: 'anchoring',
        name: 'Ankkurointi',
        description: 'EnsimmÃ¤inen mielikuva hallitsee kaikkea',
        prompt: `KÃ¤ytÃ¤ ANKKUROINTIA:

TEKSTI:
\${getActiveItem()?.content || '[Ei sisÃ¤ltÃ¶Ã¤]'}

ANKKUROINTI: EnsimmÃ¤inen kuvaus henkilÃ¶stÃ¤/paikasta/asiasta mÃ¤Ã¤rittÃ¤Ã¤ miten lukija tulkitsee kaiken myÃ¶hemmÃ¤n.

TEKNIIKAT:
1. **Vahva ensivaikutelma**: EnsimmÃ¤inen lause hahmon esittelyssÃ¤ on KRIITTINEN
2. **Kontrastoitu myÃ¶hemmin**: Ankkuri vs. realiteetti = jÃ¤nnite
3. **Moniaistillinen ankkuri**: KÃ¤ytÃ¤ useita aisteja ensikuvauksessa
4. **Emotionaalinen lataus**: Ankkuroi tunteeseen, ei vain ulkonÃ¤kÃ¶Ã¶n

ESIMERKKI:
HEIKKO ANKKURI: "Mies astui sisÃ¤Ã¤n. HÃ¤n oli pitkÃ¤."
VAHVA ANKKURI: "Mies tÃ¤ytti oviaukon. Ei vain kokonsa takia - jotain hÃ¤nen katseessaan nielaisi valon, tilan, ilman. Huone pieneni."

TEHTÃ„VÃ„:
1. Tunnista ensimmÃ¤iset kuvaukset (hahmo, paikka, asia)
2. Vahvista ne - lisÃ¤Ã¤ aisteja, emotioita, vaikutusta
3. Jos ankkuri on olemassa, voitko kontrastoida sitÃ¤ myÃ¶hemmin?
4. Anna 3-5 ankkurointiehdotusta

VASTAA SUOMEKSI.`
      }
    ]
  },

  advanced: {
    title: 'âš¡ EDISTYNEET',
    color: 'red',
    techniques: [
      {
        id: 'meta_awareness',
        name: 'Meta-tason itsetietoisuus',
        description: 'Teksti tietÃ¤Ã¤ olevansa tekstiÃ¤',
        prompt: `LisÃ¤Ã¤ META-TASON ITSETIETOISUUS:

TEKSTI:
\${getActiveItem()?.content || '[Ei sisÃ¤ltÃ¶Ã¤]'}

META: Teksti tietÃ¤Ã¤ olevansa tekstiÃ¤. Kertoja/hahmo kommentoi kirjoittamista/kerrontaa.

TEKNIIKAT:
1. **Kertojan itsereflektio**: "Miten tÃ¤mÃ¤n kertoisin? Sanat eivÃ¤t riitÃ¤."
2. **Suora puhuttelu**: "SinÃ¤, lukija, tiedÃ¤t tÃ¤mÃ¤n tunteen."
3. **Kerronnan riko minen**: "TÃ¤mÃ¤ ei ole se hetki jolloin hÃ¤n kuoli. Se tulee myÃ¶hemmin."
4. **Kirjoittajan hÃ¤ivÃ¤hdys**: "Jos olisin parempi kirjailija, osaisin kuvata..."

VAROITUS: KÃ¤ytÃ¤ sÃ¤Ã¤steliÃ¤Ã¤sti. Liika meta rikkoo immersion.

ESIMERKKI:
"HÃ¤n avasi oven. (EikÃ¶ tÃ¤mÃ¤ aina tapahdu nÃ¤in? Ovi avautuu, ja kaikki muuttuu. Mutta me jatkamme lukemista, koska haluamme tietÃ¤Ã¤ mitÃ¤ oven takana on.) SisÃ¤llÃ¤ oli..."

ANNA:
- 2-3 meta-hetkeÃ¤ (MAX)
- Varmista ettÃ¤ ne palvelevat tarinaa
- Ã„lÃ¤ ylikÃ¤ytÃ¤

VASTAA SUOMEKSI.`
      },
      {
        id: 'layering',
        name: 'Kerroksellisuus',
        description: 'Tarina tarinan sisÃ¤llÃ¤',
        prompt: `Luo KERROKSELLISUUS:

TEKSTI:
\${getActiveItem()?.content || '[Ei sisÃ¤ltÃ¶Ã¤]'}

KERROKSELLISUUS: Useita kerrontatasoja jotka peilaavat toisiaan.

TASOT:
1. **PÃ¤Ã¤kertomus**: Nykyhetki
2. **Sisempi kertomus**: Muisto/flashback/tarina-tarinan-sisÃ¤llÃ¤
3. **Symbolinen kerros**: Metaforat/kuvat jotka peilaavat pÃ¤Ã¤kertomusta

TEKNIIKAT:
- **Frame narrative**: "HÃ¤n kertoi tarinan..." â†’ sisempi tarina
- **Rinnakkaisuus**: Kaksi tarinaa samanaikaisesti, toinen peilaa toista
- **Metafora-kerros**: Luontokuvaus peilaa hahmon sisÃ¤istÃ¤ tilaa

ESIMERKKI:
Kerros 1: "HÃ¤n istui kahvilassa, yksin."
Kerros 2: [Muisto Ã¤idistÃ¤, myÃ¶s kahvilassa, myÃ¶s yksin]
Kerros 3: "Ikkunassa sadeet iski lasin, yksinÃ¤iset pisarat."

TEHTÃ„VÃ„:
1. Tunnista mahdolliset kerrokset
2. Ehdota sisempi tarina/muisto joka peilaa pÃ¤Ã¤kertomusta
3. LisÃ¤Ã¤ symbolinen kerros (luonto/sÃ¤Äƒ/objekti)
4. Varmista ettÃ¤ kerrokset keskustelevat keskenÃ¤Ã¤n

VASTAA SUOMEKSI.`
      },
      {
        id: 'unreliable_narrator',
        name: 'EpÃ¤luotettava kertoja',
        description: 'Lukija epÃ¤ilee jokaista sanaa',
        prompt: `Luo EPÃ„LUOTETTAVA KERTOJA:

TEKSTI:
\${getActiveItem()?.content || '[Ei sisÃ¤ltÃ¶Ã¤]'}

EPÃ„LUOTETTAVA KERTOJA: Anna vihjeitÃ¤ ettÃ¤ kertoja/hahmo ei kerro totuutta (itselle tai lukijalle).

TEKNIIKAT:
1. **Ristiriidat**: Sanoo X, mutta toimii Y
2. **Liioittelu**: "Kaikki vihasivat hÃ¤ntÃ¤" (todella?)
3. **Valikoiva muisti**: "En muista mitÃ¤ tapahtui seuraavaksi"
4. **Defensiivisyys**: "Se ei ollut minun vikani" (toistuvasti)
5. **Faktojen muutos**: Ensiksi sanoo A, myÃ¶hemmin B

ESIMERKKI:
"HÃ¤n ei ikinÃ¤ huutanut minulle. Totta, hÃ¤n korotti Ã¤Ã¤ntÃ¤Ã¤n joskus, mutta se oli stressiÃ¤, tyÃ¶tÃ¤, ei minua. HÃ¤n rakasti minua. Sen tiedÃ¤n. Vaikka hÃ¤n sanoi... Ei, hÃ¤n ei sanonut sitÃ¤. En muista oikein. Satoi kovasti sinÃ¤ pÃ¤ivÃ¤nÃ¤."

TEHTÃ„VÃ„:
1. LisÃ¤Ã¤ 2-3 ristiriitaa (sanat vs. teot)
2. Anna kertoja puolustautumaan liikaa
3. KÃ¤ytÃ¤ "ehkÃ¤", "luultavasti", "en muista"
4. Ã„LÃ„ PALJASTA suoraan - anna lukijan epÃ¤illÃ¤

VASTAA SUOMEKSI.`
      },
      {
        id: 'silence_power',
        name: 'Hiljaisuuden voima',
        description: 'Sanomattomat sanat painavat eniten',
        prompt: `KÃ¤ytÃ¤ HILJAISUUDEN VOIMAA:

TEKSTI:
\${getActiveItem()?.content || '[Ei sisÃ¤ltÃ¶Ã¤]'}

HILJAISUUDEN VOIMA: Sanomatta jÃ¤ttÃ¤minen on voimakkaampi kuin sanominen.

TEKNIIKAT:
1. **Keskeytetty lause**: "HÃ¤n halusi sanoa ettÃ¤ â€”"
2. **Hiljaisuus vastauksena**: "Rakastatko minua?' Hiljaisuus."
3. **Sanomaton ymmÃ¤rrys**: "He katsoivat toisiaan. He tiesivÃ¤t."
4. **TyhjÃ¤ tila dialogissa**: [ei tekstiÃ¤, vain vÃ¤lilyÃ¶nti]

ESIMERKKI:
ENNEN: "HÃ¤n sanoi ettÃ¤ rakasti hÃ¤ntÃ¤ mutta ei ollut varma."
JÃ„LKEEN: "'Rakastan sinua', hÃ¤n sanoi. Hiljaisuus venÃ¤hti. HÃ¤n toisti: 'Rakastan.' HÃ¤n ei sanonut enÃ¤Ã¤ mitÃ¤Ã¤n."

TEHTÃ„VÃ„:
1. Tunnista kohdat missÃ¤ liikaa sanotaan
2. Poista sanoja, lisÃ¤Ã¤ hiljaisuutta
3. KÃ¤ytÃ¤ keskeytettyÃ¤ puhetta
4. Anna 3-5 hiljaisuusehdotusta

MUISTA: Hiljaisuus on aktiivinen, ei passiivinen. Se PAISTAA.

VASTAA SUOMEKSI.`
      }
    ]
  },

  // Vaihe 6: LocationKeeper-tekniikat
  locationAnalysis: {
    title: 'ðŸ“ PAIKKOJEN ANALYYSI',
    color: 'green',
    techniques: [
      {
        id: 'detect_locations',
        name: 'Tunnista paikat',
        description: 'Etsi kaikki paikat tekstistÃ¤ automaattisesti',
        prompt: `Tunnista KAIKKI paikat tÃ¤stÃ¤ tekstistÃ¤. SisÃ¤llytÃ¤ kaupungit, rakennukset, kadut, luontokohteet, maamerkit.

TEKSTI:
${getActiveItem()?.content || '[Ei sisÃ¤ltÃ¶Ã¤]'}

Palauta VAIN JSON (ei mitÃ¤Ã¤n muuta tekstiÃ¤):
{
  "locations": [
    {
      "name": "paikan nimi",
      "type": "city/building/landmark/public_square/street/nature/interior",
      "city": "kaupunki jos mainittu",
      "country": "maa jos mainittu",
      "context": "lause jossa paikka mainitaan"
    }
  ]
}

Jos ei paikkoja, palauta: {"locations": []}

VASTAA PELKKÃ„ JSON.`
      },
      {
        id: 'analyze_place',
        name: 'Analysoi paikka',
        description: 'SyvÃ¤luotaava analyysi tietyn paikan tunnelmasta',
        prompt: `Analysoi tÃ¤mÃ¤ paikka kirjailijaa varten:

PAIKKA: {selectedLocation}

FAKTAT:
${JSON.stringify(getSelectedLocation()?.facts || {}, null, 2)}

VISUAALISET ELEMENTIT:
${JSON.stringify(getSelectedLocation()?.visual || {}, null, 2)}

KIRJAN GENRE:
${GENRE_OPTIONS.find(g => g.id === project.genre)?.name || 'Psykologinen trilleri'}

Palauta JSON:
{
  "analysis": {
    "atmosphere": "paikan tunnelma",
    "sensory_details": ["aistilliset yksityiskohdat"],
    "genre_fit": "miten sopii genreen",
    "writing_opportunities": ["kirjoitusmahdollisuudet"]
  }
}

VASTAA SUOMEKSI, JSON-MUODOSSA.`
      },
      {
        id: 'generate_description',
        name: 'Generoi kuvaus',
        description: 'Luo genrespesifi kuvaus paikasta',
        prompt: `Olet LocationKeeper - paikkojen kuvausasiantuntija.

PAIKKA:
{selectedLocation}

FAKTAT:
${JSON.stringify(getSelectedLocation()?.facts || {}, null, 2)}

VISUAALISET ELEMENTIT:
${JSON.stringify(getSelectedLocation()?.visual || {}, null, 2)}

KIRJAN GENRE:
${GENRE_OPTIONS.find(g => g.id === project.genre)?.name || 'Psykologinen trilleri'}

TEHTÃ„VÃ„:
Kirjoita 2-4 kappaletta paikka-kuvausta joka:

1. **Faktatarkka**: KÃ¤ytÃ¤ todellisia yksityiskohtia paikasta
2. **Aistillinen**: Aktivoi nÃ¤kÃ¶, kuulo, haju, tunto (ja maku jos relevantti)
3. **Genrespesifi**: Sovita tunnelma genreen (${project.genre})
4. **Tyylillinen**: KÃ¤ytÃ¤ defamiliarisaatiota, rytmiÃ¤, konkretiaa
5. **Emotionaalinen**: Luo tunnelma joka tukee kohtausta

GENRE-OHJEET:
${getGenreGuidance(project.genre)}

Ã„LÃ„:
- Listaa faktoja ("Paikalla on X ja Y")
- Kerro tunnelmaa suoraan ("Paikka oli ahdistava")
- KÃ¤ytÃ¤ kliseitÃ¤
- Ylihypettele

KIRJOITA NIIN ETTÃ„ SE SOPII SUORAAN ROMAANIIN.
VASTAA SUOMEKSI.`
      }
    ]
  },

  // Vaihe 5: CharacterKeeper-tekniikat
  characterContinuity: {
    title: 'ðŸ‘¥ HAHMOJEN JATKUVUUS',
    color: 'pink',
    techniques: [
      {
        id: 'check_all',
        name: 'Tarkista kaikki hahmot',
        description: 'Analysoi kaikkien hahmojen jatkuvuus tÃ¤ssÃ¤ kohtauksessa',
        prompt: `Olet CharacterKeeper - hahmojen jatkuvuuden valvoja.

TEHTÃ„VÃ„: Tarkista KAIKKI hahmot tÃ¤ssÃ¤ kohtauksessa seuraavien kriteerien mukaan:

HAHMOT:
{characterList}

TARKISTETTAVAT ASIAT:
1. **Toimintalogiikka**: Ovatko hahmojen teot uskottavia heidÃ¤n tavoitteidensa/pelkojensa/heikkouksiensa valossa?
2. **Ã„Ã¤ni**: Puhuuko hahmo tyylilleen uskollisesti? (lausepituus, sanavalinnat)
3. **Psykologinen jatkuvuus**: Muuttuuko hahmon kÃ¤ytÃ¶s liian Ã¤killisesti ilman triggeriÃ¤?
4. **Faktat**: Ovatko fyysiset yksityiskohdat (ulkonÃ¤kÃ¶, ikÃ¤, loukkaantumiset) johdonmukaisia?
5. **Resurssit**: KÃ¤yttÃ¤Ã¤kÃ¶ hahmo esineitÃ¤/taitoja, joita hÃ¤nellÃ¤ ei ole?
6. **Suhteet**: Ovatko hahmojen vÃ¤liset vuorovaikutukset uskottavia?

TEKSTI:
${getActiveItem()?.content || '[Ei sisÃ¤ltÃ¶Ã¤]'}

VASTAA TÃ„SSÃ„ MUODOSSA:

## ðŸŸ¢ TOIMIVAT HAHMOT
[Listaa hahmot joiden jatkuvuus on kunnossa]

## ðŸŸ¡ HUOMIOITAVAA
[Pienet epÃ¤johdonmukaisuudet - ehdota korjaus]

## ðŸ”´ KRIITTISET ONGELMAT
[Isot ristiriidat - vaativat korjauksia]

## ðŸ’¡ EHDOTUKSET
[Konkreettiset parannukset - lisÃ¤Ã¤ trigger, muuta dialogi, korjaa fakta]

VASTAA SUOMEKSI.`
      },
      {
        id: 'check_voice',
        name: 'Tarkista Ã¤Ã¤ni',
        description: 'Varmista ettÃ¤ hahmo puhuu/ajattelee tyylilleen uskollisesti',
        prompt: `Tarkista Ã„Ã„NIJATKUVUUS tÃ¤lle hahmolle:

HAHMO:
{selectedCharacter}

HAHMON Ã„Ã„NEN TUNNUSPIIRTEET:
- Puhetyyli: {voiceDescription}
- Tyypilliset fraasit: {lexicon}
- Lausepituus: noin {avgSentenceLength} sanaa

TEKSTI:
${getActiveItem()?.content || '[Ei sisÃ¤ltÃ¶Ã¤]'}

TARKISTA:
1. Onko dialogin tyyli johdonmukainen?
2. KÃ¤yttÃ¤Ã¤kÃ¶ hahmo tyypillisiÃ¤ fraasejaan?
3. Onko lausepituus keskimÃ¤Ã¤rin oikea?
4. Onko sanavalinnat hahmolle uskollisia?

ANNA:
- Arvosana 1-10
- Kohdat jotka eivÃ¤t kuulosta hahmolta
- Korjausehdotukset (konkreettiset diff-muutokset)

VASTAA SUOMEKSI.`
      },
      {
        id: 'check_psychology',
        name: 'Tarkista psykologia',
        description: 'Analysoi hahmon pÃ¤Ã¤tÃ¶sten ja tunteiden johdonmukaisuus',
        prompt: `Analysoi PSYKOLOGINEN JATKUVUUS:

HAHMO:
{selectedCharacter}

PSYKOLOGINEN PROFIILI:
- Tavoite: {want}
- Pelko: {fear}
- Heikkous: {weakness}
- Arvot: {values}

TEKSTI:
${getActiveItem()?.content || '[Ei sisÃ¤ltÃ¶Ã¤]'}

TARKISTA:
1. **PÃ¤Ã¤tÃ¶kset**: Ovatko hahmon valinnat johdonmukaisia tavoitteidensa kanssa?
2. **Reaktiot**: Ovatko tunnereaktion uskottavia?
3. **Tunne-hypyt**: Tapahtuuko liian suuria tunnemuutoksia ilman triggeriÃ¤?
4. **Arvo-ristiriidat**: Toimiiko hahmo arvojensa vastaisesti ilman hyvÃ¤Ã¤ syytÃ¤?

JOS LÃ–YDÃ„T ONGELMIA:
- Ehdota "mikrotriggeri" (pieni tapahtuma/muisto/bodysensaatio) joka perustelee muutoksen
- Tai suosittele teon/pÃ¤Ã¤tÃ¶ksen muuttamista

VASTAA SUOMEKSI.`
      },
      {
        id: 'check_resources',
        name: 'Tarkista resurssit',
        description: 'Varmista ettÃ¤ esineet/taidot/loukkaantumiset ovat johdonmukaisia',
        prompt: `Tarkista RESURSSIT JA FYYSISET FAKTAT:

HAHMO:
{selectedCharacter}

RESURSSIT/TAIDOT: {resources}
LOUKKAANTUMISET: {injuries}
ULKONÃ„KÃ–: {appearance}

TEKSTI:
${getActiveItem()?.content || '[Ei sisÃ¤ltÃ¶Ã¤]'}

TARKISTA:
1. KÃ¤yttÃ¤Ã¤kÃ¶ hahmo esineitÃ¤ joita hÃ¤nellÃ¤ ei ole?
2. Sovelletaanko taitoja jotka hÃ¤neltÃ¤ puuttuvat?
3. Onko loukkaantumisia mainittu/huomioitu?
4. Muuttuuko ulkonÃ¤kÃ¶ ilman selitystÃ¤?
5. IlmestyykÃ¶/hÃ¤viÃ¤Ã¤kÃ¶ esineitÃ¤?

JOS LÃ–YDÃ„T VIRHEITÃ„:
- LisÃ¤Ã¤ esine aiempaan kohtaukseen TAI
- Poista viittaus esineeseen TAI
- LisÃ¤Ã¤ lause joka selittÃ¤Ã¤ muutoksen

VASTAA SUOMEKSI konkretilla korjausehdotuksilla.`
      },
      {
        id: 'suggest_arc',
        name: 'Ehdota kehitystÃ¤',
        description: 'Anna ideoita hahmon psykologiseen kasvuun',
        prompt: `Ehdota HAHMOKAAREN KEHITYSTÃ„:

HAHMO:
{selectedCharacter}

NYKYINEN TILA:
- Tavoite: {want}
- Pelko: {fear}
- Uskomukset: {beliefs}

KOHTAUKSEN SISÃ„LTÃ–:
${getActiveItem()?.content || '[Ei sisÃ¤ltÃ¶Ã¤]'}

TEHTÃ„VÃ„:
1. Tunnista 1-3 mahdollisuutta hahmon KASVUUN/MUUTOKSEEN tÃ¤ssÃ¤ kohtauksessa
2. Ehdota triggeri joka voisi kÃ¤ynnistÃ¤Ã¤ muutoksen (paljastus, pettymys, voitto)
3. Kuvaa miten uskomus/arvo voisi muuttua
4. PidÃ¤ muutos realistisena (pieniÃ¤ askeleita, ei Ã¤kkinÃ¤isiÃ¤ tÃ¤yskÃ¤Ã¤nnÃ¶ksiÃ¤)

ESIMERKKI:
"Jos hahmo kohtaa tÃ¤ssÃ¤ kohtauksessa ystÃ¤vÃ¤n pettÃ¤myksen, se voisi alkaa rapauttaa hÃ¤nen uskoaan luottamukseen. LisÃ¤Ã¤ pieni hetki jossa hÃ¤n HUOMAA epÃ¤rÃ¶ivÃ¤nsÃ¤ (bodysensaatio: kÃ¤det kiristyvÃ¤t nyrkkiin) ennen kuin vastaa ystÃ¤vÃ¤n kysymykseen."

ANNA 2-3 KONKREETTISTA KAARI-IDEAA. VASTAA SUOMEKSI.`
      },
      {
        id: 'create_trigger',
        name: 'Luo trigger-hetki',
        description: 'Luo uskottava syy isommalle muutokselle',
        prompt: `Luo TRIGGER-HETKI hahmon muutokselle:

HAHMO:
{selectedCharacter}

HALUTTU MUUTOS:
[KÃ¤yttÃ¤jÃ¤: Kerro mitÃ¤ muutosta haluat - esim. "hahmo menettÃ¤Ã¤ luottamuksen mentoriinsa"]

KOHTAUS:
${getActiveItem()?.content || '[Ei sisÃ¤ltÃ¶Ã¤]'}

TEHTÃ„VÃ„:
Luo USKOTTAVA TRIGGER joka perustelee muutoksen. Triggerin tulee:
1. Olla emotionaalisesti voimakas (shokki, paljastus, pettymys, voitto)
2. YhdistyÃ¤ hahmon pelkoihin/arvoihin
3. Olla konkreettinen ja koettavissa (nÃ¤hdÃ¤Ã¤n/kuullaan/tunnetaan)
4. Johtaa luonnollisesti muutokseen

ANNA:
- 2-4 kappaleen triggeri-kohtaus (suoraan tekstiin lisÃ¤ttÃ¤vÃ¤)
- Hahmon sisÃ¤inen reaktio (ajatukset/tunteet)
- Lyhyt selitys miten tÃ¤mÃ¤ johtaa muutokseen

KIRJOITA KAUNIISTI, KUIN OSA ROMAANIA. VASTAA SUOMEKSI.`
      }
    ]
  }
};

// ========== NORMAN-KRUG-NATSUME: UI/UX Components ==========

// NORMAN: AI Feedback Component - Shows what AI did with progressive disclosure
const AIFeedback = ({ action, details, type = 'info', onDismiss }) => {
  if (!action) return null;
  
  const icons = {
    info: 'âœ¨',
    success: 'âœ…',
    learning: 'ðŸ§ ',
    rhythm: 'ðŸŽµ'
  };
  
  return e('div', { 
    className: 'fixed top-4 right-4 z-50 animate-slideIn'
  },
    e('div', { 
      className: 'bg-[var(--mac-bg-tertiary)] backdrop-blur-xl rounded-lg px-4 py-3 shadow-xl border border-[rgba(255,255,255,0.1)] max-w-sm'
    },
      e('div', { className: 'flex items-start gap-3' },
        // Icon
        e('div', { 
          className: 'w-6 h-6 rounded-full bg-[var(--mac-accent-blue)] flex items-center justify-center text-xs flex-shrink-0'
        }, icons[type]),
        
        // Content
        e('div', { className: 'flex-1 min-w-0' },
          e('div', { 
            className: 'text-sm font-medium',
            style: { color: 'var(--mac-text-primary)' }
          }, action),
          details && e('div', { 
            className: 'text-xs mt-1',
            style: { color: 'var(--mac-text-secondary)' }
          }, details)
        ),
        
        // Dismiss button
        onDismiss && e('button', {
          onClick: onDismiss,
          className: 'text-xs opacity-50 hover:opacity-100 transition-opacity'
        }, 'Ã—')
      )
    )
  );
};

// NORMAN: Contextual AI Bubble - Appears on cursor pause
const AIContextualBubble = ({ isVisible, suggestion, onApply, onDismiss, position }) => {
  if (!isVisible || !suggestion) return null;
  
  return e('div', { 
    className: 'absolute z-50 animate-breatheIn',
    style: {
      top: position?.top || '50%',
      left: position?.left || '50%',
      transform: 'translate(-50%, -100%)',
      marginTop: '-8px'
    }
  },
    e('div', { className: 'relative' },
      // Arrow
      e('div', { 
        className: 'absolute -bottom-1 left-4 w-2 h-2 bg-[var(--mac-bg-tertiary)] rotate-45 border-r border-b border-[rgba(255,255,255,0.1)]'
      }),
      
      // Bubble content
      e('div', { 
        className: 'bg-[var(--mac-bg-tertiary)] rounded-lg p-3 shadow-lg border border-[rgba(255,255,255,0.1)] min-w-[280px]'
      },
        // Suggestion text
        e('div', { 
          className: 'text-xs mb-2',
          style: { color: 'var(--mac-text-secondary)' }
        }, suggestion.reason || 'AI-ehdotus'),
        
        // Actions - KRUG: Simple choice, not forced
        e('div', { className: 'flex gap-2' },
          e('button', {
            onClick: onApply,
            className: 'px-3 py-1 rounded bg-[var(--mac-accent-blue)] text-white text-xs font-medium hover:opacity-90 transition-all'
          }, 'âœ¨ Sovella'),
          e('button', {
            onClick: onDismiss,
            className: 'px-3 py-1 rounded text-xs hover:bg-[rgba(255,255,255,0.08)] transition-all',
            style: { color: 'var(--mac-text-secondary)' }
          }, 'Ei kiitos')
        )
      )
    )
  );
};

// NATSUME: Inspiration Panel - Appears when stuck
const InspirationPanel = ({ isVisible, inspiration, onDismiss }) => {
  if (!isVisible || !inspiration) return null;
  
  return e('div', { 
    className: 'fixed bottom-4 left-4 z-50 animate-slideIn'
  },
    e('div', { 
      className: 'bg-[var(--mac-bg-tertiary)] backdrop-blur-xl rounded-lg p-4 shadow-xl border border-[rgba(255,255,255,0.1)] max-w-xs'
    },
      // Header
      e('div', { className: 'flex items-center gap-2 mb-3' },
        e('span', { className: 'text-xl' }, 'ðŸ’¡'),
        e('div', { 
          className: 'text-sm font-medium',
          style: { color: 'var(--mac-text-primary)' }
        }, 'Inspiraatio')
      ),
      
      // Content
      inspiration.type === 'quote' && e('blockquote', { 
        className: 'text-sm italic border-l-2 border-[var(--mac-accent-purple)] pl-3',
        style: { color: 'var(--mac-text-secondary)' }
      },
        `"${inspiration.text}"`,
        inspiration.author && e('cite', { 
          className: 'block text-xs mt-2 not-italic opacity-50'
        }, `â€” ${inspiration.author}`)
      ),
      
      inspiration.type === 'rhythm' && e('div', null,
        e('div', { 
          className: 'text-xs mb-2',
          style: { color: 'var(--mac-text-secondary)' }
        }, 'Kokeile tÃ¤tÃ¤ rytmiÃ¤:'),
        e('div', { 
          className: 'font-mono text-xs bg-black/20 rounded p-2',
          style: { color: 'var(--mac-text-primary)' }
        }, inspiration.pattern)
      ),
      
      // Dismiss
      e('button', {
        onClick: onDismiss,
        className: 'mt-3 text-xs opacity-50 hover:opacity-100 transition-opacity'
      }, 'Kiitos ðŸ‘')
    )
  );
};

// NATSUME: Flow Mode Indicator - Shows current mode subtly
const FlowModeIndicator = ({ mode }) => {
  if (mode === 'normal') return null;
  
  const labels = {
    focus: 'ðŸŽ¯ Fokus',
    rhythm: 'ðŸŽµ Rytmi',
    review: 'ðŸ” Tarkistus'
  };
  
  return e('div', { 
    className: 'fixed bottom-4 right-4 text-xs opacity-20 pointer-events-none z-10',
    style: { color: 'var(--mac-text-primary)' }
  }, labels[mode] || '');
};

// NORMAN: Learning Feedback - Shows AI learned from rejection
const LearningFeedback = ({ message, isVisible, onDismiss }) => {
  if (!isVisible) return null;
  
  return e('div', { 
    className: 'fixed top-20 right-4 z-50 animate-slideIn'
  },
    e('div', { 
      className: 'bg-[var(--mac-bg-tertiary)] backdrop-blur-xl rounded-lg px-4 py-3 shadow-xl border border-[rgba(255,255,255,0.1)] max-w-sm'
    },
      e('div', { className: 'flex items-start gap-3' },
        e('div', { 
          className: 'w-6 h-6 rounded-full bg-[var(--mac-accent-purple)] flex items-center justify-center text-xs'
        }, 'ðŸ§ '),
        e('div', { 
          className: 'text-xs',
          style: { color: 'var(--mac-text-secondary)' }
        }, message),
        e('button', {
          onClick: onDismiss,
          className: 'text-xs opacity-50 hover:opacity-100 transition-opacity ml-2'
        }, 'Ã—')
      )
    )
  );
};

// KRUG: Simple Status Bar - Always visible, minimal
const SimpleStatusBar = ({ wordCount, saveStatus }) => {
  const statusIcons = {
    saved: 'âœ“',
    saving: 'â³',
    error: 'âš ï¸'
  };
  
  const statusText = {
    saved: 'Tallennettu',
    saving: 'Tallennetaan...',
    error: 'Virhe tallennuksessa'
  };
  
  return e('div', { 
    className: 'h-8 bg-[var(--mac-bg-secondary)] border-t border-[rgba(255,255,255,0.05)] flex items-center justify-between px-4 text-xs',
    style: { color: 'var(--mac-text-secondary)' }
  },
    e('div', null, `${wordCount || 0} sanaa`),
    e('div', { className: 'flex items-center gap-1' },
      e('span', null, statusIcons[saveStatus]),
      e('span', null, statusText[saveStatus])
    )
  );
};

// NORMAN: Writer-Centric Sidebar Section
const WriterSidebarSection = ({ title, icon, children, defaultExpanded = true }) => {
  const [isExpanded, setIsExpanded] = useState(defaultExpanded);
  
  return e('div', { className: 'mb-4' },
    // Section header - clickable to expand/collapse
    e('button', {
      className: 'w-full px-3 py-2 flex items-center justify-between hover:bg-[rgba(255,255,255,0.05)] transition-colors rounded',
      onClick: () => setIsExpanded(!isExpanded)
    },
      e('div', { 
        className: 'text-[11px] font-semibold uppercase tracking-wide flex items-center gap-2',
        style: { color: 'var(--mac-text-tertiary)' }
      },
        e('span', null, icon),
        e('span', null, title)
      ),
      e('span', { 
        className: 'text-xs',
        style: { color: 'var(--mac-text-tertiary)' }
      }, isExpanded ? 'â–¼' : 'â–¶')
    ),
    
    // Content - collapsible
    isExpanded && e('div', { className: 'px-2 mt-1' }, children)
  );
};

// KRUG: Visual Hierarchy - Primary/Secondary/Tertiary Buttons
const PrimaryButton = ({ children, onClick, className = '', title }) => {
  return e('button', {
    className: `px-4 py-2 rounded-lg font-semibold transition-all ${className}`,
    style: {
      background: 'var(--mac-accent-blue)',
      color: '#ffffff'
    },
    onClick,
    title
  }, children);
};

const SecondaryButton = ({ children, onClick, className = '', title }) => {
  return e('button', {
    className: `px-3 py-1.5 rounded transition-all hover:bg-[rgba(255,255,255,0.08)] ${className}`,
    style: {
      background: 'rgba(255,255,255,0.05)',
      color: 'var(--mac-text-primary)'
    },
    onClick,
    title
  }, children);
};

const TertiaryButton = ({ children, onClick, className = '', title }) => {
  return e('button', {
    className: `px-2 py-1 text-sm rounded transition-opacity hover:opacity-100 opacity-70 ${className}`,
    style: {
      color: 'var(--mac-text-secondary)'
    },
    onClick,
    title
  }, children);
};

// ========== VISUAL MASTERS: UI Components ==========

// IDEO: Cognitive Load Indicator
const CognitiveLoadIndicator = ({ load }) => {
  if (load < 30) return null; // Only show when load is noticeable
  
  const getLoadColor = () => {
    if (load < 50) return '#30d158'; // Green - OK
    if (load < 75) return '#ff9f0a'; // Orange - Moderate
    return '#ff453a'; // Red - High
  };
  
  const getLoadLabel = () => {
    if (load < 50) return 'Kevyt kuorma';
    if (load < 75) return 'Keskitaso';
    return 'Korkea kuorma';
  };
  
  return e('div', {
    className: 'fixed bottom-20 right-4 z-20',
    style: { opacity: 0.6 }
  },
    e('div', {
      className: 'bg-black/50 backdrop-blur-xl rounded-lg px-3 py-2 flex items-center gap-2 text-xs'
    },
      // Load bar
      e('div', {
        className: 'w-16 h-1.5 bg-gray-700 rounded-full overflow-hidden'
      },
        e('div', {
          className: 'h-full transition-all duration-1000',
          style: {
            width: `${load}%`,
            background: getLoadColor()
          }
        })
      ),
      // Label
      e('span', {
        style: { color: getLoadColor() }
      }, getLoadLabel())
    )
  );
};

// SUPERSIDE: Work Phase Indicator
const WorkPhaseIndicator = ({ phase }) => {
  const phaseConfig = {
    drafting: { icon: 'ðŸš€', label: 'Luonnostelu', color: '#ff9f0a' },
    writing: { icon: 'âœï¸', label: 'Kirjoitus', color: '#0a84ff' },
    editing: { icon: 'âœ‚ï¸', label: 'Muokkaus', color: '#bf5af2' },
    reviewing: { icon: 'ðŸ”', label: 'Tarkistus', color: '#30d158' }
  };
  
  const config = phaseConfig[phase] || phaseConfig.writing;
  
  return e('div', {
    className: 'fixed top-20 right-4 z-20',
    style: { opacity: 0.4 }
  },
    e('div', {
      className: 'bg-black/50 backdrop-blur-xl rounded-lg px-3 py-2 flex items-center gap-2 text-xs transition-all duration-1000'
    },
      e('span', { className: 'text-lg' }, config.icon),
      e('span', { style: { color: config.color } }, config.label)
    )
  );
};

// IDEO: Transparent AI Indicator
const TransparentAIIndicator = ({ active, thinking, suggestionCount }) => {
  return e('div', {
    className: 'fixed bottom-4 right-4 z-20'
  },
    e('div', {
      className: 'bg-black/50 backdrop-blur-xl rounded-full px-4 py-2 flex items-center gap-3'
    },
      // Status dot
      e('div', {
        className: `w-2 h-2 rounded-full transition-all ${thinking ? 'animate-pulse' : ''}`,
        style: {
          background: thinking ? '#0a84ff' : active ? '#30d158' : '#6b6b6b'
        }
      }),
      
      // Status text
      e('span', {
        className: 'text-xs',
        style: { color: 'var(--mac-text-secondary)' }
      }, thinking ? 'Analysoin...' : active ? 'Valmis' : 'Lepotila'),
      
      // Suggestion count badge
      suggestionCount > 0 && e('span', {
        className: 'bg-blue-500 text-white text-xs px-2 py-0.5 rounded-full'
      }, suggestionCount)
    )
  );
};

// ========== NORMAN-KRUG-NATSUME: Utility Functions ==========

// NATSUME: Analyze emotional tone of text
const analyzeEmotionalTone = (text) => {
  if (!text || text.length < 50) return 'neutral';
  
  const calmWords = ['rauhallinen', 'hiljainen', 'pehmeÃ¤', 'hiljaa', 'tyyni', 'rauha', 'lempeÃ¤', 'hidas', 'kevyt'];
  const tenseWords = ['kiireinen', 'jÃ¤nnittÃ¤vÃ¤', 'nopea', 'Ã¤killinen', 'kiihkeÃ¤', 'rÃ¤jÃ¤htÃ¤vÃ¤', 'intensiivinen', 'voimakas'];
  
  const lowerText = text.toLowerCase();
  const calmCount = calmWords.filter(word => lowerText.includes(word)).length;
  const tenseCount = tenseWords.filter(word => lowerText.includes(word)).length;
  
  // Check sentence structure too
  const sentences = text.split(/[.!?]+/).filter(s => s.trim());
  const avgSentenceLength = sentences.reduce((sum, s) => sum + s.split(' ').length, 0) / sentences.length;
  
  if (calmCount > tenseCount && avgSentenceLength > 15) return 'calm';
  if (tenseCount > calmCount || avgSentenceLength < 10) return 'tense';
  return 'neutral';
};

// NATSUME: Generate inspiration based on context
const generateInspiration = (context, genre) => {
  const inspirations = {
    psychological_thriller: [
      { type: 'quote', text: 'Hiljaisuus on Ã¤Ã¤ni, joka kuuluu vain sisÃ¤ltÃ¤.', author: 'Tietoinen kirjoittaja' },
      { type: 'quote', text: 'Pelko ei ole heikkoutta, vaan keino sÃ¤ilyttÃ¤Ã¤ valppaana.', author: 'Psykologinen' },
      { type: 'rhythm', pattern: 'Lyhyt. Lyhyt. PitkÃ¤ ja virtaava lause joka antaa hengÃ¤hdystauon.' }
    ],
    romantic_drama: [
      { type: 'quote', text: 'Rakkaus ei ole se mitÃ¤ sanomme, vaan se mitÃ¤ jÃ¤tÃ¤mme sanomatta.', author: 'Romanttinen' },
      { type: 'rhythm', pattern: 'PehmeÃ¤ aalto. LempeÃ¤ liike. Ja lopulta hiljaisuus joka puhuu.' }
    ],
    mystery: [
      { type: 'quote', text: 'Jokainen kysymys paljastaa enemmÃ¤n kuin vastaus.', author: 'Mysteerio' },
      { type: 'rhythm', pattern: 'MikÃ¤? Miksi? Miten se tapahtui?' }
    ]
  };
  
  const genreInspirations = inspirations[genre] || inspirations.psychological_thriller;
  return genreInspirations[Math.floor(Math.random() * genreInspirations.length)];
};

// KRUG: Terminology mapping - Technical to Writer's language
const WRITER_TERMINOLOGY = {
  'save': 'Tallenna',
  'export': 'Vie',
  'import': 'Tuo',
  'settings': 'Asetukset',
  'preferences': 'Omat valinnat',
  'sync': 'Synkronoi',
  'backup': 'Varmuuskopio',
  'restore': 'Palauta',
  'delete': 'Poista',
  'duplicate': 'Monista',
  'rename': 'NimeÃ¤ uudelleen',
  'move': 'SiirrÃ¤',
  'edit': 'Muokkaa',
  'view': 'NÃ¤ytÃ¤',
  'hide': 'Piilota',
  'show': 'NÃ¤ytÃ¤',
  'close': 'Sulje',
  'open': 'Avaa'
};

// ========== VISUAL MASTERS: Design System ==========

// PENTAGRAM/BIERUT: Typographic Scale (Golden Ratio 1.618)
const TYPOGRAPHIC_SCALE = {
  xxxl: '44px',   // 44 / 1.618 â‰ˆ 27
  xxl: '27px',    // 27 / 1.618 â‰ˆ 17
  xl: '22px',     // Headline
  lg: '17px',     // Body (base)
  md: '15px',     // Subheadline
  sm: '13px',     // Caption
  xs: '11px'      // Footnote
};

// PENTAGRAM/BIERUT: Spacing Scale (8px base)
const SPACING_SCALE = {
  xxxxl: '96px',  // 12 * 8
  xxxl: '72px',   // 9 * 8
  xxl: '48px',    // 6 * 8
  xl: '32px',     // 4 * 8
  lg: '24px',     // 3 * 8
  md: '16px',     // 2 * 8
  sm: '12px',     // 1.5 * 8
  xs: '8px',      // 1 * 8
  xxs: '4px'      // 0.5 * 8
};

// SUPERSIDE: Comprehensive Design Tokens
const DESIGN_TOKENS = {
  // Typography
  fontFamily: {
    primary: '-apple-system, BlinkMacSystemFont, "SF Pro Display", system-ui, sans-serif',
    mono: '"SF Mono", Monaco, Menlo, monospace'
  },
  
  fontSize: TYPOGRAPHIC_SCALE,
  
  fontWeight: {
    light: 300,
    regular: 400,
    medium: 500,
    semibold: 600,
    bold: 700
  },
  
  lineHeight: {
    tight: 1.2,
    snug: 1.3,
    normal: 1.4,
    relaxed: 1.6,
    loose: 1.8
  },
  
  letterSpacing: {
    tight: '-0.02em',
    snug: '-0.01em',
    normal: '0',
    wide: '0.01em',
    wider: '0.02em'
  },
  
  // Spacing
  spacing: SPACING_SCALE,
  
  // Transitions (MOK: Timeless durations)
  transition: {
    instant: '100ms',
    fast: '150ms',
    normal: '300ms',
    slow: '500ms',
    verySlow: '1000ms',
    superSlow: '1500ms'
  },
  
  // Easing (Natural, organic)
  easing: {
    linear: 'linear',
    easeIn: 'cubic-bezier(0.4, 0, 1, 1)',
    easeOut: 'cubic-bezier(0, 0, 0.2, 1)',
    easeInOut: 'cubic-bezier(0.4, 0, 0.2, 1)',
    natural: 'cubic-bezier(0.4, 0.0, 0.2, 1)' // Sagmeister: organic
  }
};

// SAGMEISTER: Emotional color palettes
const EMOTIONAL_COLOR_ARCS = {
  positive: {
    primary: '#ff9f9f',  // Warm pink
    background: 'linear-gradient(180deg, #2a1a1f 0%, #1f0f14 100%)',
    accent: '#ffb3b3'
  },
  negative: {
    primary: '#7c9ef2',  // Cool blue
    background: 'linear-gradient(180deg, #1a1a2a 0%, #0f0f1f 100%)',
    accent: '#92aef7'
  },
  neutral: {
    primary: '#0a84ff',  // Standard blue
    background: 'linear-gradient(180deg, #1e1e1e 0%, #0f0f0f 100%)',
    accent: '#0a84ff'
  },
  intense: {
    primary: '#bf5af2',  // Purple
    background: 'linear-gradient(180deg, #1f1a2a 0%, #14101f 100%)',
    accent: '#d470ff'
  },
  calm: {
    primary: '#30d158',  // Green
    background: 'linear-gradient(180deg, #1a1f1a 0%, #0f140f 100%)',
    accent: '#40e168'
  }
};

// ========== VISUAL MASTERS: Utility Functions ==========

// SAGMEISTER: Analyze emotional arc (enhanced version)
const analyzeEmotionalArc = (text) => {
  if (!text || text.length < 100) return 'neutral';
  
  const sentences = text.split(/[.!?]+/).filter(s => s.trim());
  const lowerText = text.toLowerCase();
  
  // Word lists for emotional detection
  const positiveWords = ['iloinen', 'onnellinen', 'rauhallinen', 'lÃ¤mmin', 'valo', 'kaunis', 'rakkaus', 'hymy'];
  const negativeWords = ['surullinen', 'pimeÃ¤', 'kylmÃ¤', 'synkkÃ¤', 'pelottava', 'viha', 'suru', 'kipu'];
  const intenseWords = ['Ã¤killinen', 'rÃ¤jÃ¤htÃ¤vÃ¤', 'voimakas', 'intensiivinen', 'kiihkeÃ¤', 'hurja'];
  const calmWords = ['rauhallinen', 'hiljainen', 'tyyni', 'rauha', 'lempeÃ¤', 'pehmeÃ¤'];
  
  // Count emotional indicators
  const positiveScore = positiveWords.filter(w => lowerText.includes(w)).length;
  const negativeScore = negativeWords.filter(w => lowerText.includes(w)).length;
  const intenseScore = intenseWords.filter(w => lowerText.includes(w)).length;
  const calmScore = calmWords.filter(w => lowerText.includes(w)).length;
  
  // Check sentence structure
  const avgSentenceLength = sentences.reduce((sum, s) => sum + s.split(' ').length, 0) / sentences.length;
  const hasExclamations = (text.match(/!/g) || []).length;
  
  // Determine emotional arc
  if (intenseScore > 2 || hasExclamations > 3) return 'intense';
  if (calmScore > intenseScore && avgSentenceLength > 15) return 'calm';
  if (positiveScore > negativeScore + 2) return 'positive';
  if (negativeScore > positiveScore + 2) return 'negative';
  
  return 'neutral';
};

// SUPERSIDE: Detect work phase from activity
const detectWorkPhase = (metrics) => {
  const { editCount, wordCount, cursorMovements, timeSinceLastEdit } = metrics;
  
  // Many edits, few new words = editing
  if (editCount > 20 && wordCount < 100) return 'editing';
  
  // Lots of new words with flow = drafting
  if (wordCount > 500 && editCount < 10) return 'drafting';
  
  // Many cursor movements, few edits = reviewing
  if (cursorMovements > 50 && editCount < 5) return 'reviewing';
  
  // Default = writing
  return 'writing';
};

// IDEO: Calculate cognitive load
const calculateCognitiveLoad = (factors) => {
  const {
    typingSpeed = 50,
    errorRate = 0,
    timeOnTask = 0,
    pauseFrequency = 0
  } = factors;
  
  // Fast typing = high load (stress)
  const speedFactor = (typingSpeed / 100) * 30;
  
  // Many errors = high load
  const errorFactor = Math.min(errorRate * 0.5, 30);
  
  // Long time = increasing load (fatigue)
  const timeFactor = Math.min((timeOnTask / 60) * 0.2, 20);
  
  // Many pauses = high load (struggling)
  const pauseFactor = Math.min(pauseFrequency * 0.3, 20);
  
  return Math.min(100, speedFactor + errorFactor + timeFactor + pauseFactor);
};

// PENTAGRAM: Calculate optimal font size based on width
const getOptimalFontSize = (containerWidth) => {
  // Optimal: 60-75 characters per line
  // Formula: width / 60 (assuming ~0.5em per character)
  const optimalSize = containerWidth / 45; // ~67 chars at this size
  return Math.max(15, Math.min(20, optimalSize)); // Clamp 15-20px
};

function KirjoitusStudio() {
  const [project, setProject] = useState({
    title: 'NimetÃ¶n projekti',
    collections: [],
    targets: {
      project: 80000,
      daily: 1000,
      session: 500
    },

    // Vaihe 5: Hahmotietokanta
    characters: [],

    // Vaihe 6: Paikkatietokanta
    locations: [],
    genre: 'psychological_thriller', // Kirjan genre
    
    // StoryKeeper: Tarinan rakenne ja kausaalisuus
    story: {
      outline: [],      // Lukujen rakenne
      events: [],       // Keskeiset tapahtumat
      threads: [],      // Juonilangat
      timeline: [],     // Aikajana
      immutable_facts: [] // Faktat jotka eivÃ¤t voi muuttua
    },
    
    items: [
      {
        id: 1,
        type: 'folder',
        title: 'KÃ¤sikirjoitus',
        expanded: true,
        children: [
          { id: 11, type: 'chapter', title: 'Luku 1', content: '', wordCount: 0, notes: '', status: 'draft', label: 'none', snapshots: [] }
        ]
      },
      {
        id: 2,
        type: 'folder',
        title: 'Tutkimus',
        expanded: false,
        children: []
      }
    ]
  });

  const [activeItemId, setActiveItemId] = useState(11);
  const [isDarkMode, setIsDarkMode] = useState(false);
  const [showSidebar, setShowSidebar] = useState(true);
  const [showInspector, setShowInspector] = useState(true);
  const [aiAssistantOpen, setAiAssistantOpen] = useState(false);
  const [aiPrompt, setAiPrompt] = useState('');
  const [aiResponse, setAiResponse] = useState('');
  const [isGenerating, setIsGenerating] = useState(false);
  const [viewMode, setViewMode] = useState('editor');
  const [inspectorTab, setInspectorTab] = useState('notes');
  const [showExportMenu, setShowExportMenu] = useState(false);
  const [showCollectionsPanel, setShowCollectionsPanel] = useState(false);
  const [activeCollection, setActiveCollection] = useState(null);
  const [selectedAIApi, setSelectedAIApi] = useState('claude'); // Valittu AI-palvelu

  // Projektin tavoitteet
  const [targets, setTargets] = useState({
    project: 80000,      // Koko projektin sanamÃ¤Ã¤rÃ¤tavoite
    daily: 1000,         // PÃ¤ivittÃ¤inen tavoite
    session: 500         // Istunnon tavoite
  });

  // Nykyinen kirjoitusistunto
  const [sessionStats, setSessionStats] = useState({
    startTime: Date.now(),
    startWords: 0,
    currentWords: 0,
    wordsWritten: 0,
    duration: 0
  });

  // PÃ¤ivittÃ¤iset tilastot (tallennetaan localStorage)
  const [dailyStats, setDailyStats] = useState(() => {
    const today = new Date().toISOString().split('T')[0];
    const saved = localStorage.getItem(`dailyStats_${today}`);
    return saved ? JSON.parse(saved) : { date: today, words: 0, sessions: [] };
  });

  // Vaihe 3: Split View & Compose Mode
  const [composeMode, setComposeMode] = useState(false);
  const [splitView, setSplitView] = useState(false);
  const [typewriterMode, setTypewriterMode] = useState(false);
  const [splitViewItem, setSplitViewItem] = useState(null); // Toinen dokumentti split view'ssa

  // Vaihe 4: Fonttien mukauttaminen
  const [editorFont, setEditorFont] = useState(() => {
    const saved = localStorage.getItem('editorPreferences');
    return saved ? JSON.parse(saved).editorFont : 'serif';
  });

  const [fontSize, setFontSize] = useState(() => {
    const saved = localStorage.getItem('editorPreferences');
    return saved ? JSON.parse(saved).fontSize : 18;
  });

  const [lineHeight, setLineHeight] = useState(() => {
    const saved = localStorage.getItem('editorPreferences');
    return saved ? JSON.parse(saved).lineHeight : 1.8;
  });

  const [focusMode, setFocusMode] = useState(false);
  const [showWordCount, setShowWordCount] = useState(true);

  // Vaihe 5: CharacterKeeper - hahmojen jatkuvuuden valvoja
  const [editingCharacter, setEditingCharacter] = useState(null);
  const [showCharacterSheet, setShowCharacterSheet] = useState(false);
  
  // LocationKeeper - paikkojen hallinta
  const [editingLocation, setEditingLocation] = useState(null);
  const [showLocationSheet, setShowLocationSheet] = useState(false);

  // StoryKeeper - tarinan rakenteen hallinta
  const [editingChapter, setEditingChapter] = useState(null);
  const [showChapterSheet, setShowChapterSheet] = useState(false);
  const [editingThread, setEditingThread] = useState(null);
  const [showThreadSheet, setShowThreadSheet] = useState(false);

  // ========== NORMAN-KRUG-NATSUME: UI/UX States ==========
  
  // NATSUME: Flow Modes - Focus, Rhythm, Review
  const [flowMode, setFlowMode] = useState('normal'); // 'normal', 'focus', 'rhythm', 'review'
  const [emotionalTone, setEmotionalTone] = useState('neutral'); // 'calm', 'tense', 'neutral'
  
  // NORMAN: AI Suggestions & Feedback
  const [aiSuggestions, setAiSuggestions] = useState([]); // { id, text, reason, position, type }
  const [showAIFeedback, setShowAIFeedback] = useState(null); // { action, details, type }
  const [activeSuggestion, setActiveSuggestion] = useState(null);
  
  // NATSUME: Inspiration Panel
  const [showInspiration, setShowInspiration] = useState(false);
  const [inspirationData, setInspirationData] = useState(null);
  const [lastEditTime, setLastEditTime] = useState(Date.now());
  
  // NORMAN: Learning System - AI learns from user preferences
  const [userPreferences, setUserPreferences] = useState(() => {
    const saved = localStorage.getItem('aiLearningPreferences');
    return saved ? JSON.parse(saved) : {
      rejectedSuggestions: [],
      preferredStyles: {},
      contextPreferences: {}
    };
  });
  
  // KRUG: Optimistic UI state
  const [saveStatus, setSaveStatus] = useState('saved'); // 'saved', 'saving', 'error'

  // ========== VISUAL MASTERS: State Management ==========
  
  // SAGMEISTER: Living Typography
  const [writingSpeed, setWritingSpeed] = useState(50); // 0-100, affects font size/spacing
  const [lastKeystroke, setLastKeystroke] = useState(Date.now());
  const [keystrokeCount, setKeystrokeCount] = useState(0);
  
  // SAGMEISTER: Emotional Color Arc
  const [emotionalArc, setEmotionalArc] = useState('neutral'); // 'positive', 'negative', 'neutral', 'intense', 'calm'
  
  // SUPERSIDE: Work Phase Detection
  const [workPhase, setWorkPhase] = useState('writing'); // 'drafting', 'writing', 'editing', 'reviewing'
  const [activityMetrics, setActivityMetrics] = useState({
    editCount: 0,
    wordCount: 0,
    cursorMovements: 0,
    timeSinceLastEdit: 0
  });
  
  // IDEO: Cognitive Load
  const [cognitiveLoad, setCognitiveLoad] = useState(50); // 0-100
  
  // IDEO: AI Transparency
  const [aiTransparency, setAiTransparency] = useState({
    active: false,
    thinking: false,
    context: null
  });

  // Fonttivaihtoehdot
  const fontOptions = [
    { id: 'serif', name: 'Serif (Times)', family: 'Times New Roman, serif' },
    { id: 'sans', name: 'Sans-serif', family: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif' },
    { id: 'mono', name: 'Monospace', family: 'Menlo, Monaco, Consolas, monospace' },
    { id: 'georgia', name: 'Georgia', family: 'Georgia, serif' },
    { id: 'garamond', name: 'Garamond', family: 'Garamond, serif' },
    { id: 'bookman', name: 'Bookman', family: 'Bookman, serif' },
    { id: 'courier', name: 'Courier', family: '"Courier New", Courier, monospace' },
    { id: 'arial', name: 'Arial', family: 'Arial, Helvetica, sans-serif' },
    { id: 'verdana', name: 'Verdana', family: 'Verdana, Geneva, sans-serif' },
    { id: 'tahoma', name: 'Tahoma', family: 'Tahoma, Geneva, sans-serif' },
    // Google Fonts
    { id: 'merriweather', name: 'Merriweather', family: 'Merriweather, serif' },
    { id: 'playfair', name: 'Playfair Display', family: '"Playfair Display", serif' },
    { id: 'lora', name: 'Lora', family: 'Lora, serif' },
    { id: 'opensans', name: 'Open Sans', family: '"Open Sans", sans-serif' },
    { id: 'source', name: 'Source Code Pro', family: '"Source Code Pro", monospace' }
  ];

  const editorRef = useRef(null);

  const statusOptions = [
    { value: 'draft', label: 'Luonnos' },
    { value: 'revision', label: 'Korjaus' },
    { value: 'complete', label: 'Valmis' }
  ];

  const aiPrompts = [
    { label: 'Jatka kirjoittamista', prompt: 'Jatka tÃ¤tÃ¤ tekstiÃ¤ luonnollisesti sÃ¤ilyttÃ¤en tyylin ja Ã¤Ã¤nen.' },
    { label: 'Paranna kappaletta', prompt: 'Paranna tÃ¤tÃ¤ kappaletta sÃ¤ilyttÃ¤en sen ydinsisÃ¤llÃ¶n.' },
    { label: 'Luo juonikaari', prompt: 'Ehdota juonikaarta tÃ¤lle luvulle.' },
    { label: 'KehitÃ¤ hahmoa', prompt: 'Anna ideoita hahmon kehittÃ¤miseen tÃ¤mÃ¤n perusteella.' },
    { label: 'Paranna dialogia', prompt: 'Tee dialogista luonnollisempaa ja kiinnostavampaa.' },
    { label: 'Luo jÃ¤nnitettÃ¤', prompt: 'Ehdota tapoja lisÃ¤tÃ¤ jÃ¤nnitettÃ¤ tÃ¤hÃ¤n kohtaukseen.' }
  ];

  const findItem = (items, id) => {
    for (const item of items) {
      if (item.id === id) return item;
      if (item.children) {
        const found = findItem(item.children, id);
        if (found) return found;
      }
    }
    return null;
  };

  const getActiveItem = () => findItem(project.items, activeItemId);
  const getSelectedLocation = () => project.locations?.find(loc => loc.id === editingLocation?.id);
  const countWords = (text) => text.trim().split(/\s+/).filter(word => word.length > 0).length;

  const getTotalWordCount = () => {
    const countRecursive = (items) => items.reduce((sum, item) => {
      let count = sum + (item.wordCount || 0);
      if (item.children) count += countRecursive(item.children);
      return count;
    }, 0);
    return countRecursive(project.items);
  };

  const updateItem = (id, updates) => {
    const updateRecursive = (items) => items.map(item => {
      if (item.id === id) {
        const updatedItem = { ...item, ...updates };
        if (updates.content !== undefined) updatedItem.wordCount = countWords(updates.content);
        return updatedItem;
      }
      if (item.children) return { ...item, children: updateRecursive(item.children) };
      return item;
    });
    setProject({ ...project, items: updateRecursive(project.items) });
  };

  // Luo snapshot (tilannekuva)
  const createSnapshot = () => {
    const activeItem = getActiveItem();
    if (!activeItem || !activeItem.content) {
      alert('Ei sisÃ¤ltÃ¶Ã¤ tallennettavaksi!');
      return;
    }

    const snapshot = {
      id: Date.now(),
      title: `Tilannekuva ${new Date().toLocaleString('fi-FI')}`,
      content: activeItem.content,
      timestamp: new Date().toISOString(),
      wordCount: activeItem.wordCount
    };

    updateItem(activeItemId, { snapshots: [...(activeItem.snapshots || []), snapshot] });
    alert('Tilannekuva tallennettu!');
  };

  // Palauta snapshot
  const restoreSnapshot = (snapshot) => {
    if (confirm(`Palauta tilannekuva "${snapshot.title}"? Nykyinen sisÃ¤ltÃ¶ korvataan.`)) {
      updateItem(activeItemId, { content: snapshot.content });
      if (editorRef.current) editorRef.current.value = snapshot.content;
      alert('Tilannekuva palautettu!');
    }
  };

  // Poista snapshot
  const deleteSnapshot = (snapshotId) => {
    const activeItem = getActiveItem();
    updateItem(activeItemId, { snapshots: (activeItem.snapshots || []).filter(s => s.id !== snapshotId) });
  };

  // Luo uusi kokoelma
  const createCollection = () => {
    const name = prompt('Anna kokoelman nimi:');
    if (!name) return;

    const newCollection = {
      id: Date.now(),
      name,
      itemIds: []
    };

    setProject({ ...project, collections: [...(project.collections || []), newCollection] });
  };

  // LisÃ¤Ã¤ dokumentti kokoelmaan
  const addToCollection = (collectionId, itemId) => {
    setProject({
      ...project,
      collections: project.collections.map(col =>
        col.id === collectionId ? { ...col, itemIds: [...col.itemIds, itemId] } : col
      )
    });
  };

  // Poista dokumentti kokoelmasta
  const removeFromCollection = (collectionId, itemId) => {
    setProject({
      ...project,
      collections: project.collections.map(col =>
        col.id === collectionId ? { ...col, itemIds: col.itemIds.filter(id => id !== itemId) } : col
      )
    });
  };

  const addItem = (parentId, type) => {
    const newId = Date.now();
    const titles = {
      chapter: 'Uusi luku',
      document: 'Uusi dokumentti',
      folder: 'Uusi kansio'
    };

    const newItem = {
      id: newId,
      type,
      title: titles[type] || 'Uusi kohde',
      content: '',
      wordCount: 0,
      notes: '',
      status: 'draft',
      label: 'none',
      snapshots: []
    };

    if (type === 'folder') {
      newItem.children = [];
      newItem.expanded = true;
    }

    const addRecursive = (items) => items.map(item => {
      if (item.id === parentId && item.type === 'folder') {
        return { ...item, children: [...(item.children || []), newItem] };
      }
      if (item.children) return { ...item, children: addRecursive(item.children) };
      return item;
    });

    setProject({ ...project, items: addRecursive(project.items) });
    setActiveItemId(newId);
  };

  const deleteItem = (id) => {
    const deleteRecursive = (items) => items.filter(item => {
      if (item.id === id) return false;
      if (item.children) item.children = deleteRecursive(item.children);
      return true;
    });

    setProject({ ...project, items: deleteRecursive(project.items) });
    if (activeItemId === id) {
      setActiveItemId(project.items[0]?.children?.[0]?.id || project.items[0]?.id);
    }
  };

  const toggleFolder = (id) => {
    const toggleRecursive = (items) => items.map(item => {
      if (item.id === id && item.type === 'folder') {
        return { ...item, expanded: !item.expanded };
      }
      if (item.children) return { ...item, children: toggleRecursive(item.children) };
      return item;
    });
    setProject({ ...project, items: toggleRecursive(project.items) });
  };

  const callAIAPI = async (prompt, includeContext = true) => {
    setIsGenerating(true);
    setAiResponse('');

    try {
      const activeItem = getActiveItem();
      const context = includeContext && activeItem?.content
        ? `\n\nNykyinen sisÃ¤ltÃ¶:\n${activeItem.content}`
        : '';

      const fullPrompt = `Olet luova kirjoitusavustaja, joka auttaa kirjailijaa kirjoittamaan kirjaansa suomeksi.\n\n${prompt}${context}\n\nAnna hyÃ¶dyllistÃ¤, luovaa ja rakentavaa apua. Ole konkreettinen ja kÃ¤ytÃ¤nnÃ¶llinen. Vastaa AINA suomeksi.`;

      let result;
      switch (selectedAIApi) {
        case 'claude':
          result = await window.electronAPI.claudeAPI(fullPrompt);
          break;
        case 'grok':
          result = await window.electronAPI.grokAPI(fullPrompt);
          break;
        case 'openai':
          result = await window.electronAPI.openaiAPI(fullPrompt);
          break;
        case 'cursor':
          result = await window.electronAPI.cursorAPI(fullPrompt);
          break;
        default:
          result = await window.electronAPI.claudeAPI(fullPrompt);
      }

      if (result.success) {
        setAiResponse(result.data);
      } else {
        setAiResponse(`Vastauksen luominen epÃ¤onnistui (${selectedAIApi}): ` + result.error);
      }
    } catch (err) {
      setAiResponse('Vastauksen luominen epÃ¤onnistui. YritÃ¤ uudelleen.');
    } finally {
      setIsGenerating(false);
    }
  };

  const insertAiResponse = () => {
    if (!aiResponse) return;
    const activeItem = getActiveItem();
    const newContent = (activeItem?.content || '') + (activeItem?.content ? '\n\n' : '') + aiResponse;
    updateItem(activeItemId, { content: newContent });
    setAiResponse('');
    if (editorRef.current) {
      editorRef.current.value = newContent;
    }
  };

  const saveProject = async () => {
    const projectWithAll = {
      ...project,
      targets,
      characters: project.characters || [], // Varmista ettÃ¤ hahmot tallennetaan
      locations: project.locations || [], // Varmista ettÃ¤ paikat tallennetaan
      genre: project.genre || 'psychological_thriller', // Varmista ettÃ¤ genre tallennetaan
      story: project.story || { outline: [], events: [], threads: [], timeline: [], immutable_facts: [] } // Varmista ettÃ¤ tarina tallennetaan
    };
    const result = await window.electronAPI.saveProject(projectWithAll);
    if (result.success) {
      alert('Projekti, hahmot, paikat ja tarina tallennettu!');
    }
  };

  const loadProject = async () => {
    const result = await window.electronAPI.loadProject();
    if (result.success) {
      setProject(result.data);
      if (result.data.targets) {
        setTargets(result.data.targets);
      }
      alert('Projekti ladattu!');
    }
  };

  const exportDocument = async (format) => {
    const activeItem = getActiveItem();
    if (!activeItem || !activeItem.content) {
      alert('Ei sisÃ¤ltÃ¶Ã¤ vietÃ¤vÃ¤ksi!');
      return;
    }

    if (format === 'pdf') {
      const html = `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>${activeItem.title}</title>
<style>body{font-family:'Times New Roman',serif;max-width:800px;margin:40px auto;line-height:1.6;padding:20px;}
h1{font-size:28px;margin-bottom:20px;}p{margin-bottom:15px;text-align:justify;}</style></head>
<body><h1>${activeItem.title}</h1>${activeItem.content.split('\n\n').map(p => `<p>${p}</p>`).join('')}</body></html>`;

      const result = await window.electronAPI.exportPDF({ html, title: activeItem.title });
      if (result.success) alert('PDF viety onnistuneesti!');
    } else {
      const result = await window.electronAPI.exportDocument({
        content: activeItem.content,
        title: activeItem.title,
        format
      });
      if (result.success) alert(`Dokumentti viety ${format.toUpperCase()}-muodossa!`);
    }
    setShowExportMenu(false);
  };

  const exportFullProject = async (format) => {
    const result = await window.electronAPI.exportFullProject({ project, format });
    if (result.success) {
      alert(`Koko projekti viety ${format.toUpperCase()}-muodossa!`);
    }
    setShowExportMenu(false);
  };

  const renderTree = (items, depth = 0) => items.map(item => {
    const labelColor = LABEL_COLORS.find(l => l.id === (item.label || 'none'));
    const isActive = activeItemId === item.id;

    return e('div', { key: item.id },
      e('button', {
        className: 'w-full flex items-center gap-2 px-3 py-1.5 rounded-md text-sm transition-all cursor-pointer',
        style: {
          paddingLeft: `${depth * 16 + 12}px`,
          background: isActive ? 'var(--mac-accent-blue)' : 'transparent',
          color: isActive ? 'white' : 'var(--mac-text-primary)',
          borderLeft: labelColor && labelColor.id !== 'none' ? `2px solid ${labelColor.color}` : 'none'
        },
        onMouseEnter: (e) => {
          if (!isActive) e.currentTarget.style.background = 'rgba(255,255,255,0.05)';
        },
        onMouseLeave: (e) => {
          if (!isActive) e.currentTarget.style.background = 'transparent';
        },
        onClick: () => setActiveItemId(item.id)
      },
        item.type === 'folder' && e('span', {
          onClick: (ev) => { ev.stopPropagation(); toggleFolder(item.id); },
          className: 'flex items-center justify-center w-4'
        }, item.expanded ? e(Icons.ChevronDown, { className: 'w-3 h-3' }) : e(Icons.ChevronRight, { className: 'w-3 h-3' })),
        item.type === 'folder' ? e(Icons.Folder, { className: 'w-4 h-4' }) : e(Icons.FileText, { className: 'w-4 h-4' }),
        e('span', { className: 'flex-1 text-left truncate' }, item.title),
        item.wordCount > 0 && e('span', {
          className: 'text-[11px] font-mono tabular-nums',
          style: { color: isActive ? 'rgba(255,255,255,0.8)' : 'var(--mac-text-tertiary)' }
        }, item.wordCount)
      ),
      item.type === 'folder' && item.expanded && item.children && renderTree(item.children, depth + 1)
    );
  });

  useEffect(() => {
    if (editorRef.current) {
      const chapter = getActiveItem();
      editorRef.current.value = chapter?.content || '';
    }
  }, [activeItemId]);

  // Vaihe 3: NÃ¤ppÃ¤imistÃ¶oikotiet
  useEffect(() => {
    const handleKeyDown = (event) => {
      // Cmd/Ctrl + F11: Compose Mode
      if ((event.metaKey || event.ctrlKey) && event.key === 'F11') {
        event.preventDefault();
        setComposeMode(!composeMode);
      }

      // Cmd/Ctrl + \: Split View
      if ((event.metaKey || event.ctrlKey) && event.key === '\\') {
        event.preventDefault();
        setSplitView(!splitView);
        if (!splitView) {
          // Valitse toinen dokumentti split view'hun
          const items = [];
          const collectItems = (nodes) => {
            nodes.forEach(node => {
              if (node.type !== 'folder') items.push(node);
              if (node.children) collectItems(node.children);
            });
          };
          collectItems(project.items);
          const otherItems = items.filter(item => item.id !== activeItemId);
          if (otherItems.length > 0) {
            setSplitViewItem(otherItems[0]);
          }
        }
      }

      // Cmd/Ctrl + Shift + T: Typewriter Mode
      if ((event.metaKey || event.ctrlKey) && event.shiftKey && event.key === 'T') {
        event.preventDefault();
        setTypewriterMode(!typewriterMode);
      }
    };

    document.addEventListener('keydown', handleKeyDown);
    return () => document.removeEventListener('keydown', handleKeyDown);
  }, [composeMode, splitView, typewriterMode, activeItemId, project.items]);

  // Istunnon seuranta
  useEffect(() => {
    // Aloita istunto jos ensimmÃ¤inen
    if (sessionStats.startWords === 0) {
      setSessionStats(prev => ({
        ...prev,
        startWords: getTotalWordCount()
      }));
    }

    // PÃ¤ivitÃ¤ istunnon tilastot
    const interval = setInterval(() => {
      const currentTotal = getTotalWordCount();
      const written = currentTotal - sessionStats.startWords;
      const duration = Math.floor((Date.now() - sessionStats.startTime) / 1000);

      setSessionStats(prev => ({
        ...prev,
        currentWords: currentTotal,
        wordsWritten: written,
        duration: duration
      }));

      // PÃ¤ivitÃ¤ pÃ¤ivÃ¤tilastot
      setDailyStats(prev => {
        const updated = { ...prev, words: prev.words + written };
        const today = new Date().toISOString().split('T')[0];
        localStorage.setItem(`dailyStats_${today}`, JSON.stringify(updated));
        return updated;
      });
    }, 5000); // PÃ¤ivitÃ¤ 5 sekunnin vÃ¤lein

    return () => clearInterval(interval);
  }, [getTotalWordCount()]);

  // Vaihe 4: Tallenna fonttipreferenssit localStorageen
  useEffect(() => {
    const preferences = { editorFont, fontSize, lineHeight };
    localStorage.setItem('editorPreferences', JSON.stringify(preferences));
  }, [editorFont, fontSize, lineHeight]);

  // macOS System Theme Sync
  useEffect(() => {
    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
    
    const updateTheme = (e) => {
      setIsDarkMode(e.matches);
    };
    
    // Set initial theme
    updateTheme(mediaQuery);
    
    // Listen for changes
    mediaQuery.addEventListener('change', updateTheme);
    
    return () => mediaQuery.removeEventListener('change', updateTheme);
  }, []);

  // macOS Keyboard Shortcuts
  useEffect(() => {
    const handleKeyboard = (e) => {
      const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
      const mod = isMac ? e.metaKey : e.ctrlKey;
      
      // Cmd+S: Save
      if (mod && e.key === 's') {
        e.preventDefault();
        saveProject();
      }
      
      // Cmd+B: Toggle Sidebar
      if (mod && e.key === 'b') {
        e.preventDefault();
        setShowSidebar(prev => !prev);
      }
      
      // Cmd+Option+I: Toggle Inspector
      if (mod && e.altKey && e.key === 'i') {
        e.preventDefault();
        setShowInspector(prev => !prev);
      }
      
      // Cmd+K: AI Assistant
      if (mod && e.key === 'k') {
        e.preventDefault();
        setAiAssistantOpen(prev => !prev);
      }
      
      // Cmd+Shift+F: Focus Mode
      if (mod && e.shiftKey && e.key === 'f') {
        e.preventDefault();
        setComposeMode(prev => !prev);
      }
    };
    
    window.addEventListener('keydown', handleKeyboard);
    return () => window.removeEventListener('keydown', handleKeyboard);
  }, []);

  // ========== NORMAN-KRUG-NATSUME: Effects ==========
  
  // NATSUME: Emotional tone detection - Analyzes text and adapts UI
  useEffect(() => {
    const activeItem = getActiveItem();
    if (!activeItem || !activeItem.content) return;
    
    // Debounce analysis - don't run on every keystroke
    const timeout = setTimeout(() => {
      const tone = analyzeEmotionalTone(activeItem.content);
      if (tone !== emotionalTone) {
        setEmotionalTone(tone);
      }
    }, 2000); // Analyze 2s after user stops typing
    
    return () => clearTimeout(timeout);
  }, [project.items]); // Re-run when content changes
  
  // NATSUME: Stuck detection - Shows inspiration when no activity
  useEffect(() => {
    const checkStuck = setInterval(() => {
      const timeSinceEdit = Date.now() - lastEditTime;
      
      // If no edits for 3 minutes and document is focused
      if (timeSinceEdit > 180000 && document.hasFocus() && !showInspiration) {
        const inspiration = generateInspiration('stuck', project.genre);
        setInspirationData(inspiration);
        setShowInspiration(true);
      }
    }, 30000); // Check every 30s
    
    return () => clearInterval(checkStuck);
  }, [lastEditTime, showInspiration, project.genre]);
  
  // NORMAN: Auto-dismiss feedback after 3 seconds
  useEffect(() => {
    if (showAIFeedback) {
      const timeout = setTimeout(() => {
        setShowAIFeedback(null);
      }, 3000);
      return () => clearTimeout(timeout);
    }
  }, [showAIFeedback]);
  
  // KRUG: Track edit time for stuck detection
  useEffect(() => {
    const activeItem = getActiveItem();
    if (activeItem && activeItem.content) {
      setLastEditTime(Date.now());
    }
  }, [project.items]);
  
  // KRUG: Optimistic save with localStorage
  useEffect(() => {
    // Debounce saving
    const timeout = setTimeout(() => {
      try {
        setSaveStatus('saving');
        localStorage.setItem('kirjoitusstudio_project', JSON.stringify(project));
        setTimeout(() => setSaveStatus('saved'), 300); // Show saving briefly
      } catch (error) {
        console.error('Save error:', error);
        setSaveStatus('error');
      }
    }, 1000); // Save 1s after last change
    
    return () => clearTimeout(timeout);
  }, [project]);
  
  // NORMAN: Save learning preferences
  useEffect(() => {
    localStorage.setItem('aiLearningPreferences', JSON.stringify(userPreferences));
  }, [userPreferences]);

  // ========== NORMAN-KRUG-NATSUME: Demo & Helper Functions ==========
  
  // Demo: Show AI Feedback (can be triggered by keyboard shortcut)
  const showDemoAIFeedback = () => {
    setShowAIFeedback({
      action: 'Rytmi tasoitettu',
      details: '12% pehmeÃ¤mpi siirtymÃ¤',
      type: 'rhythm'
    });
  };
  
  // Demo: Show inspiration panel
  const showDemoInspiration = () => {
    const inspiration = generateInspiration('demo', project.genre);
    setInspirationData(inspiration);
    setShowInspiration(true);
  };
  
  // Add keyboard shortcut for demo (Cmd+Shift+D)
  useEffect(() => {
    const handleDemoShortcut = (e) => {
      const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
      const mod = isMac ? e.metaKey : e.ctrlKey;
      
      // Cmd+Shift+D: Demo AI Feedback
      if (mod && e.shiftKey && e.key === 'd') {
        e.preventDefault();
        showDemoAIFeedback();
      }
      
      // Cmd+Shift+I: Demo Inspiration
      if (mod && e.shiftKey && e.key === 'i') {
        e.preventDefault();
        showDemoInspiration();
      }
    };
    
    window.addEventListener('keydown', handleDemoShortcut);
    return () => window.removeEventListener('keydown', handleDemoShortcut);
  }, [project.genre]);

  // ========== VISUAL MASTERS: Effects ==========
  
  // SAGMEISTER: Track writing speed for living typography
  useEffect(() => {
    const now = Date.now();
    const timeSinceLastKey = now - lastKeystroke;
    
    // Calculate characters per second
    if (timeSinceLastKey < 2000) { // Within 2 seconds
      const cps = 1000 / timeSinceLastKey;
      // Normalize to 0-100 scale
      const normalizedSpeed = Math.min(100, cps * 20);
      setWritingSpeed(normalizedSpeed);
    } else {
      // Slow down if no typing
      setWritingSpeed(prev => Math.max(0, prev - 5));
    }
  }, [lastKeystroke]);
  
  // SAGMEISTER: Analyze emotional arc from content
  useEffect(() => {
    const activeItem = getActiveItem();
    if (!activeItem || !activeItem.content) return;
    
    const timeout = setTimeout(() => {
      const arc = analyzeEmotionalArc(activeItem.content);
      if (arc !== emotionalArc) {
        setEmotionalArc(arc);
      }
    }, 2000); // Analyze 2s after typing stops
    
    return () => clearTimeout(timeout);
  }, [project.items]);
  
  // SUPERSIDE: Detect work phase from activity
  useEffect(() => {
    const timeout = setTimeout(() => {
      const phase = detectWorkPhase(activityMetrics);
      if (phase !== workPhase) {
        setWorkPhase(phase);
      }
    }, 3000); // Check every 3s
    
    return () => clearTimeout(timeout);
  }, [activityMetrics]);
  
  // IDEO: Calculate cognitive load
  useEffect(() => {
    const activeItem = getActiveItem();
    if (!activeItem) return;
    
    const interval = setInterval(() => {
      const load = calculateCognitiveLoad({
        typingSpeed: writingSpeed,
        errorRate: 0, // Could track backspace frequency
        timeOnTask: (Date.now() - sessionStats.startTime) / 1000,
        pauseFrequency: writingSpeed < 20 ? 50 : 10
      });
      
      setCognitiveLoad(load);
    }, 5000); // Update every 5s
    
    return () => clearInterval(interval);
  }, [writingSpeed, sessionStats.startTime]);
  
  // Track keystroke for writing speed calculation
  useEffect(() => {
    const handleKeyPress = () => {
      setLastKeystroke(Date.now());
      setKeystrokeCount(prev => prev + 1);
    };
    
    window.addEventListener('keydown', handleKeyPress);
    return () => window.removeEventListener('keydown', handleKeyPress);
  }, []);

  // Vaihe 6: LocationKeeper-funktiot
  const detectLocationsInText = async () => {
    const activeItem = getActiveItem();
    if (!activeItem || !activeItem.content) {
      alert('Ei sisÃ¤ltÃ¶Ã¤ analysoitavaksi!');
      return;
    }

    setIsGenerating(true);

    const prompt = `Tunnista KAIKKI paikat tÃ¤stÃ¤ tekstistÃ¤. SisÃ¤llytÃ¤ kaupungit, rakennukset, kadut, luontokohteet, maamerkit.

TEKSTI:
${activeItem.content}

Palauta VAIN JSON (ei mitÃ¤Ã¤n muuta tekstiÃ¤):
{
  "locations": [
    {
      "name": "paikan nimi",
      "type": "city/building/landmark/public_square/street/nature/interior",
      "city": "kaupunki jos mainittu",
      "country": "maa jos mainittu",
      "context": "lause jossa paikka mainitaan"
    }
  ]
}

Jos ei paikkoja, palauta: {"locations": []}

VASTAA PELKKÃ„ JSON.`;

    try {
      const result = await window.electronAPI.claudeAPI(prompt);
      if (result.success) {
        // Parseri JSON
        let responseText = result.data.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        const locationData = JSON.parse(responseText);

        // LisÃ¤Ã¤ paikat projektiin (vÃ¤ltÃ¤ duplikaatit)
        const existingNames = (project.locations || []).map(l => l.name.toLowerCase());
        const newLocations = locationData.locations
          .filter(loc => !existingNames.includes(loc.name.toLowerCase()))
          .map(loc => ({
            ...LOCATION_TEMPLATE,
            id: Date.now() + Math.random(),
            name: loc.name,
            type: loc.type || 'landmark',
            city: loc.city || '',
            country: loc.country || '',
            used_in_scenes: [activeItemId]
          }));

        if (newLocations.length > 0) {
          setProject({
            ...project,
            locations: [...(project.locations || []), ...newLocations]
          });
          alert(`LÃ¶ydetty ${newLocations.length} uutta paikkaa!`);
        } else {
          alert('Ei uusia paikkoja lÃ¶ytynyt (tai kaikki jo lisÃ¤tty).');
        }
      }
    } catch (err) {
      alert('Paikkojen tunnistus epÃ¤onnistui: ' + err.message);
    } finally {
      setIsGenerating(false);
    }
  };

  const fetchLocationData = async (location) => {
    setIsGenerating(true);

    try {
      // Web search - faktat
      const factsQuery = `${location.name} ${location.city} history architecture culture atmosphere`;
      const factsResult = await window.electronAPI.webSearch(factsQuery);

      // Web search - kuvat
      const imageQuery = `${location.name} ${location.city} photos`;
      const imageResult = await window.electronAPI.webSearch(imageQuery);

      // PyydÃ¤ Claude analysoimaan
      const prompt = `Analysoi tÃ¤mÃ¤ paikka kirjailijaa varten:

PAIKKA: ${location.name} (${location.city}, ${location.country})

FAKTATIEDOT:
${JSON.stringify(factsResult)}

KUVATIEDOT:
${JSON.stringify(imageResult)}

Palauta JSON:
{
  "facts": {
    "history": "lyhyt historia",
    "architecture": ["arkkitehtuuri", "piirteitÃ¤"],
    "features": ["keskeisiÃ¤", "ominaisuuksia"],
    "atmosphere": ["tunnelma", "sanoja"]
  },
  "visual": {
    "colors_day": ["pÃ¤ivÃ¤vÃ¤rit"],
    "colors_night": ["yÃ¶vÃ¤rit"],
    "lighting": ["valaistus"],
    "textures": ["tekstuurit"]
  },
  "writing_tips": ["vinkkejÃ¤", "kuvaukseen"]
}

VASTAA SUOMEKSI, JSON-MUODOSSA.`;

      const result = await window.electronAPI.claudeAPI(prompt);

      if (result.success) {
        let responseText = result.data.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        const analysis = JSON.parse(responseText);

        // PÃ¤ivitÃ¤ location
        setProject({
          ...project,
          locations: project.locations.map(loc =>
            loc.id === location.id ? {
              ...loc,
              facts: analysis.facts,
              visual: analysis.visual,
              research: {
                last_searched: new Date().toISOString(),
                facts_source: 'web_search',
                images_source: 'web_search'
              }
            } : loc
          )
        });

        // NÃ¤ytÃ¤ AI-avustajassa
        if (!aiAssistantOpen) setAiAssistantOpen(true);
        setAiResponse(`ðŸ“ ${location.name} - Tiedot haettu!\n\n` +
          `ðŸ“š FAKTAT:\n${JSON.stringify(analysis.facts, null, 2)}\n\n` +
          `ðŸŽ¨ VISUAALISUUS:\n${JSON.stringify(analysis.visual, null, 2)}\n\n` +
          `ðŸ’¡ KIRJOITUSVINKIT:\n${analysis.writing_tips.join('\n')}`
        );

        alert('Tiedot haettu! Katso AI-avustaja.');
      }
    } catch (err) {
      alert('Tietojen haku epÃ¤onnistui: ' + err.message);
    } finally {
      setIsGenerating(false);
    }
  };

  const generateLocationDescription = async (location) => {
    if (!location.facts || !location.facts.history) {
      if (confirm('Paikan tiedot puuttuvat. Haetaanko ensin?')) {
        await fetchLocationData(location);
        return;
      }
    }

    setIsGenerating(true);

    const activeItem = getActiveItem();
    const context = activeItem?.content?.substring(0, 500) || '';

    const prompt = `Olet LocationKeeper - paikkojen kuvausasiantuntija.

PAIKKA:
${location.name} (${location.city}, ${location.country})

FAKTAT:
${JSON.stringify(location.facts, null, 2)}

VISUAALISET ELEMENTIT:
${JSON.stringify(location.visual, null, 2)}

KIRJAN GENRE:
${GENRE_OPTIONS.find(g => g.id === project.genre)?.name || 'Psykologinen trilleri'}

KOHTAUKSEN KONTEKSTI:
${context}

TEHTÃ„VÃ„:
Kirjoita 2-4 kappaletta paikka-kuvausta joka:

1. **Faktatarkka**: KÃ¤ytÃ¤ todellisia yksityiskohtia paikasta
2. **Aistillinen**: Aktivoi nÃ¤kÃ¶, kuulo, haju, tunto (ja maku jos relevantti)
3. **Genrespesifi**: Sovita tunnelma genreen (${project.genre})
4. **Tyylillinen**: KÃ¤ytÃ¤ defamiliarisaatiota, rytmiÃ¤, konkretiaa
5. **Emotionaalinen**: Luo tunnelma joka tukee kohtausta

GENRE-OHJEET:
${getGenreGuidance(project.genre)}

Ã„LÃ„:
- Listaa faktoja ("Paikalla on X ja Y")
- Kerro tunnelmaa suoraan ("Paikka oli ahdistava")
- KÃ¤ytÃ¤ kliseitÃ¤
- Ylihypettele

KIRJOITA NIIN ETTÃ„ SE SOPII SUORAAN ROMAANIIN.
VASTAA SUOMEKSI.`;

    try {
      const result = await window.electronAPI.claudeAPI(prompt);

      if (result.success) {
        // Tallenna genre-spesifi kuvaus
        const updatedLocation = {
          ...location,
          genre_descriptions: {
            ...location.genre_descriptions,
            [project.genre]: result.data
          }
        };

        setProject({
          ...project,
          locations: project.locations.map(loc =>
            loc.id === location.id ? updatedLocation : loc
          )
        });

        // NÃ¤ytÃ¤ AI-avustajassa
        if (!aiAssistantOpen) setAiAssistantOpen(true);
        setAiResponse(result.data);
      }
    } catch (err) {
      alert('Kuvauksen generointi epÃ¤onnistui: ' + err.message);
    } finally {
      setIsGenerating(false);
    }
  };

  // StoryKeeper - Juonen loogisen eheyden valvonta

  // 1. TARKISTA JUONEN LOGIIKKA
  const checkStoryLogic = async () => {
    if (!project.story || !project.story.outline || project.story.outline.length === 0) {
      alert('Luo ensin tarinan rakenne!');
      return;
    }

    setIsGenerating(true);

    const prompt = `Olet StoryKeeper - juonen loogisen eheyden valvoja.

Tarkista tÃ¤mÃ¤n tarinan logiikka:

LUVUT:
${project.story.outline.map(ch => 
  `Luku ${ch.chapter}: ${ch.title}
  Yhteenveto: ${ch.summary || 'Ei yhteenvetoa'}
  Tapahtumat: ${ch.key_events?.length || 0}`
).join('\n\n')}

JUONILANGAT:
${(project.story.threads || []).map(t =>
  `- ${t.name} (${t.importance})
    Avattu: Luku ${t.opened_chapter || '?'}
    Tila: ${t.status === 'open' ? 'AUKI âš ï¸' : 'SULJETTU âœ“'}`
).join('\n')}

TARKISTA:
1. Onko luvuissa loogisia ristiriitoja?
2. Ovatko kaikki juonilangat suljettu?
3. Onko kausaalisuus kunnossa? (A vaikuttaa B:hen)
4. Onko tempo jÃ¤rkevÃ¤?

VASTAA:
## âœ… LOOGISESTI EHEÃ„T
[Luvut joissa ei ongelmia]

## âš ï¸ HUOMIOITAVAA
[Pienet epÃ¤johdonmukaisuudet + ehdotukset]

## âŒ KRIITTISET RISTIRIIDAT
[Isot ongelmat + korjaukset]

## ðŸ§µ AVOIMET JUONILANGAT
[Juonilangat jotka pitÃ¤Ã¤ sulkea]

## ðŸ“Š YHTEENVETO
[Kokonaisarvio]

VASTAA SUOMEKSI.`;

    try {
      const result = await window.electronAPI.claudeAPI(prompt);
      if (result.success) {
        if (!aiAssistantOpen) setAiAssistantOpen(true);
        setAiResponse(result.data);
      }
    } catch (err) {
      alert('Juonitarkistus epÃ¤onnistui: ' + err.message);
    } finally {
      setIsGenerating(false);
    }
  };

  // 2. TUNNISTA TAPAHTUMAT LUVUSTA (NYT LISÃ„TTY!)
  const detectEventsInChapter = async (chapterNumber, text) => {
    const prompt = `Tunnista KESKEISET TAPAHTUMAT tÃ¤stÃ¤ luvusta.

LUKU ${chapterNumber}:
${text}

Palauta JSON:
{
  "events": [
    {
      "description": "Lyhyt kuvaus (1 lause)",
      "significance": "major/minor",
      "immutable": true/false,
      "characters_involved": ["hahmon nimi"],
      "location": "paikka"
    }
  ]
}

VAIN MERKITTÃ„VÃ„T TAPAHTUMAT (ei jokaista pientÃ¤ toimintoa).

VASTAA PELKKÃ„ JSON.`;

    try {
      const result = await window.electronAPI.claudeAPI(prompt);
      if (result.success) {
        let responseText = result.data.replace(/\`\`\`json\n?/g, '').replace(/\`\`\`\n?/g, '').trim();
        const eventData = JSON.parse(responseText);
        
        // LisÃ¤Ã¤ tapahtumat projektiin
        const newEvents = eventData.events.map(e => ({
          ...EVENT_TEMPLATE,
          id: Date.now() + Math.random(),
          chapter: chapterNumber,
          timestamp: `Luku ${chapterNumber}`,
          ...e
        }));

        setProject({
          ...project,
          story: {
            ...project.story,
            events: [...(project.story.events || []), ...newEvents]
          }
        });

        return newEvents;
      }
    } catch (err) {
      console.error('Tapahtumien tunnistus epÃ¤onnistui:', err);
      return [];
    }
  };

  // 3. TARKISTA NYKYISEN LUVUN MAHDOLLISUUS
  const checkChapterFeasibility = async (chapterNumber) => {
    const currentChapter = project.story.outline?.find(ch => ch.chapter === chapterNumber);
    if (!currentChapter) return;

    const previousEvents = (project.story.events || [])
      .filter(e => e.chapter < chapterNumber);

    const openThreads = (project.story.threads || [])
      .filter(t => t.status === 'open');

    const prompt = `Tarkista voiko Luku ${chapterNumber} tapahtua loogisesti.

AIKAISEMMAT TAPAHTUMAT:
${previousEvents.map(e => 
  `- Luku ${e.chapter}: ${e.description}`
).join('\n')}

SUUNNITELTU LUKU ${chapterNumber}:
Otsikko: ${currentChapter.title}
Yhteenveto: ${currentChapter.summary}

AVOIMET JUONILANGAT:
${openThreads.map(t => 
  `- ${t.name} (Avattu: Luku ${t.opened_chapter})`
).join('\n')}

TARKISTA:
1. Onko kaikki edeltÃ¤vÃ¤t tapahtumat olemassa?
2. Voiko tÃ¤mÃ¤ loogisesti tapahtua nyt?
3. Rikkooko tÃ¤mÃ¤ aikaisempia faktoja?
4. PitÃ¤isikÃ¶ joku juonilanka edetÃ¤/sulkea?

VASTAA:
âœ… jos loogisesti mahdollinen
âš ï¸ jos pieniÃ¤ huomioita
âŒ jos ristiriita + ehdotukset

VASTAA SUOMEKSI.`;

    try {
      const result = await window.electronAPI.claudeAPI(prompt);
      if (result.success) {
        if (!aiAssistantOpen) setAiAssistantOpen(true);
        setAiResponse(result.data);
      }
    } catch (err) {
      alert('Tarkistus epÃ¤onnistui: ' + err.message);
    }
  };

  // 4. EHDOTA SEURAAVAA LUKUA
  const suggestNextChapter = async () => {
    const lastChapter = Math.max(...(project.story.outline || []).map(ch => ch.chapter), 0);

    const prompt = `Ehdota mitÃ¤ Luku ${lastChapter + 1}:ssa voisi tapahtua.

AIKAISEMMAT LUVUT:
${(project.story.outline || []).map(ch => 
  `Luku ${ch.chapter}: ${ch.title || 'NimetÃ¶n'}
  ${ch.summary || 'Ei yhteenvetoa'}`
).join('\n\n')}

AVOIMET JUONILANGAT:
${(project.story.threads || []).filter(t => t.status === 'open').map(t =>
  `- ${t.name} (${t.importance})`
).join('\n')}

GENRE: ${GENRE_OPTIONS.find(g => g.id === project.genre)?.name || 'Ei mÃ¤Ã¤ritelty'}

EHDOTA:
3-5 mahdollista suuntaa Luku ${lastChapter + 1}:lle jotka:
1. Jatkavat loogisesti tarinaa
2. VievÃ¤t juonilankaa eteenpÃ¤in
3. LisÃ¤Ã¤vÃ¤t jÃ¤nnitettÃ¤
4. Sopivat genreen

VASTAA SUOMEKSI, SELKEÃ„STI NUMEROITUNA.`;

    try {
      const result = await window.electronAPI.claudeAPI(prompt);
      if (result.success) {
        if (!aiAssistantOpen) setAiAssistantOpen(true);
        setAiResponse(result.data);
      }
    } catch (err) {
      alert('Ehdotusten generointi epÃ¤onnistui: ' + err.message);
    }
  };

  // APUFUNKTIO: Genre-ohjeet
  const getGenreGuidance = (genre) => {
    const guides = {
      psychological_thriller: 'Focus: Ahdistus, kontrollin menetys. Elementit: Ã„Ã¤net, varjot, katseet. Tone: KylmÃ¤, uhkaava.',
      romantic_drama: 'Focus: LÃ¤mpÃ¶, intimiteetti, muistot. Elementit: Valo, vÃ¤rit, kosketukset. Tone: PehmeÃ¤, nostalginen.',
      action_thriller: 'Focus: Nopeus, liike, vaara. Elementit: PakovÃ¤ylÃ¤t, esteet. Tone: JÃ¤nnittynyt, dynaaminen.',
      horror: 'Focus: EpÃ¤todellinen, vÃ¤Ã¤ristynyt. Elementit: Ã„Ã¤net, hajut, varjot. Tone: Ahdistava, sairaalloinen.',
      noir: 'Focus: Varjot, rikkinÃ¤isyys. Elementit: Sade, pimeys, kontrastit. Tone: Karu, kylmÃ¤.',
      historical_fiction: 'Focus: Aika, autenttisuus. Elementit: Historialliset kerrokset. Tone: Reflektoiva, ajallinen.'
    };

    return guides[genre] || guides.psychological_thriller;
  };

  const sessionWords = sessionStats.currentWordCount - sessionStats.startWordCount;
  const progressToTarget = (getTotalWordCount() / project.targets.project) * 100;

  // Vaihe 5: CharacterKeeper - checkCharacterContinuity-funktio
  const checkCharacterContinuity = (character) => {
    const activeItem = getActiveItem();
    if (!activeItem || !activeItem.content) {
      alert('Ei sisÃ¤ltÃ¶Ã¤ tarkistettavaksi!');
      return;
    }

    // Rakenna hahmon tiedot promptiin
    const characterInfo = `
NIMI: ${character.name}
IKÃ„: ${character.bio.age || 'ei mÃ¤Ã¤ritelty'}
AMMATTI: ${character.bio.occupation || 'ei mÃ¤Ã¤ritelty'}
TAVOITE: ${character.psychology.want || 'ei mÃ¤Ã¤ritelty'}
PELKO: ${character.psychology.fear || 'ei mÃ¤Ã¤ritelty'}
HEIKKOUS: ${character.psychology.weakness || 'ei mÃ¤Ã¤ritelty'}
PUHETYYLI: ${character.voice.description || 'ei mÃ¤Ã¤ritelty'}
TYYPILLISET FRAASIT: ${(character.voice.lexicon || []).join(', ') || 'ei mÃ¤Ã¤ritelty'}
RESURSSIT: ${(character.state.resources || []).join(', ') || 'ei'}
LOUKKAANTUMISET: ${(character.state.injuries || []).join(', ') || 'ei'}
`.trim();

    const prompt = `Olet CharacterKeeper - hahmojen jatkuvuuden valvoja.

Tarkista tÃ¤mÃ¤n hahmon jatkuvuus kohtauksessa:

${characterInfo}

KOHTAUKSEN TEKSTI:
${activeItem.content}

TARKISTA:
1. **Ã„Ã¤ni**: Puhuuko hahmo tyylilleen uskollisesti?
2. **Psykologia**: Ovatko teot/pÃ¤Ã¤tÃ¶kset johdonmukaisia tavoitteiden/pelkojen kanssa?
3. **Faktat**: KÃ¤ytetÃ¤Ã¤nkÃ¶ esineitÃ¤/taitoja joita hÃ¤nellÃ¤ ei ole?
4. **Loukkaantumiset**: Mainitaanko/huomioidaanko loukkaantumiset?

ANNA:
âœ… MikÃ¤ toimii hyvin
âš ï¸ Pienet epÃ¤johdonmukaisuudet + korjausehdotus
âŒ Kriittiset ongelmat + konkreettinen korjaus

VASTAA SUOMEKSI.`;

    // Avaa AI-avustaja ja lÃ¤hetÃ¤ tarkistus
    if (!aiAssistantOpen) setAiAssistantOpen(true);
    setAiPrompt(`Tarkista: ${character.name}`);
    callAIAPI(prompt, false);
  };

  // Progress Bar -komponentti
  const ProgressBar = ({ value, max, label, color = 'blue' }) => {
    const percentage = Math.min((value / max) * 100, 100);
    return e('div', { className: 'mb-3' },
      e('div', { className: 'flex justify-between text-xs mb-1' },
        e('span', null, label),
        e('span', null, `${value} / ${max} (${Math.round(percentage)}%)`)
      ),
      e('div', { className: `w-full bg-gray-700 rounded-full h-2` },
        e('div', {
          className: `bg-${color}-500 h-2 rounded-full transition-all duration-300`,
          style: { width: `${percentage}%` }
        })
      )
    );
  };

  return e(React.Fragment, null,
    // Inject macOS styles
    e('style', { dangerouslySetInnerHTML: { __html: MAC_OS_STYLES } }),
    
    // Main App
    e('div', {
      className: 'h-screen flex flex-col',
      style: {
        background: 'var(--mac-bg-primary)',
        color: 'var(--mac-text-primary)'
      },
      'data-theme': isDarkMode ? 'dark' : 'light'
    },
    // macOS Titlebar with Traffic Lights
    e('header', {
      className: 'fixed top-0 left-0 right-0 h-[52px] flex items-center justify-between px-4 z-50',
      style: {
        background: 'var(--mac-bg-secondary)',
        borderBottom: '1px solid rgba(255,255,255,0.05)',
        WebkitAppRegion: 'drag'
      }
    },
      // Traffic Lights (macOS window controls)
      e('div', {
        className: 'flex gap-2',
        style: { WebkitAppRegion: 'no-drag' }
      },
        e('button', {
          className: 'w-3 h-3 rounded-full hover:opacity-80 transition-opacity',
          style: { background: '#ff5f56' },
          onClick: () => window.close?.(),
          'aria-label': 'Close',
          title: 'Close'
        }),
        e('button', {
          className: 'w-3 h-3 rounded-full hover:opacity-80 transition-opacity',
          style: { background: '#ffbd2e' },
          onClick: () => window.minimize?.(),
          'aria-label': 'Minimize',
          title: 'Minimize'
        }),
        e('button', {
          className: 'w-3 h-3 rounded-full hover:opacity-80 transition-opacity',
          style: { background: '#27c93f' },
          onClick: () => window.maximize?.(),
          'aria-label': 'Fullscreen',
          title: 'Fullscreen'
        })
      ),
      
      // Title (center)
      e('div', {
        className: 'absolute left-1/2 -translate-x-1/2 text-sm font-medium flex items-center gap-2',
        style: { color: 'var(--mac-text-primary)', WebkitAppRegion: 'no-drag' }
      },
        e(Icons.Book, { className: 'w-4 h-4' }),
        e('input', {
          value: project.title,
          onChange: (ev) => setProject({ ...project, title: ev.target.value }),
          className: 'bg-transparent border-none outline-none text-center font-medium',
          style: { color: 'var(--mac-text-primary)' },
          placeholder: 'NimetÃ¶n projekti'
        })
      ),
      
      // Toolbar Controls (right)
      e('div', {
        className: 'flex items-center gap-3',
        style: { WebkitAppRegion: 'no-drag' }
      },
        // Word count badge
        e('div', {
          className: 'px-3 py-1 rounded text-xs font-mono tabular-nums',
          style: {
            background: 'rgba(255,255,255,0.05)',
            color: 'var(--mac-text-secondary)'
          }
        }, `${getTotalWordCount()} sanaa`),
        
        // NATSUME: Flow Mode Switcher
        e('div', { className: 'flex items-center gap-1 px-2 py-1 rounded', style: { background: 'rgba(255,255,255,0.05)' } },
          e('button', {
            className: `px-2 py-1 rounded text-xs transition-all ${flowMode === 'normal' ? 'bg-[var(--mac-accent-blue)] text-white' : 'hover:bg-[rgba(255,255,255,0.05)]'}`,
            onClick: () => setFlowMode('normal'),
            title: 'Normal Mode'
          }, 'âœï¸'),
          e('button', {
            className: `px-2 py-1 rounded text-xs transition-all ${flowMode === 'focus' ? 'bg-[var(--mac-accent-blue)] text-white' : 'hover:bg-[rgba(255,255,255,0.05)]'}`,
            onClick: () => setFlowMode('focus'),
            title: 'Focus Mode - Minimaal distraktiota'
          }, 'ðŸŽ¯'),
          e('button', {
            className: `px-2 py-1 rounded text-xs transition-all ${flowMode === 'rhythm' ? 'bg-[var(--mac-accent-purple)] text-white' : 'hover:bg-[rgba(255,255,255,0.05)]'}`,
            onClick: () => setFlowMode('rhythm'),
            title: 'Rhythm Mode - Tekstin rytmin analyysi'
          }, 'ðŸŽµ'),
          e('button', {
            className: `px-2 py-1 rounded text-xs transition-all ${flowMode === 'review' ? 'bg-[var(--mac-accent-green)] text-white' : 'hover:bg-[rgba(255,255,255,0.05)]'}`,
            onClick: () => setFlowMode('review'),
            title: 'Review Mode - Tarkistus ja korjaus'
          }, 'ðŸ”')
        ),
        
        // Theme toggle
        e('button', {
          className: 'w-8 h-8 rounded flex items-center justify-center transition-colors',
          style: { background: 'rgba(255,255,255,0.05)' },
          onClick: () => setIsDarkMode(!isDarkMode),
          title: isDarkMode ? 'Vaihda vaaleaseen' : 'Vaihda tummaan'
        }, isDarkMode ? e(Icons.Sun, { className: 'w-4 h-4' }) : e(Icons.Moon, { className: 'w-4 h-4' })),
        
        // Sidebar toggle
        e('button', {
          className: 'w-8 h-8 rounded flex items-center justify-center hover:bg-[rgba(255,255,255,0.08)] transition-colors',
          onClick: () => setShowSidebar(!showSidebar),
          title: 'Toggle Sidebar (Cmd+B)'
        }, e(Icons.Menu, { className: 'w-5 h-5' })),
        
        // Inspector toggle
        e('button', {
          className: 'w-8 h-8 rounded flex items-center justify-center hover:bg-[rgba(255,255,255,0.08)] transition-colors',
          onClick: () => setShowInspector(!showInspector),
          title: 'Toggle Inspector (Cmd+Option+I)'
        }, showInspector ? e(Icons.EyeOff, { className: 'w-5 h-5' }) : e(Icons.Eye, { className: 'w-5 h-5' }))
      )
    ),

    // Main content area (below titlebar)
    // NATSUME + SAGMEISTER: Flow-transition + emotional arc background
    e('div', { 
      className: `flex flex-1 overflow-hidden flow-transition mode-${flowMode} tone-${emotionalTone}`, 
      style: { 
        marginTop: '52px',
        background: EMOTIONAL_COLOR_ARCS[emotionalArc]?.background || EMOTIONAL_COLOR_ARCS.neutral.background,
        transition: 'background 2s ease-in-out'
      } 
    },
      // Sidebar - macOS Source List with NORMAN Writer-Centric Navigation
      showSidebar && e('aside', {
        className: 'w-60 overflow-y-auto',
        style: {
          background: 'var(--mac-bg-secondary)',
          borderRight: '1px solid rgba(255,255,255,0.05)'
        }
      },
        e('div', { className: 'p-2' },
          // NORMAN: Writer-Centric Navigation Menu
          e('div', { className: 'mb-4 pb-4 border-b border-[rgba(255,255,255,0.05)]' },
            e('div', {
              className: 'text-[10px] font-semibold uppercase tracking-wide px-3 py-2',
              style: { color: 'var(--mac-text-tertiary)' }
            }, 'KIRJOITTAJAN TYÃ–TILA'),
            
            // TARINA (Story) Section
            e('button', {
              className: 'w-full px-3 py-2 rounded flex items-center gap-2 hover:bg-[rgba(255,255,255,0.05)] transition-colors text-sm',
              style: { color: 'var(--mac-text-primary)' },
              title: 'Tarina: Luvut, juonilangat, tapahtumat'
            },
              e('span', null, 'ðŸ“–'),
              e('span', null, 'Tarina')
            ),
            
            // MAAILMA (World) Section
            e('button', {
              className: 'w-full px-3 py-2 rounded flex items-center gap-2 hover:bg-[rgba(255,255,255,0.05)] transition-colors text-sm',
              onClick: () => setShowCharacterSheet(true),
              style: { color: 'var(--mac-text-primary)' },
              title: 'Maailma: Hahmot, paikat, aikajana'
            },
              e('span', null, 'ðŸŒ'),
              e('span', null, 'Maailma'),
              e('span', { className: 'ml-auto text-xs opacity-50' }, `${project.characters?.length || 0}`)
            ),
            
            // TYÃ–KALUT (Tools) Section
            e('button', {
              className: 'w-full px-3 py-2 rounded flex items-center gap-2 hover:bg-[rgba(255,255,255,0.05)] transition-colors text-sm',
              onClick: () => setAiAssistantOpen(true),
              style: { color: 'var(--mac-text-primary)' },
              title: 'TyÃ¶kalut: Tekniikat, analyysi, AI-apu'
            },
              e('span', null, 'âœ¨'),
              e('span', null, 'AI-TyÃ¶kalut')
            )
          ),
          
          // Original file tree section
          e('div', {
            className: 'px-3 py-2 flex items-center justify-between',
            style: { color: 'var(--mac-text-tertiary)' }
          },
            e('div', {
              className: 'text-[11px] font-semibold uppercase tracking-wide'
            }, 'TIEDOSTOT'),
            e('button', {
              onClick: () => addItem(1, 'chapter'),
              className: 'w-5 h-5 rounded flex items-center justify-center hover:bg-[rgba(255,255,255,0.08)] transition-colors',
              title: 'LisÃ¤Ã¤ luku'
            }, e(Icons.Plus, { className: 'w-3 h-3' }))
          ),
          renderTree(project.items)
        )
      ),

      // Collections Panel - macOS Source List
      showCollectionsPanel && e('aside', {
        className: 'w-60 overflow-y-auto',
        style: {
          background: 'var(--mac-bg-secondary)',
          borderRight: '1px solid rgba(255,255,255,0.05)'
        }
      },
        e('div', { className: 'p-2' },
          // Section header
          e('div', {
            className: 'px-3 py-2 flex items-center justify-between',
            style: { color: 'var(--mac-text-tertiary)' }
          },
            e('div', {
              className: 'text-[11px] font-semibold uppercase tracking-wide'
            }, 'KOKOELMAT'),
            e('button', {
              onClick: createCollection,
              className: 'w-5 h-5 rounded flex items-center justify-center hover:bg-[rgba(255,255,255,0.08)] transition-colors',
              title: 'Luo kokoelma'
            }, e(Icons.Plus, { className: 'w-3 h-3' }))
          ),
          (project.collections || []).length === 0
            ? e('div', {
                className: 'text-xs text-center py-4',
                style: { color: 'var(--mac-text-tertiary)' }
              }, 'Ei kokoelmia')
            : (project.collections || []).map(collection =>
                e('button', {
                  key: collection.id,
                  className: 'w-full flex items-center gap-2 px-3 py-2 rounded-md text-sm transition-all cursor-pointer',
                  style: {
                    background: 'transparent',
                    color: 'var(--mac-text-primary)'
                  },
                  onMouseEnter: (e) => {
                    e.currentTarget.style.background = 'rgba(255,255,255,0.05)';
                  },
                  onMouseLeave: (e) => {
                    e.currentTarget.style.background = 'transparent';
                  }
                },
                  e(Icons.Collection, { className: 'w-4 h-4' }),
                  e('div', { className: 'flex-1 text-left' },
                    e('div', { className: 'font-medium' }, collection.name),
                    e('div', {
                      className: 'text-[11px]',
                      style: { color: 'var(--mac-text-tertiary)' }
                    }, `${collection.itemIds.length} dokumenttia`)
                  )
                )
              )
        )
      ),

      // Editor - Vaihe 3: Compose Mode & Split View
      e('main', {
        className: `flex-1 overflow-hidden ${composeMode ? 'bg-gray-900' : ''}`,
        style: composeMode ? {
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          zIndex: 9999
        } : {}
      },
        viewMode === 'editor' && (
          composeMode ? (
            // Compose Mode - HÃ¤iriÃ¶tÃ¶n kirjoitustila
            e('div', {
              className: 'h-full flex items-center justify-center p-8',
              style: {
                background: isDarkMode ? '#111827' : '#f9fafb',
                color: isDarkMode ? '#f9fafb' : '#111827'
              }
            },
              e('div', {
                className: 'w-full max-w-4xl',
                style: typewriterMode ? {
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  justifyContent: 'center',
                  height: '100%'
                } : {}
              },
                typewriterMode && e('div', {
                  className: 'text-center mb-8',
                  style: { fontSize: '14px', opacity: 0.7 }
                }, `${getActiveItem()?.title || 'NimetÃ¶n dokumentti'} â€¢ ${getActiveItem()?.wordCount || 0} sanaa`),

                e('textarea', {
                  ref: editorRef,
                  defaultValue: getActiveItem()?.content || '',
                  onChange: (ev) => updateItem(activeItemId, { content: ev.target.value }),
                  placeholder: 'Aloita kirjoittaminen...',
                  className: `w-full resize-none outline-none ${
                    isDarkMode
                      ? 'bg-transparent text-gray-100 placeholder-gray-600'
                      : 'bg-transparent text-gray-900 placeholder-gray-400'
                  }`,
                  style: {
                    fontFamily: fontOptions.find(f => f.id === editorFont)?.family || 'serif',
                    fontSize: `${fontSize}px`,
                    lineHeight: lineHeight,
                    ...(typewriterMode ? {
                      textAlign: 'center',
                      minHeight: '60vh'
                    } : {
                      minHeight: '80vh'
                    })
                  }
                })
              )
            )
          ) : splitView && splitViewItem ? (
            // Split View - Kaksi dokumenttia vierekkÃ¤in
            e('div', { className: 'flex h-full' },
              // Vasen paneeli (aktiivinen dokumentti)
              e('div', { className: 'flex-1 border-r border-gray-700 overflow-y-auto' },
                e('div', { className: 'max-w-4xl mx-auto p-8' },
                  e('div', { className: 'mb-4' },
                    e('input', {
                      value: getActiveItem()?.title || '',
                      onChange: (ev) => updateItem(activeItemId, { title: ev.target.value }),
                      className: `text-2xl font-bold w-full bg-transparent border-b-2 border-transparent hover:border-blue-500 focus:border-blue-500 outline-none mb-2 ${
                        isDarkMode ? 'text-white' : 'text-gray-900'
                      }`
                    }),
                    e('div', { className: 'text-sm opacity-60' }, `${getActiveItem()?.wordCount || 0} sanaa`)
                  ),
                  e('textarea', {
                    ref: editorRef,
                    defaultValue: getActiveItem()?.content || '',
                    onChange: (ev) => updateItem(activeItemId, { content: ev.target.value }),
                    placeholder: 'Aloita kirjoittaminen...',
                    className: `w-full min-h-[600px] p-6 rounded-lg border-2 resize-none outline-none ${
                      isDarkMode
                        ? 'bg-gray-800 border-gray-700 text-gray-100 placeholder-gray-600'
                        : 'bg-white border-gray-200 text-gray-900 placeholder-gray-400'
                    }`,
                    style: {
                      fontFamily: fontOptions.find(f => f.id === editorFont)?.family || 'serif',
                      fontSize: `${fontSize}px`,
                      lineHeight: lineHeight
                    }
                  })
                )
              ),

              // Oikea paneeli (toinen dokumentti)
              e('div', { className: 'flex-1 overflow-y-auto' },
                e('div', { className: 'max-w-4xl mx-auto p-8' },
                  e('div', { className: 'mb-4' },
                    e('input', {
                      value: splitViewItem.title || '',
                      onChange: (ev) => updateItem(splitViewItem.id, { title: ev.target.value }),
                      className: `text-2xl font-bold w-full bg-transparent border-b-2 border-transparent hover:border-blue-500 focus:border-blue-500 outline-none mb-2 ${
                        isDarkMode ? 'text-white' : 'text-gray-900'
                      }`
                    }),
                    e('div', { className: 'text-sm opacity-60' }, `${splitViewItem.wordCount || 0} sanaa`)
                  ),
                  e('textarea', {
                    defaultValue: splitViewItem.content || '',
                    onChange: (ev) => updateItem(splitViewItem.id, { content: ev.target.value }),
                    placeholder: 'Aloita kirjoittaminen...',
                    className: `w-full min-h-[600px] p-6 rounded-lg border-2 resize-none outline-none ${
                      isDarkMode
                        ? 'bg-gray-800 border-gray-700 text-gray-100 placeholder-gray-600'
                        : 'bg-white border-gray-200 text-gray-900 placeholder-gray-400'
                    }`,
                    style: {
                      fontFamily: fontOptions.find(f => f.id === editorFont)?.family || 'serif',
                      fontSize: `${fontSize}px`,
                      lineHeight: lineHeight
                    }
                  })
                )
              )
            )
          ) : (
            // Normaali editori
            e('div', { className: 'max-w-4xl mx-auto p-8' },
              e('div', { className: 'mb-4' },
                e('input', {
                  value: getActiveItem()?.title || '',
                  onChange: (ev) => updateItem(activeItemId, { title: ev.target.value }),
                  className: `text-2xl font-bold w-full bg-transparent border-b-2 border-transparent hover:border-blue-500 focus:border-blue-500 outline-none mb-2 ${
                    isDarkMode ? 'text-white' : 'text-gray-900'
                  }`
                }),
                e('div', { className: 'text-sm opacity-60' }, `${getActiveItem()?.wordCount || 0} sanaa`)
              ),
              e('textarea', {
                ref: editorRef,
                defaultValue: getActiveItem()?.content || '',
                onChange: (ev) => updateItem(activeItemId, { content: ev.target.value }),
                placeholder: 'Aloita kirjoittaminen...',
                className: `w-full min-h-[600px] p-6 rounded-lg border-2 resize-none outline-none ${
                  isDarkMode
                    ? 'bg-gray-800 border-gray-700 text-gray-100 placeholder-gray-600'
                    : 'bg-white border-gray-200 text-gray-900 placeholder-gray-400'
                }`,
                style: {
                  fontFamily: fontOptions.find(f => f.id === editorFont)?.family || 'serif',
                  fontSize: `${fontSize}px`,
                  lineHeight: lineHeight
                }
              })
            )
          )
        )
      ),

      // Inspector - macOS style
      showInspector && e('aside', {
        className: 'w-80 flex flex-col',
        style: {
          background: 'var(--mac-bg-secondary)',
          borderLeft: '1px solid rgba(255,255,255,0.05)'
        }
      },
        // Inspector tabs - macOS style
        e('div', {
          className: 'flex border-b overflow-x-auto',
          style: {
            borderColor: 'rgba(255,255,255,0.05)',
            scrollbarWidth: 'none'
          }
        },
          ['notes', 'metadata', 'snapshots', 'targets', 'appearance', 'tekniikat', 'characters', 'locations', 'story'].map(tab => {
            const isActive = inspectorTab === tab;
            const tabLabel = tab === 'notes' ? 'Muistiinpanot' : 
                           tab === 'metadata' ? 'Metatiedot' : 
                           tab === 'snapshots' ? 'Tilannekuvat' : 
                           tab === 'targets' ? 'Tavoitteet' : 
                           tab === 'appearance' ? 'Ulkoasu' : 
                           tab === 'tekniikat' ? 'Tekniikat' :
                           tab === 'characters' ? 'Hahmot' :
                           tab === 'locations' ? 'Paikat' :
                           'Tarina';
            
            return e('button', {
              key: tab,
              onClick: () => setInspectorTab(tab),
              className: 'flex-1 min-w-fit px-4 py-3 text-sm font-medium relative transition-colors',
              style: {
                background: 'transparent',
                border: 'none',
                color: isActive ? 'var(--mac-text-primary)' : 'var(--mac-text-secondary)',
                cursor: 'pointer'
              },
              onMouseEnter: (e) => {
                if (!isActive) e.currentTarget.style.color = 'var(--mac-text-primary)';
              },
              onMouseLeave: (e) => {
                if (!isActive) e.currentTarget.style.color = 'var(--mac-text-secondary)';
              }
            }, 
              tabLabel,
              isActive && e('div', {
                className: 'absolute bottom-0 left-0 right-0 h-0.5 rounded-t',
                style: { background: 'var(--mac-accent-blue)' }
              })
            );
          })
        ),
        
        // Inspector content
        e('div', { className: 'flex-1 overflow-y-auto p-4 space-y-4' },

          inspectorTab === 'notes' && e('div', null,
            e('h4', { className: 'text-sm font-semibold mb-2' }, 'Dokumentin muistiinpanot'),
            e('textarea', {
              value: getActiveItem()?.notes || '',
              onChange: (ev) => updateItem(activeItemId, { notes: ev.target.value }),
              placeholder: 'Kirjoita muistiinpanoja tÃ¤hÃ¤n...',
              className: `w-full h-40 p-3 rounded border resize-none ${
                isDarkMode ? 'bg-gray-900 border-gray-700 text-white' : 'bg-gray-50 border-gray-200 text-gray-900'
              }`,
              style: {
                fontFamily: fontOptions.find(f => f.id === editorFont)?.family || 'serif',
                fontSize: `${Math.max(fontSize - 2, 12)}px`,
                lineHeight: lineHeight
              }
            })
          ),

          inspectorTab === 'metadata' && e('div', { className: 'space-y-3' },
            e('div', null,
              e('label', { className: 'text-sm font-semibold block mb-1' }, 'Tila'),
              e('select', {
                value: getActiveItem()?.status || 'draft',
                onChange: (ev) => updateItem(activeItemId, { status: ev.target.value }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700 text-white' : 'bg-white border-gray-200 text-gray-900'
                }`
              }, statusOptions.map(opt => e('option', { key: opt.value, value: opt.value }, opt.label)))
            ),
            e('div', null,
              e('label', { className: 'text-sm font-semibold block mb-1' }, 'MerkintÃ¤'),
              e('select', {
                value: getActiveItem()?.label || 'none',
                onChange: (ev) => updateItem(activeItemId, { label: ev.target.value }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700 text-white' : 'bg-white border-gray-200 text-gray-900'
                }`
              }, LABEL_COLORS.map(label => e('option', { key: label.id, value: label.id }, label.name)))
            )
          ),

          inspectorTab === 'snapshots' && e('div', null,
            e('h4', { className: 'text-sm font-semibold mb-2' }, 'Tilannekuvat'),
            (getActiveItem()?.snapshots || []).length === 0
              ? e('div', { className: 'text-xs opacity-50 text-center py-4' }, 'Ei tilannekuvia')
              : (getActiveItem()?.snapshots || []).map(snapshot =>
                  e('div', {
                    key: snapshot.id,
                    className: `p-3 mb-2 rounded border ${
                      isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'
                    }`
                  },
                    e('div', { className: 'flex items-start justify-between mb-2' },
                      e('div', { className: 'flex-1' },
                        e('div', { className: 'text-sm font-medium' }, snapshot.title),
                        e('div', { className: 'text-xs opacity-75' }, `${snapshot.wordCount} sanaa`)
                      ),
                      e('div', { className: 'flex gap-1' },
                        e('button', {
                          onClick: () => restoreSnapshot(snapshot),
                          className: 'text-xs px-2 py-1 rounded bg-blue-500 text-white hover:bg-blue-600',
                          title: 'Palauta'
                        }, 'â†º'),
                        e('button', {
                          onClick: () => deleteSnapshot(snapshot.id),
                          className: 'text-xs px-2 py-1 rounded bg-red-500 text-white hover:bg-red-600',
                          title: 'Poista'
                        }, 'Ã—')
                      )
                    )
                  )
                )
          ),

          inspectorTab === 'targets' && e('div', { className: 'space-y-4' },
            e('h4', { className: 'text-sm font-semibold mb-3' }, 'Kirjoitustavoitteet'),

            // Istunnon edistyminen
            e('div', { className: 'p-3 rounded border ' + (isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200') },
              e('h5', { className: 'text-xs font-medium mb-2 opacity-75' }, 'Nykyinen istunto'),
              ProgressBar({
                value: sessionStats.wordsWritten,
                max: targets.session,
                label: 'Istuntotavoite',
                color: 'green'
              }),
              e('div', { className: 'text-xs opacity-75 mt-2' },
                `Kesto: ${Math.floor(sessionStats.duration / 60)} min | `,
                `Nopeus: ${Math.round(sessionStats.wordsWritten / (sessionStats.duration / 60) || 0)} sanaa/min`
              )
            ),

            // PÃ¤ivÃ¤tavoite
            e('div', { className: 'p-3 rounded border ' + (isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200') },
              e('h5', { className: 'text-xs font-medium mb-2 opacity-75' }, 'PÃ¤ivÃ¤tavoite'),
              ProgressBar({
                value: dailyStats.words,
                max: targets.daily,
                label: 'PÃ¤ivÃ¤n sanat',
                color: 'blue'
              })
            ),

            // Projektitavoite
            e('div', { className: 'p-3 rounded border ' + (isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200') },
              e('h5', { className: 'text-xs font-medium mb-2 opacity-75' }, 'Projektin edistyminen'),
              ProgressBar({
                value: getTotalWordCount(),
                max: targets.project,
                label: 'KokonaissanamÃ¤Ã¤rÃ¤',
                color: 'purple'
              }),
              e('div', { className: 'text-xs opacity-75 mt-2' },
                `JÃ¤ljellÃ¤: ${targets.project - getTotalWordCount()} sanaa | `,
                `Arvioitu valmis: ${Math.ceil((targets.project - getTotalWordCount()) / targets.daily)} pÃ¤ivÃ¤ssÃ¤`
              )
            ),

            // Tavoitteiden muokkaus
            e('div', { className: 'p-3 rounded border ' + (isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200') },
              e('h5', { className: 'text-xs font-medium mb-2 opacity-75' }, 'Muokkaa tavoitteita'),
              e('div', { className: 'space-y-2' },
                e('input', {
                  type: 'number',
                  value: targets.session,
                  onChange: (ev) => setTargets({...targets, session: parseInt(ev.target.value)}),
                  className: 'w-full p-2 rounded border text-sm ' + (isDarkMode ? 'bg-gray-800 border-gray-600' : 'bg-white border-gray-300'),
                  placeholder: 'Istuntotavoite'
                }),
                e('input', {
                  type: 'number',
                  value: targets.daily,
                  onChange: (ev) => setTargets({...targets, daily: parseInt(ev.target.value)}),
                  className: 'w-full p-2 rounded border text-sm ' + (isDarkMode ? 'bg-gray-800 border-gray-600' : 'bg-white border-gray-300'),
                  placeholder: 'PÃ¤ivÃ¤tavoite'
                }),
                e('input', {
                  type: 'number',
                  value: targets.project,
                  onChange: (ev) => setTargets({...targets, project: parseInt(ev.target.value)}),
                  className: 'w-full p-2 rounded border text-sm ' + (isDarkMode ? 'bg-gray-800 border-gray-600' : 'bg-white border-gray-300'),
                  placeholder: 'Projektitavoite'
                })
              )
            )
          ),

          inspectorTab === 'appearance' && e('div', { className: 'space-y-4' },
            e('h4', { className: 'text-sm font-semibold mb-3' }, 'Ulkoasu'),

            // Fontti valinta
            e('div', { className: 'space-y-2' },
              e('label', { className: 'text-xs font-medium opacity-75' }, 'Fontti'),
              e('select', {
                value: editorFont,
                onChange: (ev) => setEditorFont(ev.target.value),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-200'
                }`
              }, fontOptions.map(font =>
                e('option', { key: font.id, value: font.id }, font.name)
              ))
            ),

            // Fonttikoko
            e('div', { className: 'space-y-2' },
              e('label', { className: 'text-xs font-medium opacity-75' }, `Fonttikoko: ${fontSize}px`),
              e('input', {
                type: 'range',
                min: 12,
                max: 32,
                value: fontSize,
                onChange: (ev) => setFontSize(parseInt(ev.target.value)),
                className: 'w-full'
              }),
              e('div', { className: 'flex justify-between text-xs opacity-50' },
                e('span', null, '12px'),
                e('span', null, '32px')
              )
            ),

            // RivivÃ¤li
            e('div', { className: 'space-y-2' },
              e('label', { className: 'text-xs font-medium opacity-75' }, `RivivÃ¤li: ${lineHeight}`),
              e('input', {
                type: 'range',
                min: 1,
                max: 3,
                step: 0.1,
                value: lineHeight,
                onChange: (ev) => setLineHeight(parseFloat(ev.target.value)),
                className: 'w-full'
              }),
              e('div', { className: 'flex justify-between text-xs opacity-50' },
                e('span', null, 'Tiukka'),
                e('span', null, 'VÃ¤ljÃ¤')
              )
            ),

            // Esikatselu
            e('div', {
              className: `p-4 rounded border ${
                isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'
              }`
            },
              e('h5', { className: 'text-xs font-medium mb-2 opacity-75' }, 'Esikatselu'),
              e('p', {
                style: {
                  fontFamily: fontOptions.find(f => f.id === editorFont)?.family,
                  fontSize: `${fontSize}px`,
                  lineHeight: lineHeight
                }
              }, 'TÃ¤mÃ¤ on esimerkkiteksti. NÃ¤et miltÃ¤ valitsemasi fontti nÃ¤yttÃ¤Ã¤ kirjoittaessa. Lorem ipsum dolor sit amet, consectetur adipiscing elit.')
            ),

            // Kirjoitustila vaihtoehdot
            e('div', { className: 'space-y-2 pt-4 border-t ' + (isDarkMode ? 'border-gray-700' : 'border-gray-200') },
              e('h5', { className: 'text-xs font-medium mb-2 opacity-75' }, 'Kirjoitustila'),

              e('label', { className: 'flex items-center gap-2 text-sm' },
                e('input', {
                  type: 'checkbox',
                  checked: typewriterMode || false,
                  onChange: (ev) => setTypewriterMode(ev.target.checked)
                }),
                'Typewriter scrolling'
              ),

              e('label', { className: 'flex items-center gap-2 text-sm' },
                e('input', {
                  type: 'checkbox',
                  checked: focusMode || false,
                  onChange: (ev) => setFocusMode(ev.target.checked)
                }),
                'Focus mode (korostaa nykyistÃ¤ kappaletta)'
              ),

              e('label', { className: 'flex items-center gap-2 text-sm' },
                e('input', {
                  type: 'checkbox',
                  checked: showWordCount || true,
                  onChange: (ev) => setShowWordCount(ev.target.checked)
                }),
                'NÃ¤ytÃ¤ sanamÃ¤Ã¤rÃ¤'
              )
            )
          ),

          // HAHMOT-vÃ¤lilehti - CharacterKeeper
          inspectorTab === 'characters' && e('div', { className: 'space-y-3' },
            e('div', { className: 'flex items-center justify-between mb-3' },
              e('h4', { className: 'text-sm font-semibold flex items-center gap-2' },
                e('span', null, 'ðŸ‘¥ Hahmot'),
                e('span', { className: 'text-xs opacity-50 font-normal' },
                  `${project.characters?.length || 0} hahmoa`)
              ),
              e('button', {
                onClick: () => {
                  const newChar = {
                    ...CHARACTER_TEMPLATE,
                    id: Date.now(),
                    name: 'Uusi hahmo'
                  };
                  setProject({
                    ...project,
                    characters: [...(project.characters || []), newChar]
                  });
                },
                className: 'px-2 py-1 text-xs rounded bg-blue-500 text-white hover:bg-blue-600'
              }, '+ LisÃ¤Ã¤ hahmo')
            ),

            // Hahmolista
            (project.characters || []).length === 0 ?
              e('div', { className: 'text-xs opacity-50 text-center py-8' },
                'Ei hahmoja. Luo ensimmÃ¤inen hahmo!') :

              (project.characters || []).map(char =>
                e('div', {
                  key: char.id,
                  className: `p-3 rounded border mb-2 ${
                    isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'
                  }`
                },
                  // Hahmon nimi
                  e('div', { className: 'flex items-center justify-between mb-2' },
                    e('input', {
                      value: char.name,
                      onChange: (ev) => {
                        setProject({
                          ...project,
                          characters: project.characters.map(c =>
                            c.id === char.id ? { ...c, name: ev.target.value } : c
                          )
                        });
                      },
                      className: `font-medium text-sm bg-transparent border-b border-transparent hover:border-blue-500 focus:border-blue-500 outline-none ${
                        isDarkMode ? 'text-white' : 'text-gray-900'
                      }`,
                      placeholder: 'Hahmon nimi'
                    }),
                    e('button', {
                      onClick: () => {
                        if (confirm(`Poista hahmo "${char.name}"?`)) {
                          setProject({
                            ...project,
                            characters: project.characters.filter(c => c.id !== char.id)
                          });
                        }
                      },
                      className: 'text-red-500 hover:text-red-600'
                    }, e(Icons.Trash))
                  ),

                  // Pika-info
                  e('div', { className: 'text-xs space-y-1 opacity-75 mb-2' },
                    char.bio.age && e('div', null, `ðŸ“… ${char.bio.age} vuotta`),
                    char.bio.occupation && e('div', null, `ðŸ’¼ ${char.bio.occupation}`),
                    char.psychology.want && e('div', null, `ðŸŽ¯ Haluaa: ${char.psychology.want}`)
                  ),

                  // Toimintopainikkeet
                  e('div', { className: 'flex gap-1 mt-2' },
                    e('button', {
                      onClick: () => {
                        // Avaa CharacterSheet -modaali
                        setEditingCharacter(char);
                        setShowCharacterSheet(true);
                      },
                      className: 'flex-1 px-2 py-1 text-xs rounded bg-blue-500 text-white hover:bg-blue-600'
                    }, 'âœï¸ Muokkaa'),

                    e('button', {
                      onClick: () => {
                        // Tarkista hahmo nykyisessÃ¤ dokumentissa
                        checkCharacterContinuity(char);
                      },
                      className: 'flex-1 px-2 py-1 text-xs rounded bg-purple-500 text-white hover:bg-purple-600',
                      title: 'Tarkista jatkuvuus'
                    }, 'ðŸ” Tarkista')
                  )
                )
              )
          ),
          
          // TEKNIIKAT-vÃ¤lilehti
          inspectorTab === 'tekniikat' && e('div', { className: 'space-y-3' },
            // Info-laatikko
            e('div', { className: `p-3 rounded border text-xs mb-4 ${isDarkMode ? 'bg-purple-900/20 border-purple-700' : 'bg-purple-50 border-purple-300'}` },
              e('div', { className: 'font-medium mb-1' }, 'ðŸ’¡ Kuinka kÃ¤yttÃ¤Ã¤:'),
              e('div', { className: 'opacity-75' }, 'Valitse tekniikka â†’ Claude analysoi aktiivisen dokumentin ja soveltaa valitsemaasi tekniikkaa. Tulos ilmestyy AI-avustajaan.')
            ),
            
            // Tekniikkakategoriat
            Object.entries(WRITING_TECHNIQUES).map(([categoryKey, category]) =>
              e('div', { key: categoryKey, className: `p-3 rounded border mb-3 ${isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'}` },
                e('h5', { className: 'text-xs font-bold mb-2 text-' + category.color + '-500' }, category.title),
                
                category.techniques.map(technique =>
                  e('button', {
                    key: technique.id,
                    onClick: () => {
                      // KÃ¤ytÃ¤ tekniikkaa nykyiseen sisÃ¤ltÃ¶Ã¶n
                      const activeItem = getActiveItem();
                      const prompt = technique.prompt
                        .replace(/\$\{getActiveItem\(\)\?\.content \|\| '\[Ei sisÃ¤ltÃ¶Ã¤\]'\}/g, activeItem?.content || '[Ei sisÃ¤ltÃ¶Ã¤]')
                        .replace('{characterList}', project.characters?.map(char => `
- ${char.name} (${char.bio.age || '?'}v, ${char.bio.occupation || 'ammatti?'})
  Tavoite: ${char.psychology.want || '?'}
  Pelko: ${char.psychology.fear || '?'}
  Puhetyyli: ${char.voice.description || '?'}
`).join('\n') || 'Ei hahmoja mÃ¤Ã¤riteltynÃ¤')
                        .replace('{selectedCharacter}', editingCharacter ? `${editingCharacter.name} (${editingCharacter.bio.age || '?'}v)` : 'Ei valittua hahmoa')
                        .replace('{voiceDescription}', editingCharacter?.voice?.description || 'Ei mÃ¤Ã¤ritelty')
                        .replace('{lexicon}', editingCharacter?.voice?.lexicon?.join(', ') || 'Ei mÃ¤Ã¤ritelty')
                        .replace('{avgSentenceLength}', editingCharacter?.voice?.avgSentenceLength || '12')
                        .replace('{want}', editingCharacter?.psychology?.want || 'Ei mÃ¤Ã¤ritelty')
                        .replace('{fear}', editingCharacter?.psychology?.fear || 'Ei mÃ¤Ã¤ritelty')
                        .replace('{weakness}', editingCharacter?.psychology?.weakness || 'Ei mÃ¤Ã¤ritelty')
                        .replace('{values}', editingCharacter?.psychology?.values?.join(', ') || 'Ei mÃ¤Ã¤ritelty')
                        .replace('{resources}', editingCharacter?.state?.resources?.join(', ') || 'Ei mÃ¤Ã¤ritelty')
                        .replace('{injuries}', editingCharacter?.state?.injuries?.join(', ') || 'Ei mÃ¤Ã¤ritelty')
                        .replace('{appearance}', editingCharacter?.bio?.appearance || 'Ei mÃ¤Ã¤ritelty')
                        .replace('{beliefs}', JSON.stringify(editingCharacter?.state?.beliefs || {}));

                      if (!aiAssistantOpen) setAiAssistantOpen(true);
                      setAiPrompt(`${technique.name}: ${technique.description}`);
                      callAIAPI(prompt, false);
                    },
                    className: `w-full text-left p-2 mb-2 rounded text-xs transition-colors ${
                      isDarkMode ? 'bg-gray-800 hover:bg-gray-700' : 'bg-white hover:bg-gray-100'
                    }`,
                    title: technique.description
                  },
                    e('div', { className: 'font-medium mb-0.5' }, technique.name),
                    e('div', { className: 'opacity-75 text-[10px]' }, technique.description)
                  )
                )
              )
            )
          ),
          
          // PAIKAT-vÃ¤lilehti (LocationKeeper)
          inspectorTab === 'locations' && e('div', { className: 'space-y-3' },
            // Header
            e('div', { className: 'flex items-center justify-between mb-3' },
              e('h4', { className: 'text-sm font-semibold flex items-center gap-2' },
                e('span', null, 'ðŸ“ Paikat'),
                e('span', { className: 'text-xs opacity-50 font-normal' }, 
                  `${project.locations?.length || 0} paikkaa`)
              ),
              e('button', {
                onClick: () => detectLocationsInText(),
                className: 'px-2 py-1 text-xs rounded bg-purple-500 text-white hover:bg-purple-600',
                title: 'Tunnista paikat automaattisesti',
                disabled: isGenerating
              }, 'ðŸ” Tunnista')
            ),

            // Genre-valinta
            e('div', { className: 'mb-3' },
              e('label', { className: 'text-xs block mb-1 opacity-75' }, 'Kirjan genre'),
              e('select', {
                value: project.genre || 'psychological_thriller',
                onChange: (ev) => setProject({ ...project, genre: ev.target.value }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-200'
                }`
              }, GENRE_OPTIONS.map(g => e('option', { key: g.id, value: g.id }, `${g.icon} ${g.name}`)))
            ),

            // Paikkalista
            (project.locations || []).length === 0 ? 
              e('div', { className: 'text-xs opacity-50 text-center py-8' }, 
                'Ei paikkoja. Klikkaa "Tunnista" tai lisÃ¤Ã¤ manuaalisesti.') :
              
              (project.locations || []).map(loc =>
                e('div', {
                  key: loc.id,
                  className: `p-3 rounded border mb-2 ${
                    isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'
                  }`
                },
                  // Paikan nimi ja tyyppi
                  e('div', { className: 'flex items-start justify-between mb-2' },
                    e('div', { className: 'flex-1' },
                      e('div', { className: 'font-medium text-sm mb-1' },
                        LOCATION_TYPES.find(t => t.id === loc.type)?.icon || 'ðŸ“',
                        ' ',
                        loc.name
                      ),
                      loc.city && e('div', { className: 'text-xs opacity-75' },
                        `${loc.city}${loc.country ? `, ${loc.country}` : ''}`
                      )
                    ),
                    e('button', {
                      onClick: () => {
                        if (confirm(`Poista paikka "${loc.name}"?`)) {
                          setProject({
                            ...project,
                            locations: project.locations.filter(l => l.id !== loc.id)
                          });
                        }
                      },
                      className: 'text-red-500 hover:text-red-600'
                    }, e(Icons.Trash))
                  ),

                  // Stats
                  e('div', { className: 'text-xs opacity-75 mb-2' },
                    `KÃ¤ytetty: ${loc.used_in_scenes?.length || 0} kohtausta`,
                    loc.genre_descriptions && Object.keys(loc.genre_descriptions).length > 0 &&
                      ` â€¢ ${Object.keys(loc.genre_descriptions).length} kuvausta`
                  ),

                  // Toiminnot
                  e('div', { className: 'flex gap-1 mt-2 flex-wrap' },
                    e('button', {
                      onClick: () => {
                        setEditingLocation(loc);
                        setShowLocationSheet(true);
                      },
                      className: 'px-2 py-1 text-xs rounded bg-blue-500 text-white hover:bg-blue-600'
                    }, 'âœï¸ Muokkaa'),
                    
                    e('button', {
                      onClick: () => fetchLocationData(loc),
                      disabled: isGenerating,
                      className: `px-2 py-1 text-xs rounded ${
                        isGenerating 
                          ? 'bg-gray-600 cursor-not-allowed' 
                          : 'bg-green-500 text-white hover:bg-green-600'
                      }`
                    }, 'ðŸ” Hae tiedot'),
                    
                    e('button', {
                      onClick: () => generateLocationDescription(loc),
                      disabled: isGenerating,
                      className: `px-2 py-1 text-xs rounded ${
                        isGenerating 
                          ? 'bg-gray-600 cursor-not-allowed' 
                          : 'bg-purple-500 text-white hover:bg-purple-600'
                      }`
                    }, 'âœï¸ Generoi kuvaus')
                  )
                )
              ),

            // LisÃ¤Ã¤ paikka manuaalisesti
            e('button', {
              onClick: () => {
                const newLoc = {
                  ...LOCATION_TEMPLATE,
                  id: Date.now(),
                  name: 'Uusi paikka'
                };
                setProject({
                  ...project,
                  locations: [...(project.locations || []), newLoc]
                });
              },
              className: 'w-full px-3 py-2 text-sm rounded border-2 border-dashed hover:bg-gray-700 transition-colors',
              style: { borderColor: isDarkMode ? '#4b5563' : '#d1d5db' }
            }, '+ LisÃ¤Ã¤ paikka manuaalisesti')
          ),
          
          // TARINA-vÃ¤lilehti (StoryKeeper)
          inspectorTab === 'story' && e('div', { className: 'space-y-3' },
            // Header
            e('div', { className: 'flex items-center justify-between mb-3' },
              e('h4', { className: 'text-sm font-semibold flex items-center gap-2' },
                e('span', null, 'ðŸ“– Tarina'),
                e('span', { className: 'text-xs opacity-50 font-normal' }, 
                  `${project.story?.outline?.length || 0} lukua`)
              ),
              e('button', {
                onClick: () => checkStoryLogic(),
                disabled: isGenerating,
                className: `px-2 py-1 text-xs rounded ${
                  isGenerating 
                    ? 'bg-gray-600 cursor-not-allowed' 
                    : 'bg-purple-500 text-white hover:bg-purple-600'
                }`,
                title: 'Tarkista juonen logiikka'
              }, 'ðŸ” Tarkista juoni')
            ),

            // Lukujen lista
            e('div', { className: 'space-y-2' },
              e('div', { className: 'text-xs font-semibold opacity-75 mb-1' }, 'LUVUT'),
              
              (project.story?.outline || []).length === 0 ?
                e('div', { className: 'text-xs opacity-50 text-center py-4' },
                  'Ei lukuja. Luo tarinan rakenne.') :
                
                (project.story.outline || []).map((chapter, idx) =>
                  e('div', {
                    key: idx,
                    className: `p-2 rounded border text-xs ${
                      chapter.status === 'completed' 
                        ? (isDarkMode ? 'bg-green-900/20 border-green-700' : 'bg-green-50 border-green-300')
                        : chapter.status === 'in_progress'
                        ? (isDarkMode ? 'bg-blue-900/20 border-blue-700' : 'bg-blue-50 border-blue-300')
                        : (isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200')
                    }`
                  },
                    e('div', { className: 'flex items-start justify-between mb-1' },
                      e('div', { className: 'flex-1' },
                        e('div', { className: 'font-medium' },
                          `${chapter.chapter}. ${chapter.title || 'NimetÃ¶n luku'}`
                        ),
                        chapter.summary && e('div', { className: 'opacity-75 mt-1' }, 
                          chapter.summary.substring(0, 60) + (chapter.summary.length > 60 ? '...' : '')
                        )
                      ),
                      e('div', { className: 'flex gap-1' },
                        chapter.status === 'completed' && e('span', { title: 'Valmis' }, 'âœ“'),
                        chapter.status === 'in_progress' && e('span', { title: 'Kirjoitetaan' }, 'âœï¸'),
                        chapter.status === 'not_started' && e('span', { title: 'Ei aloitettu', className: 'opacity-50' }, 'â—‹')
                      )
                    ),
                    
                    chapter.key_events && chapter.key_events.length > 0 && 
                      e('div', { className: 'mt-1 opacity-75' },
                        `${chapter.key_events.length} tapahtumaa`
                      ),
                    
                    e('button', {
                      onClick: () => {
                        setEditingChapter(chapter);
                        setShowChapterSheet(true);
                      },
                      className: 'mt-2 px-2 py-1 text-xs rounded bg-blue-500 text-white hover:bg-blue-600'
                    }, 'âœï¸ Muokkaa')
                  )
                )
            ),

            // LisÃ¤Ã¤ luku
            e('button', {
              onClick: () => {
                const newChapter = {
                  ...CHAPTER_TEMPLATE,
                  chapter: (project.story.outline?.length || 0) + 1
                };
                setProject({
                  ...project,
                  story: {
                    ...project.story,
                    outline: [...(project.story.outline || []), newChapter]
                  }
                });
              },
              className: 'w-full px-3 py-2 text-sm rounded border-2 border-dashed hover:bg-gray-700 transition-colors',
              style: { borderColor: isDarkMode ? '#4b5563' : '#d1d5db' }
            }, '+ LisÃ¤Ã¤ luku'),

            // JUONILANGAT
            e('div', { className: 'mt-4' },
              e('div', { className: 'text-xs font-semibold opacity-75 mb-2 flex items-center justify-between' },
                e('span', null, 'JUONILANGAT'),
                e('button', {
                  onClick: () => {
                    const newThread = {
                      ...THREAD_TEMPLATE,
                      id: Date.now(),
                      name: 'Uusi juonilanka'
                    };
                    setProject({
                      ...project,
                      story: {
                        ...project.story,
                        threads: [...(project.story.threads || []), newThread]
                      }
                    });
                  },
                  className: 'px-2 py-1 text-xs rounded bg-blue-500 text-white hover:bg-blue-600'
                }, '+')
              ),

              (project.story?.threads || []).length === 0 ?
                e('div', { className: 'text-xs opacity-50 text-center py-2' },
                  'Ei juonilankoja') :
                
                (project.story.threads || []).map(thread =>
                  e('div', {
                    key: thread.id,
                    className: `p-2 rounded border text-xs mb-2 ${
                      thread.status === 'closed'
                        ? (isDarkMode ? 'bg-green-900/20 border-green-700' : 'bg-green-50 border-green-300')
                        : thread.importance === 'major'
                        ? (isDarkMode ? 'bg-red-900/20 border-red-700' : 'bg-red-50 border-red-300')
                        : (isDarkMode ? 'bg-yellow-900/20 border-yellow-700' : 'bg-yellow-50 border-yellow-300')
                    }`
                  },
                    e('div', { className: 'flex items-start justify-between' },
                      e('div', { className: 'flex-1' },
                        e('div', { className: 'font-medium flex items-center gap-1' },
                          thread.importance === 'major' ? 'ðŸ”´' : 
                          thread.importance === 'minor' ? 'ðŸŸ¡' : 'âšª',
                          thread.name
                        ),
                        e('div', { className: 'opacity-75 mt-1' },
                          thread.status === 'open' 
                            ? `Avattu: Luku ${thread.opened_chapter || '?'}` 
                            : `Suljettu: Luku ${thread.closed_chapter}`
                        )
                      ),
                      e('div', { className: 'flex gap-1' },
                        e('button', {
                          onClick: () => {
                            setEditingThread(thread);
                            setShowThreadSheet(true);
                          },
                          className: 'px-2 py-1 text-xs rounded bg-blue-500 text-white hover:bg-blue-600',
                          title: 'Muokkaa'
                        }, 'âœï¸'),
                        thread.status === 'open' && e('button', {
                          onClick: () => {
                            setProject({
                              ...project,
                              story: {
                                ...project.story,
                                threads: project.story.threads.map(t =>
                                  t.id === thread.id 
                                    ? { ...t, status: 'closed', closed_chapter: getActiveItem()?.metadata?.chapter || '?' }
                                    : t
                                )
                              }
                            });
                          },
                          className: 'px-2 py-1 text-xs rounded bg-green-600 hover:bg-green-700 text-white',
                          title: 'Merkitse suljetuksi'
                        }, 'âœ“')
                      )
                    )
                  )
                )
            )
          )
        )
      ),

      // Vaihe 5: Tekniikat-paneeli
      e('aside', {
        className: `w-80 border-l overflow-y-auto ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`
      },
        e('div', { className: 'p-4 space-y-4' },
          e('div', { className: 'flex items-center justify-between' },
            e('div', { className: 'flex items-center gap-2' },
              e('span', { className: 'text-lg' }, 'ðŸŽ¨'),
              e('h3', { className: 'font-semibold' }, 'Kirjoitustekniikat')
            ),
            e('button', {
              onClick: () => setAiAssistantOpen(false),
              className: 'p-1 rounded hover:bg-gray-700'
            }, e(Icons.X))
          ),

          // Tekniikkakategoriat
          Object.entries(WRITING_TECHNIQUES).map(([categoryKey, category]) =>
            e('div', { key: categoryKey, className: 'space-y-2' },
              e('h4', { className: 'text-sm font-medium opacity-75' }, category.title),
              e('div', { className: 'grid grid-cols-1 gap-1' },
                category.techniques.map(technique =>
                  e('button', {
                    key: technique.id,
                    onClick: () => {
                      // KÃ¤ytÃ¤ tekniikkaa nykyiseen sisÃ¤ltÃ¶Ã¶n
                      const prompt = technique.prompt
                        .replace('{characterList}', project.characters?.map(char => `
- ${char.name} (${char.bio.age || '?'}v, ${char.bio.occupation || 'ammatti?'})
  Tavoite: ${char.psychology.want || '?'}
  Pelko: ${char.psychology.fear || '?'}
  Puhetyyli: ${char.voice.description || '?'}
`).join('\n') || 'Ei hahmoja mÃ¤Ã¤riteltynÃ¤')
                        .replace('{selectedCharacter}', editingCharacter ? `${editingCharacter.name} (${editingCharacter.bio.age || '?'}v)` : 'Ei valittua hahmoa')
                        .replace('{voiceDescription}', editingCharacter?.voice?.description || 'Ei mÃ¤Ã¤ritelty')
                        .replace('{lexicon}', editingCharacter?.voice?.lexicon?.join(', ') || 'Ei mÃ¤Ã¤ritelty')
                        .replace('{avgSentenceLength}', editingCharacter?.voice?.avgSentenceLength || '12')
                        .replace('{want}', editingCharacter?.psychology?.want || 'Ei mÃ¤Ã¤ritelty')
                        .replace('{fear}', editingCharacter?.psychology?.fear || 'Ei mÃ¤Ã¤ritelty')
                        .replace('{weakness}', editingCharacter?.psychology?.weakness || 'Ei mÃ¤Ã¤ritelty')
                        .replace('{values}', editingCharacter?.psychology?.values?.join(', ') || 'Ei mÃ¤Ã¤ritelty')
                        .replace('{resources}', editingCharacter?.state?.resources?.join(', ') || 'Ei mÃ¤Ã¤ritelty')
                        .replace('{injuries}', editingCharacter?.state?.injuries?.join(', ') || 'Ei mÃ¤Ã¤ritelty')
                        .replace('{appearance}', editingCharacter?.bio?.appearance || 'Ei mÃ¤Ã¤ritelty')
                        .replace('{beliefs}', JSON.stringify(editingCharacter?.state?.beliefs || {}));

                      if (!aiAssistantOpen) setAiAssistantOpen(true);
                      setAiPrompt(`${technique.name}: ${technique.description}`);
                      callAIAPI(prompt, false);
                    },
                    className: `w-full text-left p-2 rounded text-xs transition-colors ${
                      isDarkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-50 hover:bg-gray-100'
                    }`,
                    title: technique.description
                  }, technique.name)
                )
              )
            )
          )
        )
      ),

      // AI Assistant
      aiAssistantOpen && e('aside', {
        className: `w-96 border-l overflow-y-auto ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`
      },
        e('div', { className: 'p-4 space-y-4' },
          e('div', { className: 'flex items-center justify-between' },
            e('div', { className: 'flex items-center gap-2' },
              e(Icons.Sparkles, { className: 'w-5 h-5 text-purple-500' }),
              e('h3', { className: 'font-semibold' }, 'AI-avustaja')
            ),
            e('button', { onClick: () => setAiAssistantOpen(false), className: 'p-1 rounded hover:bg-gray-700' }, e(Icons.X))
          ),
          e('div', null,
            e('h4', { className: 'text-sm font-medium mb-2 opacity-75' }, 'AI-palvelu'),
            e('select', {
              value: selectedAIApi,
              onChange: (ev) => setSelectedAIApi(ev.target.value),
              className: `w-full p-2 mb-3 rounded border text-sm ${
                isDarkMode ? 'bg-gray-900 border-gray-700 text-white' : 'bg-white border-gray-200 text-gray-900'
              }`
            }, [
              e('option', { key: 'claude', value: 'claude' }, 'Claude (Anthropic)'),
              e('option', { key: 'grok', value: 'grok' }, 'Grok (xAI)'),
              e('option', { key: 'openai', value: 'openai' }, 'OpenAI (GPT-4)'),
              e('option', { key: 'cursor', value: 'cursor' }, 'Cursor')
            ]),
            e('h4', { className: 'text-sm font-medium mb-2 opacity-75' }, 'Pikatoiminnot'),
            e('div', { className: 'grid grid-cols-2 gap-2' },
              aiPrompts.map((item, idx) =>
                e('button', {
                  key: idx,
                  onClick: () => { setAiPrompt(item.prompt); callAIAPI(item.prompt, true); },
                  disabled: isGenerating,
                  className: `p-2 text-xs rounded border transition-colors ${
                    isDarkMode ? 'border-gray-700 hover:bg-gray-700' : 'border-gray-200 hover:bg-gray-50'
                  } ${isGenerating ? 'opacity-50' : ''}`
                }, item.label)
              )
            )
          ),
          e('div', null,
            e('h4', { className: 'text-sm font-medium mb-2 opacity-75' }, 'Oma pyyntÃ¶'),
            e('textarea', {
              value: aiPrompt,
              onChange: (ev) => setAiPrompt(ev.target.value),
              placeholder: 'Kysy Claudelta mitÃ¤ tahansa...',
              className: `w-full h-24 p-3 rounded border resize-none text-sm ${
                isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'
              }`
            }),
            e('button', {
              onClick: () => callAIAPI(aiPrompt, true),
              disabled: isGenerating || !aiPrompt.trim(),
              className: `w-full mt-2 px-4 py-2 rounded font-medium flex items-center justify-center gap-2 ${
                isGenerating || !aiPrompt.trim()
                  ? 'bg-gray-600 text-gray-400 cursor-not-allowed'
                  : 'bg-purple-600 text-white hover:bg-purple-700'
              }`
            }, isGenerating ? [e(Icons.Loader), ' Luodaan...'] : 'Luo vastaus')
          ),
          aiResponse && e('div', {
            className: `p-4 rounded border ${isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'}`
          },
            e('div', { className: 'flex items-center justify-between mb-2' },
              e('h4', { className: 'text-sm font-medium' }, 'Vastaus'),
              e('button', {
                onClick: insertAiResponse,
                className: 'text-xs px-2 py-1 rounded bg-purple-600 text-white hover:bg-purple-700'
              }, 'LisÃ¤Ã¤ tekstiin')
            ),
            e('div', { className: 'text-sm whitespace-pre-wrap' }, aiResponse)
          )
        )
      )
    ),

    // Vaihe 5: CharacterSheet Modal
  showCharacterSheet && editingCharacter && e('div', {
    className: 'fixed inset-0 bg-black/50 flex items-center justify-center z-[10000]',
    onClick: () => setShowCharacterSheet(false)
  },
    e('div', {
      className: `w-full max-w-3xl max-h-[90vh] overflow-y-auto rounded-lg shadow-xl ${
        isDarkMode ? 'bg-gray-800' : 'bg-white'
      }`,
      onClick: (ev) => ev.stopPropagation()
    },
      // Header
      e('div', { className: 'p-4 border-b flex items-center justify-between sticky top-0 bg-inherit z-10' },
        e('h3', { className: 'text-lg font-bold' }, `Hahmo: ${editingCharacter.name}`),
        e('button', {
          onClick: () => setShowCharacterSheet(false),
          className: 'p-2 rounded hover:bg-gray-700'
        }, e(Icons.X))
      ),

      // Content
      e('div', { className: 'p-4 space-y-6' },
        // PERUSTIEDOT
        e('div', null,
          e('h4', { className: 'font-semibold mb-2 text-blue-500' }, 'ðŸ“‹ Perustiedot'),
          e('div', { className: 'grid grid-cols-2 gap-3' },
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'IkÃ¤'),
              e('input', {
                type: 'number',
                value: editingCharacter.bio.age || '',
                onChange: (ev) => setEditingCharacter({
                  ...editingCharacter,
                  bio: { ...editingCharacter.bio, age: parseInt(ev.target.value) }
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`
              })
            ),
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Ammatti'),
              e('input', {
                value: editingCharacter.bio.occupation || '',
                onChange: (ev) => setEditingCharacter({
                  ...editingCharacter,
                  bio: { ...editingCharacter.bio, occupation: ev.target.value }
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`,
                placeholder: 'esim. toimittaja'
              })
            )
          ),
          e('div', { className: 'mt-3' },
            e('label', { className: 'text-xs block mb-1' }, 'UlkonÃ¤kÃ¶'),
            e('textarea', {
              value: editingCharacter.bio.appearance || '',
              onChange: (ev) => setEditingCharacter({
                ...editingCharacter,
                bio: { ...editingCharacter.bio, appearance: ev.target.value }
              }),
              className: `w-full p-2 rounded border text-sm h-20 resize-none ${
                isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
              }`,
              placeholder: 'PitkÃ¤t mustat hiukset, vihreÃ¤t silmÃ¤t...'
            })
          )
        ),

        // PSYKOLOGIA
        e('div', null,
          e('h4', { className: 'font-semibold mb-2 text-purple-500' }, 'ðŸ§  Psykologia'),
          e('div', { className: 'space-y-3' },
            ['want', 'fear', 'weakness'].map(field =>
              e('div', { key: field },
                e('label', { className: 'text-xs block mb-1' },
                  field === 'want' ? 'MitÃ¤ haluaa' :
                  field === 'fear' ? 'MitÃ¤ pelkÃ¤Ã¤' :
                  'Heikkous'
                ),
                e('input', {
                  value: editingCharacter.psychology[field] || '',
                  onChange: (ev) => setEditingCharacter({
                    ...editingCharacter,
                    psychology: { ...editingCharacter.psychology, [field]: ev.target.value }
                  }),
                  className: `w-full p-2 rounded border text-sm ${
                    isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                  }`,
                  placeholder:
                    field === 'want' ? 'esim. totuus, rakkaus, vapaus' :
                    field === 'fear' ? 'esim. hylÃ¤tyksi tuleminen, epÃ¤onnistuminen' :
                    'esim. ylianalysoi, impulsiivinen'
                })
              )
            )
          )
        ),

        // Ã„Ã„NI JA PUHETYYLI
        e('div', null,
          e('h4', { className: 'font-semibold mb-2 text-green-500' }, 'ðŸ—£ï¸ Ã„Ã¤ni ja puhetyyli'),
          e('div', null,
            e('label', { className: 'text-xs block mb-1' }, 'Miten hahmo puhuu'),
            e('textarea', {
              value: editingCharacter.voice.description || '',
              onChange: (ev) => setEditingCharacter({
                ...editingCharacter,
                voice: { ...editingCharacter.voice, description: ev.target.value }
              }),
              className: `w-full p-2 rounded border text-sm h-20 resize-none ${
                isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
              }`,
              placeholder: 'Lyhyet lauseet, suorat kysymykset, ei runoile...'
            })
          ),
          e('div', { className: 'mt-3' },
            e('label', { className: 'text-xs block mb-1' },
              'Tyypilliset fraasit (pilkulla eroteltu)'),
            e('input', {
              value: (editingCharacter.voice.lexicon || []).join(', '),
              onChange: (ev) => setEditingCharacter({
                ...editingCharacter,
                voice: {
                  ...editingCharacter.voice,
                  lexicon: ev.target.value.split(',').map(s => s.trim()).filter(Boolean)
                }
              }),
              className: `w-full p-2 rounded border text-sm ${
                isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
              }`,
              placeholder: 'kuule nyt, hitto vie, ajattelen ettÃ¤...'
            })
          )
        ),

        // TILA JA RESURSSIT
        e('div', null,
          e('h4', { className: 'font-semibold mb-2 text-orange-500' }, 'ðŸŽ’ Tila ja resurssit'),
          e('div', { className: 'space-y-3' },
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Loukkaantumiset / Vammat'),
              e('input', {
                value: (editingCharacter.state.injuries || []).join(', '),
                onChange: (ev) => setEditingCharacter({
                  ...editingCharacter,
                  state: {
                    ...editingCharacter.state,
                    injuries: ev.target.value.split(',').map(s => s.trim()).filter(Boolean)
                  }
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`,
                placeholder: 'mustelma oikea kyynÃ¤rpÃ¤Ã¤, murtanut luuja...'
              })
            ),
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Esineet / Taidot'),
              e('input', {
                value: (editingCharacter.state.resources || []).join(', '),
                onChange: (ev) => setEditingCharacter({
                  ...editingCharacter,
                  state: {
                    ...editingCharacter.state,
                    resources: ev.target.value.split(',').map(s => s.trim()).filter(Boolean)
                  }
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`,
                placeholder: 'salaoviavain, hakkerointi, ase...'
              })
            ),
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Nykyinen mieliala'),
              e('input', {
                value: editingCharacter.state.mood || '',
                onChange: (ev) => setEditingCharacter({
                  ...editingCharacter,
                  state: { ...editingCharacter.state, mood: ev.target.value }
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`,
                placeholder: 'epÃ¤luuloinen, innokas, vÃ¤synyt...'
              })
            )
          )
        ),

        // SUHTEET
        e('div', null,
          e('h4', { className: 'font-semibold mb-2 text-pink-500' }, 'ðŸ’• Suhteet'),
          e('div', { className: 'text-xs opacity-75 mb-2' },
            'LisÃ¤Ã¤ hahmon suhteet toisiin hahmoihin'),
          // TODO: Suhteet-UI (yksinkertainen versio)
          e('div', { className: 'text-xs opacity-50' },
            '(Tulossa: suhdekartta ja luottamusindeksit)')
        ),

        // MUISTIINPANOT
        e('div', null,
          e('h4', { className: 'font-semibold mb-2' }, 'ðŸ“ Muistiinpanot'),
          e('textarea', {
            value: editingCharacter.notes || '',
            onChange: (ev) => setEditingCharacter({
              ...editingCharacter,
              notes: ev.target.value
            }),
            className: `w-full p-2 rounded border text-sm h-32 resize-none ${
              isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
            }`,
            placeholder: 'Vapaita muistiinpanoja hahmosta...'
          })
        )
      ),

      // Footer
      e('div', { className: 'p-4 border-t flex justify-end gap-2 sticky bottom-0 bg-inherit' },
        e('button', {
          onClick: () => setShowCharacterSheet(false),
          className: 'px-4 py-2 rounded text-sm hover:bg-gray-700'
        }, 'Peruuta'),
        e('button', {
          onClick: () => {
            // Tallenna muutokset
            setProject({
              ...project,
              characters: project.characters.map(c =>
                c.id === editingCharacter.id ? editingCharacter : c
              )
            });
            setShowCharacterSheet(false);
          },
          className: 'px-4 py-2 rounded text-sm bg-blue-500 text-white hover:bg-blue-600'
        }, 'Tallenna')
      )
    )
  ),
  
  // LocationSheet Modal
  showLocationSheet && editingLocation && e('div', {
    className: 'fixed inset-0 bg-black/50 flex items-center justify-center z-[10000]',
    onClick: () => setShowLocationSheet(false)
  },
    e('div', {
      className: `w-full max-w-2xl max-h-[90vh] overflow-y-auto rounded-lg shadow-xl ${
        isDarkMode ? 'bg-gray-800' : 'bg-white'
      }`,
      onClick: (ev) => ev.stopPropagation()
    },
      // Header
      e('div', { className: 'p-4 border-b flex items-center justify-between sticky top-0 bg-inherit z-10' },
        e('h3', { className: 'text-lg font-bold' }, `Paikka: ${editingLocation.name}`),
        e('button', {
          onClick: () => setShowLocationSheet(false),
          className: 'p-2 rounded hover:bg-gray-700'
        }, e(Icons.X))
      ),

      // Content
      e('div', { className: 'p-4 space-y-4' },
        // Perustiedot
        e('div', null,
          e('h4', { className: 'font-semibold mb-2 text-blue-500 text-sm' }, 'ðŸ“ Perustiedot'),
          e('div', { className: 'grid grid-cols-2 gap-3' },
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Nimi'),
              e('input', {
                value: editingLocation.name || '',
                onChange: (ev) => setEditingLocation({
                  ...editingLocation,
                  name: ev.target.value
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`
              })
            ),
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Tyyppi'),
              e('select', {
                value: editingLocation.type || 'landmark',
                onChange: (ev) => setEditingLocation({
                  ...editingLocation,
                  type: ev.target.value
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`
              }, LOCATION_TYPES.map(t => e('option', { key: t.id, value: t.id }, `${t.icon} ${t.name}`)))
            ),
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Kaupunki'),
              e('input', {
                value: editingLocation.city || '',
                onChange: (ev) => setEditingLocation({
                  ...editingLocation,
                  city: ev.target.value
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`
              })
            ),
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Maa'),
              e('input', {
                value: editingLocation.country || '',
                onChange: (ev) => setEditingLocation({
                  ...editingLocation,
                  country: ev.target.value
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`
              })
            )
          )
        ),

        // Muistiinpanot
        e('div', null,
          e('h4', { className: 'font-semibold mb-2 text-sm' }, 'ðŸ“ Muistiinpanot'),
          e('textarea', {
            value: editingLocation.notes || '',
            onChange: (ev) => setEditingLocation({
              ...editingLocation,
              notes: ev.target.value
            }),
            className: `w-full p-2 rounded border text-sm h-24 resize-none ${
              isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
            }`,
            placeholder: 'Vapaat muistiinpanot paikasta...'
          })
        ),

        // Genre-kuvaukset (read-only nÃ¤yttÃ¶)
        Object.keys(editingLocation.genre_descriptions || {}).length > 0 && e('div', null,
          e('h4', { className: 'font-semibold mb-2 text-purple-500 text-sm' }, 'âœï¸ Tallennetut kuvaukset'),
          Object.entries(editingLocation.genre_descriptions).map(([genre, description]) =>
            e('div', {
              key: genre,
              className: `p-3 rounded border mb-2 ${
                isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-gray-50 border-gray-200'
              }`
            },
              e('div', { className: 'text-xs font-medium mb-1 opacity-75' },
                GENRE_OPTIONS.find(g => g.id === genre)?.name || genre
              ),
              e('div', { className: 'text-xs whitespace-pre-wrap' }, description)
            )
          )
        )
      ),

      // Footer
      e('div', { className: 'p-4 border-t flex justify-end gap-2 sticky bottom-0 bg-inherit' },
        e('button', {
          onClick: () => setShowLocationSheet(false),
          className: 'px-4 py-2 rounded text-sm hover:bg-gray-700'
        }, 'Peruuta'),
        e('button', {
          onClick: () => {
            setProject({
              ...project,
              locations: project.locations.map(loc =>
                loc.id === editingLocation.id ? editingLocation : loc
              )
            });
            setShowLocationSheet(false);
          },
          className: 'px-4 py-2 rounded text-sm bg-blue-500 text-white hover:bg-blue-600'
        }, 'Tallenna')
      )
    ),

    // ChapterSheet Modal (StoryKeeper)
    showChapterSheet && editingChapter && e('div', {
      className: 'fixed inset-0 bg-black/50 flex items-center justify-center z-[10000]',
      onClick: () => setShowChapterSheet(false)
    },
      e('div', {
        className: `w-full max-w-2xl max-h-[90vh] overflow-y-auto rounded-lg shadow-xl ${
          isDarkMode ? 'bg-gray-800' : 'bg-white'
        }`,
        onClick: (ev) => ev.stopPropagation()
      },
        // Header
        e('div', { className: 'p-4 border-b flex items-center justify-between sticky top-0 bg-inherit z-10' },
          e('h3', { className: 'text-lg font-bold' }, `Luku ${editingChapter.chapter}`),
          e('button', {
            onClick: () => setShowChapterSheet(false),
            className: 'p-2 rounded hover:bg-gray-700'
          }, e(Icons.X))
        ),

        // Content
        e('div', { className: 'p-4 space-y-4' },
          // Otsikko
          e('div', null,
            e('label', { className: 'text-xs block mb-1' }, 'Otsikko'),
            e('input', {
              value: editingChapter.title || '',
              onChange: (ev) => setEditingChapter({
                ...editingChapter,
                title: ev.target.value
              }),
              className: `w-full p-2 rounded border text-sm ${
                isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
              }`,
              placeholder: 'Luvun otsikko'
            })
          ),

          // Yhteenveto
          e('div', null,
            e('label', { className: 'text-xs block mb-1' }, 'Yhteenveto'),
            e('textarea', {
              value: editingChapter.summary || '',
              onChange: (ev) => setEditingChapter({
                ...editingChapter,
                summary: ev.target.value
              }),
              className: `w-full p-2 rounded border text-sm h-24 resize-none ${
                isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
              }`,
              placeholder: 'Lyhyt yhteenveto luvusta...'
            })
          ),

          // Tila
          e('div', null,
            e('label', { className: 'text-xs block mb-1' }, 'Tila'),
            e('select', {
              value: editingChapter.status || 'not_started',
              onChange: (ev) => setEditingChapter({
                ...editingChapter,
                status: ev.target.value
              }),
              className: `w-full p-2 rounded border text-sm ${
                isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
              }`
            },
              e('option', { value: 'not_started' }, 'Ei aloitettu'),
              e('option', { value: 'in_progress' }, 'Kirjoitetaan'),
              e('option', { value: 'completed' }, 'Valmis')
            )
          ),

          // Aika tarinassa
          e('div', { className: 'grid grid-cols-2 gap-3' },
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Aika tarinassa'),
              e('input', {
                value: editingChapter.story_time || '',
                onChange: (ev) => setEditingChapter({
                  ...editingChapter,
                  story_time: ev.target.value
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`,
                placeholder: 'esim. Maanantai 9:00'
              })
            ),
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Kesto'),
              e('input', {
                value: editingChapter.duration || '',
                onChange: (ev) => setEditingChapter({
                  ...editingChapter,
                  duration: ev.target.value
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`,
                placeholder: 'esim. 2h'
              })
            )
          ),

          // POV ja paikka
          e('div', { className: 'grid grid-cols-2 gap-3' },
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'POV (nÃ¤kÃ¶kulma)'),
              e('input', {
                value: editingChapter.pov || '',
                onChange: (ev) => setEditingChapter({
                  ...editingChapter,
                  pov: ev.target.value
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`,
                placeholder: 'esim. Aava'
              })
            ),
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Paikka'),
              e('input', {
                value: editingChapter.location || '',
                onChange: (ev) => setEditingChapter({
                  ...editingChapter,
                  location: ev.target.value
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`,
                placeholder: 'esim. Kampin aukio'
              })
            )
          )
        ),

        // Footer
        e('div', { className: 'p-4 border-t flex justify-end gap-2 sticky bottom-0 bg-inherit' },
          e('button', {
            onClick: () => setShowChapterSheet(false),
            className: 'px-4 py-2 rounded text-sm hover:bg-gray-700'
          }, 'Peruuta'),
          e('button', {
            onClick: () => {
              setProject({
                ...project,
                story: {
                  ...project.story,
                  outline: project.story.outline.map(ch =>
                    ch.chapter === editingChapter.chapter ? editingChapter : ch
                  )
                }
              });
              setShowChapterSheet(false);
            },
            className: 'px-4 py-2 rounded text-sm bg-blue-500 text-white hover:bg-blue-600'
          }, 'Tallenna')
        )
      )
    ),

    // ThreadSheet Modal (StoryKeeper)
    showThreadSheet && editingThread && e('div', {
      className: 'fixed inset-0 bg-black/50 flex items-center justify-center z-[10000]',
      onClick: () => setShowThreadSheet(false)
    },
      e('div', {
        className: `w-full max-w-2xl max-h-[90vh] overflow-y-auto rounded-lg shadow-xl ${
          isDarkMode ? 'bg-gray-800' : 'bg-white'
        }`,
        onClick: (ev) => ev.stopPropagation()
      },
        // Header
        e('div', { className: 'p-4 border-b flex items-center justify-between sticky top-0 bg-inherit z-10' },
          e('h3', { className: 'text-lg font-bold' }, 'Juonilanka'),
          e('button', {
            onClick: () => setShowThreadSheet(false),
            className: 'p-2 rounded hover:bg-gray-700'
          }, e(Icons.X))
        ),

        // Content
        e('div', { className: 'p-4 space-y-4' },
          // Nimi
          e('div', null,
            e('label', { className: 'text-xs block mb-1' }, 'Nimi'),
            e('input', {
              value: editingThread.name || '',
              onChange: (ev) => setEditingThread({
                ...editingThread,
                name: ev.target.value
              }),
              className: `w-full p-2 rounded border text-sm ${
                isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
              }`,
              placeholder: 'Juonilangan nimi'
            })
          ),

          // Kuvaus
          e('div', null,
            e('label', { className: 'text-xs block mb-1' }, 'Kuvaus'),
            e('textarea', {
              value: editingThread.description || '',
              onChange: (ev) => setEditingThread({
                ...editingThread,
                description: ev.target.value
              }),
              className: `w-full p-2 rounded border text-sm h-24 resize-none ${
                isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
              }`,
              placeholder: 'Juonilangan kuvaus...'
            })
          ),

          // TÃ¤rkeys ja tila
          e('div', { className: 'grid grid-cols-2 gap-3' },
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'TÃ¤rkeys'),
              e('select', {
                value: editingThread.importance || 'minor',
                onChange: (ev) => setEditingThread({
                  ...editingThread,
                  importance: ev.target.value
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`
              },
                e('option', { value: 'major' }, 'ðŸ”´ Major (PÃ¤Ã¤juoni)'),
                e('option', { value: 'minor' }, 'ðŸŸ¡ Minor (Sivujuoni)'),
                e('option', { value: 'subplot' }, 'âšª Subplot (Alajuoni)')
              )
            ),
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Tila'),
              e('select', {
                value: editingThread.status || 'open',
                onChange: (ev) => setEditingThread({
                  ...editingThread,
                  status: ev.target.value
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`
              },
                e('option', { value: 'open' }, 'Auki'),
                e('option', { value: 'closed' }, 'Suljettu'),
                e('option', { value: 'abandoned' }, 'HylÃ¤tty')
              )
            )
          ),

          // Luvut
          e('div', { className: 'grid grid-cols-2 gap-3' },
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Avattu luku'),
              e('input', {
                type: 'number',
                value: editingThread.opened_chapter || '',
                onChange: (ev) => setEditingThread({
                  ...editingThread,
                  opened_chapter: parseInt(ev.target.value) || null
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`,
                placeholder: 'esim. 1'
              })
            ),
            e('div', null,
              e('label', { className: 'text-xs block mb-1' }, 'Suljettu luku'),
              e('input', {
                type: 'number',
                value: editingThread.closed_chapter || '',
                onChange: (ev) => setEditingThread({
                  ...editingThread,
                  closed_chapter: parseInt(ev.target.value) || null
                }),
                className: `w-full p-2 rounded border text-sm ${
                  isDarkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-300'
                }`,
                placeholder: 'esim. 12',
                disabled: editingThread.status !== 'closed'
              })
            )
          )
        ),

        // Footer
        e('div', { className: 'p-4 border-t flex justify-end gap-2 sticky bottom-0 bg-inherit' },
          e('button', {
            onClick: () => setShowThreadSheet(false),
            className: 'px-4 py-2 rounded text-sm hover:bg-gray-700'
          }, 'Peruuta'),
          e('button', {
            onClick: () => {
              setProject({
                ...project,
                story: {
                  ...project.story,
                  threads: project.story.threads.map(t =>
                    t.id === editingThread.id ? editingThread : t
                  )
                }
              });
              setShowThreadSheet(false);
            },
            className: 'px-4 py-2 rounded text-sm bg-blue-500 text-white hover:bg-blue-600'
          }, 'Tallenna')
        )
      )
    ),
    
    // ========== NORMAN-KRUG-NATSUME: UI Components ==========
    
    // NORMAN: AI Feedback - Shows what AI did
    e(AIFeedback, {
      action: showAIFeedback?.action,
      details: showAIFeedback?.details,
      type: showAIFeedback?.type || 'info',
      onDismiss: () => setShowAIFeedback(null)
    }),
    
    // NATSUME: Inspiration Panel - Appears when stuck
    e(InspirationPanel, {
      isVisible: showInspiration,
      inspiration: inspirationData,
      onDismiss: () => setShowInspiration(false)
    }),
    
    // NATSUME: Flow Mode Indicator - Subtle mode display
    e(FlowModeIndicator, { mode: flowMode }),
    
    // NATSUME: Genre Visual Metaphor - Shows genre theme
    project.genre && e('div', {
      className: 'fixed top-20 left-4 text-4xl opacity-10 pointer-events-none z-10'
    }, GENRE_OPTIONS.find(g => g.id === project.genre)?.icon || ''),
    
    // ========== VISUAL MASTERS: Indicators ==========
    
    // IDEO: Cognitive Load Indicator
    e(CognitiveLoadIndicator, { load: cognitiveLoad }),
    
    // SUPERSIDE: Work Phase Indicator
    e(WorkPhaseIndicator, { phase: workPhase }),
    
    // IDEO: Transparent AI Indicator
    e(TransparentAIIndicator, {
      active: aiTransparency.active,
      thinking: aiTransparency.thinking || isGenerating,
      suggestionCount: aiSuggestions.length
    })
    
  )) // Close Fragment
  ); // Close return statement
}
// Error boundary for debugging
class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, error: null };
  }
  
  static getDerivedStateFromError(error) {
    return { hasError: true, error };
  }
  
  componentDidCatch(error, errorInfo) {
    console.error('React Error:', error, errorInfo);
  }
  
  render() {
    if (this.state.hasError) {
      return React.createElement('div', { 
        style: { 
          padding: '20px', 
          color: 'white', 
          background: '#1e1e1e',
          fontFamily: 'monospace'
        } 
      },
        React.createElement('h1', null, 'Error in app'),
        React.createElement('pre', null, this.state.error?.toString()),
        React.createElement('pre', null, this.state.error?.stack)
      );
    }
    return this.props.children;
  }
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(ErrorBoundary, null, e(KirjoitusStudio)));
